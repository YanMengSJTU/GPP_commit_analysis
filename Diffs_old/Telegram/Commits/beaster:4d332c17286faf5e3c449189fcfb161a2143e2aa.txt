diff --git a/Dependencies/gradle/commons.gradle b/Dependencies/gradle/commons.gradle
new file mode 100644
index 000000000..bd9bf6bdc
--- /dev/null
+++ b/Dependencies/gradle/commons.gradle
@@ -0,0 +1,45 @@
+
+/**
+ * Removes release build type from output file name.
+ * @return Output file name without build type.
+ */
+def removeAllVariantsBuildType() {
+    android.applicationVariants.all { variant ->
+        variant.outputs.each { output ->
+            output.outputFile = new File(output.outputFile.parent, output.outputFile.name.replace("-release", ""))
+        }
+    } 
+}
+
+/**
+ * Gets build version code of project based on commits count of whole repository.
+ * @return Number of commits in current git branch.
+ */
+def getGitRevision() { 
+    def code = new ByteArrayOutputStream()
+    exec {
+        commandLine 'git', 'rev-list', '--count', '--all', 'HEAD'
+        standardOutput = code
+    }
+
+     return Integer.valueOf(code.toString().trim()) 
+}
+
+
+/**
+ * Composes build version name with given version name and code.
+ * @param versionName Version name to compose with.
+ * @param versionCode Version code to compose with.
+ * @return The build version name with given version name and code.
+ */
+def composeVersionName(String versionName, int versionCode) {
+    println sprintf("Building version %s", versionName + "." + versionCode)
+    return versionName + "." + versionCode;
+}
+
+
+ext{
+	cleanBuildType = this.&removeAllVariantsBuildType
+	getYotaVersionName = this.&composeVersionName
+	getYotaVersionCode = this.&getGitRevision
+}
\ No newline at end of file
diff --git a/TMessagesProj/src/main/java/org/telegram/bsui/Cells/BSChatAudioCell.java b/TMessagesProj/src/main/java/org/telegram/bsui/Cells/BSChatAudioCell.java
index b121d1684..7d3c21d12 100644
--- a/TMessagesProj/src/main/java/org/telegram/bsui/Cells/BSChatAudioCell.java
+++ b/TMessagesProj/src/main/java/org/telegram/bsui/Cells/BSChatAudioCell.java
@@ -34,6 +34,10 @@
 
     public BSChatAudioCell(Context context) {
         super(context);
+    }
+
+    @Override
+    protected void initResources() {
         if(timePaint == null) {
             backgroundDrawableIn = getResources().getDrawable(R.drawable.msg_in_bs);
             backgroundDrawableOut = getResources().getDrawable(R.drawable.msg_out_bs);
@@ -58,10 +62,11 @@ public BSChatAudioCell(Context context) {
 
             timePaintOut = new TextPaint(TextPaint.ANTI_ALIAS_FLAG);
             timePaintOut.setColor(0xff70b15c);
+
+            timePaint.setTextSize(dp(12));
+            timePaintIn.setTextSize(dp(12));
+            timePaintOut.setTextSize(dp(12));
         }
-        timePaint.setTextSize(dp(12));
-        timePaintIn.setTextSize(dp(12));
-        timePaintOut.setTextSize(dp(12));
     }
 
     @Override
diff --git a/TMessagesProj/src/main/java/org/telegram/bsui/Cells/BSChatContactCell.java b/TMessagesProj/src/main/java/org/telegram/bsui/Cells/BSChatContactCell.java
index 9612283d9..5f52e1545 100644
--- a/TMessagesProj/src/main/java/org/telegram/bsui/Cells/BSChatContactCell.java
+++ b/TMessagesProj/src/main/java/org/telegram/bsui/Cells/BSChatContactCell.java
@@ -6,8 +6,10 @@
 import android.text.TextPaint;
 
 import org.telegram.android.AndroidUtilities;
+import org.telegram.bsui.BSAvatarDrawable;
 import org.telegram.messenger.R;
 import org.telegram.ui.Cells.ChatContactCell;
+import org.telegram.ui.Components.AvatarDrawable;
 
 /**
  * Created by E1ektr0 on 04.01.2015.
@@ -47,6 +49,11 @@ public BSChatContactCell(Context context) {
         super(context);
     }
 
+    @Override
+    protected void initResources() {
+
+    }
+
     @Override
     protected void initNamePaint() {
         if (namePaint == null) {
diff --git a/TMessagesProj/src/main/java/org/telegram/bsui/Cells/BSChatMediaCell.java b/TMessagesProj/src/main/java/org/telegram/bsui/Cells/BSChatMediaCell.java
index 52d99a2d4..fd759f462 100644
--- a/TMessagesProj/src/main/java/org/telegram/bsui/Cells/BSChatMediaCell.java
+++ b/TMessagesProj/src/main/java/org/telegram/bsui/Cells/BSChatMediaCell.java
@@ -19,6 +19,10 @@
     private static Drawable backgroundDrawableIn;
     private static Drawable backgroundDrawableInSelected;
     private static Drawable backgroundDrawableOut;
+    private static Drawable backgroundMediaDrawableIn;
+    private static Drawable backgroundMediaDrawableInSelected;
+    private static Drawable backgroundMediaDrawableOut;
+    private static Drawable backgroundMediaDrawableOutSelected;
     private static TextPaint namePaint;
     private static Paint docBackPaint;
 
@@ -51,6 +55,11 @@ public BSChatMediaCell(Context context) {
         initMedia();
     }
 
+    @Override
+    protected void initResources() {
+
+    }
+
     @Override
     protected void initMedia() {
         if(placeholderDocInDrawable == null) {
@@ -76,6 +85,10 @@ protected void initMedia() {
             backgroundDrawableOut = getResources().getDrawable(R.drawable.msg_out_bs);
             backgroundDrawableOutSelected = getResources().getDrawable(R.drawable.msg_out_selected_bs);
             backgroundDrawableInSelected = getResources().getDrawable(R.drawable.msg_in_selected_bs);
+            backgroundMediaDrawableIn = getResources().getDrawable(R.drawable.msg_in_photo);
+            backgroundMediaDrawableInSelected = getResources().getDrawable(R.drawable.msg_in_photo_selected);
+            backgroundMediaDrawableOut = getResources().getDrawable(R.drawable.msg_out_photo);
+            backgroundMediaDrawableOutSelected = getResources().getDrawable(R.drawable.msg_out_photo_selected);
             docMenuInDrawable = getResources().getDrawable(android.R.color.white);
             docMenuOutDrawable = getResources().getDrawable(android.R.color.white);
 
@@ -109,14 +122,40 @@ protected void initMedia() {
 
             deleteProgressPaint = new Paint(Paint.ANTI_ALIAS_FLAG);
             deleteProgressPaint.setColor(0xffe4e2e0);
+
+            infoPaint.setTextSize(dp(12));
+
+            namePaint.setTextSize(dp(16));
+
+            timePaintIn.setTextSize(dp(12));
+
+            timePaintOut.setTextSize(dp(12));
         }
-        infoPaint.setTextSize(dp(12));
+    }
+
+    @Override
+    protected Drawable getMediaBackgroundDrawable() {
+        return  mediaBackgroundDrawable;
+    }
+
+    @Override
+    protected Drawable getBackgroundMediaDrawableIn() {
+        return backgroundMediaDrawableIn;
+    }
 
-        namePaint.setTextSize(dp(16));
+    @Override
+    protected Drawable getBackgroundMediaDrawableInSelected() {
+        return backgroundMediaDrawableInSelected;
+    }
 
-        timePaintIn.setTextSize(dp(12));
+    @Override
+    protected Drawable getBackgroundMediaDrawableOut() {
+        return backgroundMediaDrawableOut;
+    }
 
-        timePaintOut.setTextSize(dp(12));
+    @Override
+    protected Drawable getBackgroundMediaDrawableOutSelected() {
+        return backgroundMediaDrawableOutSelected;
     }
 
     @Override
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatAudioCell.java b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatAudioCell.java
index d76eaf5c7..f2cceac19 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatAudioCell.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatAudioCell.java
@@ -65,12 +65,13 @@ protected TextPaint getTimePaint(){
         return timePaint;
     }
 
+
     public ChatAudioCell(Context context) {
         super(context);
         TAG = MediaController.getInstance().generateObserverTag();
 
         avatarImage = new ImageReceiver(this);
-        avatarImage.setRoundRadius(dp(25));
+        avatarImage.setRoundRadius(AndroidUtilities.dp(25));
         seekBar = new SeekBar(context);
         seekBar.delegate = this;
         progressView = new ProgressView();
@@ -96,7 +97,7 @@ public ChatAudioCell(Context context) {
             statesDrawable[7][1] = getResources().getDrawable(R.drawable.audiocancel2_pressed);
 
             timePaint = new TextPaint(TextPaint.ANTI_ALIAS_FLAG);
-            timePaint.setTextSize(dp(12));
+            timePaint.setTextSize(AndroidUtilities.dp(12));
         }
     }
 
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatBaseCell.java b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatBaseCell.java
index deede70da..ecd29da01 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatBaseCell.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatBaseCell.java
@@ -17,6 +17,7 @@
 import android.text.StaticLayout;
 import android.text.TextPaint;
 import android.text.TextUtils;
+import android.util.Log;
 import android.view.MotionEvent;
 import android.view.SoundEffectConstants;
 
@@ -145,6 +146,26 @@ protected Drawable getBackgroundDrawableIn() {
         return backgroundDrawableIn;
     }
 
+    protected Drawable getBackgroundMediaDrawableIn() {
+        return backgroundMediaDrawableIn;
+    }
+
+    protected Drawable getBackgroundMediaDrawableInSelected() {
+        return backgroundMediaDrawableInSelected;
+    }
+
+    protected Drawable getBackgroundMediaDrawableOut() {
+        return backgroundMediaDrawableOut;
+    }
+
+    protected Drawable getBackgroundMediaDrawableOutSelected() {
+        return backgroundMediaDrawableOutSelected;
+    }
+
+    protected Drawable getMediaBackgroundDrawable() {
+        return mediaBackgroundDrawable;
+    }
+
     protected int backgroundWidth = 100;
 
     protected int layoutWidth;
@@ -206,8 +227,7 @@ protected void initResources() {
             backgroundMediaDrawableInSelected = getResources().getDrawable(R.drawable.msg_in_photo_selected);
             backgroundMediaDrawableOut = getResources().getDrawable(R.drawable.msg_out_photo);
             backgroundMediaDrawableOutSelected = getResources().getDrawable(R.drawable.msg_out_photo_selected);
-            checkDrawable = getResources().getDrawable(R.drawable.msg_check);
-            halfCheckDrawable = getResources().getDrawable(R.drawable.msg_halfcheck);
+
             clockDrawable = getResources().getDrawable(R.drawable.msg_clock);
             checkMediaDrawable = getResources().getDrawable(R.drawable.msg_check_w);
             halfCheckMediaDrawable = getResources().getDrawable(R.drawable.msg_halfcheck_w);
@@ -218,22 +238,25 @@ protected void initResources() {
             broadcastMediaDrawable = getResources().getDrawable(R.drawable.broadcast4);
 
             timePaintIn = new TextPaint(TextPaint.ANTI_ALIAS_FLAG);
-            timePaintIn.setTextSize(dp(12));
+            timePaintIn.setTextSize(AndroidUtilities.dp(12));
             timePaintIn.setColor(0xffa1aab3);
 
             timePaintOut = new TextPaint(TextPaint.ANTI_ALIAS_FLAG);
-            timePaintOut.setTextSize(dp(12));
+            timePaintOut.setTextSize(AndroidUtilities.dp(12));
             timePaintOut.setColor(0xff70b15c);
 
             timeMediaPaint = new TextPaint(TextPaint.ANTI_ALIAS_FLAG);
-            timeMediaPaint.setTextSize(dp(12));
+            timeMediaPaint.setTextSize(AndroidUtilities.dp(12));
             timeMediaPaint.setColor(0xffffffff);
 
             namePaint = new TextPaint(TextPaint.ANTI_ALIAS_FLAG);
-            namePaint.setTextSize(dp(15));
+            namePaint.setTextSize(AndroidUtilities.dp(15));
 
             forwardNamePaint = new TextPaint(TextPaint.ANTI_ALIAS_FLAG);
-            forwardNamePaint.setTextSize(dp(14));
+            forwardNamePaint.setTextSize(AndroidUtilities.dp(14));
+
+            checkDrawable = getResources().getDrawable(R.drawable.msg_check);
+            halfCheckDrawable = getResources().getDrawable(R.drawable.msg_halfcheck);
         }
     }
 
@@ -522,13 +545,13 @@ protected void onDraw(Canvas canvas) {
                 if (!media) {
                     currentBackgroundDrawable = getBackgroundDrawableOutSelected();
                 } else {
-                    currentBackgroundDrawable = backgroundMediaDrawableOutSelected;
+                    currentBackgroundDrawable = getBackgroundMediaDrawableOutSelected();
                 }
             } else {
                 if (!media) {
                     currentBackgroundDrawable = getBackgroundDrawableOut();
                 } else {
-                    currentBackgroundDrawable = backgroundMediaDrawableOut;
+                    currentBackgroundDrawable = getBackgroundMediaDrawableOut();
                 }
             }
             setDrawableBounds(currentBackgroundDrawable, layoutWidth - backgroundWidth - (!media ? 0 : dp(9)), dp(1), backgroundWidth, layoutHeight - dp(2));
@@ -537,13 +560,13 @@ protected void onDraw(Canvas canvas) {
                 if (!media) {
                     currentBackgroundDrawable = getBackgroundDrawableInSelected();
                 } else {
-                    currentBackgroundDrawable = backgroundMediaDrawableInSelected;
+                    currentBackgroundDrawable = getBackgroundMediaDrawableInSelected();
                 }
             } else {
                 if (!media) {
                     currentBackgroundDrawable = getBackgroundDrawableIn();
                 } else {
-                    currentBackgroundDrawable = backgroundMediaDrawableIn;
+                    currentBackgroundDrawable = getBackgroundMediaDrawableIn();
                 }
             }
             if (isChat) {
@@ -584,8 +607,8 @@ protected void onDraw(Canvas canvas) {
 
         if (drawTime) {
             if (media) {
-                setDrawableBounds(mediaBackgroundDrawable, timeX - dp(3), layoutHeight - dp(27.5f), timeWidth + dp(6 + (currentMessageObject.isOut() ? 20 : 0)), dp(16.5f));
-                mediaBackgroundDrawable.draw(canvas);
+                setDrawableBounds(getMediaBackgroundDrawable(), timeX - dp(3), layoutHeight - dp(27.5f), timeWidth + dp(6 + (currentMessageObject.isOut() ? 20 : 0)), dp(16.5f));
+                getMediaBackgroundDrawable().draw(canvas);
 
                 canvas.save();
                 canvas.translate(timeX, layoutHeight - dp(12.0f) - timeLayout.getHeight());
@@ -650,7 +673,11 @@ protected void onDraw(Canvas canvas) {
                     if (drawCheck2) {
                         if (!media) {
                             if (drawCheck1) {
-                                setDrawableBounds(getCheckDrawable(), layoutWidth - dp(22.5f) - getCheckDrawable().getIntrinsicWidth(), layoutHeight - dp(8.5f) - getCheckDrawable().getIntrinsicHeight());
+                                final int x = layoutWidth - dp(22.5f) - getCheckDrawable().getIntrinsicWidth();
+                                final int y = layoutHeight - dp(8.5f) - getCheckDrawable().getIntrinsicHeight();
+                                Log.d("TAG", "layoutWidth"+layoutWidth);
+                                Log.d("TAG", "getCheckDrawable().getIntrinsicWidth()"+getCheckDrawable().getIntrinsicWidth());
+                                setDrawableBounds(getCheckDrawable(), x, y);
                             } else {
                                 setDrawableBounds(getCheckDrawable(), layoutWidth - dp(18.5f) - getCheckDrawable().getIntrinsicWidth(), layoutHeight - dp(8.5f) - getCheckDrawable().getIntrinsicHeight());
                             }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatContactCell.java b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatContactCell.java
index ef00c3cd6..a3675ce63 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatContactCell.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatContactCell.java
@@ -67,7 +67,6 @@ protected TextPaint getPhonePaint() {
     protected Drawable getAddContactDrawableIn() {
         return addContactDrawableIn;
     }
-
     protected Drawable getAddContactDrawableOut() {
         return addContactDrawableOut;
     }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMediaCell.java b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMediaCell.java
index b536bbfcd..434af23ae 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMediaCell.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMediaCell.java
@@ -1003,8 +1003,8 @@ protected void onAfterBackgroundDraw(Canvas canvas) {
             }
         } else if (infoLayout != null && (buttonState == 1 || buttonState == 0 || buttonState == 3 || currentMessageObject.isSecretPhoto())) {
             getInfoPaint().setColor(0xffffffff);
-            setDrawableBounds(mediaBackgroundDrawable, photoImage.getImageX() + dp(4), photoImage.getImageY() + dp(4), infoWidth + dp(8) + infoOffset, dp(16.5f));
-            mediaBackgroundDrawable.draw(canvas);
+            setDrawableBounds(getMediaBackgroundDrawable(), photoImage.getImageX() + dp(4), photoImage.getImageY() + dp(4), infoWidth + dp(8) + infoOffset, dp(16.5f));
+            getMediaBackgroundDrawable().draw(canvas);
 
             if (currentMessageObject.type == 3) {
                 setDrawableBounds(getVideoIconDrawable(), photoImage.getImageX() + dp(8), photoImage.getImageY() + dp(7.5f));
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMessageCell.java b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMessageCell.java
index 50d372e6c..b14895a95 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMessageCell.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMessageCell.java
@@ -33,6 +33,7 @@ public ChatMessageCell(Context context) {
         drawForwardedName = true;
     }
 
+
     @Override
     public boolean onTouchEvent(MotionEvent event) {
         if (currentMessageObject != null && currentMessageObject.textLayoutBlocks != null && !currentMessageObject.textLayoutBlocks.isEmpty() && currentMessageObject.messageText instanceof Spannable && !isPressed) {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
index 1bad799c7..9f583d415 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
@@ -19,6 +19,7 @@
 import android.content.pm.PackageManager;
 import android.content.res.Configuration;
 import android.database.Cursor;
+import android.graphics.Canvas;
 import android.graphics.Point;
 import android.net.Uri;
 import android.os.Build;
@@ -64,6 +65,7 @@
 import org.telegram.ui.ActionBar.ActionBarLayout;
 import org.telegram.ui.ActionBar.BaseFragment;
 import org.telegram.ui.ActionBar.DrawerLayoutContainer;
+import org.telegram.ui.Cells.ChatMessageCell;
 
 import java.io.BufferedReader;
 import java.io.File;
diff --git a/TMessagesProj/src/main/res/drawable-hdpi/ic_mic.png b/TMessagesProj/src/main/res/drawable-hdpi/ic_mic.png
new file mode 100644
index 000000000..e55f0e09b
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-hdpi/ic_mic.png differ
