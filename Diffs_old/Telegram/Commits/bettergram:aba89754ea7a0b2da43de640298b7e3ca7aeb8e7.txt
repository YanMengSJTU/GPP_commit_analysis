diff --git a/TMessagesProj/src/main/java/io/bettergram/adapters/CryptoAdapter.java b/TMessagesProj/src/main/java/io/bettergram/adapters/CryptoAdapter.java
index 6286e2dc9..c570050f4 100644
--- a/TMessagesProj/src/main/java/io/bettergram/adapters/CryptoAdapter.java
+++ b/TMessagesProj/src/main/java/io/bettergram/adapters/CryptoAdapter.java
@@ -31,13 +31,13 @@
 import io.bettergram.data.CryptoCurrencyInfoResponse__JsonHelper;
 import io.bettergram.messenger.R;
 import io.bettergram.service.CryptoDataService;
-import io.bettergram.utils.Number;
-import io.bettergram.utils.SpanBuilder;
 import io.bettergram.telegram.messenger.AndroidUtilities;
 import io.bettergram.telegram.messenger.support.widget.RecyclerView;
 import io.bettergram.telegram.ui.ActionBar.Theme;
 import io.bettergram.telegram.ui.Components.LayoutHelper;
 import io.bettergram.telegram.ui.Components.TabStrip.SlidingTabLayout;
+import io.bettergram.utils.Number;
+import io.bettergram.utils.SpanBuilder;
 
 import java.io.IOException;
 import java.util.ArrayList;
@@ -375,7 +375,11 @@ public void registerReceiver(Activity activity) {
      * Unregister {@link BroadcastReceiver} of {@link CryptoDataService}
      */
     public void unregisterReceiver(Activity activity) {
-        activity.unregisterReceiver(receiver);
+        try {
+            activity.unregisterReceiver(receiver);
+        } catch (IllegalArgumentException e) {
+            e.printStackTrace();
+        }
     }
 
     class TabsPagerAdapter extends PagerAdapter {
diff --git a/TMessagesProj/src/main/java/io/bettergram/adapters/NewsAdapter.java b/TMessagesProj/src/main/java/io/bettergram/adapters/NewsAdapter.java
index 8fb5784cf..033bef7ec 100644
--- a/TMessagesProj/src/main/java/io/bettergram/adapters/NewsAdapter.java
+++ b/TMessagesProj/src/main/java/io/bettergram/adapters/NewsAdapter.java
@@ -173,7 +173,11 @@ public void registerReceiver(Activity activity) {
      * Unregister {@link BroadcastReceiver} of {@link NewsDataService}
      */
     public void unregisterReceiver(Activity activity) {
-        activity.unregisterReceiver(receiver);
+        try {
+            activity.unregisterReceiver(receiver);
+        } catch (IllegalArgumentException e) {
+            e.printStackTrace();
+        }
     }
 
 }
diff --git a/TMessagesProj/src/main/java/io/bettergram/adapters/ResourcesAdapter.java b/TMessagesProj/src/main/java/io/bettergram/adapters/ResourcesAdapter.java
index 3058de337..f8421a3ab 100644
--- a/TMessagesProj/src/main/java/io/bettergram/adapters/ResourcesAdapter.java
+++ b/TMessagesProj/src/main/java/io/bettergram/adapters/ResourcesAdapter.java
@@ -202,7 +202,11 @@ public void registerReceiver(Activity activity) {
      * Unregister {@link BroadcastReceiver} of {@link ResourcesDataService}
      */
     public void unregisterReceiver(Activity activity) {
-        activity.unregisterReceiver(receiver);
+        try {
+            activity.unregisterReceiver(receiver);
+        } catch (IllegalArgumentException e) {
+            e.printStackTrace();
+        }
     }
 
 }
diff --git a/TMessagesProj/src/main/java/io/bettergram/adapters/YouTubePlayerAdapter.java b/TMessagesProj/src/main/java/io/bettergram/adapters/YouTubePlayerAdapter.java
index 73dc661f4..bc902b2a2 100644
--- a/TMessagesProj/src/main/java/io/bettergram/adapters/YouTubePlayerAdapter.java
+++ b/TMessagesProj/src/main/java/io/bettergram/adapters/YouTubePlayerAdapter.java
@@ -20,9 +20,9 @@
 import io.bettergram.data.VideoList__JsonHelper;
 import io.bettergram.messenger.R;
 import io.bettergram.service.YoutubeDataService;
-import io.bettergram.utils.RoundedCornersTransform;
 import io.bettergram.telegram.messenger.AndroidUtilities;
 import io.bettergram.telegram.messenger.support.widget.RecyclerView;
+import io.bettergram.utils.RoundedCornersTransform;
 
 import java.io.IOException;
 import java.util.ArrayList;
@@ -175,6 +175,10 @@ public void registerReceiver(Activity activity) {
      * Unregister {@link BroadcastReceiver} of {@link YoutubeDataService}
      */
     public void unregisterReceiver(Activity activity) {
-        activity.unregisterReceiver(receiver);
+        try {
+            activity.unregisterReceiver(receiver);
+        } catch (IllegalArgumentException e) {
+            e.printStackTrace();
+        }
     }
 }
diff --git a/TMessagesProj/src/main/java/io/bettergram/telegram/ui/ActionBar/ActionBarLayout.java b/TMessagesProj/src/main/java/io/bettergram/telegram/ui/ActionBar/ActionBarLayout.java
index 26833c674..9a6ee7c68 100644
--- a/TMessagesProj/src/main/java/io/bettergram/telegram/ui/ActionBar/ActionBarLayout.java
+++ b/TMessagesProj/src/main/java/io/bettergram/telegram/ui/ActionBar/ActionBarLayout.java
@@ -25,6 +25,7 @@
 import android.graphics.drawable.Drawable;
 import android.os.Build;
 import android.support.annotation.Keep;
+import android.util.Log;
 import android.view.Gravity;
 import android.view.HapticFeedbackConstants;
 import android.view.KeyEvent;
@@ -51,9 +52,13 @@
 
     public interface ActionBarLayoutDelegate {
         boolean onPreIme();
+
         boolean needPresentFragment(BaseFragment fragment, boolean removeLast, boolean forceWithoutAnimation, ActionBarLayout layout);
+
         boolean needAddFragmentToStack(BaseFragment fragment, ActionBarLayout layout);
+
         boolean needCloseLastFragment(ActionBarLayout layout);
+
         void onRebuildAllFragments(ActionBarLayout layout, boolean last);
     }
 
@@ -349,7 +354,7 @@ protected boolean drawChild(Canvas canvas, View child, long drawingTime) {
                 layerShadowDrawable.setAlpha((int) (0xff * alpha));
                 layerShadowDrawable.draw(canvas);
             } else if (child == containerViewBack) {
-                float opacity = Math.min(0.8f, (width - translationX) / (float)width);
+                float opacity = Math.min(0.8f, (width - translationX) / (float) width);
                 if (opacity < 0) {
                     opacity = 0;
                 }
@@ -1514,6 +1519,14 @@ public boolean extendActionMode(Menu menu) {
         return !fragmentsStack.isEmpty() && fragmentsStack.get(fragmentsStack.size() - 1).extendActionMode(menu);
     }
 
+    @Override
+    protected void onAttachedToWindow() {
+        super.onAttachedToWindow();
+        for (BaseFragment fragment : fragmentsStack) {
+            fragment.onAttach(parentActivity);
+        }
+    }
+
     @Override
     public boolean hasOverlappingRendering() {
         return false;
diff --git a/TMessagesProj/src/main/java/io/bettergram/telegram/ui/ActionBar/BaseFragment.java b/TMessagesProj/src/main/java/io/bettergram/telegram/ui/ActionBar/BaseFragment.java
index 9f44e1892..86611ab1a 100644
--- a/TMessagesProj/src/main/java/io/bettergram/telegram/ui/ActionBar/BaseFragment.java
+++ b/TMessagesProj/src/main/java/io/bettergram/telegram/ui/ActionBar/BaseFragment.java
@@ -12,14 +12,12 @@
 import android.app.Activity;
 import android.app.Dialog;
 import android.content.Context;
-import android.content.DialogInterface;
 import android.content.Intent;
 import android.os.Build;
 import android.os.Bundle;
 import android.view.Menu;
 import android.view.View;
 import android.view.ViewGroup;
-
 import io.bettergram.telegram.messenger.FileLog;
 import io.bettergram.telegram.messenger.UserConfig;
 import io.bettergram.telegram.tgnet.ConnectionsManager;
@@ -40,6 +38,12 @@
     protected boolean swipeBackEnabled = true;
     protected boolean hasOwnBackground = false;
 
+    protected ActivityEnabledListener activityListener;
+
+    protected interface ActivityEnabledListener {
+        void onActivityEnabled(Activity activity);
+    }
+
     public BaseFragment() {
         classGuid = ConnectionsManager.generateClassGuid();
     }
@@ -76,6 +80,14 @@ public int getCurrentAccount() {
         return currentAccount;
     }
 
+    protected void getAvailableActivity(ActivityEnabledListener listener) {
+        if (getParentActivity() == null) {
+            activityListener = listener;
+        } else {
+            listener.onActivityEnabled(getParentActivity());
+        }
+    }
+
     protected void setInPreviewMode(boolean value) {
         inPreviewMode = value;
         if (actionBar != null) {
@@ -218,6 +230,13 @@ public boolean needDelayOpenAnimation() {
         return false;
     }
 
+    public void onAttach(Activity activity) {
+        if (activityListener != null) {
+            activityListener.onActivityEnabled(activity);
+            activityListener = null;
+        }
+    }
+
     public void onResume() {
 
     }
diff --git a/TMessagesProj/src/main/java/io/bettergram/telegram/ui/DialogsActivity.java b/TMessagesProj/src/main/java/io/bettergram/telegram/ui/DialogsActivity.java
index 8af7ec780..c2e15a885 100644
--- a/TMessagesProj/src/main/java/io/bettergram/telegram/ui/DialogsActivity.java
+++ b/TMessagesProj/src/main/java/io/bettergram/telegram/ui/DialogsActivity.java
@@ -34,8 +34,8 @@
 import android.view.animation.AccelerateDecelerateInterpolator;
 import android.view.animation.DecelerateInterpolator;
 import android.widget.*;
-import io.bettergram.messenger.R;
 import io.bettergram.adapters.*;
+import io.bettergram.messenger.R;
 import io.bettergram.telegram.messenger.*;
 import io.bettergram.telegram.messenger.support.widget.LinearLayoutManager;
 import io.bettergram.telegram.messenger.support.widget.LinearSmoothScrollerMiddle;
@@ -1341,21 +1341,17 @@ public void onMessageSend(CharSequence message) {
             });
         }
 
-        Activity activity = getParentActivity();
-        if (activity != null) {
-
-            cryptoAdapter.startService(activity);
-
-            newsAdapter.startService(getParentActivity());
-
-            if (videoAdapter == null) {
-                videoAdapter = new YouTubePlayerAdapter(activity);
+        getAvailableActivity(activity -> {
+            if (activity != null) {
+                cryptoAdapter.startService(activity);
+                newsAdapter.startService(getParentActivity());
+                if (videoAdapter == null) {
+                    videoAdapter = new YouTubePlayerAdapter(activity);
+                }
+                videoAdapter.startService(activity);
+                resourcesAdapter.startService(activity);
             }
-
-            videoAdapter.startService(activity);
-
-            resourcesAdapter.startService(activity);
-        }
+        });
 
         BottomNavigationBar bottomBar = new BottomNavigationBar(context)
                 .setOnSelectListener((position, title) -> {
@@ -1447,21 +1443,22 @@ public void onResume() {
             }
         }
 
-        Activity activity = getParentActivity();
-        if (activity != null) {
-            if (cryptoAdapter != null) {
-                cryptoAdapter.registerReceiver(activity);
-            }
-            if (newsAdapter != null) {
-                newsAdapter.registerReceiver(activity);
-            }
-            if (videoAdapter != null) {
-                videoAdapter.registerReceiver(activity);
-            }
-            if (resourcesAdapter != null) {
-                resourcesAdapter.registerReceiver(activity);
+        getAvailableActivity(activity -> {
+            if (activity != null) {
+                if (cryptoAdapter != null) {
+                    cryptoAdapter.registerReceiver(activity);
+                }
+                if (newsAdapter != null) {
+                    newsAdapter.registerReceiver(activity);
+                }
+                if (videoAdapter != null) {
+                    videoAdapter.registerReceiver(activity);
+                }
+                if (resourcesAdapter != null) {
+                    resourcesAdapter.registerReceiver(activity);
+                }
             }
-        }
+        });
     }
 
     @Override
@@ -1470,21 +1467,22 @@ public void onPause() {
         if (commentView != null) {
             commentView.onResume();
         }
-        Activity activity = getParentActivity();
-        if (activity != null) {
-            if (cryptoAdapter != null) {
-                cryptoAdapter.unregisterReceiver(activity);
-            }
-            if (newsAdapter != null) {
-                newsAdapter.unregisterReceiver(activity);
-            }
-            if (videoAdapter != null) {
-                videoAdapter.unregisterReceiver(activity);
-            }
-            if (resourcesAdapter != null) {
-                resourcesAdapter.unregisterReceiver(activity);
+        getAvailableActivity(activity -> {
+            if (activity != null) {
+                if (cryptoAdapter != null) {
+                    cryptoAdapter.unregisterReceiver(activity);
+                }
+                if (newsAdapter != null) {
+                    newsAdapter.unregisterReceiver(activity);
+                }
+                if (videoAdapter != null) {
+                    videoAdapter.unregisterReceiver(activity);
+                }
+                if (resourcesAdapter != null) {
+                    resourcesAdapter.unregisterReceiver(activity);
+                }
             }
-        }
+        });
     }
 
     private void checkUnreadCount(boolean animated) {
