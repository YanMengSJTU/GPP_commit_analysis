diff --git a/okhttp/src/main/java/okhttp3/HttpUrl.java b/okhttp/src/main/java/okhttp3/HttpUrl.java
index f4092f3d9f..de89804991 100644
--- a/okhttp/src/main/java/okhttp3/HttpUrl.java
+++ b/okhttp/src/main/java/okhttp3/HttpUrl.java
@@ -1787,8 +1787,9 @@ static int decodeHexDigit(char c) {
     return -1;
   }
 
-  private static boolean isValidCode(int codePoint) {
-    return codePoint < 0xd800 || codePoint > 0xdfff && codePoint <= 0x10ffff;
+  private static boolean isValidCodePoint(int codePoint) {
+    return Character.isValidCodePoint(codePoint)
+            && !Character.isSurrogate((char) codePoint);
   }
 
   /**
@@ -1814,7 +1815,7 @@ static String canonicalize(String input, int pos, int limit, String encodeSet,
       codePoint = input.codePointAt(i);
       if (codePoint < 0x20
           || codePoint == 0x7f
-          || codePoint >= 0x80 && asciiOnly && isValidCode(codePoint)
+          || codePoint >= 0x80 && asciiOnly && isValidCodePoint(codePoint)
           || encodeSet.indexOf(codePoint) != -1
           || codePoint == '%' && (!alreadyEncoded || strict && !percentEncoded(input, i, limit))
           || codePoint == '+' && plusIsSpace) {
@@ -1845,7 +1846,7 @@ static void canonicalize(Buffer out, String input, int pos, int limit, String en
         out.writeUtf8(alreadyEncoded ? "+" : "%2B");
       } else if (codePoint < 0x20
           || codePoint == 0x7f
-          || codePoint >= 0x80 && asciiOnly && isValidCode(codePoint)
+          || codePoint >= 0x80 && asciiOnly && isValidCodePoint(codePoint)
           || encodeSet.indexOf(codePoint) != -1
           || codePoint == '%' && (!alreadyEncoded || strict && !percentEncoded(input, i, limit))) {
         // Percent encode this character.
@@ -1859,7 +1860,7 @@ static void canonicalize(Buffer out, String input, int pos, int limit, String en
           out.writeByte(HEX_DIGITS[(b >> 4) & 0xf]);
           out.writeByte(HEX_DIGITS[b & 0xf]);
         }
-      } else if (isValidCode(codePoint)) {
+      } else if (isValidCodePoint(codePoint)) {
         // This character doesn't need encoding. Just copy it over.
         out.writeUtf8CodePoint(codePoint);
       }
