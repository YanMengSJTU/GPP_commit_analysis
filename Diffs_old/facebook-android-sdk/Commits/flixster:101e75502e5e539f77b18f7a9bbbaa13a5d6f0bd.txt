diff --git a/build.gradle b/build.gradle
index 2d3bec743..fdf10eb4b 100644
--- a/build.gradle
+++ b/build.gradle
@@ -4,6 +4,6 @@ buildscript {
         mavenCentral()
     }
     dependencies {
-        classpath 'com.android.tools.build:gradle:0.7.+'
+        classpath 'com.android.tools.build:gradle:0.9.+'
     }
 }
diff --git a/facebook/TestApp/build.gradle b/facebook/TestApp/build.gradle
index a2cda0280..535d02a65 100644
--- a/facebook/TestApp/build.gradle
+++ b/facebook/TestApp/build.gradle
@@ -13,6 +13,10 @@ android {
         targetSdkVersion 19
     }
 
+    lintOptions {
+        abortOnError false
+    }
+
     sourceSets {
         main {
             manifest.srcFile 'AndroidManifest.xml'
diff --git a/facebook/build.gradle b/facebook/build.gradle
index ea2914c49..45098e21d 100644
--- a/facebook/build.gradle
+++ b/facebook/build.gradle
@@ -2,6 +2,7 @@ apply plugin: 'android-library'
 
 dependencies {
     compile 'com.android.support:support-v4:13.0.+'
+    compile files('libs/bolts.jar')
 }
 
 android {
@@ -13,6 +14,10 @@ android {
         targetSdkVersion 19
     }
 
+    lintOptions {
+        abortOnError false
+    }
+
     sourceSets {
         main {
             manifest.srcFile 'AndroidManifest.xml'
diff --git a/facebook/res/drawable-hdpi/com_facebook_tooltip_black_background.9.png b/facebook/res/drawable-hdpi/com_facebook_tooltip_black_background.9.png
new file mode 100644
index 000000000..4707ba20c
Binary files /dev/null and b/facebook/res/drawable-hdpi/com_facebook_tooltip_black_background.9.png differ
diff --git a/facebook/res/drawable-hdpi/com_facebook_tooltip_black_bottomnub.png b/facebook/res/drawable-hdpi/com_facebook_tooltip_black_bottomnub.png
new file mode 100644
index 000000000..83bf9694b
Binary files /dev/null and b/facebook/res/drawable-hdpi/com_facebook_tooltip_black_bottomnub.png differ
diff --git a/facebook/res/drawable-hdpi/com_facebook_tooltip_black_topnub.png b/facebook/res/drawable-hdpi/com_facebook_tooltip_black_topnub.png
new file mode 100644
index 000000000..0d8fb82b6
Binary files /dev/null and b/facebook/res/drawable-hdpi/com_facebook_tooltip_black_topnub.png differ
diff --git a/facebook/res/drawable-hdpi/com_facebook_tooltip_black_xout.png b/facebook/res/drawable-hdpi/com_facebook_tooltip_black_xout.png
new file mode 100644
index 000000000..5bebe5e35
Binary files /dev/null and b/facebook/res/drawable-hdpi/com_facebook_tooltip_black_xout.png differ
diff --git a/facebook/res/drawable-hdpi/com_facebook_tooltip_blue_background.9.png b/facebook/res/drawable-hdpi/com_facebook_tooltip_blue_background.9.png
new file mode 100644
index 000000000..0f8c5dffc
Binary files /dev/null and b/facebook/res/drawable-hdpi/com_facebook_tooltip_blue_background.9.png differ
diff --git a/facebook/res/drawable-hdpi/com_facebook_tooltip_blue_bottomnub.png b/facebook/res/drawable-hdpi/com_facebook_tooltip_blue_bottomnub.png
new file mode 100644
index 000000000..21145bca6
Binary files /dev/null and b/facebook/res/drawable-hdpi/com_facebook_tooltip_blue_bottomnub.png differ
diff --git a/facebook/res/drawable-hdpi/com_facebook_tooltip_blue_topnub.png b/facebook/res/drawable-hdpi/com_facebook_tooltip_blue_topnub.png
new file mode 100644
index 000000000..8b534773d
Binary files /dev/null and b/facebook/res/drawable-hdpi/com_facebook_tooltip_blue_topnub.png differ
diff --git a/facebook/res/drawable-hdpi/com_facebook_tooltip_blue_xout.png b/facebook/res/drawable-hdpi/com_facebook_tooltip_blue_xout.png
new file mode 100644
index 000000000..9f341075c
Binary files /dev/null and b/facebook/res/drawable-hdpi/com_facebook_tooltip_blue_xout.png differ
diff --git a/facebook/res/drawable-mdpi/com_facebook_tooltip_black_background.9.png b/facebook/res/drawable-mdpi/com_facebook_tooltip_black_background.9.png
new file mode 100644
index 000000000..59f263982
Binary files /dev/null and b/facebook/res/drawable-mdpi/com_facebook_tooltip_black_background.9.png differ
diff --git a/facebook/res/drawable-mdpi/com_facebook_tooltip_black_bottomnub.png b/facebook/res/drawable-mdpi/com_facebook_tooltip_black_bottomnub.png
new file mode 100644
index 000000000..4c97bf923
Binary files /dev/null and b/facebook/res/drawable-mdpi/com_facebook_tooltip_black_bottomnub.png differ
diff --git a/facebook/res/drawable-mdpi/com_facebook_tooltip_black_topnub.png b/facebook/res/drawable-mdpi/com_facebook_tooltip_black_topnub.png
new file mode 100644
index 000000000..7fdf08201
Binary files /dev/null and b/facebook/res/drawable-mdpi/com_facebook_tooltip_black_topnub.png differ
diff --git a/facebook/res/drawable-mdpi/com_facebook_tooltip_black_xout.png b/facebook/res/drawable-mdpi/com_facebook_tooltip_black_xout.png
new file mode 100644
index 000000000..21ad6a54e
Binary files /dev/null and b/facebook/res/drawable-mdpi/com_facebook_tooltip_black_xout.png differ
diff --git a/facebook/res/drawable-mdpi/com_facebook_tooltip_blue_background.9.png b/facebook/res/drawable-mdpi/com_facebook_tooltip_blue_background.9.png
new file mode 100644
index 000000000..bd54278da
Binary files /dev/null and b/facebook/res/drawable-mdpi/com_facebook_tooltip_blue_background.9.png differ
diff --git a/facebook/res/drawable-mdpi/com_facebook_tooltip_blue_bottomnub.png b/facebook/res/drawable-mdpi/com_facebook_tooltip_blue_bottomnub.png
new file mode 100644
index 000000000..299afc24e
Binary files /dev/null and b/facebook/res/drawable-mdpi/com_facebook_tooltip_blue_bottomnub.png differ
diff --git a/facebook/res/drawable-mdpi/com_facebook_tooltip_blue_topnub.png b/facebook/res/drawable-mdpi/com_facebook_tooltip_blue_topnub.png
new file mode 100644
index 000000000..cb29b55f3
Binary files /dev/null and b/facebook/res/drawable-mdpi/com_facebook_tooltip_blue_topnub.png differ
diff --git a/facebook/res/drawable-mdpi/com_facebook_tooltip_blue_xout.png b/facebook/res/drawable-mdpi/com_facebook_tooltip_blue_xout.png
new file mode 100644
index 000000000..73695f03b
Binary files /dev/null and b/facebook/res/drawable-mdpi/com_facebook_tooltip_blue_xout.png differ
diff --git a/facebook/res/drawable-xhdpi/com_facebook_tooltip_black_background.9.png b/facebook/res/drawable-xhdpi/com_facebook_tooltip_black_background.9.png
new file mode 100644
index 000000000..d6f89a731
Binary files /dev/null and b/facebook/res/drawable-xhdpi/com_facebook_tooltip_black_background.9.png differ
diff --git a/facebook/res/drawable-xhdpi/com_facebook_tooltip_black_bottomnub.png b/facebook/res/drawable-xhdpi/com_facebook_tooltip_black_bottomnub.png
new file mode 100644
index 000000000..71abe544b
Binary files /dev/null and b/facebook/res/drawable-xhdpi/com_facebook_tooltip_black_bottomnub.png differ
diff --git a/facebook/res/drawable-xhdpi/com_facebook_tooltip_black_topnub.png b/facebook/res/drawable-xhdpi/com_facebook_tooltip_black_topnub.png
new file mode 100644
index 000000000..2ac32dbc2
Binary files /dev/null and b/facebook/res/drawable-xhdpi/com_facebook_tooltip_black_topnub.png differ
diff --git a/facebook/res/drawable-xhdpi/com_facebook_tooltip_black_xout.png b/facebook/res/drawable-xhdpi/com_facebook_tooltip_black_xout.png
new file mode 100644
index 000000000..e3d562b60
Binary files /dev/null and b/facebook/res/drawable-xhdpi/com_facebook_tooltip_black_xout.png differ
diff --git a/facebook/res/drawable-xhdpi/com_facebook_tooltip_blue_background.9.png b/facebook/res/drawable-xhdpi/com_facebook_tooltip_blue_background.9.png
new file mode 100644
index 000000000..a1978044c
Binary files /dev/null and b/facebook/res/drawable-xhdpi/com_facebook_tooltip_blue_background.9.png differ
diff --git a/facebook/res/drawable-xhdpi/com_facebook_tooltip_blue_bottomnub.png b/facebook/res/drawable-xhdpi/com_facebook_tooltip_blue_bottomnub.png
new file mode 100644
index 000000000..cee80f129
Binary files /dev/null and b/facebook/res/drawable-xhdpi/com_facebook_tooltip_blue_bottomnub.png differ
diff --git a/facebook/res/drawable-xhdpi/com_facebook_tooltip_blue_topnub.png b/facebook/res/drawable-xhdpi/com_facebook_tooltip_blue_topnub.png
new file mode 100644
index 000000000..2ec445e5d
Binary files /dev/null and b/facebook/res/drawable-xhdpi/com_facebook_tooltip_blue_topnub.png differ
diff --git a/facebook/res/drawable-xhdpi/com_facebook_tooltip_blue_xout.png b/facebook/res/drawable-xhdpi/com_facebook_tooltip_blue_xout.png
new file mode 100644
index 000000000..7fd57632d
Binary files /dev/null and b/facebook/res/drawable-xhdpi/com_facebook_tooltip_blue_xout.png differ
diff --git a/facebook/res/layout/com_facebook_tooltip_bubble.xml b/facebook/res/layout/com_facebook_tooltip_bubble.xml
new file mode 100644
index 000000000..07a48e26c
--- /dev/null
+++ b/facebook/res/layout/com_facebook_tooltip_bubble.xml
@@ -0,0 +1,54 @@
+<?xml version="1.0" encoding="utf-8"?>
+<RelativeLayout
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="wrap_content"
+    android:layout_height="wrap_content"
+    android:paddingLeft="20dp"
+    android:paddingRight="20dp">
+  <RelativeLayout
+  	android:id="@+id/com_facebook_body_frame"
+    android:layout_width="wrap_content"
+    android:layout_height="wrap_content"
+    android:layout_below="@+id/com_facebook_tooltip_bubble_view_top_pointer"
+    android:layout_centerHorizontal="true"
+    android:background="@drawable/com_facebook_tooltip_blue_background">
+      <ImageView 
+        android:id="@+id/com_facebook_button_xout"
+        android:layout_width="wrap_content"
+        android:layout_height="wrap_content"
+        android:layout_alignParentTop="true"
+        android:layout_alignParentRight="true"
+        android:padding="10dp"
+        android:src="@drawable/com_facebook_tooltip_blue_xout"
+        />
+      <TextView
+          android:id="@+id/com_facebook_tooltip_bubble_view_text_body"
+          android:layout_width="wrap_content"
+          android:layout_height="wrap_content"
+          android:layout_alignParentTop="true"
+          android:layout_toLeftOf="@id/com_facebook_button_xout"
+          android:layout_alignParentLeft="true"
+          android:padding="10dp"
+          style="@style/tooltip_bubble_text"
+          />
+  </RelativeLayout>
+  <ImageView
+      android:id="@+id/com_facebook_tooltip_bubble_view_top_pointer"
+      android:layout_width="wrap_content"
+      android:layout_height="wrap_content"
+      android:layout_alignParentTop="true"
+      android:layout_centerHorizontal="true"
+      android:layout_marginBottom="-10dp"
+      android:src="@drawable/com_facebook_tooltip_blue_topnub"
+      />
+  <ImageView
+      android:id="@+id/com_facebook_tooltip_bubble_view_bottom_pointer"
+      android:layout_width="wrap_content"
+      android:layout_height="wrap_content"
+      android:layout_gravity="center_horizontal|bottom"
+      android:layout_centerHorizontal="true"
+      android:layout_below="@id/com_facebook_body_frame"
+      android:layout_marginTop="-13dp"
+      android:src="@drawable/com_facebook_tooltip_blue_bottomnub"
+      />
+</RelativeLayout>
diff --git a/facebook/res/values/strings.xml b/facebook/res/values/strings.xml
index 022d85c80..e73d31fc0 100644
--- a/facebook/res/values/strings.xml
+++ b/facebook/res/values/strings.xml
@@ -41,4 +41,5 @@
     <string name="com_facebook_requesterror_password_changed">Your Facebook password has changed. Please log into this app again to reconnect your Facebook account.</string>
     <string name="com_facebook_requesterror_reconnect">Please log into this app again to reconnect your Facebook account.</string>
     <string name="com_facebook_requesterror_permissions">This app doesn’t have permission to do this. To change permissions, try logging into the app again.</string>
+    <string name="com_facebook_tooltip_default">New! You\'re in control - choose what info you want to share with apps.</string>
 </resources>
diff --git a/facebook/res/values/styles.xml b/facebook/res/values/styles.xml
index aafc79431..926b60346 100644
--- a/facebook/res/values/styles.xml
+++ b/facebook/res/values/styles.xml
@@ -35,6 +35,8 @@
     <dimen name="com_facebook_profilepictureview_preset_size_small">50dp</dimen>
     <dimen name="com_facebook_profilepictureview_preset_size_normal">100dp</dimen>
     <dimen name="com_facebook_profilepictureview_preset_size_large">180dp</dimen>
+    
+    <dimen name="com_facebook_tooltip_horizontal_padding">10dp</dimen>
 
     <style name="com_facebook_loginview_default_style" parent="@android:style/Widget.Button">
         <item name="android:layout_width">wrap_content</item>
@@ -56,4 +58,13 @@
         <item name="android:textColor">#4B5164</item>
         <item name="android:gravity">center</item>
     </style>
+    
+    <style name="tooltip_bubble_text">
+	    <item name="android:textColor">@android:color/white</item>
+	    <item name="android:gravity">left</item>
+	    <item name="android:textSize">12sp</item>
+	    <item name="android:shadowDy">-1</item>
+	    <item name="android:shadowRadius">0.25</item>
+	    <item name="android:shadowColor">#40000000</item>
+    </style>
 </resources>
diff --git a/facebook/src/com/facebook/AccessToken.java b/facebook/src/com/facebook/AccessToken.java
index 374a2b498..bb6693929 100644
--- a/facebook/src/com/facebook/AccessToken.java
+++ b/facebook/src/com/facebook/AccessToken.java
@@ -28,6 +28,7 @@
 import java.io.ObjectInputStream;
 import java.io.Serializable;
 import java.util.ArrayList;
+import java.util.Arrays;
 import java.util.Collections;
 import java.util.Date;
 import java.util.List;
@@ -204,6 +205,12 @@ static AccessToken createFromWebBundle(List<String> requestedPermissions, Bundle
         Date expires = getBundleLongAsDate(bundle, EXPIRES_IN_KEY, new Date());
         String token = bundle.getString(ACCESS_TOKEN_KEY);
 
+        // With Login v4, we now get back the actual permissions granted, so update the permissions to be the real thing
+        String grantedPermissions = bundle.getString("granted_scopes");
+        if (!Utility.isNullOrEmpty(grantedPermissions)) {
+            requestedPermissions =  new ArrayList<String>(Arrays.asList(grantedPermissions.split(",")));
+        }
+
         return createNew(requestedPermissions, token, expires, source);
     }
 
diff --git a/facebook/src/com/facebook/AppEventsLogger.java b/facebook/src/com/facebook/AppEventsLogger.java
index 7fe715cd2..20e4c24a8 100644
--- a/facebook/src/com/facebook/AppEventsLogger.java
+++ b/facebook/src/com/facebook/AppEventsLogger.java
@@ -91,7 +91,7 @@
  * </li>
  * <li>
  * There is a limit to the number of unique parameter names in the provided parameters that can
- * be used per event, on the order of 10.  This is not just for an individual call, but for all
+ * be used per event, on the order of 25.  This is not just for an individual call, but for all
  * invocations for that eventName.
  * </li>
  * <li>
diff --git a/facebook/src/com/facebook/AuthorizationClient.java b/facebook/src/com/facebook/AuthorizationClient.java
index cbd308add..5de41dd88 100644
--- a/facebook/src/com/facebook/AuthorizationClient.java
+++ b/facebook/src/com/facebook/AuthorizationClient.java
@@ -31,9 +31,6 @@
 import com.facebook.internal.NativeProtocol;
 import com.facebook.internal.ServerProtocol;
 import com.facebook.internal.Utility;
-import com.facebook.model.GraphMultiResult;
-import com.facebook.model.GraphObject;
-import com.facebook.model.GraphObjectList;
 import com.facebook.model.GraphUser;
 import com.facebook.widget.WebDialog;
 import org.json.JSONException;
@@ -192,7 +189,6 @@ boolean onActivityResult(int requestCode, int resultCode, Intent data) {
         if (behavior.allowsKatanaAuth()) {
             if (!request.isLegacy()) {
                 handlers.add(new GetTokenAuthHandler());
-                handlers.add(new KatanaLoginDialogAuthHandler());
             }
             handlers.add(new KatanaProxyAuthHandler());
         }
@@ -393,15 +389,9 @@ public void onCompleted(Response response) {
             @Override
             public void onCompleted(Response response) {
                 try {
-                    GraphMultiResult result = response.getGraphObjectAs(GraphMultiResult.class);
-                    if (result != null) {
-                        GraphObjectList<GraphObject> data = result.getData();
-                        if (data != null && data.size() == 1) {
-                            GraphObject permissions = data.get(0);
-
-                            // The keys are the permission names.
-                            tokenPermissions.addAll(permissions.asMap().keySet());
-                        }
+                    List<String> permissions = Session.handlePermissionResponse(null, response);
+                    if (permissions != null) {
+                        tokenPermissions.addAll(permissions);
                     }
                 } catch (Exception ex) {
                 }
@@ -441,7 +431,6 @@ public void onBatchCompleted(RequestBatch batch) {
 
     Request createGetPermissionsRequest(String accessToken) {
         Bundle parameters = new Bundle();
-        parameters.putString("fields", "id");
         parameters.putString("access_token", accessToken);
         return new Request(null, "me/permissions", parameters, HttpMethod.GET, null);
     }
@@ -631,6 +620,7 @@ public void onComplete(Bundle values, FacebookException error) {
             WebDialog.Builder builder =
                     new AuthDialogBuilder(getStartActivityDelegate().getActivityContext(), applicationId, parameters)
                             .setE2E(e2e)
+                            .setIsRerequest(request.isRerequest())
                             .setOnCompleteListener(listener);
             loginDialog = builder.build();
             loginDialog.show();
@@ -803,119 +793,6 @@ protected boolean tryIntent(Intent intent, int requestCode) {
         }
     }
 
-    class KatanaLoginDialogAuthHandler extends KatanaAuthHandler {
-        private static final long serialVersionUID = 1L;
-        private String applicationId;
-        private String callId;
-
-        @Override
-        String getNameForLogging() {
-            return "katana_login_dialog";
-        }
-
-        @Override
-        boolean tryAuthorize(AuthorizationRequest request) {
-            applicationId = request.getApplicationId();
-
-            Intent intent = NativeProtocol.createLoginDialog20121101Intent(context, request.getApplicationId(),
-                    new ArrayList<String>(request.getPermissions()),
-                    request.getDefaultAudience().getNativeProtocolAudience());
-            if (intent == null) {
-                return false;
-            }
-
-            callId = intent.getStringExtra(NativeProtocol.EXTRA_PROTOCOL_CALL_ID);
-
-            addLoggingExtra(EVENT_EXTRAS_APP_CALL_ID, callId);
-            addLoggingExtra(EVENT_EXTRAS_PROTOCOL_VERSION,
-                    intent.getIntExtra(NativeProtocol.EXTRA_PROTOCOL_VERSION, 0));
-            addLoggingExtra(EVENT_EXTRAS_PERMISSIONS,
-                    TextUtils.join(",", intent.getStringArrayListExtra(NativeProtocol.EXTRA_PERMISSIONS)));
-            addLoggingExtra(EVENT_EXTRAS_WRITE_PRIVACY, intent.getStringExtra(NativeProtocol.EXTRA_WRITE_PRIVACY));
-            logEvent(AnalyticsEvents.EVENT_NATIVE_LOGIN_DIALOG_START,
-                    AnalyticsEvents.PARAMETER_NATIVE_LOGIN_DIALOG_START_TIME, callId);
-
-            return tryIntent(intent, request.getRequestCode());
-        }
-
-        @Override
-        boolean onActivityResult(int requestCode, int resultCode, Intent data) {
-            Result outcome;
-
-            logEvent(AnalyticsEvents.EVENT_NATIVE_LOGIN_DIALOG_COMPLETE,
-                    AnalyticsEvents.PARAMETER_NATIVE_LOGIN_DIALOG_COMPLETE_TIME, callId);
-
-            if (data == null) {
-                // This happens if the user presses 'Back'.
-                outcome = Result.createCancelResult(pendingRequest, "Operation canceled");
-            } else if (NativeProtocol.isServiceDisabledResult20121101(data)) {
-                outcome = null;
-            } else if (resultCode == Activity.RESULT_CANCELED) {
-                outcome = createCancelOrErrorResult(pendingRequest, data);
-            } else if (resultCode != Activity.RESULT_OK) {
-                outcome = Result.createErrorResult(pendingRequest, "Unexpected resultCode from authorization.", null);
-            } else {
-                outcome = handleResultOk(data);
-            }
-
-            if (outcome != null) {
-                completeAndValidate(outcome);
-            } else {
-                tryNextHandler();
-            }
-
-            return true;
-        }
-
-        private Result handleResultOk(Intent data) {
-            Bundle extras = data.getExtras();
-            String errorType = extras.getString(NativeProtocol.STATUS_ERROR_TYPE);
-            if (errorType == null) {
-                return Result.createTokenResult(pendingRequest,
-                        AccessToken.createFromNativeLogin(extras, AccessTokenSource.FACEBOOK_APPLICATION_NATIVE));
-            } else if (NativeProtocol.ERROR_SERVICE_DISABLED.equals(errorType)) {
-                addLoggingExtra(EVENT_EXTRAS_SERVICE_DISABLED, AppEventsConstants.EVENT_PARAM_VALUE_YES);
-                return null;
-            } else {
-                return createCancelOrErrorResult(pendingRequest, data);
-            }
-        }
-
-        private Result createCancelOrErrorResult(AuthorizationRequest request, Intent data) {
-            Bundle extras = data.getExtras();
-            String errorType = extras.getString(NativeProtocol.STATUS_ERROR_TYPE);
-
-            if (NativeProtocol.ERROR_USER_CANCELED.equals(errorType) ||
-                    NativeProtocol.ERROR_PERMISSION_DENIED.equals(errorType)) {
-                return Result.createCancelResult(request, data.getStringExtra(NativeProtocol.STATUS_ERROR_DESCRIPTION));
-            } else {
-                // See if we can get an error code out of the JSON.
-                String errorJson = extras.getString(NativeProtocol.STATUS_ERROR_JSON);
-                String errorCode = null;
-                if (errorJson != null) {
-                    try {
-                        JSONObject jsonObject = new JSONObject(errorJson);
-                        errorCode = jsonObject.getString("error_code");
-                    } catch (JSONException e) {
-                    }
-                }
-                return Result.createErrorResult(request, errorType,
-                        data.getStringExtra(NativeProtocol.STATUS_ERROR_DESCRIPTION), errorCode);
-            }
-        }
-
-        private void logEvent(String eventName, String timeParameter, String callId) {
-            if (callId != null) {
-                AppEventsLogger appEventsLogger = AppEventsLogger.newLogger(context, applicationId);
-                Bundle parameters = new Bundle();
-                parameters.putString(AnalyticsEvents.PARAMETER_APP_ID, applicationId);
-                parameters.putString(AnalyticsEvents.PARAMETER_ACTION_ID, callId);
-                parameters.putLong(timeParameter, System.currentTimeMillis());
-                appEventsLogger.logSdkEvent(eventName, null, parameters);
-            }
-        }
-    }
-
     class KatanaProxyAuthHandler extends KatanaAuthHandler {
         private static final long serialVersionUID = 1L;
         private String applicationId;
@@ -931,7 +808,7 @@ boolean tryAuthorize(AuthorizationRequest request) {
 
             String e2e = getE2E();
             Intent intent = NativeProtocol.createProxyAuthIntent(context, request.getApplicationId(),
-                    request.getPermissions(), e2e);
+                    request.getPermissions(), e2e, request.isRerequest());
 
             addLoggingExtra(ServerProtocol.DIALOG_PARAM_E2E, e2e);
 
@@ -1017,6 +894,7 @@ private void logWebLoginCompleted(String applicationId, String e2e) {
         private static final String OAUTH_DIALOG = "oauth";
         static final String REDIRECT_URI = "fbconnect://success";
         private String e2e;
+        private boolean isRerequest;
 
         public AuthDialogBuilder(Context context, String applicationId, Bundle parameters) {
             super(context, applicationId, OAUTH_DIALOG, parameters);
@@ -1027,12 +905,24 @@ public AuthDialogBuilder setE2E(String e2e) {
             return this;
         }
 
+        public AuthDialogBuilder setIsRerequest(boolean isRerequest) {
+            this.isRerequest = isRerequest;
+            return this;
+        }
+
         @Override
         public WebDialog build() {
             Bundle parameters = getParameters();
             parameters.putString(ServerProtocol.DIALOG_PARAM_REDIRECT_URI, REDIRECT_URI);
             parameters.putString(ServerProtocol.DIALOG_PARAM_CLIENT_ID, getApplicationId());
             parameters.putString(ServerProtocol.DIALOG_PARAM_E2E, e2e);
+            parameters.putString(ServerProtocol.DIALOG_PARAM_RESPONSE_TYPE, ServerProtocol.DIALOG_RESPONSE_TYPE_TOKEN);
+            parameters.putString(ServerProtocol.DIALOG_PARAM_RETURN_SCOPES, ServerProtocol.DIALOG_RETURN_SCOPES_TRUE);
+
+            // Only set the rerequest auth type for non legacy requests
+            if (isRerequest && !Settings.getPlatformCompatibilityEnabled()) {
+                parameters.putString(ServerProtocol.DIALOG_PARAM_AUTH_TYPE, ServerProtocol.DIALOG_REREQUEST_AUTH_TYPE);
+            }
 
             return new WebDialog(getContext(), OAUTH_DIALOG, parameters, getTheme(), getListener());
         }
@@ -1050,6 +940,7 @@ public WebDialog build() {
         private final String applicationId;
         private final String previousAccessToken;
         private final String authId;
+        private boolean isRerequest = false;
 
         AuthorizationRequest(SessionLoginBehavior loginBehavior, int requestCode, boolean isLegacy,
                 List<String> permissions, SessionDefaultAudience defaultAudience, String applicationId,
@@ -1063,7 +954,6 @@ public WebDialog build() {
             this.previousAccessToken = validateSameFbidAsToken;
             this.startActivityDelegate = startActivityDelegate;
             this.authId = authId;
-
         }
 
         StartActivityDelegate getStartActivityDelegate() {
@@ -1113,6 +1003,14 @@ boolean needsNewTokenValidation() {
         String getAuthId() {
             return authId;
         }
+
+        boolean isRerequest() {
+            return isRerequest;
+        }
+
+        void setRerequest(boolean isRerequest) {
+            this.isRerequest = isRerequest;
+        }
     }
 
 
diff --git a/facebook/src/com/facebook/FacebookAppLinkResolver.java b/facebook/src/com/facebook/FacebookAppLinkResolver.java
new file mode 100644
index 000000000..e05e05f99
--- /dev/null
+++ b/facebook/src/com/facebook/FacebookAppLinkResolver.java
@@ -0,0 +1,234 @@
+/**
+ * Copyright 2010-present Facebook.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.facebook;
+
+import android.net.Uri;
+import android.os.Bundle;
+import bolts.AppLink;
+import bolts.AppLinkResolver;
+import bolts.Continuation;
+import bolts.Task;
+import com.facebook.model.GraphObject;
+import org.json.JSONArray;
+import org.json.JSONException;
+import org.json.JSONObject;
+
+import java.util.*;
+
+/**
+ * Provides an implementation for the {@link AppLinkResolver AppLinkResolver} interface that uses the Facebook App Link
+ * index to solve App Links, given a Url. It also provides an additional helper method that can resolve multiple App
+ * Links in a single call.
+ */
+public class FacebookAppLinkResolver implements AppLinkResolver {
+
+    private static final String APP_LINK_ANDROID_TARGET_KEY = "android";
+    private static final String APP_LINK_WEB_TARGET_KEY = "web";
+    private static final String APP_LINK_TARGET_PACKAGE_KEY = "package";
+    private static final String APP_LINK_TARGET_CLASS_KEY = "class";
+    private static final String APP_LINK_TARGET_APP_NAME_KEY = "app_name";
+    private static final String APP_LINK_TARGET_URL_KEY = "url";
+    private static final String APP_LINK_TARGET_SHOULD_FALLBACK_KEY = "should_fallback";
+
+    private final HashMap<Uri, AppLink> cachedAppLinks = new HashMap<Uri, AppLink>();
+
+    /**
+     * Asynchronously resolves App Link data for the passed in Uri
+     *
+     * @param uri Uri to be resolved into an App Link
+     * @return A Task that, when successful, will return an AppLink for the passed in Uri. This may be null if no App
+     * Link data was found for this Uri.
+     * In the case of general server errors, the task will be completed with the corresponding error.
+     */
+    public Task<AppLink> getAppLinkFromUrlInBackground(final Uri uri) {
+        ArrayList<Uri> uris = new ArrayList<Uri>();
+        uris.add(uri);
+
+        Task<Map<Uri, AppLink>> resolveTask = getAppLinkFromUrlsInBackground(uris);
+
+        return resolveTask.onSuccess(new Continuation<Map<Uri, AppLink>, AppLink>() {
+            @Override
+            public AppLink then(Task<Map<Uri, AppLink>> resolveUrisTask) throws Exception {
+                return resolveUrisTask.getResult().get(uri);
+            }
+        });
+    }
+
+    /**
+     * Asynchronously resolves App Link data for multiple Urls
+     *
+     * @param uris A list of Uri objects to resolve into App Links
+     * @return A Task that, when successful, will return a Map of Uri->AppLink for each Uri that was successfully
+     * resolved into an App Link. Uris that could not be resolved into App Links will not be present in the Map.
+     * In the case of general server errors, the task will be completed with the corresponding error.
+     */
+    public Task<Map<Uri, AppLink>> getAppLinkFromUrlsInBackground(List<Uri> uris) {
+        final Map<Uri, AppLink> appLinkResults = new HashMap<Uri, AppLink>();
+        final HashSet<Uri> urisToRequest = new HashSet<Uri>();
+        StringBuilder graphRequestFields = new StringBuilder();
+
+        for (Uri uri : uris) {
+            AppLink appLink = null;
+            synchronized (cachedAppLinks) {
+                appLink = cachedAppLinks.get(uri);
+            }
+
+            if (appLink != null) {
+                appLinkResults.put(uri, appLink);
+            } else {
+                if (!urisToRequest.isEmpty()) {
+                    graphRequestFields.append(',');
+                }
+                graphRequestFields.append(uri.toString());
+                urisToRequest.add(uri);
+            }
+        }
+
+        if (urisToRequest.isEmpty()) {
+            return Task.forResult(appLinkResults);
+        }
+
+        final Task<Map<Uri, AppLink>>.TaskCompletionSource taskCompletionSource = Task.create();
+
+        Bundle appLinkRequestParameters = new Bundle();
+        appLinkRequestParameters.putString("type", "al");
+        appLinkRequestParameters.putString("ids", graphRequestFields.toString());
+        appLinkRequestParameters.putString(
+                "fields",
+                String.format("%s,%s", APP_LINK_ANDROID_TARGET_KEY, APP_LINK_WEB_TARGET_KEY));
+
+        Request appLinkRequest = new Request(
+                null, /* Session */
+                "", /* Graph path */
+                appLinkRequestParameters, /* Query parameters */
+                null, /* HttpMethod */
+                new Request.Callback() { /* Callback */
+                    @Override
+                    public void onCompleted(Response response) {
+                        FacebookRequestError error = response.getError();
+                        if (error != null) {
+                            taskCompletionSource.setError(error.getException());
+                            return;
+                        }
+
+                        GraphObject responseObject = response.getGraphObject();
+                        JSONObject responseJson = responseObject != null ? responseObject.getInnerJSONObject() : null;
+                        if (responseJson == null) {
+                            taskCompletionSource.setResult(appLinkResults);
+                            return;
+                        }
+
+                        for (Uri uri : urisToRequest) {
+                            String uriString = uri.toString();
+                            if (!responseJson.has(uriString)) {
+                                continue;
+                            }
+
+                            JSONObject urlData = null;
+                            try {
+                                urlData = responseJson.getJSONObject(uri.toString());
+                                JSONArray rawTargets = urlData.getJSONArray(APP_LINK_ANDROID_TARGET_KEY);
+
+                                int targetsCount = rawTargets.length();
+                                List<AppLink.Target> targets = new ArrayList<AppLink.Target>(targetsCount);
+
+                                for (int i = 0; i < targetsCount; i++) {
+                                    AppLink.Target target = getAndroidTargetFromJson(rawTargets.getJSONObject(i));
+                                    if (target != null) {
+                                        targets.add(target);
+                                    }
+                                }
+
+                                Uri webFallbackUrl = getWebFallbackUriFromJson(uri, urlData);
+                                AppLink appLink = new AppLink(uri, targets, webFallbackUrl);
+
+                                appLinkResults.put(uri, appLink);
+                                synchronized (cachedAppLinks) {
+                                    cachedAppLinks.put(uri, appLink);
+                                }
+                            } catch (JSONException e) {
+                                // The data for this uri was missing or badly formed.
+                                continue;
+                            }
+                        }
+
+                        taskCompletionSource.setResult(appLinkResults);
+                    }
+                });
+
+        appLinkRequest.executeAsync();
+
+        return taskCompletionSource.getTask();
+    }
+
+    private static AppLink.Target getAndroidTargetFromJson(JSONObject targetJson) {
+        String packageName = tryGetStringFromJson(targetJson, APP_LINK_TARGET_PACKAGE_KEY, null);
+        if (packageName == null) {
+            // Package name is mandatory for each Android target
+            return null;
+        }
+        String className = tryGetStringFromJson(targetJson, APP_LINK_TARGET_CLASS_KEY, null);
+        String appName = tryGetStringFromJson(targetJson, APP_LINK_TARGET_APP_NAME_KEY, null);
+        String targetUrlString = tryGetStringFromJson(targetJson, APP_LINK_TARGET_URL_KEY, null);
+        Uri targetUri = null;
+        if (targetUrlString != null) {
+            targetUri = Uri.parse(targetUrlString);
+        }
+
+        return new AppLink.Target(packageName, className, targetUri, appName);
+    }
+
+    private static Uri getWebFallbackUriFromJson(Uri sourceUrl, JSONObject urlData) {
+        // Try and get a web target. This is best effort. Any failures results in null being returned.
+        try {
+            JSONObject webTarget = urlData.getJSONObject(APP_LINK_WEB_TARGET_KEY);
+            boolean shouldFallback = tryGetBooleanFromJson(webTarget, APP_LINK_TARGET_SHOULD_FALLBACK_KEY, true);
+            if (!shouldFallback) {
+                // Don't use a fallback url
+                return null;
+            }
+
+            String webTargetUrlString = tryGetStringFromJson(webTarget, APP_LINK_TARGET_URL_KEY, null);
+            Uri webUri = null;
+            if (webTargetUrlString != null) {
+                webUri = Uri.parse(webTargetUrlString);
+            }
+
+            // If we weren't able to parse a url from the web target, use the source url
+            return webUri != null ? webUri: sourceUrl;
+        } catch (JSONException e) {
+            // If we were missing a web target, just use the source as the web url
+            return sourceUrl;
+        }
+    }
+
+    private static String tryGetStringFromJson(JSONObject json, String propertyName, String defaultValue) {
+        try {
+            return json.getString(propertyName);
+        } catch(JSONException e) {
+            return defaultValue;
+        }
+    }
+
+    private static boolean tryGetBooleanFromJson(JSONObject json, String propertyName, boolean defaultValue) {
+        try {
+            return json.getBoolean(propertyName);
+        } catch (JSONException e) {
+            return defaultValue;
+        }
+    }
+}
diff --git a/facebook/src/com/facebook/FacebookSdkVersion.java b/facebook/src/com/facebook/FacebookSdkVersion.java
index 92ad5c99d..0a8e7b9bf 100644
--- a/facebook/src/com/facebook/FacebookSdkVersion.java
+++ b/facebook/src/com/facebook/FacebookSdkVersion.java
@@ -17,6 +17,5 @@
 package com.facebook;
 
 final class FacebookSdkVersion {
-    public static final String BUILD = "3.8.0";
-    public static final String MIGRATION_BUNDLE = "fbsdk:20131203";
+    public static final String BUILD = "3.14.0";
 }
diff --git a/facebook/src/com/facebook/Request.java b/facebook/src/com/facebook/Request.java
index b69d6b8fa..e604a44a3 100644
--- a/facebook/src/com/facebook/Request.java
+++ b/facebook/src/com/facebook/Request.java
@@ -22,6 +22,7 @@
 import android.net.Uri;
 import android.os.*;
 import android.text.TextUtils;
+import android.util.Log;
 import android.util.Pair;
 import com.facebook.internal.*;
 import com.facebook.model.*;
@@ -37,6 +38,8 @@
 import java.text.SimpleDateFormat;
 import java.util.*;
 import java.util.Map.Entry;
+import java.util.regex.Matcher;
+import java.util.regex.Pattern;
 
 /**
  * A single request to be sent to the Facebook Platform through either the <a
@@ -65,6 +68,8 @@
      */
     public static final int MAXIMUM_BATCH_SIZE = 50;
 
+    public static final String TAG = Request.class.getSimpleName();
+
     private static final String ME = "me";
     private static final String MY_FRIENDS = "me/friends";
     private static final String MY_PHOTOS = "me/photos";
@@ -79,6 +84,7 @@
     private static final String USER_AGENT_BASE = "FBAndroidSDK";
     private static final String USER_AGENT_HEADER = "User-Agent";
     private static final String CONTENT_TYPE_HEADER = "Content-Type";
+    private static final String ACCEPT_LANGUAGE_HEADER = "Accept-Language";
 
     // Parameter names/values
     private static final String PICTURE_PARAM = "picture";
@@ -97,7 +103,6 @@
     private static final String BATCH_PARAM = "batch";
     private static final String ATTACHMENT_FILENAME_PREFIX = "file";
     private static final String ATTACHED_FILES_PARAM = "attached_files";
-    private static final String MIGRATION_BUNDLE_PARAM = "migration_bundle";
     private static final String ISO_8601_FORMAT_STRING = "yyyy-MM-dd'T'HH:mm:ssZ";
     private static final String STAGING_PARAM = "file";
     private static final String OBJECT_PARAM = "object";
@@ -106,6 +111,8 @@
 
     private static String defaultBatchApplicationId;
 
+    private static Pattern versionPattern = Pattern.compile("^v\\d+\\.\\d+/.*");
+
     private Session session;
     private HttpMethod httpMethod;
     private String graphPath;
@@ -118,6 +125,7 @@
     private Callback callback;
     private String overriddenURL;
     private Object tag;
+    private String version;
 
     /**
      * Constructs a request without a session, graph path, or any other parameters.
@@ -184,9 +192,36 @@ public Request(Session session, String graphPath, Bundle parameters, HttpMethod
      *            a callback that will be called when the request is completed to handle success or error conditions
      */
     public Request(Session session, String graphPath, Bundle parameters, HttpMethod httpMethod, Callback callback) {
+        this(session, graphPath, parameters, httpMethod, callback, null);
+    }
+
+    /**
+     * Constructs a request with a specific Session, graph path, parameters, and HTTP method. A Session need not be
+     * provided, in which case the request is sent without an access token and thus is not executed in the context of
+     * any particular user. Only certain graph requests can be expected to succeed in this case. If a Session is
+     * provided, it must be in an opened state or the request will fail.
+     *
+     * Depending on the httpMethod parameter, the object at the graph path may be retrieved, created, or deleted.
+     *
+     * @param session
+     *            the Session to use, or null
+     * @param graphPath
+     *            the graph path to retrieve, create, or delete
+     * @param parameters
+     *            additional parameters to pass along with the Graph API request; parameters must be Strings, Numbers,
+     *            Bitmaps, Dates, or Byte arrays.
+     * @param httpMethod
+     *            the {@link HttpMethod} to use for the request, or null for default (HttpMethod.GET)
+     * @param callback
+     *            a callback that will be called when the request is completed to handle success or error conditions
+     * @param version
+     *            the version of the Graph API
+     */
+    public Request(Session session, String graphPath, Bundle parameters, HttpMethod httpMethod, Callback callback, String version) {
         this.session = session;
         this.graphPath = graphPath;
         this.callback = callback;
+        this.version = version;
 
         setHttpMethod(httpMethod);
 
@@ -196,8 +231,8 @@ public Request(Session session, String graphPath, Bundle parameters, HttpMethod
             this.parameters = new Bundle();
         }
 
-        if (!this.parameters.containsKey(MIGRATION_BUNDLE_PARAM)) {
-            this.parameters.putString(MIGRATION_BUNDLE_PARAM, FacebookSdkVersion.MIGRATION_BUNDLE);
+        if (this.version == null) {
+            this.version = ServerProtocol.getAPIVersion();
         }
     }
 
@@ -870,6 +905,26 @@ public final void setHttpMethod(HttpMethod httpMethod) {
         this.httpMethod = (httpMethod != null) ? httpMethod : HttpMethod.GET;
     }
 
+    /**
+     * Returns the version of the API that this request will use.  By default this is the current API at the time
+     * the SDK is released.
+     *
+     * @return the version that this request will use
+     */
+    public final String getVersion() {
+        return this.version;
+    }
+
+    /**
+     * Set the version to use for this request.  By default the version will be the current API at the time the SDK
+     * is released.  Only use this if you need to explicitly override.
+     *
+     * @param version The version to use.  Should look like "v2.0"
+     */
+    public final void setVersion(String version) {
+        this.version = version;
+    }
+
     /**
      * Returns the parameters for this request.
      *
@@ -1694,6 +1749,7 @@ static HttpURLConnection createConnection(URL url) throws IOException {
 
         connection.setRequestProperty(USER_AGENT_HEADER, getUserAgent());
         connection.setRequestProperty(CONTENT_TYPE_HEADER, getMimeContentType());
+        connection.setRequestProperty(ACCEPT_LANGUAGE_HEADER, Locale.getDefault().toString());
 
         connection.setChunkedStreamingMode(0);
         return connection;
@@ -1709,6 +1765,16 @@ private void addCommonParameters() {
                 Logger.registerAccessToken(accessToken);
                 this.parameters.putString(ACCESS_TOKEN_PARAM, accessToken);
             }
+        } else if (!this.parameters.containsKey(ACCESS_TOKEN_PARAM)) {
+            String appID = Settings.getApplicationId();
+            String clientToken = Settings.getClientToken();
+            if (!Utility.isNullOrEmpty(appID) && !Utility.isNullOrEmpty(clientToken)) {
+                String accessToken = appID + "|" + clientToken;
+                this.parameters.putString(ACCESS_TOKEN_PARAM, accessToken);
+            } else {
+                Log.d(TAG,
+                        "Warning: Sessionless Request needs token but missing either application ID or client token.");
+            }
         }
         this.parameters.putString(SDK_PARAM, SDK_ANDROID);
         this.parameters.putString(FORMAT_PARAM, FORMAT_JSON);
@@ -1748,9 +1814,9 @@ final String getUrlForBatchedRequest() {
 
         String baseUrl;
         if (this.restMethod != null) {
-            baseUrl = ServerProtocol.BATCHED_REST_METHOD_URL_BASE + this.restMethod;
+            baseUrl = getRestPathWithVersion();
         } else {
-            baseUrl = this.graphPath;
+            baseUrl = getGraphPathWithVersion();
         }
 
         addCommonParameters();
@@ -1764,19 +1830,37 @@ final String getUrlForSingleRequest() {
 
         String baseUrl;
         if (this.restMethod != null) {
-            baseUrl = String.format("%s/%s", ServerProtocol.getRestUrlBase(), restMethod);
+            baseUrl = String.format("%s/%s", ServerProtocol.getRestUrlBase(), getRestPathWithVersion());
         } else {
+            String graphBaseUrlBase;
             if (this.getHttpMethod() == HttpMethod.POST && graphPath != null && graphPath.endsWith(VIDEOS_SUFFIX)) {
-                baseUrl = String.format("%s/%s", ServerProtocol.getGraphVideoUrlBase(), graphPath);
+                graphBaseUrlBase = ServerProtocol.getGraphVideoUrlBase();
             } else {
-                baseUrl = String.format("%s/%s", ServerProtocol.getGraphUrlBase(), graphPath);
+                graphBaseUrlBase = ServerProtocol.getGraphUrlBase();
             }
+            baseUrl = String.format("%s/%s", graphBaseUrlBase, getGraphPathWithVersion());
         }
 
         addCommonParameters();
         return appendParametersToBaseUrl(baseUrl);
     }
 
+    private String getGraphPathWithVersion() {
+        Matcher matcher = versionPattern.matcher(this.graphPath);
+        if (matcher.matches()) {
+            return this.graphPath;
+        }
+        return String.format("%s/%s", this.version, this.graphPath);
+    }
+
+    private String getRestPathWithVersion() {
+        Matcher matcher = versionPattern.matcher(this.restMethod);
+        if (matcher.matches()) {
+            return this.restMethod;
+        }
+        return String.format("%s/%s/%s", this.version, ServerProtocol.REST_METHOD_BASE, this.restMethod);
+    }
+
     private static class Attachment {
         private final Request request;
         private final Object value;
diff --git a/facebook/src/com/facebook/Response.java b/facebook/src/com/facebook/Response.java
index 4697aaf12..a5e408d88 100644
--- a/facebook/src/com/facebook/Response.java
+++ b/facebook/src/com/facebook/Response.java
@@ -42,6 +42,7 @@
     private final GraphObjectList<GraphObject> graphObjectList;
     private final boolean isFromCache;
     private final FacebookRequestError error;
+    private final String rawResponse;
     private final Request request;
 
     /**
@@ -61,31 +62,26 @@
     private static final String RESPONSE_CACHE_TAG = "ResponseCache";
     private static FileLruCache responseCache;
 
-    Response(Request request, HttpURLConnection connection, GraphObject graphObject, boolean isFromCache) {
-        this.request = request;
-        this.connection = connection;
-        this.graphObject = graphObject;
-        this.graphObjectList = null;
-        this.isFromCache = isFromCache;
-        this.error = null;
+    Response(Request request, HttpURLConnection connection, String rawResponse, GraphObject graphObject, boolean isFromCache) {
+        this(request, connection, rawResponse, graphObject, null, isFromCache, null);
     }
 
-    Response(Request request, HttpURLConnection connection, GraphObjectList<GraphObject> graphObjects,
+    Response(Request request, HttpURLConnection connection, String rawResponse, GraphObjectList<GraphObject> graphObjects,
             boolean isFromCache) {
-        this.request = request;
-        this.connection = connection;
-        this.graphObject = null;
-        this.graphObjectList = graphObjects;
-        this.isFromCache = isFromCache;
-        this.error = null;
+        this(request, connection, rawResponse, null, graphObjects, isFromCache, null);
     }
 
     Response(Request request, HttpURLConnection connection, FacebookRequestError error) {
+        this(request, connection, null, null, null, false, error);
+    }
+
+    Response(Request request, HttpURLConnection connection, String rawResponse, GraphObject graphObject, GraphObjectList<GraphObject> graphObjects, boolean isFromCache, FacebookRequestError error) {
         this.request = request;
         this.connection = connection;
-        this.graphObject = null;
-        this.graphObjectList = null;
-        this.isFromCache = false;
+        this.rawResponse = rawResponse;
+        this.graphObject = graphObject;
+        this.graphObjectList = graphObjects;
+        this.isFromCache = isFromCache;
         this.error = error;
     }
 
@@ -166,6 +162,15 @@ public Request getRequest() {
         return request;
     }
 
+    /**
+     * Returns the server response as a String that this response is for.
+     *
+     * @return A String representation of the actual response from the server
+     */
+    public String getRawResponse() {
+        return rawResponse;
+    }
+
     /**
      * Indicates whether paging is being done forward or backward.
      */
@@ -425,18 +430,18 @@ private static Response createResponseFromObject(Request request, HttpURLConnect
 
             if (body instanceof JSONObject) {
                 GraphObject graphObject = GraphObject.Factory.create((JSONObject) body);
-                return new Response(request, connection, graphObject, isFromCache);
+                return new Response(request, connection, body.toString(), graphObject, isFromCache);
             } else if (body instanceof JSONArray) {
                 GraphObjectList<GraphObject> graphObjectList = GraphObject.Factory.createList(
                         (JSONArray) body, GraphObject.class);
-                return new Response(request, connection, graphObjectList, isFromCache);
+                return new Response(request, connection, body.toString(), graphObjectList, isFromCache);
             }
             // We didn't get a body we understand how to handle, so pretend we got nothing.
             object = JSONObject.NULL;
         }
 
         if (object == JSONObject.NULL) {
-            return new Response(request, connection, (GraphObject)null, isFromCache);
+            return new Response(request, connection, object.toString(), (GraphObject)null, isFromCache);
         } else {
             throw new FacebookException("Got unexpected object type in response, class: "
                     + object.getClass().getSimpleName());
diff --git a/facebook/src/com/facebook/Session.java b/facebook/src/com/facebook/Session.java
index 64fe3a292..2e01ce699 100644
--- a/facebook/src/com/facebook/Session.java
+++ b/facebook/src/com/facebook/Session.java
@@ -25,6 +25,9 @@
 import android.text.TextUtils;
 import android.util.Log;
 import com.facebook.internal.*;
+import com.facebook.model.GraphMultiResult;
+import com.facebook.model.GraphObject;
+import com.facebook.model.GraphObjectList;
 import org.json.JSONException;
 import org.json.JSONObject;
 
@@ -107,13 +110,6 @@
      */
     public static final String ACTION_ACTIVE_SESSION_CLOSED = "com.facebook.sdk.ACTIVE_SESSION_CLOSED";
 
-    /**
-     * Session takes application id as a constructor parameter. If this is null,
-     * Session will attempt to load the application id from
-     * application/meta-data using this String as the key.
-     */
-    public static final String APPLICATION_ID_PROPERTY = "com.facebook.sdk.ApplicationId";
-
     private static final Object STATIC_LOCK = new Object();
     private static Session activeSession;
     private static volatile Context staticContext;
@@ -128,6 +124,8 @@
     private static final String PUBLISH_PERMISSION_PREFIX = "publish";
     private static final String MANAGE_PERMISSION_PREFIX = "manage";
 
+    private static final String BASIC_INFO_PERMISSION = "basic_info";
+
     @SuppressWarnings("serial")
     private static final Set<String> OTHER_PUBLISH_PERMISSIONS = new HashSet<String>() {{
         add("ads_management");
@@ -143,6 +141,8 @@
     private AuthorizationRequest pendingAuthorizationRequest;
     private AuthorizationClient authorizationClient;
 
+    private Set<String> requestedPermissions = new HashSet<String>();
+
     // The following are not serialized with the Session object
     private volatile Bundle authorizationBundle;
     private final List<StatusCallback> callbacks;
@@ -186,6 +186,41 @@ private Object readResolve() {
         }
     }
 
+    /**
+     * Serialization proxy for the Session class. This is version 2 of
+     * serialization. Future serializations may differ in format. This
+     * class should not be modified. If serializations formats change,
+     * create a new class SerializationProxyVx.
+     */
+    private static class SerializationProxyV2 implements Serializable {
+        private static final long serialVersionUID = 7663436173185080064L;
+        private final String applicationId;
+        private final SessionState state;
+        private final AccessToken tokenInfo;
+        private final Date lastAttemptedTokenExtendDate;
+        private final boolean shouldAutoPublish;
+        private final AuthorizationRequest pendingAuthorizationRequest;
+        private final Set<String> requestedPermissions;
+
+        SerializationProxyV2(String applicationId, SessionState state,
+                             AccessToken tokenInfo, Date lastAttemptedTokenExtendDate,
+                             boolean shouldAutoPublish, AuthorizationRequest pendingAuthorizationRequest,
+                             Set<String> requestedPermissions) {
+            this.applicationId = applicationId;
+            this.state = state;
+            this.tokenInfo = tokenInfo;
+            this.lastAttemptedTokenExtendDate = lastAttemptedTokenExtendDate;
+            this.shouldAutoPublish = shouldAutoPublish;
+            this.pendingAuthorizationRequest = pendingAuthorizationRequest;
+            this.requestedPermissions = requestedPermissions;
+        }
+
+        private Object readResolve() {
+            return new Session(applicationId, state, tokenInfo,
+                    lastAttemptedTokenExtendDate, shouldAutoPublish, pendingAuthorizationRequest, requestedPermissions);
+        }
+    }
+
     /**
      * Used by version 1 of the serialization proxy, do not modify.
      */
@@ -203,6 +238,25 @@ private Session(String applicationId, SessionState state,
         callbacks = new ArrayList<StatusCallback>();
     }
 
+    /**
+     * Used by version 2 of the serialization proxy, do not modify.
+     */
+    private Session(String applicationId, SessionState state,
+                    AccessToken tokenInfo, Date lastAttemptedTokenExtendDate,
+                    boolean shouldAutoPublish, AuthorizationRequest pendingAuthorizationRequest,
+                    Set<String> requestedPermissions) {
+        this.applicationId = applicationId;
+        this.state = state;
+        this.tokenInfo = tokenInfo;
+        this.lastAttemptedTokenExtendDate = lastAttemptedTokenExtendDate;
+        this.pendingAuthorizationRequest = pendingAuthorizationRequest;
+        this.requestedPermissions = requestedPermissions;
+        handler = new Handler(Looper.getMainLooper());
+        currentTokenRefreshRequest = null;
+        tokenCachingStrategy = null;
+        callbacks = new ArrayList<StatusCallback>();
+    }
+
     /**
      * Initializes a new Session with the specified context.
      *
@@ -358,6 +412,48 @@ public final Date getExpirationDate() {
         }
     }
 
+    /**
+     * <p>
+     *     Returns whether a particular permission has been granted
+     * </p>
+     *
+     * @param permission The permission to check for
+     * @return true if the permission is granted, false otherwise
+     */
+    public boolean isPermissionGranted(String permission) {
+        List<String> grantedPermissions = getPermissions();
+        if (grantedPermissions != null) {
+            return grantedPermissions.contains(permission);
+        }
+        return false;
+    }
+
+    /**
+     * <p>
+     * Returns the list of permissions that have been requested in this session but not granted
+     * </p>
+     *
+     * @return the list of requested permissions that have been declined
+     */
+    public final List<String> getDeclinedPermissions() {
+        synchronized (this.lock) {
+            List<String> grantedPermissions = getPermissions();
+            List<String> declinedPermissions = new ArrayList<String>(requestedPermissions);
+            if (grantedPermissions != null) {
+                boolean removedBasicInfo = false;
+                for (String permission : grantedPermissions) {
+                    declinedPermissions.remove(permission);
+                    // We can remove "basic_info" permission if we have any granted permissions
+                    if (!removedBasicInfo && requestedPermissions.contains(BASIC_INFO_PERMISSION)) {
+                        declinedPermissions.remove(BASIC_INFO_PERMISSION);
+                        removedBasicInfo = true;
+                    }
+                }
+            }
+            return declinedPermissions;
+        }
+    }
+
     /**
      * <p>
      * Logs a user in to Facebook.
@@ -512,6 +608,91 @@ public final void requestNewPublishPermissions(NewPermissionsRequest newPermissi
         requestNewPermissions(newPermissionsRequest, SessionAuthorizationType.PUBLISH);
     }
 
+    /**
+     * <p>
+     * Issues a request to refresh the permissions on the session.
+     * </p>
+     * <p>
+     * If successful, this will update the permissions and call the app back with
+     * {@link SessionState#OPENED_TOKEN_UPDATED}.  The session can then be queried to see the granted and declined
+     * permissions.  If this fails because the user has removed the app, the session will close.
+     * </p>
+     */
+    public final void refreshPermissions() {
+        Request request = new Request(this, "me/permissions");
+        request.setCallback(new Request.Callback() {
+            @Override
+            public void onCompleted(Response response) {
+                List<String> grantedPermissions = handlePermissionResponse(Session.this, response);
+                if (grantedPermissions != null) {
+                    // Update our token with the refreshed permissions
+                    synchronized (lock) {
+                        tokenInfo = AccessToken.createFromTokenWithRefreshedPermissions(tokenInfo, grantedPermissions);
+                        postStateChange(state, SessionState.OPENED_TOKEN_UPDATED, null);
+                    }
+                }
+            }
+        });
+        request.executeAsync();
+    }
+
+    /**
+     * This parses a server response to a call to me/permissions.  It will return the list of granted permissions.
+     * It will optionally update a session with the requested permissions.  It also handles the distinction between
+     * 1.0 and 2.0 calls to the endpoint.
+     *
+     * @param session An optional session to update the requested permission set
+     * @param response The server response
+     * @return A list of granted permissions or null if an error
+     */
+    static List<String> handlePermissionResponse(Session session, Response response) {
+        if (response.getError() != null) {
+            return null;
+        }
+
+        GraphMultiResult result = response.getGraphObjectAs(GraphMultiResult.class);
+        if (result == null) {
+            return null;
+        }
+
+        GraphObjectList<GraphObject> data = result.getData();
+        if (data == null || data.size() == 0) {
+            return null;
+        }
+        List<String> allPermissions = new ArrayList<String>(data.size());
+        List<String> grantedPermissions = new ArrayList<String>(data.size());
+
+        // Check if we are dealing with v2.0 or v1.0 behavior until the server is updated
+        GraphObject firstObject = data.get(0);
+        if (firstObject.getProperty("permission") != null) { // v2.0
+            for (GraphObject graphObject : data) {
+                String permission = (String) graphObject.getProperty("permission");
+                String status = (String) graphObject.getProperty("status");
+                allPermissions.add(permission);
+                if(status.equals("granted")) {
+                    grantedPermissions.add(permission);
+                }
+            }
+        } else { // v1.0
+            Map<String, Object> permissionsMap = firstObject.asMap();
+            for (Map.Entry<String, Object> entry : permissionsMap.entrySet()) {
+                if (entry.getKey().equals("installed")) {
+                    continue;
+                }
+                allPermissions.add(entry.getKey());
+                if ((Integer)entry.getValue() == 1) {
+                    grantedPermissions.add(entry.getKey());
+                }
+            }
+        }
+
+        // If we have a session track all the permissions that were requested
+        if (session != null) {
+            session.addRequestedPermissions(allPermissions);
+        }
+        return grantedPermissions;
+    }
+
     /**
      * Provides an implementation for {@link Activity#onActivityResult
      * onActivityResult} that updates the Session based on information returned
@@ -675,8 +856,8 @@ void extendTokenCompleted(Bundle bundle) {
     }
 
     private Object writeReplace() {
-        return new SerializationProxyV1(applicationId, state, tokenInfo,
-                lastAttemptedTokenExtendDate, false, pendingAuthorizationRequest);
+        return new SerializationProxyV2(applicationId, state, tokenInfo,
+                lastAttemptedTokenExtendDate, false, pendingAuthorizationRequest, requestedPermissions);
     }
 
     // have a readObject that throws to prevent spoofing
@@ -834,6 +1015,33 @@ public static Session openActiveSession(Activity activity, boolean allowLoginUI,
         return openActiveSession(activity, allowLoginUI, new OpenRequest(activity).setCallback(callback));
     }
 
+    /**
+     * If allowLoginUI is true, this will create a new Session, make it active, and
+     * open it. If the default token cache is not available, then this will request
+     * the permissions provided (and basic permissions of no permissions are provided).
+     * If the default token cache is available and cached tokens are loaded, this will
+     * use the cached token and associated permissions.
+     * <p/>
+     * If allowedLoginUI is false, this will only create the active session and open
+     * it if it requires no user interaction (i.e. the token cache is available and
+     * there are cached tokens).
+     *
+     * @param activity     The Activity that is opening the new Session.
+     * @param allowLoginUI if false, only sets the active session and opens it if it
+     *                     does not require user interaction
+     * @param permissions  The permissions to request for this Session
+     * @param callback     The {@link StatusCallback SessionStatusCallback} to
+     *                     notify regarding Session state changes. May be null.
+     * @return The new Session or null if one could not be created
+     */
+    public static Session openActiveSession(Activity activity, boolean allowLoginUI,
+            List<String> permissions, StatusCallback callback) {
+        return openActiveSession(
+                activity, 
+                allowLoginUI, 
+                new OpenRequest(activity).setCallback(callback).setPermissions(permissions));
+    }
+    
     /**
      * If allowLoginUI is true, this will create a new Session, make it active, and
      * open it. If the default token cache is not available, then this will request
@@ -856,6 +1064,34 @@ public static Session openActiveSession(Context context, Fragment fragment,
             boolean allowLoginUI, StatusCallback callback) {
         return openActiveSession(context, allowLoginUI, new OpenRequest(fragment).setCallback(callback));
     }
+    
+    /**
+     * If allowLoginUI is true, this will create a new Session, make it active, and
+     * open it. If the default token cache is not available, then this will request
+     * the permissions provided (and basic permissions of no permissions are provided).
+     * If the default token cache is available and cached tokens are loaded, this will
+     * use the cached token and associated permissions.
+     * <p/>
+     * If allowedLoginUI is false, this will only create the active session and open
+     * it if it requires no user interaction (i.e. the token cache is available and
+     * there are cached tokens).
+     *
+     * @param context      The Activity or Service creating this Session
+     * @param fragment     The Fragment that is opening the new Session.
+     * @param allowLoginUI if false, only sets the active session and opens it if it
+     *                     does not require user interaction
+     * @param permissions  The permissions to request for this Session
+     * @param callback     The {@link StatusCallback SessionStatusCallback} to
+     *                     notify regarding Session state changes.
+     * @return The new Session or null if one could not be created
+     */
+    public static Session openActiveSession(Context context, Fragment fragment,
+            boolean allowLoginUI, List<String> permissions, StatusCallback callback) {
+        return openActiveSession(
+                context, 
+                allowLoginUI, 
+                new OpenRequest(fragment).setCallback(callback).setPermissions(permissions));
+    }
 
     /**
      * Opens a session based on an existing Facebook access token, and also makes this session
@@ -920,6 +1156,8 @@ void authorize(AuthorizationRequest request) {
 
         started = tryLoginActivity(request);
 
+        addRequestedPermissions(request.getPermissions());
+
         pendingAuthorizationRequest.loggingExtras.put(AuthorizationClient.EVENT_EXTRAS_TRY_LOGIN_ACTIVITY,
                 started ? AppEventsConstants.EVENT_PARAM_VALUE_YES : AppEventsConstants.EVENT_PARAM_VALUE_NO);
 
@@ -1280,6 +1518,14 @@ private void saveTokenToCache(AccessToken newToken) {
         }
     }
 
+    private void addRequestedPermissions(List<String> permissions) {
+        synchronized (this.lock) {
+            for(String permission : permissions) {
+                requestedPermissions.add(permission);
+            }
+        }
+    }
+
     void postStateChange(final SessionState oldState, final SessionState newState, final Exception exception) {
         // When we request new permissions, we stay in SessionState.OPENED_TOKEN_UPDATED,
         // but we still want notifications of the state change since permissions are
@@ -2065,5 +2311,12 @@ public final NewPermissionsRequest setDefaultAudience(SessionDefaultAudience def
             super.setDefaultAudience(defaultAudience);
             return this;
         }
+
+        @Override
+        AuthorizationClient.AuthorizationRequest getAuthorizationClientRequest() {
+            AuthorizationClient.AuthorizationRequest request = super.getAuthorizationClientRequest();
+            request.setRerequest(true);
+            return request;
+        }
     }
 }
diff --git a/facebook/src/com/facebook/Settings.java b/facebook/src/com/facebook/Settings.java
index a07e31639..cc1eb033b 100644
--- a/facebook/src/com/facebook/Settings.java
+++ b/facebook/src/com/facebook/Settings.java
@@ -19,6 +19,8 @@
 import android.content.ContentResolver;
 import android.content.Context;
 import android.content.SharedPreferences;
+import android.content.pm.ApplicationInfo;
+import android.content.pm.PackageManager;
 import android.database.Cursor;
 import android.net.Uri;
 import android.os.AsyncTask;
@@ -49,9 +51,13 @@
     private static volatile Executor executor;
     private static volatile boolean shouldAutoPublishInstall;
     private static volatile String appVersion;
+    private static volatile String applicationId;
+    private static volatile String appClientToken;
+    private static volatile boolean defaultsLoaded = false;
     private static final String FACEBOOK_COM = "facebook.com";
     private static volatile String facebookDomain = FACEBOOK_COM;
     private static AtomicLong onProgressThreshold = new AtomicLong(65536);
+    private static volatile boolean platformCompatibilityEnabled;
 
     private static final int DEFAULT_CORE_POOL_SIZE = 5;
     private static final int DEFAULT_MAXIMUM_POOL_SIZE = 128;
@@ -80,6 +86,17 @@ public Thread newThread(Runnable runnable) {
         }
     };
 
+    /**
+     * loadDefaultsFromMetadata will attempt to load certain settings (e.g., application ID, client token) from
+     * metadata in the app's AndroidManifest.xml. The application ID will be read from this key.
+     */
+    public static final String APPLICATION_ID_PROPERTY = "com.facebook.sdk.ApplicationId";
+    /**
+     * loadDefaultsFromMetadata will attempt to load certain settings (e.g., application ID, client token) from
+     * metadata in the app's AndroidManifest.xml. The client token will be read from this key.
+     */
+    public static final String CLIENT_TOKEN_PROPERTY = "com.facebook.sdk.ClientToken";
+
     /**
      * Certain logging behaviors are available for debugging beyond those that should be
      * enabled in production.
@@ -383,7 +400,7 @@ static Response publishInstallAndWaitForResponse(
                 if (graphObject == null) {
                     return Response.createResponsesFromString("true", null, new RequestBatch(publishRequest), true).get(0);
                 } else {
-                    return new Response(null, null, graphObject, true);
+                    return new Response(null, null, null, graphObject, true);
                 }
             } else if (identifiers.getAndroidAdvertiserId() == null && identifiers.getAttributionId() == null) {
                 throw new FacebookException("No attribution id available to send to server.");
@@ -463,17 +480,6 @@ public static String getSdkVersion() {
         return FacebookSdkVersion.BUILD;
     }
 
-    /**
-     * Gets the current Facebook migration bundle string; this string can be passed to Graph API
-     * endpoints to specify a set of platform migrations that are explicitly turned on or off for
-     * that call, in order to ensure compatibility between a given version of the SDK and the
-     * Graph API.
-     * @return the migration bundle supported by this version of the SDK
-     */
-    public static String getMigrationBundle() {
-        return FacebookSdkVersion.MIGRATION_BUNDLE;
-    }
-
     /**
      * Gets whether data such as that generated through AppEventsLogger and sent to Facebook should be restricted from
      * being used for purposes other than analytics and conversions, such as for targeting ads to this user.  Defaults
@@ -517,4 +523,98 @@ public static long getOnProgressThreshold() {
     public static void setOnProgressThreshold(long threshold) {
         onProgressThreshold.set(threshold);
     }
+
+    /**
+     * Gets whether the SDK is running in Platform Compatibility mode (i.e. making calls to v1.0 endpoints by default)
+     * The default is false.
+     *
+     * @return the value
+     */
+    public static boolean getPlatformCompatibilityEnabled() {
+        return platformCompatibilityEnabled;
+    }
+
+    /**
+     * Sets whether the SDK is running in Platform Compatibility mode (i.e. making calls to v1.0 endpoints by default)
+     * The default is false.  This is provided for apps that have strong reason not to take advantage of new
+     * capabilities in version 2.0+ of the API.
+     *
+     * @param platformCompatibilityEnabled whether to set Legacy Graph API mode
+     */
+    public static void setPlatformCompatibilityEnabled(boolean platformCompatibilityEnabled) {
+        Settings.platformCompatibilityEnabled = platformCompatibilityEnabled;
+    }
+
+    /**
+     * Loads default values for certain settings from an application's AndroidManifest.xml metadata, if possible.
+     * If values have been explicitly set for a particular setting, they will not be overwritten. The following
+     * settings are currently loaded from metadata: APPLICATION_ID_PROPERTY, CLIENT_TOKEN_PROPERTY
+     * @param context the Context to use for loading metadata
+     */
+    public static void loadDefaultsFromMetadata(Context context) {
+        defaultsLoaded = true;
+
+        if (context == null) {
+            return;
+        }
+
+        ApplicationInfo ai = null;
+        try {
+            ai = context.getPackageManager().getApplicationInfo(
+                    context.getPackageName(), PackageManager.GET_META_DATA);
+        } catch (PackageManager.NameNotFoundException e) {
+            return;
+        }
+
+        if (ai == null || ai.metaData == null) {
+            return;
+        }
+
+        if (applicationId == null) {
+            applicationId = ai.metaData.getString(APPLICATION_ID_PROPERTY);
+        }
+        if (appClientToken == null) {
+            appClientToken = ai.metaData.getString(CLIENT_TOKEN_PROPERTY);
+        }
+    }
+
+    static void loadDefaultsFromMetadataIfNeeded(Context context) {
+        if (!defaultsLoaded) {
+            loadDefaultsFromMetadata(context);
+        }
+    }
+
+    /**
+     * Gets the Facebook application ID for the current app. This will be null unless explicitly set or unless
+     * loadDefaultsFromMetadata has been called.
+     * @return the application ID
+     */
+    public static String getApplicationId() {
+        return applicationId;
+    }
+
+    /**
+     * Sets the Facebook application ID for the current app.
+     * @param applicationId the application ID
+     */
+    public static void setApplicationId(String applicationId) {
+        Settings.applicationId = applicationId;
+    }
+
+    /**
+     * Gets the client token for the current app. This will be null unless explicitly set or unless
+     * loadDefaultsFromMetadata has been called.
+     * @return the client token
+     */
+    public static String getClientToken() {
+        return appClientToken;
+    }
+
+    /**
+     * Sets the Facebook client token for the current app.
+     * @param clientToken the client token
+     */
+    public static void setClientToken(String clientToken) {
+        appClientToken = clientToken;
+    }
 }
diff --git a/facebook/src/com/facebook/TestSession.java b/facebook/src/com/facebook/TestSession.java
index 9133cb91f..ac5fa6d66 100644
--- a/facebook/src/com/facebook/TestSession.java
+++ b/facebook/src/com/facebook/TestSession.java
@@ -77,6 +77,7 @@
     private final List<String> requestedPermissions;
     private final Mode mode;
     private String testAccountId;
+    private String testAccountUserName;
 
     private boolean wasAskedToExtendAccessToken;
 
@@ -200,6 +201,16 @@ public final String getTestUserId() {
         return testAccountId;
     }
 
+    /**
+     * Gets the name of the test user that this TestSession is authenticated as.
+     *
+     * @return the name of the test user
+     */
+    public final String getTestUserName() {
+        return testAccountUserName;
+    }
+
+
     private static synchronized TestSession createTestSession(Activity activity, List<String> permissions, Mode mode,
             String sessionUniqueUserTag) {
         if (Utility.isNullOrEmpty(testApplicationId) || Utility.isNullOrEmpty(testApplicationSecret)) {
@@ -375,6 +386,7 @@ private void findOrCreateSharedTestAccount() {
 
     private void finishAuthWithTestAccount(TestAccount testAccount) {
         testAccountId = testAccount.getId();
+        testAccountUserName = testAccount.getName();
 
         AccessToken accessToken = AccessToken.createFromString(testAccount.getAccessToken(), requestedPermissions,
                 AccessTokenSource.TEST_USER);
diff --git a/facebook/src/com/facebook/UiLifecycleHelper.java b/facebook/src/com/facebook/UiLifecycleHelper.java
index d1b74ff66..7b68c16fa 100644
--- a/facebook/src/com/facebook/UiLifecycleHelper.java
+++ b/facebook/src/com/facebook/UiLifecycleHelper.java
@@ -70,6 +70,9 @@ public UiLifecycleHelper(Activity activity, Session.StatusCallback callback) {
         this.callback = callback;
         this.receiver = new ActiveSessionBroadcastReceiver();
         this.broadcastManager = LocalBroadcastManager.getInstance(activity);
+
+        // Make sure we've loaded default settings if we haven't already.
+        Settings.loadDefaultsFromMetadataIfNeeded(activity);
     }
 
     /**
diff --git a/facebook/src/com/facebook/internal/AnalyticsEvents.java b/facebook/src/com/facebook/internal/AnalyticsEvents.java
index e01ac4371..e57ec0fb7 100644
--- a/facebook/src/com/facebook/internal/AnalyticsEvents.java
+++ b/facebook/src/com/facebook/internal/AnalyticsEvents.java
@@ -13,6 +13,8 @@
     public static final String EVENT_PLACE_PICKER_USAGE             = "fb_place_picker_usage";
     public static final String EVENT_LOGIN_VIEW_USAGE               = "fb_login_view_usage";
     public static final String EVENT_USER_SETTINGS_USAGE            = "fb_user_settings_vc_usage";
+    public static final String EVENT_NATIVE_DIALOG_START            = "fb_native_dialog_start";
+    public static final String EVENT_NATIVE_DIALOG_COMPLETE         = "fb_native_dialog_complete";
 
     public static final String PARAMETER_WEB_LOGIN_E2E                  = "fb_web_login_e2e";
     public static final String PARAMETER_WEB_LOGIN_SWITCHBACK_TIME      = "fb_web_login_switchback_time";
@@ -28,4 +30,10 @@
     public static final String PARAMETER_DIALOG_OUTCOME_VALUE_CANCELLED = "Cancelled";
     public static final String PARAMETER_DIALOG_OUTCOME_VALUE_FAILED    = "Failed";
 
+    public static final String EVENT_NATIVE_DIALOG_TYPE_SHARE           = "fb_dialogs_present_share";
+    public static final String EVENT_NATIVE_DIALOG_TYPE_MESSAGE         = "fb_dialogs_present_message";
+    public static final String EVENT_NATIVE_DIALOG_TYPE_OG_SHARE        = "fb_dialogs_present_share_og";
+    public static final String EVENT_NATIVE_DIALOG_TYPE_OG_MESSAGE      = "fb_dialogs_present_message_og";
+    public static final String EVENT_NATIVE_DIALOG_TYPE_PHOTO_SHARE     = "fb_dialogs_present_share_photo";
+    public static final String EVENT_NATIVE_DIALOG_TYPE_PHOTO_MESSAGE   = "fb_dialogs_present_message_photo";
 }
diff --git a/facebook/src/com/facebook/internal/NativeProtocol.java b/facebook/src/com/facebook/internal/NativeProtocol.java
index c322f4419..5c2ef7531 100644
--- a/facebook/src/com/facebook/internal/NativeProtocol.java
+++ b/facebook/src/com/facebook/internal/NativeProtocol.java
@@ -26,7 +26,6 @@
 import android.os.Bundle;
 import android.text.TextUtils;
 import com.facebook.*;
-import com.facebook.android.BuildConfig;
 
 import java.util.*;
 
@@ -42,7 +41,6 @@
     private static final String FACEBOOK_PROXY_AUTH_ACTIVITY = "com.facebook.katana.ProxyAuth";
     private static final String FACEBOOK_TOKEN_REFRESH_ACTIVITY = "com.facebook.katana.platform.TokenRefreshService";
 
-    private static final String BASIC_INFO = "basic_info";
     public static final String FACEBOOK_PROXY_AUTH_PERMISSIONS_KEY = "scope";
     public static final String FACEBOOK_PROXY_AUTH_APP_ID_KEY = "client_id";
     public static final String FACEBOOK_PROXY_AUTH_E2E_KEY = "e2e";
@@ -58,6 +56,7 @@
     public static final int PROTOCOL_VERSION_20130618 = 20130618;
     public static final int PROTOCOL_VERSION_20131107 = 20131107;
     public static final int PROTOCOL_VERSION_20140204 = 20140204;
+    public static final int PROTOCOL_VERSION_20140324 = 20140324;
 
     public static final String EXTRA_PROTOCOL_VERSION = "com.facebook.platform.protocol.PROTOCOL_VERSION";
     public static final String EXTRA_PROTOCOL_ACTION = "com.facebook.platform.protocol.PROTOCOL_ACTION";
@@ -87,22 +86,25 @@
     static final String EXTRA_PROTOCOL_VERSIONS = "com.facebook.platform.extra.PROTOCOL_VERSIONS";
 
     // Values of EXTRA_PROTOCOL_ACTION supported by PlatformActivity:
-    public static final String ACTION_LOGIN_DIALOG = "com.facebook.platform.action.request.LOGIN_DIALOG";
     public static final String ACTION_FEED_DIALOG = "com.facebook.platform.action.request.FEED_DIALOG";
+    public static final String ACTION_MESSAGE_DIALOG = "com.facebook.platform.action.request.MESSAGE_DIALOG";
     public static final String ACTION_OGACTIONPUBLISH_DIALOG =
             "com.facebook.platform.action.request.OGACTIONPUBLISH_DIALOG";
+    public static final String ACTION_OGMESSAGEPUBLISH_DIALOG =
+            "com.facebook.platform.action.request.OGMESSAGEPUBLISH_DIALOG";
 
     // Values of EXTRA_PROTOCOL_ACTION values returned by PlatformActivity:
-    static final String ACTION_LOGIN_DIALOG_REPLY =
-            "com.facebook.platform.action.reply.LOGIN_DIALOG";
     public static final String ACTION_FEED_DIALOG_REPLY =
             "com.facebook.platform.action.reply.FEED_DIALOG";
+    public static final String ACTION_MESSAGE_DIALOG_REPLY =
+            "com.facebook.platform.action.reply.MESSAGE_DIALOG";
     public static final String ACTION_OGACTIONPUBLISH_DIALOG_REPLY =
             "com.facebook.platform.action.reply.OGACTIONPUBLISH_DIALOG";
+    public static final String ACTION_OGMESSAGEPUBLISH_DIALOG_REPLY =
+            "com.facebook.platform.action.reply.OGMESSAGEPUBLISH_DIALOG";
 
     // Extras supported for ACTION_LOGIN_DIALOG:
     public static final String EXTRA_PERMISSIONS = "com.facebook.platform.extra.PERMISSIONS";
-    public static final String EXTRA_WRITE_PRIVACY = "com.facebook.platform.extra.WRITE_PRIVACY";
     public static final String EXTRA_APPLICATION_ID = "com.facebook.platform.extra.APPLICATION_ID";
     public static final String EXTRA_APPLICATION_NAME = "com.facebook.platform.extra.APPLICATION_NAME";
 
@@ -173,7 +175,20 @@
 
     private static abstract class NativeAppInfo {
         abstract protected String getPackage();
-        abstract protected String getSignature();
+
+        private static final String FBI_HASH = "a4b7452e2ed8f5f191058ca7bbfd26b0d3214bfc";
+        private static final String FBL_HASH = "5e8f16062ea3cd2c4a0d547876baa6f38cabf625";
+        private static final String FBR_HASH = "8a3c4b262d721acd49a4bf97d5213199c86fa2b9";
+
+        private static final HashSet<String> validAppSignatureHashes = buildAppSignatureHashes();
+
+        private static HashSet<String> buildAppSignatureHashes() {
+            HashSet<String> set = new HashSet<String>();
+            set.add(FBR_HASH);
+            set.add(FBI_HASH);
+            set.add(FBL_HASH);
+            return set;
+        }
 
         public boolean validateSignature(Context context, String packageName) {
             String brand = Build.BRAND;
@@ -192,61 +207,36 @@ public boolean validateSignature(Context context, String packageName) {
             }
 
             for (Signature signature : packageInfo.signatures) {
-                if (signature.toCharsString().equals(this.getSignature())) {
+                String hashedSignature = Utility.sha1hash(signature.toByteArray());
+                if (validAppSignatureHashes.contains(hashedSignature)) {
                     return true;
                 }
             }
 
             return false;
         }
-
     }
 
     private static class KatanaAppInfo extends NativeAppInfo {
         static final String KATANA_PACKAGE = "com.facebook.katana";
-        static final String KATANA_SIGNATURE =
-                "30820268308201d102044a9c4610300d06092a864886f70d0101040500307a310"
-                        + "b3009060355040613025553310b30090603550408130243413112301006035504"
-                        + "07130950616c6f20416c746f31183016060355040a130f46616365626f6f6b204"
-                        + "d6f62696c653111300f060355040b130846616365626f6f6b311d301b06035504"
-                        + "03131446616365626f6f6b20436f72706f726174696f6e3020170d30393038333"
-                        + "13231353231365a180f32303530303932353231353231365a307a310b30090603"
-                        + "55040613025553310b30090603550408130243413112301006035504071309506"
-                        + "16c6f20416c746f31183016060355040a130f46616365626f6f6b204d6f62696c"
-                        + "653111300f060355040b130846616365626f6f6b311d301b06035504031314466"
-                        + "16365626f6f6b20436f72706f726174696f6e30819f300d06092a864886f70d01"
-                        + "0101050003818d0030818902818100c207d51df8eb8c97d93ba0c8c1002c928fa"
-                        + "b00dc1b42fca5e66e99cc3023ed2d214d822bc59e8e35ddcf5f44c7ae8ade50d7"
-                        + "e0c434f500e6c131f4a2834f987fc46406115de2018ebbb0d5a3c261bd97581cc"
-                        + "fef76afc7135a6d59e8855ecd7eacc8f8737e794c60a761c536b72b11fac8e603"
-                        + "f5da1a2d54aa103b8a13c0dbc10203010001300d06092a864886f70d010104050"
-                        + "0038181005ee9be8bcbb250648d3b741290a82a1c9dc2e76a0af2f2228f1d9f9c"
-                        + "4007529c446a70175c5a900d5141812866db46be6559e2141616483998211f4a6"
-                        + "73149fb2232a10d247663b26a9031e15f84bc1c74d141ff98a02d76f85b2c8ab2"
-                        + "571b6469b232d8e768a7f7ca04f7abe4a775615916c07940656b58717457b42bd"
-                        + "928a2";
-        @Override
-        protected String getSignature() {
-            return KATANA_SIGNATURE;
-        }
+
         @Override
         protected String getPackage() {
             return KATANA_PACKAGE;
         }
     }
 
-    private static class WakizashiAppInfo extends NativeAppInfo {
-        static final String WAKIZASHI_PACKAGE = "com.facebook.wakizashi";
+    private static class MessengerAppInfo extends NativeAppInfo {
+        static final String MESSENGER_PACKAGE = "com.facebook.orca";
 
         @Override
-        public boolean validateSignature(Context context, String packageName) {
-            return true;
+        protected String getPackage() {
+            return MESSENGER_PACKAGE;
         }
+    }
 
-        @Override
-        protected String getSignature() {
-            return null;
-        }
+    private static class WakizashiAppInfo extends NativeAppInfo {
+        static final String WAKIZASHI_PACKAGE = "com.facebook.wakizashi";
 
         @Override
         protected String getPackage() {
@@ -263,10 +253,7 @@ protected String getPackage() {
 
         // Katana needs to be the first thing in the list since it will get selected as the default FACEBOOK_APP_INFO
         list.add(FACEBOOK_APP_INFO);
-
-        if(BuildConfig.DEBUG) {
-            list.add(new WakizashiAppInfo());
-        }
+        list.add(new WakizashiAppInfo());
 
         return list;
     }
@@ -274,10 +261,14 @@ protected String getPackage() {
     private static Map<String, List<NativeAppInfo>> buildActionToAppInfoMap() {
         Map<String, List<NativeAppInfo>> map = new HashMap<String, List<NativeAppInfo>>();
 
+        ArrayList<NativeAppInfo> messengerAppInfoList = new ArrayList<NativeAppInfo>();
+        messengerAppInfoList.add(new MessengerAppInfo());
+
         // Add individual actions and the list they should try
         map.put(ACTION_OGACTIONPUBLISH_DIALOG, facebookAppInfoList);
         map.put(ACTION_FEED_DIALOG, facebookAppInfoList);
-        map.put(ACTION_LOGIN_DIALOG, facebookAppInfoList);
+        map.put(ACTION_MESSAGE_DIALOG, messengerAppInfoList);
+        map.put(ACTION_OGMESSAGEPUBLISH_DIALOG, messengerAppInfoList);
 
         return map;
     }
@@ -317,31 +308,59 @@ static Intent validateServiceIntent(Context context, Intent intent, NativeAppInf
     }
 
     public static Intent createProxyAuthIntent(Context context, String applicationId, List<String> permissions,
-            String e2e) {
-        Intent intent = new Intent()
-                .setClassName(FACEBOOK_APP_INFO.getPackage(), FACEBOOK_PROXY_AUTH_ACTIVITY)
-                .putExtra(FACEBOOK_PROXY_AUTH_APP_ID_KEY, applicationId);
+            String e2e, boolean isRerequest) {
+        for (NativeAppInfo appInfo : facebookAppInfoList) {
+            Intent intent = new Intent()
+                    .setClassName(appInfo.getPackage(), FACEBOOK_PROXY_AUTH_ACTIVITY)
+                    .putExtra(FACEBOOK_PROXY_AUTH_APP_ID_KEY, applicationId);
 
-        if (!Utility.isNullOrEmpty(permissions)) {
-            intent.putExtra(FACEBOOK_PROXY_AUTH_PERMISSIONS_KEY, TextUtils.join(",", permissions));
-        }
-        if (!Utility.isNullOrEmpty(e2e)) {
-            intent.putExtra(FACEBOOK_PROXY_AUTH_E2E_KEY, e2e);
-        }
+            if (!Utility.isNullOrEmpty(permissions)) {
+                intent.putExtra(FACEBOOK_PROXY_AUTH_PERMISSIONS_KEY, TextUtils.join(",", permissions));
+            }
+            if (!Utility.isNullOrEmpty(e2e)) {
+                intent.putExtra(FACEBOOK_PROXY_AUTH_E2E_KEY, e2e);
+            }
+
+            intent.putExtra(ServerProtocol.DIALOG_PARAM_RESPONSE_TYPE, ServerProtocol.DIALOG_RESPONSE_TYPE_TOKEN);
+            intent.putExtra(ServerProtocol.DIALOG_PARAM_RETURN_SCOPES, ServerProtocol.DIALOG_RETURN_SCOPES_TRUE);
 
-        return validateActivityIntent(context, intent, FACEBOOK_APP_INFO);
+            if (!Settings.getPlatformCompatibilityEnabled()) {
+                // Override the API Version for Auth
+                intent.putExtra(ServerProtocol.DIALOG_PARAM_LEGACY_OVERRIDE, ServerProtocol.GRAPH_API_VERSION);
+
+                // Only set the rerequest auth type for non legacy requests
+                if (isRerequest) {
+                    intent.putExtra(ServerProtocol.DIALOG_PARAM_AUTH_TYPE, ServerProtocol.DIALOG_REREQUEST_AUTH_TYPE);
+                }
+            }
+
+            intent = validateActivityIntent(context, intent, appInfo);
+
+            if (intent != null) {
+                return intent;
+            }
+        }
+        return null;
     }
 
     public static Intent createTokenRefreshIntent(Context context) {
-        Intent intent = new Intent()
-                .setClassName(FACEBOOK_APP_INFO.getPackage(), FACEBOOK_TOKEN_REFRESH_ACTIVITY);
+        for (NativeAppInfo appInfo : facebookAppInfoList) {
+            Intent intent = new Intent()
+                    .setClassName(appInfo.getPackage(), FACEBOOK_TOKEN_REFRESH_ACTIVITY);
 
-        return validateServiceIntent(context, intent, FACEBOOK_APP_INFO);
+            intent = validateServiceIntent(context, intent, appInfo);
+
+            if (intent != null) {
+                return intent;
+            }
+        }
+        return null;
     }
 
     // Note: be sure this stays sorted in descending order; add new versions at the beginning
     private static final List<Integer> KNOWN_PROTOCOL_VERSIONS =
             Arrays.asList(
+                    PROTOCOL_VERSION_20140324,
                     PROTOCOL_VERSION_20140204,
                     PROTOCOL_VERSION_20131107,
                     PROTOCOL_VERSION_20130618,
@@ -396,23 +415,6 @@ public static Intent createPlatformServiceIntent(Context context) {
         return null;
     }
 
-    public static Intent createLoginDialog20121101Intent(Context context, String applicationId, ArrayList<String> permissions,
-            String audience) {
-        Intent intent = findActivityIntent(context, INTENT_ACTION_PLATFORM_ACTIVITY, ACTION_LOGIN_DIALOG);
-        if (intent == null) {
-            return null;
-        }
-
-        intent.putExtra(EXTRA_PROTOCOL_VERSION, PROTOCOL_VERSION_20121101)
-              .putExtra(EXTRA_PROTOCOL_ACTION, ACTION_LOGIN_DIALOG)
-              .putExtra(EXTRA_APPLICATION_ID, applicationId)
-              .putStringArrayListExtra(EXTRA_PERMISSIONS, ensureDefaultPermissions(permissions))
-              .putExtra(EXTRA_PROTOCOL_CALL_ID, generateCallId())
-              .putExtra(EXTRA_WRITE_PRIVACY, ensureDefaultAudience(audience));
-
-        return intent;
-    }
-
     public static boolean isErrorResult(Intent resultIntent) {
         return resultIntent.hasExtra(STATUS_ERROR_TYPE);
     }
@@ -432,44 +434,6 @@ public static Exception getErrorFromResult(Intent resultIntent) {
         return new FacebookException(description);
     }
 
-    private static String generateCallId() {
-        return UUID.randomUUID().toString();
-    }
-
-    private static String ensureDefaultAudience(String audience) {
-        if (Utility.isNullOrEmpty(audience)) {
-            return AUDIENCE_ME;
-        } else {
-            return audience;
-        }
-    }
-
-    private static ArrayList<String> ensureDefaultPermissions(ArrayList<String> permissions) {
-        ArrayList<String> updated;
-
-        // Return if we are doing publish, or if basic_info is already included
-        if (Utility.isNullOrEmpty(permissions)) {
-            updated = new ArrayList<String>();
-        } else {
-            for (String permission : permissions) {
-                if (Session.isPublishPermission(permission) || BASIC_INFO.equals(permission)) {
-                    return permissions;
-                }
-            }
-            updated = new ArrayList<String>(permissions);
-        }
-
-        updated.add(BASIC_INFO);
-        return updated;
-    }
-
-    public static boolean isServiceDisabledResult20121101(Intent data) {
-        int protocolVersion = data.getIntExtra(EXTRA_PROTOCOL_VERSION, 0);
-        String errorType = data.getStringExtra(STATUS_ERROR_TYPE);
-
-        return ((PROTOCOL_VERSION_20121101 == protocolVersion) && ERROR_SERVICE_DISABLED.equals(errorType));
-    }
-
     public static int getLatestAvailableProtocolVersionForService(Context context, final int minimumVersion) {
         // Services are currently always against the Facebook App
         return getLatestAvailableProtocolVersionForAppInfoList(context, facebookAppInfoList, minimumVersion);
diff --git a/facebook/src/com/facebook/internal/ServerProtocol.java b/facebook/src/com/facebook/internal/ServerProtocol.java
index 6f3dd7d49..06155ce5e 100644
--- a/facebook/src/com/facebook/internal/ServerProtocol.java
+++ b/facebook/src/com/facebook/internal/ServerProtocol.java
@@ -17,7 +17,6 @@
 package com.facebook.internal;
 
 import com.facebook.Settings;
-import com.facebook.internal.Utility;
 
 import java.util.Collection;
 
@@ -29,20 +28,29 @@
 public final class ServerProtocol {
     private static final String DIALOG_AUTHORITY_FORMAT = "m.%s";
     public static final String DIALOG_PATH = "dialog/";
-    public static final String DIALOG_PARAM_SCOPE = "scope";
-    public static final String DIALOG_PARAM_CLIENT_ID = "client_id";
-    public static final String DIALOG_PARAM_DISPLAY = "display";
-    public static final String DIALOG_PARAM_REDIRECT_URI = "redirect_uri";
-    public static final String DIALOG_PARAM_TYPE = "type";
     public static final String DIALOG_PARAM_ACCESS_TOKEN = "access_token";
     public static final String DIALOG_PARAM_APP_ID = "app_id";
+    public static final String DIALOG_PARAM_AUTH_TYPE = "auth_type";
+    public static final String DIALOG_PARAM_CLIENT_ID = "client_id";
+    public static final String DIALOG_PARAM_DISPLAY = "display";
     public static final String DIALOG_PARAM_E2E = "e2e";
+    public static final String DIALOG_PARAM_LEGACY_OVERRIDE = "legacy_override";
+    public static final String DIALOG_PARAM_REDIRECT_URI = "redirect_uri";
+    public static final String DIALOG_PARAM_RESPONSE_TYPE = "response_type";
+    public static final String DIALOG_PARAM_RETURN_SCOPES = "return_scopes";
+    public static final String DIALOG_PARAM_SCOPE = "scope";
+    public static final String DIALOG_REREQUEST_AUTH_TYPE = "rerequest";
+    public static final String DIALOG_RESPONSE_TYPE_TOKEN = "token";
+    public static final String DIALOG_RETURN_SCOPES_TRUE = "true";
 
     // URL components
     private static final String GRAPH_VIDEO_URL_FORMAT = "https://graph-video.%s";
     private static final String GRAPH_URL_FORMAT = "https://graph.%s";
-    private static final String REST_URL_FORMAT = "https://api.%s/method";
-    public static final String BATCHED_REST_METHOD_URL_BASE = "method/";
+    private static final String REST_URL_FORMAT = "https://api.%s";
+    public static final String REST_METHOD_BASE = "method";
+    public static final String GRAPH_API_VERSION = "v2.0";
+
+    private static final String LEGACY_API_VERSION = "v1.0";
 
     public static final Collection<String> errorsProxyAuthDisabled =
             Utility.unmodifiableCollection("service_disabled", "AndroidAuthKillSwitchException");
@@ -64,4 +72,11 @@ public static final String getGraphVideoUrlBase() {
     public static final String getRestUrlBase() {
         return String.format(REST_URL_FORMAT, Settings.getFacebookDomain());
     }
+
+    public static final String getAPIVersion() {
+        if (Settings.getPlatformCompatibilityEnabled()) {
+            return LEGACY_API_VERSION;
+        }
+        return GRAPH_API_VERSION;
+    }
 }
diff --git a/facebook/src/com/facebook/internal/Utility.java b/facebook/src/com/facebook/internal/Utility.java
index 3704d2fcb..7289c1477 100644
--- a/facebook/src/com/facebook/internal/Utility.java
+++ b/facebook/src/com/facebook/internal/Utility.java
@@ -17,8 +17,6 @@
 package com.facebook.internal;
 
 import android.content.Context;
-import android.content.pm.ApplicationInfo;
-import android.content.pm.PackageManager;
 import android.net.Uri;
 import android.os.Bundle;
 import android.os.Parcelable;
@@ -57,9 +55,14 @@
     private static final String URL_SCHEME = "https";
     private static final String SUPPORTS_ATTRIBUTION = "supports_attribution";
     private static final String SUPPORTS_IMPLICIT_SDK_LOGGING = "supports_implicit_sdk_logging";
+    private static final String NUX_CONTENT = "gdpv4_nux_content";
+    private static final String NUX_ENABLED = "gdpv4_nux_enabled";
+
     private static final String [] APP_SETTING_FIELDS = new String[] {
             SUPPORTS_ATTRIBUTION,
-            SUPPORTS_IMPLICIT_SDK_LOGGING
+            SUPPORTS_IMPLICIT_SDK_LOGGING,
+            NUX_CONTENT,
+            NUX_ENABLED
     };
     private static final String APPLICATION_FIELDS = "fields";
 
@@ -72,10 +75,17 @@
     public static class FetchedAppSettings {
         private boolean supportsAttribution;
         private boolean supportsImplicitLogging;
+        private String nuxContent;
+        private boolean nuxEnabled;
 
-        private FetchedAppSettings(boolean supportsAttribution, boolean supportsImplicitLogging) {
+        private FetchedAppSettings(boolean supportsAttribution,
+                                   boolean supportsImplicitLogging,
+                                   String nuxContent,
+                                   boolean nuxEnabled) {
             this.supportsAttribution = supportsAttribution;
             this.supportsImplicitLogging = supportsImplicitLogging;
+            this.nuxContent = nuxContent;
+            this.nuxEnabled = nuxEnabled;
         }
 
         public boolean supportsAttribution() {
@@ -85,6 +95,14 @@ public boolean supportsAttribution() {
         public boolean supportsImplicitLogging() {
             return supportsImplicitLogging;
         }
+
+        public String getNuxContent() {
+            return nuxContent;
+        }
+
+        public boolean getNuxEnabled() {
+            return nuxEnabled;
+        }
     }
 
     // Returns true iff all items in subset are in superset, treating null and
@@ -128,19 +146,30 @@ static String md5hash(String key) {
         return hashWithAlgorithm(HASH_ALGORITHM_MD5, key);
     }
 
-    private static String sha1hash(String key) {
+    static String sha1hash(String key) {
         return hashWithAlgorithm(HASH_ALGORITHM_SHA1, key);
     }
 
+    static String sha1hash(byte[] bytes) {
+        return hashWithAlgorithm(HASH_ALGORITHM_SHA1, bytes);
+    }
+
     private static String hashWithAlgorithm(String algorithm, String key) {
-        MessageDigest hash = null;
+        return hashWithAlgorithm(algorithm, key.getBytes());
+    }
+
+    private static String hashWithAlgorithm(String algorithm, byte[] bytes) {
+        MessageDigest hash;
         try {
             hash = MessageDigest.getInstance(algorithm);
         } catch (NoSuchAlgorithmException e) {
             return null;
         }
+        return hashBytes(hash, bytes);
+    }
 
-        hash.update(key.getBytes());
+    private static String hashBytes(MessageDigest hash, byte[] bytes) {
+        hash.update(bytes);
         byte[] digest = hash.digest();
         StringBuilder builder = new StringBuilder();
         for (int b : digest) {
@@ -195,17 +224,9 @@ public static void disconnectQuietly(URLConnection connection) {
     public static String getMetadataApplicationId(Context context) {
         Validate.notNull(context, "context");
 
-        try {
-            ApplicationInfo ai = context.getPackageManager().getApplicationInfo(
-                    context.getPackageName(), PackageManager.GET_META_DATA);
-            if (ai.metaData != null) {
-                return ai.metaData.getString(Session.APPLICATION_ID_PROPERTY);
-            }
-        } catch (PackageManager.NameNotFoundException e) {
-            // if we can't find it in the manifest, just return null
-        }
+        Settings.loadDefaultsFromMetadata(context);
 
-        return null;
+        return Settings.getApplicationId();
     }
 
     static Map<String, Object> convertJSONObjectToHashMap(JSONObject jsonObject) {
@@ -361,7 +382,10 @@ public static FetchedAppSettings queryAppSettings(final String applicationId, fi
         GraphObject supportResponse = request.executeAndWait().getGraphObject();
         FetchedAppSettings result = new FetchedAppSettings(
                 safeGetBooleanFromResponse(supportResponse, SUPPORTS_ATTRIBUTION),
-                safeGetBooleanFromResponse(supportResponse, SUPPORTS_IMPLICIT_SDK_LOGGING));
+                safeGetBooleanFromResponse(supportResponse, SUPPORTS_IMPLICIT_SDK_LOGGING),
+                safeGetStringFromResponse(supportResponse, NUX_CONTENT),
+                safeGetBooleanFromResponse(supportResponse, NUX_ENABLED)
+                );
 
         fetchedAppSettings.put(applicationId, result);
 
@@ -379,6 +403,17 @@ private static boolean safeGetBooleanFromResponse(GraphObject response, String p
         return (Boolean) result;
     }
 
+    private static String safeGetStringFromResponse(GraphObject response, String propertyName) {
+        Object result = "";
+        if (response != null) {
+            result = response.getProperty(propertyName);
+        }
+        if (!(result instanceof String)) {
+            result = "";
+        }
+        return (String) result;
+    }
+
     public static void clearCaches(Context context) {
         ImageDownloader.clearCache(context);
     }
@@ -423,11 +458,11 @@ public static String getHashedDeviceAndAppID(Context context, String application
     public static void setAppEventAttributionParameters(GraphObject params,
             AttributionIdentifiers attributionIdentifiers, String hashedDeviceAndAppId, boolean limitEventUsage) {
         // Send attributionID if it exists, otherwise send a hashed device+appid specific value as the advertiser_id.
-        if (attributionIdentifiers.getAttributionId() != null) {
+        if (attributionIdentifiers != null && attributionIdentifiers.getAttributionId() != null) {
             params.setProperty("attribution", attributionIdentifiers.getAttributionId());
         }
 
-        if (attributionIdentifiers.getAndroidAdvertiserId() != null) {
+        if (attributionIdentifiers != null && attributionIdentifiers.getAndroidAdvertiserId() != null) {
             params.setProperty("advertiser_id", attributionIdentifiers.getAndroidAdvertiserId());
             params.setProperty("advertiser_tracking_enabled", !attributionIdentifiers.isTrackingLimited());
         } else if (hashedDeviceAndAppId != null) {
diff --git a/facebook/src/com/facebook/widget/FacebookDialog.java b/facebook/src/com/facebook/widget/FacebookDialog.java
index cb5c8a56a..59ba695ee 100644
--- a/facebook/src/com/facebook/widget/FacebookDialog.java
+++ b/facebook/src/com/facebook/widget/FacebookDialog.java
@@ -25,6 +25,7 @@
 import android.os.Parcelable;
 import android.support.v4.app.Fragment;
 import com.facebook.*;
+import com.facebook.internal.AnalyticsEvents;
 import com.facebook.internal.NativeProtocol;
 import com.facebook.internal.Utility;
 import com.facebook.internal.Validate;
@@ -123,6 +124,49 @@ public int getMinVersion() {
         }
     }
 
+    /**
+     * Defines a set of features that may be supported by the native Message dialog exposed by the Facebook Messenger application.
+     * As additional features are added, these flags may be passed to
+     * {@link FacebookDialog#canPresentMessageDialog(android.content.Context,
+     * com.facebook.widget.FacebookDialog.MessageDialogFeature...)}
+     * to determine whether the version of the Facebook application installed on the user's device is recent
+     * enough to support specific features, which in turn may be used to determine which UI, etc., to present to the
+     * user.
+     */
+    public enum MessageDialogFeature implements DialogFeature {
+        /**
+         * Indicates whether the native Message dialog itself is supported by the installed version of the
+         * Facebook application.
+         */
+        MESSAGE_DIALOG(NativeProtocol.PROTOCOL_VERSION_20140204),
+        /**
+         * Indicates whether the native Message dialog supports sharing of photo images.
+         */
+        PHOTOS(NativeProtocol.PROTOCOL_VERSION_20140324),
+        ;
+
+        private int minVersion;
+
+        private MessageDialogFeature(int minVersion) {
+            this.minVersion = minVersion;
+        }
+
+        /**
+         * This method is for internal use only.
+         */
+        public String getAction() {
+            return NativeProtocol.ACTION_MESSAGE_DIALOG;
+        }
+
+        /**
+         * This method is for internal use only.
+         */
+        public int getMinVersion() {
+            return minVersion;
+        }
+    }
+
+
     /**
      * Defines a set of features that may be supported by the native Open Graph dialogs exposed by the Facebook
      * application. As additional features are added, these flags may be passed to
@@ -160,6 +204,43 @@ public int getMinVersion() {
         }
     }
 
+    /**
+     * Defines a set of features that may be supported by the native Open Graph Message dialogs exposed by the Facebook
+     * application. As additional features are added, these flags may be passed to
+     * {@link FacebookDialog#canPresentOpenGraphMessageDialog(android.content.Context,
+     * com.facebook.widget.FacebookDialog.OpenGraphMessageDialogFeature...)}
+     * to determine whether the version of the Facebook application installed on the user's device is recent
+     * enough to support specific features, which in turn may be used to determine which UI, etc., to present to the
+     * user.
+     */
+    public enum OpenGraphMessageDialogFeature implements DialogFeature {
+        /**
+         * Indicates whether the native Open Graph Message dialog itself is supported by the installed version of the
+         * Messenger application.
+         */
+        OG_MESSAGE_DIALOG(NativeProtocol.PROTOCOL_VERSION_20140204);
+
+        private int minVersion;
+
+        private OpenGraphMessageDialogFeature(int minVersion) {
+            this.minVersion = minVersion;
+        }
+
+        /**
+         * This method is for internal use only.
+         */
+        public String getAction() {
+            return NativeProtocol.ACTION_OGMESSAGEPUBLISH_DIALOG;
+        }
+
+        /**
+         * This method is for internal use only.
+         */
+        public int getMinVersion() {
+            return minVersion;
+        }
+    }
+
     interface OnPresentCallback {
         void onPresent(Context context) throws Exception;
     }
@@ -218,6 +299,9 @@ private FacebookDialog(Activity activity, Fragment fragment, PendingCall appCall
      * @return a PendingCall containing the unique call ID corresponding to this call to the Facebook application
      */
     public PendingCall present() {
+        logDialogActivity(activity, fragment, getEventName(appCall.getRequestIntent()),
+                AnalyticsEvents.PARAMETER_DIALOG_OUTCOME_VALUE_COMPLETED);
+
         if (onPresentCallback != null) {
             try {
                 onPresentCallback.onPresent(activity);
@@ -281,6 +365,21 @@ public static boolean canPresentShareDialog(Context context, ShareDialogFeature.
         return handleCanPresent(context, EnumSet.of(ShareDialogFeature.SHARE_DIALOG, features));
     }
 
+    /**
+     * Determines whether the version of the Facebook application installed on the user's device is recent
+     * enough to support specific features of the native Message dialog, which in turn may be used to determine
+     * which UI, etc., to present to the user.
+     *
+     * @param context  the calling Context
+     * @param features zero or more features to check for; {@link com.facebook.widget.FacebookDialog.MessageDialogFeature#MESSAGE_DIALOG} is implicitly
+     *                 checked if not explicitly specified
+     * @return true if all of the specified features are supported by the currently installed version of the
+     *         Facebook application; false if any of the features are not supported
+     */
+    public static boolean canPresentMessageDialog(Context context, MessageDialogFeature... features) {
+        return handleCanPresent(context, EnumSet.of(MessageDialogFeature.MESSAGE_DIALOG, features));
+    }
+
     /**
      * Determines whether the version of the Facebook application installed on the user's device is recent
      * enough to support specific features of the native Open Graph action dialog, which in turn may be used to
@@ -296,6 +395,21 @@ public static boolean canPresentOpenGraphActionDialog(Context context, OpenGraph
         return handleCanPresent(context, EnumSet.of(OpenGraphActionDialogFeature.OG_ACTION_DIALOG, features));
     }
 
+    /**
+     * Determines whether the version of the Facebook application installed on the user's device is recent
+     * enough to support specific features of the native Open Graph Message dialog, which in turn may be used to
+     * determine which UI, etc., to present to the user.
+     *
+     * @param context  the calling Context
+     * @param features zero or more features to check for; {@link com.facebook.widget.FacebookDialog.OpenGraphMessageDialogFeature#OG_MESSAGE_DIALOG} is
+     *                 implicitly checked if not explicitly specified
+     * @return true if all of the specified features are supported by the currently installed version of the
+     *         Facebook application; false if any of the features are not supported
+     */
+    public static boolean canPresentOpenGraphMessageDialog(Context context, OpenGraphMessageDialogFeature... features) {
+        return handleCanPresent(context, EnumSet.of(OpenGraphMessageDialogFeature.OG_MESSAGE_DIALOG, features));
+    }
+
     private static boolean handleCanPresent(Context context, Iterable<? extends DialogFeature> features) {
         return getProtocolVersionForNativeDialog(context, getActionForFeatures(features), getMinVersionForFeatures(features))
                 != NativeProtocol.NO_PROTOCOL_AVAILABLE;
@@ -332,6 +446,40 @@ private static String getActionForFeatures(Iterable<? extends DialogFeature> fea
         return action;
     }
 
+    private static void logDialogActivity(Activity activity, Fragment fragment, String eventName, String outcome) {
+        AppEventsLogger logger = AppEventsLogger.newLogger(fragment != null ? fragment.getActivity() : activity);
+        Bundle parameters = new Bundle();
+        parameters.putString(AnalyticsEvents.PARAMETER_DIALOG_OUTCOME, outcome);
+        logger.logSdkEvent(eventName, null, parameters);
+    }
+
+    static private String getEventName(Intent intent) {
+        String action = intent.getStringExtra(NativeProtocol.EXTRA_PROTOCOL_ACTION);
+        boolean hasPhotos = intent.hasExtra(NativeProtocol.EXTRA_PHOTOS);
+        return getEventName(action, hasPhotos);
+    }
+
+    static private String getEventName(String action, boolean hasPhotos) {
+        String eventName;
+
+        if (action.equals(NativeProtocol.ACTION_FEED_DIALOG)) {
+            eventName = hasPhotos ?
+                    AnalyticsEvents.EVENT_NATIVE_DIALOG_TYPE_PHOTO_SHARE :
+                    AnalyticsEvents.EVENT_NATIVE_DIALOG_TYPE_SHARE;
+        } else if (action.equals(NativeProtocol.ACTION_MESSAGE_DIALOG)) {
+            eventName = hasPhotos ?
+                    AnalyticsEvents.EVENT_NATIVE_DIALOG_TYPE_PHOTO_MESSAGE :
+                    AnalyticsEvents.EVENT_NATIVE_DIALOG_TYPE_MESSAGE;
+        } else if (action.equals(NativeProtocol.ACTION_OGACTIONPUBLISH_DIALOG)) {
+            eventName = AnalyticsEvents.EVENT_NATIVE_DIALOG_TYPE_OG_SHARE;
+        } else if (action.equals(NativeProtocol.ACTION_OGMESSAGEPUBLISH_DIALOG)) {
+            eventName = AnalyticsEvents.EVENT_NATIVE_DIALOG_TYPE_OG_MESSAGE;
+        } else {
+            throw new FacebookException("An unspecified action was presented");
+        }
+        return eventName;
+    }
+
     abstract static class Builder<CONCRETE extends Builder<?>> {
         final protected Activity activity;
         final protected String applicationId;
@@ -412,6 +560,10 @@ public FacebookDialog build() {
 
             Intent intent = NativeProtocol.createPlatformActivityIntent(activity, action, protocolVersion, extras);
             if (intent == null) {
+                logDialogActivity(activity, fragment,
+                        getEventName(action, extras.containsKey(NativeProtocol.EXTRA_PHOTOS)),
+                        AnalyticsEvents.PARAMETER_DIALOG_OUTCOME_VALUE_FAILED);
+
                 throw new FacebookException(
                         "Unable to create Intent; this likely means the Facebook app is not installed.");
             }
@@ -693,6 +845,7 @@ public ShareDialogBuilder(Activity activity) {
 
     private static abstract class PhotoDialogBuilderBase<CONCRETE extends PhotoDialogBuilderBase<?>>
             extends Builder<CONCRETE> {
+        static int MAXIMUM_PHOTO_COUNT = 6;
         private String place;
         private ArrayList<String> friends;
         private ArrayList<String> imageAttachmentUrls = new ArrayList<String>();
@@ -740,6 +893,7 @@ public CONCRETE setFriends(List<String> friends) {
          * FacebookBroadcastReceiver class and register it in their AndroidManifest.xml.</p>
          * <p>In order for the images to be provided to the Facebook application as part of the app call, the
          * NativeAppCallContentProvider must be specified correctly in the application's AndroidManifest.xml.</p>
+         * No more than six photos may be shared at a time.
          * @param photos a collection of Files representing photos to be uploaded
          * @return this instance of the builder
          */
@@ -756,6 +910,7 @@ public CONCRETE addPhotos(Collection<Bitmap> photos) {
          * shared the photos, but the photos themselves may be uploaded in the background by the Facebook app;
          * apps wishing to be notified when the photo upload has succeeded or failed should extend the
          * FacebookBroadcastReceiver class and register it in their AndroidManifest.xml.
+         * No more than six photos may be shared at a time.
          * @param photos a collection of Files representing photos to be uploaded
          * @return this instance of the builder
          */
@@ -766,6 +921,8 @@ public CONCRETE addPhotoFiles(Collection<File> photos) {
             return result;
         }
 
+        abstract int getMaximumNumberOfPhotos();
+
         @Override
         void validate() {
             super.validate();
@@ -773,6 +930,10 @@ void validate() {
             if (imageAttachmentUrls.isEmpty()) {
                 throw new FacebookException("Must specify at least one photo.");
             }
+
+            if (imageAttachmentUrls.size() > getMaximumNumberOfPhotos()) {
+                throw new FacebookException(String.format("Cannot add more than %d photos.", getMaximumNumberOfPhotos()));
+            }
         }
 
         @Override
@@ -810,6 +971,60 @@ public PhotoShareDialogBuilder(Activity activity) {
             return EnumSet.of(ShareDialogFeature.SHARE_DIALOG, ShareDialogFeature.PHOTOS);
         }
 
+        @Override
+        int getMaximumNumberOfPhotos() {
+            return MAXIMUM_PHOTO_COUNT;
+        }
+    }
+
+    /**
+     * Provides a builder which can construct a FacebookDialog instance suitable for presenting the native
+     * Message dialog for sharing photos. This builder will throw an exception if the Messenger application is not
+     * installed, so it should only be used if {@link FacebookDialog#canPresentMessageDialog(android.content.Context,
+     * com.facebook.widget.FacebookDialog.MessageDialogFeature...)} indicates the capability is available.
+     */
+    public static class PhotoMessageDialogBuilder extends PhotoDialogBuilderBase<PhotoMessageDialogBuilder> {
+        /**
+         * Constructor.
+         *
+         * @param activity the Activity which is presenting the native Message dialog; must not be null
+         */
+        public PhotoMessageDialogBuilder(Activity activity) {
+            super(activity);
+        }
+
+        @Override
+        EnumSet<? extends DialogFeature> getDialogFeatures() {
+            return EnumSet.of(MessageDialogFeature.MESSAGE_DIALOG, MessageDialogFeature.PHOTOS);
+        }
+
+        @Override
+        int getMaximumNumberOfPhotos() {
+            return MAXIMUM_PHOTO_COUNT;
+        }
+    }
+
+    /**
+     * Provides a builder which can construct a FacebookDialog instance suitable for presenting the native
+     * Message dialog. This builder will throw an exception if the Facebook Messenger application is not installed, so it
+     * should only be used if {@link FacebookDialog#canPresentMessageDialog(android.content.Context,
+     * com.facebook.widget.FacebookDialog.MessageDialogFeature...)}  indicates the capability is available.
+     */
+    public static class MessageDialogBuilder extends ShareDialogBuilderBase<MessageDialogBuilder> {
+
+        /**
+         * Constructor.
+         *
+         * @param activity the Activity which is presenting the native Message dialog; must not be null
+         */
+        public MessageDialogBuilder(Activity activity) {
+            super(activity);
+        }
+
+        @Override
+        EnumSet<? extends DialogFeature> getDialogFeatures() {
+            return EnumSet.of(MessageDialogFeature.MESSAGE_DIALOG);
+        }
     }
 
     private static abstract class OpenGraphDialogBuilderBase<CONCRETE extends OpenGraphDialogBuilderBase<?>>
@@ -1304,6 +1519,36 @@ public OpenGraphActionDialogBuilder(Activity activity, OpenGraphAction action, S
         }
     }
 
+    /**
+     * Provides a builder which can construct a FacebookDialog instance suitable for presenting the native
+     * Open Graph action message dialog. This builder allows the caller to specify binary images for both the
+     * action and any Open Graph objects to be created prior to publishing the action.
+     * This builder will throw an exception if the Facebook application is not installed, so it
+     * should only be used if {@link FacebookDialog#canPresentOpenGraphMessageDialog(android.content.Context,
+     * com.facebook.widget.FacebookDialog.OpenGraphMessageDialogFeature...)} indicates the capability is available.
+     */
+    public static class OpenGraphMessageDialogBuilder extends OpenGraphDialogBuilderBase<OpenGraphMessageDialogBuilder> {
+        /**
+         * Constructor.
+         *
+         * @param activity            the Activity which is presenting the native Open Graph action message dialog;
+         *                            must not be null
+         * @param action              the Open Graph action to be sent, which must contain a reference to at least one
+         *                            Open Graph object with the property name specified by setPreviewPropertyName; the action
+         *                            must have had its type specified via the {@link OpenGraphAction#setType(String)} method
+         * @param previewPropertyName the name of a property on the Open Graph action that contains the
+         *                            Open Graph object which will be displayed as a preview to the user
+         */
+        public OpenGraphMessageDialogBuilder(Activity activity, OpenGraphAction action, String previewPropertyName) {
+            super(activity, action, previewPropertyName);
+        }
+
+        @Override
+        EnumSet<? extends DialogFeature> getDialogFeatures() {
+            return EnumSet.of(OpenGraphMessageDialogFeature.OG_MESSAGE_DIALOG);
+        }
+    }
+
     /**
      * Encapsulates information about a call being made to the Facebook application for Android. A unique String
      * call ID is used to track calls through their lifecycle.
diff --git a/facebook/src/com/facebook/widget/LoginButton.java b/facebook/src/com/facebook/widget/LoginButton.java
index ce67f6955..5c2ab2ae2 100644
--- a/facebook/src/com/facebook/widget/LoginButton.java
+++ b/facebook/src/com/facebook/widget/LoginButton.java
@@ -22,7 +22,9 @@
 import android.content.DialogInterface;
 import android.content.Intent;
 import android.content.res.TypedArray;
+import android.graphics.Canvas;
 import android.graphics.Typeface;
+import android.os.AsyncTask;
 import android.os.Bundle;
 import android.support.v4.app.Fragment;
 import android.util.AttributeSet;
@@ -31,6 +33,7 @@
 import android.view.Gravity;
 import android.view.View;
 import android.widget.Button;
+
 import com.facebook.*;
 import com.facebook.android.R;
 import com.facebook.internal.AnalyticsEvents;
@@ -38,6 +41,7 @@
 import com.facebook.internal.SessionAuthorizationType;
 import com.facebook.internal.SessionTracker;
 import com.facebook.internal.Utility;
+import com.facebook.internal.Utility.FetchedAppSettings;
 
 import java.util.Arrays;
 import java.util.Collections;
@@ -55,6 +59,24 @@
  * the {@link #setSession(com.facebook.Session)} method.
  */
 public class LoginButton extends Button {
+    
+    public static enum ToolTipMode {
+        /**
+         * Default display mode. A server query will determine if the tool tip should be displayed
+         * and, if so, what the string shown to the user should be.
+         */
+        DEFAULT,
+        
+        /**
+         * Display the tool tip with a local string--regardless of what the server returns 
+         */
+        DISPLAY_ALWAYS,
+        
+        /**
+         * Never display the tool tip--regardless of what the server says
+         */
+        NEVER_DISPLAY
+    }
 
     private static final String TAG = LoginButton.class.getName();
     private String applicationId = null;
@@ -69,6 +91,11 @@
     private Fragment parentFragment;
     private LoginButtonProperties properties = new LoginButtonProperties();
     private String loginLogoutEventName = AnalyticsEvents.EVENT_LOGIN_VIEW_USAGE;
+    private OnClickListener listenerCallback;
+    private boolean nuxChecked;
+    private ToolTipPopup.Style nuxStyle = ToolTipPopup.Style.BLUE;
+    private ToolTipMode nuxMode = ToolTipMode.DEFAULT;
+    private long nuxDisplayTime = ToolTipPopup.DEFAULT_POPUP_DISPLAY_TIME;
 
     static class LoginButtonProperties {
         private SessionDefaultAudience defaultAudience = SessionDefaultAudience.FRIENDS;
@@ -469,6 +496,52 @@ public void setSessionStatusCallback(Session.StatusCallback callback) {
     public Session.StatusCallback getSessionStatusCallback() {
         return properties.getSessionStatusCallback();
     }
+    
+    /**
+     * Sets the style (background) of the Tool Tip popup. Currently a blue style and a black
+     * style are supported. Blue is default
+     * @param nuxStyle The style of the tool tip popup.
+     */
+    public void setToolTipStyle(ToolTipPopup.Style nuxStyle) {
+        this.nuxStyle = nuxStyle;
+    }
+    
+    /**
+     * Sets the mode of the Tool Tip popup. Currently supported modes are default (normal
+     * behavior), always_on (popup remains up until forcibly dismissed), and always_off (popup
+     * doesn't show)
+     * @param nuxMode The new mode for the tool tip
+     */
+    public void setToolTipMode(ToolTipMode nuxMode) {
+        this.nuxMode = nuxMode;
+    }
+    
+    /**
+     * Return the current {@link ToolTipMode} for this LoginButton
+     * @return The {@link ToolTipMode}
+     */
+    public ToolTipMode getToolTipMode() {
+        return nuxMode;
+    }
+    
+    /**
+     * Sets the amount of time (in milliseconds) that the tool tip will be shown to the user. The 
+     * default is {@value ToolTipPopup#DEFAULT_POPUP_DISPLAY_TIME}. Any value that is less than or
+     * equal to zero will cause the tool tip to be displayed indefinitely.
+     * @param displayTime The amount of time (in milliseconds) that the tool tip will be displayed
+     * to the user
+     */
+    public void setToolTipDisplayTime(long displayTime) {
+        this.nuxDisplayTime = displayTime;
+    }
+    
+    /**
+     * Gets the current amount of time (in ms) that the tool tip will be displayed to the user
+     * @return
+     */
+    public long getToolTipDisplayTime() {
+        return nuxDisplayTime;
+    }
 
     /**
      * Provides an implementation for {@link Activity#onActivityResult
@@ -527,7 +600,7 @@ public void onFinishInflate() {
     }
 
     private void finishInit() {
-        setOnClickListener(new LoginClickListener());
+        super.setOnClickListener(new LoginClickListener());
         setButtonText();
         if (!isInEditMode()) {
             sessionTracker = new SessionTracker(getContext(), new LoginButtonCallback(), null, false);
@@ -556,6 +629,54 @@ protected void onAttachedToWindow() {
             setButtonText();
         }
     }
+    
+    @Override
+    protected void onDraw(Canvas canvas) {
+        super.onDraw(canvas);
+
+        if (!nuxChecked && nuxMode != ToolTipMode.NEVER_DISPLAY) {
+            nuxChecked = true;
+            checkNuxSettings();
+        }
+    }
+    
+    private void showNuxPerSettings(FetchedAppSettings settings) {
+        if (settings != null && settings.getNuxEnabled() && getVisibility() == View.VISIBLE) {
+            String nuxString = settings.getNuxContent();
+            displayNux(nuxString);
+        }
+    }
+    
+    private void displayNux(String nuxString) {
+        ToolTipPopup popup = new ToolTipPopup(nuxString, this);
+        popup.setStyle(nuxStyle);
+        popup.setNuxDisplayTime(nuxDisplayTime);
+        popup.show();
+    }
+    
+    private void checkNuxSettings() {
+        if (nuxMode == ToolTipMode.DISPLAY_ALWAYS) {
+            String nuxString = getResources().getString(R.string.com_facebook_tooltip_default);
+            displayNux(nuxString);
+        } else {
+            // kick off an async request
+            final String appId = Utility.getMetadataApplicationId(getContext());
+            AsyncTask<Void, Void, FetchedAppSettings> task = new AsyncTask<Void, Void, Utility.FetchedAppSettings>() {
+                @Override
+                protected FetchedAppSettings doInBackground(Void... params) {
+                    FetchedAppSettings settings = Utility.queryAppSettings(appId, false);
+                    return settings;
+                }
+
+                @Override
+                protected void onPostExecute(FetchedAppSettings result) {
+                    showNuxPerSettings(result);
+                }
+            };
+            task.execute((Void[])null);
+        }
+
+    }
 
     @Override
     protected void onDetachedFromWindow() {
@@ -646,6 +767,16 @@ public void onCompleted(GraphUser me,  Response response) {
         }
     }
 
+    /**
+     * Allow a developer to set the OnClickListener for the button.  This will be called back after we do any handling
+     * internally for login
+     * @param clickListener
+     */
+    @Override
+    public void setOnClickListener(OnClickListener clickListener) {
+        listenerCallback = clickListener;
+    }
+
     private class LoginClickListener implements OnClickListener {
 
         @Override
@@ -714,6 +845,10 @@ public void onClick(DialogInterface dialog, int which) {
             parameters.putInt("logging_in", (openSession != null) ? 0 : 1);
 
             logger.logSdkEvent(loginLogoutEventName, null, parameters);
+
+            if (listenerCallback != null) {
+                listenerCallback.onClick(v);
+            }
         }
     }
 
diff --git a/facebook/src/com/facebook/widget/ToolTipPopup.java b/facebook/src/com/facebook/widget/ToolTipPopup.java
new file mode 100644
index 000000000..8b21777b5
--- /dev/null
+++ b/facebook/src/com/facebook/widget/ToolTipPopup.java
@@ -0,0 +1,237 @@
+/**
+ * Copyright 2010-present Facebook.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.facebook.widget;
+
+import java.lang.ref.WeakReference;
+
+import com.facebook.android.R;
+import com.facebook.widget.LoginButton.ToolTipMode;
+
+import android.app.Activity;
+import android.content.Context;
+import android.view.LayoutInflater;
+import android.view.View;
+import android.view.ViewTreeObserver;
+import android.view.Window;
+import android.widget.FrameLayout;
+import android.widget.ImageView;
+import android.widget.PopupWindow;
+import android.widget.TextView;
+
+public class ToolTipPopup {
+    
+    public static enum Style {
+        /**
+         * The tool tip will be shown with a blue style; including a blue background and blue
+         * arrows.
+         */
+        BLUE,
+        
+        /**
+         * The tool tip will be shown with a black style; including a black background and black
+         * arrows.
+         */
+        BLACK
+    }
+    
+    /**
+     * The default time that the tool tip will be displayed
+     */
+    public static final long DEFAULT_POPUP_DISPLAY_TIME = 6000;
+    
+    private final String mText;
+    private final WeakReference<View> mAnchorViewRef;
+    private final Context mContext;
+    private PopupContentView mPopupContent;
+    private PopupWindow mPopupWindow;
+    private Style mStyle = Style.BLUE;
+    private long mNuxDisplayTime = DEFAULT_POPUP_DISPLAY_TIME;
+    
+    private final ViewTreeObserver.OnScrollChangedListener mScrollListener = 
+            new ViewTreeObserver.OnScrollChangedListener() {
+                @Override
+                public void onScrollChanged() {
+                    if (mAnchorViewRef.get() != null && 
+                            mPopupWindow != null && 
+                            mPopupWindow.isShowing()) {
+                        if (mPopupWindow.isAboveAnchor()) {
+                            mPopupContent.showBottomArrow();
+                        } else {
+                            mPopupContent.showTopArrow();
+                        }
+                    }
+                }
+            };
+    
+    /**
+     * Create a new ToolTipPopup
+     * @param text The text to be displayed in the tool tip
+     * @param anchor The view to anchor this tool tip to.
+     */
+    public ToolTipPopup(String text, View anchor) {
+        mText = text;
+        mAnchorViewRef = new WeakReference<View>(anchor);
+        mContext = anchor.getContext();
+    }
+    
+    /**
+     * Sets the {@link Style} of this tool tip.
+     * @param mStyle
+     */
+    public void setStyle(Style mStyle) {
+        this.mStyle = mStyle;
+    }
+    
+    /**
+     * Display this tool tip to the user
+     */
+    public void show() {
+        if (mAnchorViewRef.get() != null) {
+            mPopupContent = new PopupContentView(mContext);
+            TextView body = (TextView) mPopupContent.findViewById(
+                    R.id.com_facebook_tooltip_bubble_view_text_body);
+            body.setText(mText);
+            if (mStyle == Style.BLUE) {
+                mPopupContent.bodyFrame.setBackgroundResource(
+                        R.drawable.com_facebook_tooltip_blue_background);
+                mPopupContent.bottomArrow.setImageResource(
+                        R.drawable.com_facebook_tooltip_blue_bottomnub);
+                mPopupContent.topArrow.setImageResource(
+                        R.drawable.com_facebook_tooltip_blue_topnub);
+                mPopupContent.xOut.setImageResource(R.drawable.com_facebook_tooltip_blue_xout);
+            } else {
+                mPopupContent.bodyFrame.setBackgroundResource(
+                        R.drawable.com_facebook_tooltip_black_background);
+                mPopupContent.bottomArrow.setImageResource(
+                        R.drawable.com_facebook_tooltip_black_bottomnub);
+                mPopupContent.topArrow.setImageResource(
+                        R.drawable.com_facebook_tooltip_black_topnub);
+                mPopupContent.xOut.setImageResource(R.drawable.com_facebook_tooltip_black_xout);
+            }
+            
+            final Window window = ((Activity) mContext).getWindow();
+            final View decorView = window.getDecorView();
+            final int decorWidth = decorView.getWidth();
+            final int decorHeight = decorView.getHeight();
+            registerObserver();
+            mPopupContent.onMeasure(
+                    View.MeasureSpec.makeMeasureSpec(decorWidth, View.MeasureSpec.AT_MOST), 
+                    View.MeasureSpec.makeMeasureSpec(decorHeight, View.MeasureSpec.AT_MOST));
+            mPopupWindow = new PopupWindow(
+                    mPopupContent, 
+                    mPopupContent.getMeasuredWidth(),
+                    mPopupContent.getMeasuredHeight());
+            mPopupWindow.showAsDropDown(mAnchorViewRef.get());
+            updateArrows();
+            if (mNuxDisplayTime > 0) {
+                mPopupContent.postDelayed(new Runnable() {
+                    @Override
+                    public void run() {
+                        dismiss();
+                    }
+                }, mNuxDisplayTime);
+            }
+            mPopupWindow.setTouchable(true);
+            mPopupContent.setOnClickListener(new View.OnClickListener() {
+                @Override
+                public void onClick(View v) {
+                    dismiss();
+                }
+            });
+        }
+    }
+    
+    /**
+     * Set the time (in milliseconds) the tool tip will be displayed. Any number less than or equal
+     * to 0 will cause the tool tip to be displayed indefinitely
+     * @param displayTime The amount of time (in milliseconds) to display the tool tip
+     */
+    public void setNuxDisplayTime(long displayTime) {
+        this.mNuxDisplayTime = displayTime;
+    }
+    
+    private void updateArrows() {
+        if (mPopupWindow != null && mPopupWindow.isShowing()) {
+            if (mPopupWindow.isAboveAnchor()) {
+                mPopupContent.showBottomArrow();
+            } else {
+                mPopupContent.showTopArrow();
+            }
+        }
+    }
+    
+    /**
+     * Dismiss the tool tip
+     */
+    public void dismiss() {
+        unregisterObserver();
+        if (mPopupWindow != null) {
+            mPopupWindow.dismiss();
+        }
+    }
+    
+    private void registerObserver() {
+        unregisterObserver();
+        if (mAnchorViewRef.get() != null) {
+            mAnchorViewRef.get().getViewTreeObserver().addOnScrollChangedListener(mScrollListener);
+        }
+    }
+    
+    private void unregisterObserver() {
+        if (mAnchorViewRef.get() != null) {
+            mAnchorViewRef.get().getViewTreeObserver().addOnScrollChangedListener(mScrollListener);
+        }
+    }
+    
+    private class PopupContentView extends FrameLayout {
+        private ImageView topArrow;
+        private ImageView bottomArrow;
+        private View bodyFrame;
+        private ImageView xOut;
+        
+        public PopupContentView(Context context) {
+            super(context);
+            init();
+        }
+        
+        private void init() {
+            LayoutInflater inflater = LayoutInflater.from(getContext());
+            inflater.inflate(R.layout.com_facebook_tooltip_bubble, this);
+            topArrow = (ImageView) findViewById(R.id.com_facebook_tooltip_bubble_view_top_pointer);
+            bottomArrow = (ImageView) findViewById(
+                    R.id.com_facebook_tooltip_bubble_view_bottom_pointer);
+            bodyFrame = findViewById(R.id.com_facebook_body_frame);
+            xOut = (ImageView) findViewById(R.id.com_facebook_button_xout);
+        }
+        
+        public void showTopArrow() {
+            topArrow.setVisibility(View.VISIBLE);
+            bottomArrow.setVisibility(View.INVISIBLE);
+        }
+        
+        public void showBottomArrow() {
+            topArrow.setVisibility(View.INVISIBLE);
+            bottomArrow.setVisibility(View.VISIBLE);
+        }
+        
+        // Expose so popup content can be sized
+        @Override
+        public void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
+            super.onMeasure(widthMeasureSpec, heightMeasureSpec);
+        }
+    }
+}
diff --git a/facebook/src/com/facebook/widget/WebDialog.java b/facebook/src/com/facebook/widget/WebDialog.java
index 0066d3490..374bbe24d 100644
--- a/facebook/src/com/facebook/widget/WebDialog.java
+++ b/facebook/src/com/facebook/widget/WebDialog.java
@@ -140,9 +140,10 @@ public WebDialog(Context context, String action, Bundle parameters, int theme, O
         parameters.putString(ServerProtocol.DIALOG_PARAM_REDIRECT_URI, REDIRECT_URI);
 
         parameters.putString(ServerProtocol.DIALOG_PARAM_DISPLAY, DISPLAY_TOUCH);
-        parameters.putString(ServerProtocol.DIALOG_PARAM_TYPE, USER_AGENT);
 
-        Uri uri = Utility.buildUri(ServerProtocol.getDialogAuthority(), ServerProtocol.DIALOG_PATH + action,
+        Uri uri = Utility.buildUri(
+                ServerProtocol.getDialogAuthority(),
+                ServerProtocol.getAPIVersion() + "/" + ServerProtocol.DIALOG_PATH + action,
                 parameters);
         this.url = uri.toString();
         onCompleteListener = listener;
diff --git a/facebook/tests/AndroidManifest.xml b/facebook/tests/AndroidManifest.xml
index 1509af65d..09b8b240b 100644
--- a/facebook/tests/AndroidManifest.xml
+++ b/facebook/tests/AndroidManifest.xml
@@ -19,6 +19,7 @@
         <activity android:name="com.facebook.LoginActivity" />
         <activity android:name="com.facebook.FacebookActivityTests$FacebookTestActivity" />
         <meta-data android:name="com.facebook.sdk.ApplicationId" android:value="@string/app_id"/>
+        <meta-data android:name="com.facebook.sdk.ClientToken" android:value="@string/client_token"/>
     </application>
     <!--
     This declares that this application uses the instrumentation test runner targeting
diff --git a/facebook/tests/build.gradle b/facebook/tests/build.gradle
index 1a7be02eb..166b4e5e6 100644
--- a/facebook/tests/build.gradle
+++ b/facebook/tests/build.gradle
@@ -14,16 +14,20 @@ android {
         targetSdkVersion 19
     }
 
+    lintOptions {
+        abortOnError false
+    }
+
     sourceSets {
         main {
             manifest.srcFile 'AndroidManifest.xml'
             java.srcDirs = ['src']
             res.srcDirs = ['res']
+            assets.srcDirs = ['assets']
         }
 
         instrumentTest {
             java.srcDirs = ['src']
-            assets.srcDirs = ['assets']
         }
     }
 }
diff --git a/facebook/tests/res/values/strings.xml b/facebook/tests/res/values/strings.xml
index 05dacbbfd..2331e1e47 100644
--- a/facebook/tests/res/values/strings.xml
+++ b/facebook/tests/res/values/strings.xml
@@ -17,4 +17,5 @@
 
 <resources>
     <string name="app_id">1234567890</string>
+    <string name="client_token">abcdef123456</string>
 </resources>
diff --git a/facebook/tests/src/com/facebook/AsyncRequestTests.java b/facebook/tests/src/com/facebook/AsyncRequestTests.java
index 07857df61..f30af6bb7 100644
--- a/facebook/tests/src/com/facebook/AsyncRequestTests.java
+++ b/facebook/tests/src/com/facebook/AsyncRequestTests.java
@@ -95,7 +95,8 @@ public void testExecuteBatchWithNullRequestThrows() throws Exception {
     @MediumTest
     @LargeTest
     public void testExecuteSingleGet() {
-        Request request = new Request(null, "TourEiffel", null, null, new ExpectSuccessCallback() {
+        final TestSession session = openTestSessionWithSharedUser();
+        Request request = new Request(session, "TourEiffel", null, null, new ExpectSuccessCallback() {
             @Override
             protected void performAsserts(Response response) {
                 assertNotNull(response);
@@ -115,7 +116,8 @@ protected void performAsserts(Response response) {
     @MediumTest
     @LargeTest
     public void testExecuteSingleGetUsingHttpURLConnection() {
-        Request request = new Request(null, "TourEiffel", null, null, new ExpectSuccessCallback() {
+        final TestSession session = openTestSessionWithSharedUser();
+        Request request = new Request(session, "TourEiffel", null, null, new ExpectSuccessCallback() {
             @Override
             protected void performAsserts(Response response) {
                 assertNotNull(response);
@@ -136,7 +138,8 @@ protected void performAsserts(Response response) {
     @MediumTest
     @LargeTest
     public void testExecuteSingleGetFailureCase() {
-        Request request = new Request(null, "-1", null, null, new ExpectFailureCallback());
+        final TestSession session = openTestSessionWithSharedUser();
+        Request request = new Request(session, "-1", null, null, new ExpectFailureCallback());
 
         TestRequestAsyncTask task = new TestRequestAsyncTask(request);
 
diff --git a/facebook/tests/src/com/facebook/AuthorizationClientTests.java b/facebook/tests/src/com/facebook/AuthorizationClientTests.java
index 0a96adf35..f931578dd 100644
--- a/facebook/tests/src/com/facebook/AuthorizationClientTests.java
+++ b/facebook/tests/src/com/facebook/AuthorizationClientTests.java
@@ -229,110 +229,6 @@ public void testGetTokenHandlesNoResult() {
         assertEquals(PERMISSIONS.size(), request.getPermissions().size());
     }
 
-    // KatanaLoginDialogAuthHandler tests
-
-    @SmallTest
-    @MediumTest
-    @LargeTest
-    public void testLoginDialogHandlesSuccess() {
-        Bundle bundle = new Bundle();
-        bundle.putStringArrayList(NativeProtocol.EXTRA_PERMISSIONS, PERMISSIONS);
-        bundle.putLong(NativeProtocol.EXTRA_EXPIRES_SECONDS_SINCE_EPOCH, new Date().getTime() / 1000 + EXPIRES_IN_DELTA);
-        bundle.putString(NativeProtocol.EXTRA_ACCESS_TOKEN, ACCESS_TOKEN);
-
-        Intent intent = new Intent();
-        intent.putExtras(bundle);
-
-        MockAuthorizationClient client = new MockAuthorizationClient();
-        AuthorizationClient.KatanaLoginDialogAuthHandler handler = client.new KatanaLoginDialogAuthHandler();
-
-        AuthorizationClient.AuthorizationRequest request = createRequest();
-        client.setRequest(request);
-        handler.onActivityResult(0, Activity.RESULT_OK, intent);
-
-        assertNotNull(client.result);
-        assertEquals(AuthorizationClient.Result.Code.SUCCESS, client.result.code);
-
-        AccessToken token = client.result.token;
-        assertNotNull(token);
-        assertEquals(ACCESS_TOKEN, token.getToken());
-        assertDateDiffersWithinDelta(new Date(), token.getExpires(), EXPIRES_IN_DELTA * 1000, 1000);
-        assertEquals(PERMISSIONS, token.getPermissions());
-    }
-
-    @SmallTest
-    @MediumTest
-    @LargeTest
-    public void testLoginDialogHandlesCancel() {
-        Bundle bundle = new Bundle();
-        bundle.putString(NativeProtocol.STATUS_ERROR_TYPE, NativeProtocol.ERROR_USER_CANCELED);
-
-        Intent intent = new Intent();
-        intent.putExtras(bundle);
-
-        MockAuthorizationClient client = new MockAuthorizationClient();
-        AuthorizationClient.KatanaLoginDialogAuthHandler handler = client.new KatanaLoginDialogAuthHandler();
-
-        AuthorizationClient.AuthorizationRequest request = createRequest();
-        client.setRequest(request);
-        handler.onActivityResult(0, Activity.RESULT_CANCELED, intent);
-
-        assertNotNull(client.result);
-        assertEquals(AuthorizationClient.Result.Code.CANCEL, client.result.code);
-
-        AccessToken token = client.result.token;
-        assertNull(token);
-        assertNull(client.result.errorMessage);
-    }
-
-    @SmallTest
-    @MediumTest
-    @LargeTest
-    public void testLoginDialogHandlesError() {
-        Bundle bundle = new Bundle();
-        bundle.putString(NativeProtocol.STATUS_ERROR_TYPE, ERROR_MESSAGE);
-
-        Intent intent = new Intent();
-        intent.putExtras(bundle);
-
-        MockAuthorizationClient client = new MockAuthorizationClient();
-        AuthorizationClient.KatanaLoginDialogAuthHandler handler = client.new KatanaLoginDialogAuthHandler();
-
-        AuthorizationClient.AuthorizationRequest request = createRequest();
-        client.setRequest(request);
-        handler.onActivityResult(0, Activity.RESULT_OK, intent);
-
-        assertNotNull(client.result);
-        assertEquals(AuthorizationClient.Result.Code.ERROR, client.result.code);
-
-        AccessToken token = client.result.token;
-        assertNull(token);
-        assertNotNull(client.result.errorMessage);
-        assertEquals(ERROR_MESSAGE, client.result.errorMessage);
-    }
-
-    @SmallTest
-    @MediumTest
-    @LargeTest
-    public void testLoginDialogHandlesDisabled() {
-        Bundle bundle = new Bundle();
-        bundle.putInt(NativeProtocol.EXTRA_PROTOCOL_VERSION, NativeProtocol.PROTOCOL_VERSION_20121101);
-        bundle.putString(NativeProtocol.STATUS_ERROR_TYPE, NativeProtocol.ERROR_SERVICE_DISABLED);
-
-        Intent intent = new Intent();
-        intent.putExtras(bundle);
-
-        MockAuthorizationClient client = new MockAuthorizationClient();
-        AuthorizationClient.KatanaLoginDialogAuthHandler handler = client.new KatanaLoginDialogAuthHandler();
-
-        AuthorizationClient.AuthorizationRequest request = createRequest();
-        client.setRequest(request);
-        handler.onActivityResult(0, Activity.RESULT_OK, intent);
-
-        assertNull(client.result);
-        assertTrue(client.triedNextHandler);
-    }
-
     // KatanaProxyAuthHandler tests
 
     @SmallTest
@@ -469,7 +365,7 @@ public Response createResponse() {
                     String fbid = mapAccessTokenToFbid.get(accessToken);
                     GraphUser user = GraphObject.Factory.create(GraphUser.class);
                     user.setId(fbid);
-                    return new Response(this, null, user, false);
+                    return new Response(this, null, null, user, false);
                 }
             };
         }
@@ -492,7 +388,7 @@ public Response createResponse() {
                     GraphMultiResult result = GraphObject.Factory.create(GraphMultiResult.class);
                     result.setProperty("data", data);
 
-                    return new Response(this, null, result, false);
+                    return new Response(this, null, null, result, false);
                 }
             };
         }
@@ -544,7 +440,9 @@ public void testReauthorizationWithSameFbidSucceeds() throws Exception {
         AccessToken resultToken = client.result.token;
         assertNotNull(resultToken);
         assertEquals(USER_1_ACCESS_TOKEN, resultToken.getToken());
-        assertEquals(PERMISSIONS, resultToken.getPermissions());
+
+        // We don't care about ordering.
+        assertEquals(new HashSet<String>(PERMISSIONS), new HashSet<String>(resultToken.getPermissions()));
     }
 
     @MediumTest
diff --git a/facebook/tests/src/com/facebook/BatchRequestTests.java b/facebook/tests/src/com/facebook/BatchRequestTests.java
index 7a863649f..d75d31ab5 100644
--- a/facebook/tests/src/com/facebook/BatchRequestTests.java
+++ b/facebook/tests/src/com/facebook/BatchRequestTests.java
@@ -40,6 +40,11 @@ protected void setUp() throws Exception {
         Request.setDefaultBatchApplicationId(null);
     }
 
+    protected String[] getPermissionsForDefaultTestSession()
+    {
+        return new String[] { "email", "publish_actions", "read_stream" };
+    };
+
     @SmallTest
     @MediumTest
     @LargeTest
@@ -89,12 +94,12 @@ public void testExecuteBatchRequestsPathEncoding() throws IOException {
         // ensures that paths passed to batch requests are encoded properly before
         // we send it up to the server
 
-        setBatchApplicationIdForTestApp();
+        TestSession session = openTestSessionWithSharedUser();
 
-        Request request1 = new Request(null, "TourEiffel");
+        Request request1 = new Request(session, "TourEiffel");
         request1.setBatchEntryName("eiffel");
         request1.setBatchEntryOmitResultOnSuccess(false);
-        Request request2 = new Request(null, "{result=eiffel:$.id}");
+        Request request2 = new Request(session, "{result=eiffel:$.id}");
 
         List<Response> responses = Request.executeBatchAndWait(request1, request2);
         assertEquals(2, responses.size());
@@ -113,10 +118,10 @@ public void testExecuteBatchRequestsPathEncoding() throws IOException {
     @MediumTest
     @LargeTest
     public void testExecuteBatchedGets() throws IOException {
-        setBatchApplicationIdForTestApp();
+        TestSession session = openTestSessionWithSharedUser();
 
-        Request request1 = new Request(null, "TourEiffel");
-        Request request2 = new Request(null, "SpaceNeedle");
+        Request request1 = new Request(session, "TourEiffel");
+        Request request2 = new Request(session, "SpaceNeedle");
 
         List<Response> responses = Request.executeBatchAndWait(request1, request2);
         assertEquals(2, responses.size());
@@ -160,8 +165,10 @@ public void testBatchPostStatusUpdate() {
 
         Request postRequest1 = Request.newPostRequest(session, "me/feed", statusUpdate1, null);
         postRequest1.setBatchEntryName("postRequest1");
+        postRequest1.setBatchEntryOmitResultOnSuccess(false);
         Request postRequest2 = Request.newPostRequest(session, "me/feed", statusUpdate2, null);
         postRequest2.setBatchEntryName("postRequest2");
+        postRequest2.setBatchEntryOmitResultOnSuccess(false);
         Request getRequest1 = new Request(session, "{result=postRequest1:$.id}");
         Request getRequest2 = new Request(session, "{result=postRequest2:$.id}");
 
@@ -207,7 +214,7 @@ public void testBatchWithValidSessionAndNoSession() {
         TestSession session = openTestSessionWithSharedUser();
 
         Request request1 = new Request(session, "me");
-        Request request2 = new Request(null, "zuck");
+        Request request2 = new Request(null, "me");
 
         List<Response> responses = Request.executeBatchAndWait(request1, request2);
         assertNotNull(responses);
@@ -217,18 +224,16 @@ public void testBatchWithValidSessionAndNoSession() {
         GraphUser user2 = responses.get(1).getGraphObjectAs(GraphUser.class);
 
         assertNotNull(user1);
-        assertNotNull(user2);
+        assertNull(user2);
 
-        assertFalse(user1.getId().equals(user2.getId()));
         assertEquals(session.getTestUserId(), user1.getId());
-        assertEquals("4", user2.getId());
     }
 
     @LargeTest
     public void testBatchWithNoSessionAndValidSession() {
         TestSession session = openTestSessionWithSharedUser();
 
-        Request request1 = new Request(null, "zuck");
+        Request request1 = new Request(null, "me");
         Request request2 = new Request(session, "me");
 
         List<Response> responses = Request.executeBatchAndWait(request1, request2);
@@ -238,11 +243,9 @@ public void testBatchWithNoSessionAndValidSession() {
         GraphUser user1 = responses.get(0).getGraphObjectAs(GraphUser.class);
         GraphUser user2 = responses.get(1).getGraphObjectAs(GraphUser.class);
 
-        assertNotNull(user1);
+        assertNull(user1);
         assertNotNull(user2);
 
-        assertFalse(user1.getId().equals(user2.getId()));
-        assertEquals("4", user1.getId());
         assertEquals(session.getTestUserId(), user2.getId());
     }
 
@@ -252,8 +255,8 @@ public void testBatchWithTwoSessionlessRequestsAndDefaultAppID() {
         String appId = session.getApplicationId();
         Request.setDefaultBatchApplicationId(appId);
 
-        Request request1 = new Request(null, "zuck");
-        Request request2 = new Request(null, "zuck");
+        Request request1 = new Request(null, "me");
+        Request request2 = new Request(null, "me");
 
         List<Response> responses = Request.executeBatchAndWait(request1, request2);
         assertNotNull(responses);
@@ -262,11 +265,8 @@ public void testBatchWithTwoSessionlessRequestsAndDefaultAppID() {
         GraphUser user1 = responses.get(0).getGraphObjectAs(GraphUser.class);
         GraphUser user2 = responses.get(1).getGraphObjectAs(GraphUser.class);
 
-        assertNotNull(user1);
-        assertNotNull(user2);
-
-        assertEquals("4", user1.getId());
-        assertEquals("4", user2.getId());
+        assertNull(user1);
+        assertNull(user2);
     }
 
     @LargeTest
diff --git a/facebook/tests/src/com/facebook/FacebookActivityTestCase.java b/facebook/tests/src/com/facebook/FacebookActivityTestCase.java
index ad2753abe..c0afc8c73 100644
--- a/facebook/tests/src/com/facebook/FacebookActivityTestCase.java
+++ b/facebook/tests/src/com/facebook/FacebookActivityTestCase.java
@@ -25,6 +25,7 @@
 import android.os.Handler;
 import android.test.ActivityInstrumentationTestCase2;
 import android.util.Log;
+import com.facebook.android.Util;
 import com.facebook.model.GraphObject;
 import com.facebook.internal.Utility;
 import junit.framework.AssertionFailedError;
@@ -45,6 +46,7 @@
 
     private static String applicationId;
     private static String applicationSecret;
+    private static String clientToken;
 
     public final static String SECOND_TEST_USER_TAG = "Second";
     public final static String THIRD_TEST_USER_TAG = "Third";
@@ -62,6 +64,8 @@ public FacebookActivityTestCase(Class<T> activityClass) {
         super("", activityClass);
     }
 
+    protected String[] getPermissionsForDefaultTestSession() { return null; };
+
     // Returns an un-opened TestSession
     protected TestSession getTestSessionWithSharedUser() {
         return getTestSessionWithSharedUser(null);
@@ -97,7 +101,7 @@ protected TestSession openTestSessionWithSharedUser() {
     }
 
     protected TestSession openTestSessionWithSharedUser(String sessionUniqueUserTag) {
-        return openTestSessionWithSharedUserAndPermissions(sessionUniqueUserTag, (String[]) null);
+        return openTestSessionWithSharedUserAndPermissions(sessionUniqueUserTag, getPermissionsForDefaultTestSession());
     }
 
     protected TestSession openTestSessionWithSharedUserAndPermissions(String sessionUniqueUserTag,
@@ -151,11 +155,11 @@ public void run() {
 
     protected synchronized void readApplicationIdAndSecret() {
         synchronized (FacebookTestCase.class) {
-            if (applicationId != null && applicationSecret != null) {
+            if (applicationId != null && applicationSecret != null && clientToken != null) {
                 return;
             }
 
-            AssetManager assets = getInstrumentation().getContext().getResources().getAssets();
+            AssetManager assets = getActivity().getResources().getAssets();
             InputStream stream = null;
             final String errorMessage = "could not read applicationId and applicationSecret from config.json; ensure "
                     + "you have run 'configure_unit_tests.sh'. Error: ";
@@ -172,9 +176,11 @@ protected synchronized void readApplicationIdAndSecret() {
 
                 applicationId = jsonObject.optString("applicationId");
                 applicationSecret = jsonObject.optString("applicationSecret");
+                clientToken = jsonObject.optString("clientToken");
 
-                if (Utility.isNullOrEmpty(applicationId) || Utility.isNullOrEmpty(applicationSecret)) {
-                    fail(errorMessage + "one or both config values are missing");
+                if (Utility.isNullOrEmpty(applicationId) || Utility.isNullOrEmpty(applicationSecret) ||
+                        Utility.isNullOrEmpty(clientToken)) {
+                    fail(errorMessage + "config values are missing");
                 }
 
                 TestSession.setTestApplicationId(applicationId);
@@ -230,6 +236,9 @@ protected void setUp() throws Exception {
         // Make sure we have read application ID and secret.
         readApplicationIdAndSecret();
 
+        Settings.setApplicationId(applicationId);
+        Settings.setClientToken(clientToken);
+
         // These are useful for debugging unit test failures.
         Settings.addLoggingBehavior(LoggingBehavior.REQUESTS);
         Settings.addLoggingBehavior(LoggingBehavior.INCLUDE_ACCESS_TOKENS);
@@ -385,7 +394,7 @@ protected File createTempFileFromAsset(String assetPath) throws IOException {
         FileOutputStream outStream = null;
 
         try {
-            AssetManager assets = getInstrumentation().getContext().getResources().getAssets();
+            AssetManager assets = getActivity().getResources().getAssets();
             inputStream = assets.open(assetPath);
 
             File outputDir = getActivity().getCacheDir(); // context being the Activity pointer
diff --git a/facebook/tests/src/com/facebook/FacebookAppLinkResolverTests.java b/facebook/tests/src/com/facebook/FacebookAppLinkResolverTests.java
new file mode 100644
index 000000000..2aca415ad
--- /dev/null
+++ b/facebook/tests/src/com/facebook/FacebookAppLinkResolverTests.java
@@ -0,0 +1,205 @@
+/**
+ * Copyright 2010-present Facebook.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.facebook;
+
+import android.net.Uri;
+import android.os.Handler;
+import android.test.AndroidTestCase;
+import bolts.AppLink;
+import bolts.Continuation;
+import bolts.Task;
+
+import java.util.ArrayList;
+import java.util.List;
+
+public class FacebookAppLinkResolverTests extends FacebookTestCase {
+    private Task resolveTask;
+
+    public void testSingleUrl() {
+        String testUrlString = "https://fb.me/732873156764191";
+        Uri testUrl = Uri.parse(testUrlString);
+        Uri testWebUri = Uri.parse("http://www.facebook.com/");
+        ArrayList<AppLink.Target> testTargets = new ArrayList<AppLink.Target>();
+        testTargets.add(new AppLink.Target(
+                "com.myapp",
+                null,
+                Uri.parse("myapp://3"),
+                "my app"));
+        testTargets.add(new AppLink.Target(
+                "com.myapp-test",
+                null,
+                Uri.parse("myapp-test://4"),
+                "my test app"));
+        try {
+            executeResolverOnBlockerThread(new FacebookAppLinkResolver(), testUrl);
+
+            getTestBlocker().waitForSignals(1);
+
+            assertNotNull(resolveTask);
+
+            Task<AppLink> singleUrlResolveTask = (Task<AppLink>)resolveTask;
+
+            assertTrue(singleUrlResolveTask.isCompleted() &&
+                    !singleUrlResolveTask.isCancelled() &&
+                    !singleUrlResolveTask.isFaulted());
+
+            AppLink appLink = singleUrlResolveTask.getResult();
+
+            assertEquals(appLink.getSourceUrl(), testUrl);
+            assertEquals(appLink.getWebUrl(), testWebUri);
+            assertTrue(targetListsAreEqual(appLink.getTargets(), testTargets));
+        } catch (Exception e) {
+            // Forcing the test to fail with details
+            assertNull(e);
+        }
+    }
+
+    public void testUrlWithNoAppLinkData() {
+        String testNoAppLinkUrlString = "https://fb.me/732873156764191_no_app_link";
+        Uri testNoAppLinkUrl = Uri.parse(testNoAppLinkUrlString);
+        try {
+            executeResolverOnBlockerThread(new FacebookAppLinkResolver(), testNoAppLinkUrl);
+
+            getTestBlocker().waitForSignals(1);
+
+            assertNotNull(resolveTask);
+
+            Task<AppLink> singleUrlResolveTask = (Task<AppLink>)resolveTask;
+
+            assertTrue(singleUrlResolveTask.isCompleted() &&
+                    !singleUrlResolveTask.isCancelled() &&
+                    !singleUrlResolveTask.isFaulted());
+
+            AppLink appLink = singleUrlResolveTask.getResult();
+            assertNull(appLink);
+        } catch (Exception e) {
+            // Forcing the test to fail with details
+            assertNull(e);
+        }
+    }
+
+    public void testCachedAppLinkData() {
+        String testUrlString = "https://fb.me/732873156764191";
+        Uri testUrl = Uri.parse(testUrlString);
+        Uri testWebUri = Uri.parse("http://www.facebook.com/");
+        ArrayList<AppLink.Target> testTargets = new ArrayList<AppLink.Target>();
+        testTargets.add(new AppLink.Target(
+                "com.myapp",
+                null,
+                Uri.parse("myapp://3"),
+                "my app"));
+        testTargets.add(new AppLink.Target(
+                "com.myapp-test",
+                null,
+                Uri.parse("myapp-test://4"),
+                "my test app"));
+
+        try {
+            FacebookAppLinkResolver resolver = new FacebookAppLinkResolver();
+
+            // This will prefetch the app link
+            executeResolverOnBlockerThread(resolver, testUrl);
+            getTestBlocker().waitForSignals(1);
+            assertNotNull(resolveTask);
+
+            // Now let's fetch it again. This should complete the task synchronously.
+            Task<AppLink> cachedUrlResolveTask = resolver.getAppLinkFromUrlInBackground(testUrl);
+
+            assertTrue(cachedUrlResolveTask.isCompleted() &&
+                    !cachedUrlResolveTask.isCancelled() &&
+                    !cachedUrlResolveTask.isFaulted());
+
+            AppLink appLink = cachedUrlResolveTask.getResult();
+
+            assertEquals(appLink.getSourceUrl(), testUrl);
+            assertEquals(appLink.getWebUrl(), testWebUri);
+            assertTrue(targetListsAreEqual(appLink.getTargets(), testTargets));
+        } catch (Exception e) {
+            // Forcing the test to fail with details
+            assertNull(e);
+        }
+    }
+
+    public void executeResolverOnBlockerThread(final FacebookAppLinkResolver resolver, final Uri testUrl) {
+        final TestBlocker blocker = getTestBlocker();
+        Runnable runnable = new Runnable() {
+            public void run() {
+                try {
+                    resolveTask = resolver.getAppLinkFromUrlInBackground(testUrl);
+                    resolveTask.continueWith(new Continuation() {
+                        @Override
+                        public Object then(Task task) throws Exception {
+                            // Once the task is complete, unblock the test thread, so it can inspect for errors/results.
+                            blocker.signal();
+                            return null;
+                        }
+                    });
+                } catch (Exception e) {
+                    // Get back to the test case if there was an uncaught exception
+                    blocker.signal();
+                }
+            }
+        };
+
+        Handler handler = new Handler(blocker.getLooper());
+        handler.post(runnable);
+    }
+
+    private static boolean targetListsAreEqual(List<AppLink.Target> list1, List<AppLink.Target> list2) {
+        if (list1 == null) {
+            return list2 == null;
+        } else if (list2 == null || list1.size() != list2.size()) {
+            return false;
+        }
+
+        ArrayList<AppLink.Target> list2Copy = new ArrayList<AppLink.Target>(list2);
+
+        for(int i = 0; i < list1.size(); i++) {
+            int j;
+            for (j = 0; j < list2Copy.size(); j++) {
+                if (targetsAreEqual(list1.get(i), list2Copy.get(j))) {
+                    break;
+                }
+            }
+
+            if (j < list2Copy.size()) {
+                // Found a match. Remove from the copy to make sure the same target isn't matched twice.
+                list2Copy.remove(j);
+            } else {
+                // Match not found
+                return false;
+            }
+        }
+        return true;
+    }
+
+    private static boolean targetsAreEqual(AppLink.Target target1, AppLink.Target target2) {
+        boolean isEqual =
+                objectsAreEqual(target1.getPackageName(), target2.getPackageName()) &&
+                objectsAreEqual(target1.getClassName(), target2.getClassName()) &&
+                objectsAreEqual(target1.getAppName(), target2.getAppName()) &&
+                objectsAreEqual(target1.getUrl(), target2.getUrl()) ;
+
+        return isEqual;
+    }
+
+    private static boolean objectsAreEqual(Object s1, Object s2) {
+        return s1 == null
+                ? s2 == null
+                : s1.equals(s2);
+    }
+}
diff --git a/facebook/tests/src/com/facebook/GraphRequestTests.java b/facebook/tests/src/com/facebook/GraphRequestTests.java
index 5ff2a975d..7157823c3 100644
--- a/facebook/tests/src/com/facebook/GraphRequestTests.java
+++ b/facebook/tests/src/com/facebook/GraphRequestTests.java
@@ -25,6 +25,11 @@
 // to the underlying request/batch plumbing.
 public class GraphRequestTests extends FacebookTestCase {
 
+    protected String[] getPermissionsForDefaultTestSession()
+    {
+        return new String[] { "email", "publish_actions", "read_stream" };
+    };
+
     @LargeTest
     public void testCommentRoundTrip() {
         TestSession session = openTestSessionWithSharedUser();
@@ -60,31 +65,4 @@ public void testCommentRoundTrip() {
         assertNotNull(comment2Message);
         assertEquals(commentMessage, comment2Message);
     }
-
-    @LargeTest
-    public void testEventRoundTrip() {
-        TestSession session = openTestSessionWithSharedUserAndPermissions(null, "create_event");
-
-        GraphObject event = GraphObject.Factory.create();
-        // Android emulators tend to not have the right date/time. To avoid issues with posting events in the past
-        // or too far in the future, we use a constant year. This test will break in 2030, angering our robot overlords.
-        Date startTime = new Date(130, 2, 17, 12, 34, 56);
-        event.setProperty("name", "My awesome St. Patrick's Day party on " + startTime.toString());
-        final String eventDescription = "This is a great event. You should all come.";
-        event.setProperty("description", eventDescription);
-        Date endTime = new Date(startTime.getTime() + 3600 * 1000);
-        event.setProperty("start_time", startTime);
-        event.setProperty("end_time", endTime);
-        event.setProperty("location", "My house");
-
-        GraphObject event1 = batchCreateAndGet(session, "me/events", event, null, GraphObject.class);
-        assertNotNull(event1);
-        assertEquals(eventDescription, event1.getProperty("description"));
-
-        event1.removeProperty("id");
-        GraphObject event2 = batchCreateAndGet(session, "me/events", event1, null, GraphObject.class);
-        assertNotNull(event2);
-        assertEquals(eventDescription, event2.getProperty("description"));
-    }
-
 }
diff --git a/facebook/tests/src/com/facebook/RequestTests.java b/facebook/tests/src/com/facebook/RequestTests.java
index bdb34a78b..99da7ab6d 100644
--- a/facebook/tests/src/com/facebook/RequestTests.java
+++ b/facebook/tests/src/com/facebook/RequestTests.java
@@ -23,6 +23,7 @@
 import android.test.suitebuilder.annotation.LargeTest;
 import android.test.suitebuilder.annotation.MediumTest;
 import android.test.suitebuilder.annotation.SmallTest;
+import com.facebook.internal.ServerProtocol;
 import com.facebook.model.*;
 
 import java.io.File;
@@ -37,6 +38,11 @@
 public class RequestTests extends FacebookTestCase {
     private final static String TEST_OG_TYPE = "facebooksdktests:test";
 
+    protected String[] getPermissionsForDefaultTestSession()
+    {
+        return new String[] { "email", "publish_actions", "read_stream" };
+    };
+
     @SmallTest
     @MediumTest
     @LargeTest
@@ -343,7 +349,7 @@ public void testSingleGetToHttpRequest() throws Exception {
         assertTrue(connection != null);
 
         assertEquals("GET", connection.getRequestMethod());
-        assertEquals("/TourEiffel", connection.getURL().getPath());
+        assertEquals("/" + ServerProtocol.getAPIVersion() + "/TourEiffel", connection.getURL().getPath());
 
         assertTrue(connection.getRequestProperty("User-Agent").startsWith("FBAndroidSDK"));
 
@@ -352,15 +358,33 @@ public void testSingleGetToHttpRequest() throws Exception {
         assertEquals("json", uri.getQueryParameter("format"));
     }
 
+    @SmallTest
+    @MediumTest
+    @LargeTest
+    public void testBuildsClientTokenIfNeeded() throws Exception {
+        Request requestMe = new Request(null, "TourEiffel");
+        HttpURLConnection connection = Request.toHttpConnection(requestMe);
+
+        assertTrue(connection != null);
+
+        Uri uri = Uri.parse(connection.getURL().toString());
+        String accessToken = uri.getQueryParameter("access_token");
+        assertNotNull(accessToken);
+        assertTrue(accessToken.contains(Settings.getApplicationId()));
+        assertTrue(accessToken.contains(Settings.getClientToken()));
+    }
+
     @MediumTest
     @LargeTest
     public void testExecuteSingleGet() {
-        Request request = new Request(null, "TourEiffel");
+        TestSession session = openTestSessionWithSharedUser();
+        Request request = new Request(session, "TourEiffel");
         Response response = request.executeAndWait();
 
         assertTrue(response != null);
         assertTrue(response.getError() == null);
         assertTrue(response.getGraphObject() != null);
+        assertNotNull(response.getRawResponse());
 
         GraphPlace graphPlace = response.getGraphObjectAs(GraphPlace.class);
         assertEquals("Paris", graphPlace.getLocation().getCity());
@@ -369,7 +393,8 @@ public void testExecuteSingleGet() {
     @MediumTest
     @LargeTest
     public void testExecuteSingleGetUsingHttpURLConnection() throws IOException {
-        Request request = new Request(null, "TourEiffel");
+        TestSession session = openTestSessionWithSharedUser();
+        Request request = new Request(session, "TourEiffel");
         HttpURLConnection connection = Request.toHttpConnection(request);
 
         List<Response> responses = Request.executeConnectionAndWait(connection, Arrays.asList(new Request[]{request}));
@@ -381,6 +406,7 @@ public void testExecuteSingleGetUsingHttpURLConnection() throws IOException {
         assertTrue(response != null);
         assertTrue(response.getError() == null);
         assertTrue(response.getGraphObject() != null);
+        assertNotNull(response.getRawResponse());
 
         GraphPlace graphPlace = response.getGraphObjectAs(GraphPlace.class);
         assertEquals("Paris", graphPlace.getLocation().getCity());
@@ -388,7 +414,7 @@ public void testExecuteSingleGetUsingHttpURLConnection() throws IOException {
         // Make sure calling code can still access HTTP headers and call disconnect themselves.
         int code = connection.getResponseCode();
         assertEquals(200, code);
-        assertTrue(connection.getHeaderFields().keySet().contains("Content-Length"));
+        assertTrue(connection.getHeaderFields().keySet().contains("Content-Type"));
         connection.disconnect();
     }
 
@@ -458,6 +484,7 @@ static void validateMeResponse(TestSession session, Response response) {
         GraphUser me = response.getGraphObjectAs(GraphUser.class);
         assertNotNull(me);
         assertEquals(session.getTestUserId(), me.getId());
+        assertNotNull(response.getRawResponse());
     }
 
     @MediumTest
@@ -481,6 +508,8 @@ static void validateMyFriendsResponse(TestSession session, Response response) {
 
         List<GraphObject> results = graphResult.getData();
         assertNotNull(results);
+
+        assertNotNull(response.getRawResponse());
     }
 
     @MediumTest
@@ -503,6 +532,8 @@ public void testExecutePlaceRequestWithLocation() {
 
         List<GraphObject> results = graphResult.getData();
         assertNotNull(results);
+
+        assertNotNull(response.getRawResponse());
     }
 
     @MediumTest
@@ -522,6 +553,8 @@ public void testExecutePlaceRequestWithSearchText() {
 
         List<GraphObject> results = graphResult.getData();
         assertNotNull(results);
+
+        assertNotNull(response.getRawResponse());
     }
 
     @MediumTest
@@ -544,6 +577,8 @@ public void testExecutePlaceRequestWithLocationAndSearchText() {
 
         List<GraphObject> results = graphResult.getData();
         assertNotNull(results);
+
+        assertNotNull(response.getRawResponse());
     }
 
     private String executePostOpenGraphRequest() {
@@ -563,6 +598,8 @@ private String executePostOpenGraphRequest() {
         assertNotNull(graphResult);
         assertNotNull(graphResult.getProperty("id"));
 
+        assertNotNull(response.getRawResponse());
+
         return (String) graphResult.getProperty("id");
     }
 
@@ -586,6 +623,7 @@ public void testDeleteObjectRequest() {
         assertNotNull(result);
 
         assertTrue((Boolean) result.getProperty(Response.NON_JSON_RESPONSE_PROPERTY));
+        assertNotNull(response.getRawResponse());
     }
 
     @LargeTest
@@ -605,6 +643,7 @@ public void testUpdateOpenGraphObjectRequest() {
 
         GraphObject result = response.getGraphObject();
         assertNotNull(result);
+        assertNotNull(response.getRawResponse());
     }
 
     @LargeTest
@@ -620,6 +659,7 @@ public void testExecuteUploadPhoto() {
 
         GraphObject result = response.getGraphObject();
         assertNotNull(result);
+        assertNotNull(response.getRawResponse());
     }
 
     @LargeTest
@@ -647,6 +687,7 @@ public void testExecuteUploadPhotoViaFile() throws IOException {
 
             GraphObject result = response.getGraphObject();
             assertNotNull(result);
+            assertNotNull(response.getRawResponse());
         } finally {
             if (outStream != null) {
                 outStream.close();
@@ -672,6 +713,7 @@ public void testUploadVideoFile() throws IOException, URISyntaxException {
 
             GraphObject result = response.getGraphObject();
             assertNotNull(result);
+            assertNotNull(response.getRawResponse());
         } catch (Exception ex) {
             return;
         } finally {
@@ -712,6 +754,8 @@ public void testRestMethodGetUser() {
         GraphObject user = graphObjects.get(0);
         assertNotNull(user);
         assertEquals(testUserId, user.getProperty("uid").toString());
+
+        assertNotNull(response.getRawResponse());
     }
 
     @MediumTest
diff --git a/facebook/tests/src/com/facebook/SettingsTests.java b/facebook/tests/src/com/facebook/SettingsTests.java
index 435de6d40..a96c25347 100644
--- a/facebook/tests/src/com/facebook/SettingsTests.java
+++ b/facebook/tests/src/com/facebook/SettingsTests.java
@@ -17,7 +17,6 @@
 package com.facebook;
 
 import android.os.ConditionVariable;
-import android.test.AndroidTestCase;
 import android.test.suitebuilder.annotation.LargeTest;
 import android.test.suitebuilder.annotation.MediumTest;
 import android.test.suitebuilder.annotation.SmallTest;
@@ -27,7 +26,7 @@
 import java.io.IOException;
 import java.util.concurrent.Executor;
 
-public final class SettingsTests extends AndroidTestCase {
+public final class SettingsTests extends FacebookTestCase {
 
     @SmallTest @MediumTest @LargeTest
     public void testGetExecutor() {
@@ -99,4 +98,26 @@ public void testFacebookDomain() {
 
         Settings.setFacebookDomain("facebook.com");
     }
+
+    @SmallTest @MediumTest @LargeTest
+    public void testLoadDefaults() {
+        Settings.setApplicationId(null);
+        Settings.setClientToken(null);
+
+        Settings.loadDefaultsFromMetadata(getActivity());
+
+        assertEquals("1234567890", Settings.getApplicationId());
+        assertEquals("abcdef123456", Settings.getClientToken());
+    }
+
+    @SmallTest @MediumTest @LargeTest
+    public void testLoadDefaultsDoesNotOverwrite() {
+        Settings.setApplicationId("hello");
+        Settings.setClientToken("world");
+
+        Settings.loadDefaultsFromMetadata(getActivity());
+
+        assertEquals("hello", Settings.getApplicationId());
+        assertEquals("world", Settings.getClientToken());
+    }
 }
diff --git a/gradle/wrapper/gradle-wrapper.properties b/gradle/wrapper/gradle-wrapper.properties
index 75b72d4da..56c0deed9 100644
--- a/gradle/wrapper/gradle-wrapper.properties
+++ b/gradle/wrapper/gradle-wrapper.properties
@@ -1,6 +1,6 @@
-#Wed Feb 05 10:18:08 PST 2014
+#Tue Apr 22 14:47:00 PDT 2014
 distributionBase=GRADLE_USER_HOME
 distributionPath=wrapper/dists
 zipStoreBase=GRADLE_USER_HOME
 zipStorePath=wrapper/dists
-distributionUrl=http\://services.gradle.org/distributions/gradle-1.9-all.zip
+distributionUrl=http\://services.gradle.org/distributions/gradle-1.11-all.zip
diff --git a/libs/bolts.jar b/libs/bolts.jar
new file mode 100644
index 000000000..9a9a1e94b
Binary files /dev/null and b/libs/bolts.jar differ
diff --git a/samples/FriendPickerSample/build.gradle b/samples/FriendPickerSample/build.gradle
index a2cda0280..535d02a65 100644
--- a/samples/FriendPickerSample/build.gradle
+++ b/samples/FriendPickerSample/build.gradle
@@ -13,6 +13,10 @@ android {
         targetSdkVersion 19
     }
 
+    lintOptions {
+        abortOnError false
+    }
+
     sourceSets {
         main {
             manifest.srcFile 'AndroidManifest.xml'
diff --git a/samples/FriendPickerSample/res/values/strings.xml b/samples/FriendPickerSample/res/values/strings.xml
index 747f98078..863108c2a 100644
--- a/samples/FriendPickerSample/res/values/strings.xml
+++ b/samples/FriendPickerSample/res/values/strings.xml
@@ -20,4 +20,7 @@
     <string name="app_id">370546396320150</string>
     <string name="exception">Exception: %1$s</string>
     <string name="ok_button">OK</string>
+    <string name="need_perms_alert_text">In order to pick your friends you need to accept all the permissions on the following page.</string>
+    <string name="need_perms_alert_button_ok">OK</string>
+    <string name="need_perms_alert_button_quit">Quit</string>
 </resources>
diff --git a/samples/FriendPickerSample/src/com/facebook/samples/friendpicker/FriendPickerSampleActivity.java b/samples/FriendPickerSample/src/com/facebook/samples/friendpicker/FriendPickerSampleActivity.java
index 1c8ec2b62..478bd7a5d 100644
--- a/samples/FriendPickerSample/src/com/facebook/samples/friendpicker/FriendPickerSampleActivity.java
+++ b/samples/FriendPickerSample/src/com/facebook/samples/friendpicker/FriendPickerSampleActivity.java
@@ -16,6 +16,8 @@
 
 package com.facebook.samples.friendpicker;
 
+import android.app.AlertDialog;
+import android.content.DialogInterface;
 import android.content.Intent;
 import android.os.Bundle;
 import android.support.v4.app.FragmentActivity;
@@ -23,7 +25,9 @@
 import android.view.View;
 import android.widget.Button;
 import android.widget.TextView;
+
 import com.facebook.AppEventsLogger;
+import com.facebook.Session.NewPermissionsRequest;
 import com.facebook.SessionState;
 import com.facebook.UiLifecycleHelper;
 import com.facebook.model.GraphUser;
@@ -31,8 +35,15 @@
 
 import java.util.ArrayList;
 import java.util.Collection;
+import java.util.List;
 
 public class FriendPickerSampleActivity extends FragmentActivity {
+    private static final List<String> PERMISSIONS = new ArrayList<String>() {
+        {
+            add("user_friends");
+            add("public_profile");
+        }
+    };
     private static final int PICK_FRIENDS_ACTIVITY = 1;
     private Button pickFriendsButton;
     private TextView resultsTextView;
@@ -94,19 +105,70 @@ public void onActivityResult(int requestCode, int resultCode, Intent data) {
     private boolean ensureOpenSession() {
         if (Session.getActiveSession() == null ||
                 !Session.getActiveSession().isOpened()) {
-            Session.openActiveSession(this, true, new Session.StatusCallback() {
-                @Override
-                public void call(Session session, SessionState state, Exception exception) {
-                    onSessionStateChanged(session, state, exception);
-                }
-            });
+            Session.openActiveSession(
+                    this, 
+                    true, 
+                    PERMISSIONS,
+                    new Session.StatusCallback() {
+                        @Override
+                        public void call(Session session, SessionState state, Exception exception) {
+                            onSessionStateChanged(session, state, exception);
+                        }
+                    });
             return false;
         }
         return true;
     }
+    
+    private boolean sessionHasNecessaryPerms(Session session) {
+        if (session != null && session.getPermissions() != null) {
+            for (String requestedPerm : PERMISSIONS) {
+                if (!session.getPermissions().contains(requestedPerm)) {
+                    return false;
+                }
+            }
+            return true;
+        }
+        return false;
+    }
+    
+    private List<String> getMissingPermissions(Session session) {
+        List<String> missingPerms = new ArrayList<String>(PERMISSIONS);
+        if (session != null && session.getPermissions() != null) {
+            for (String requestedPerm : PERMISSIONS) {
+                if (session.getPermissions().contains(requestedPerm)) {
+                    missingPerms.remove(requestedPerm);
+                }
+            }
+        }
+        return missingPerms;
+    }
 
-    private void onSessionStateChanged(Session session, SessionState state, Exception exception) {
-        if (pickFriendsWhenSessionOpened && state.isOpened()) {
+    private void onSessionStateChanged(final Session session, SessionState state, Exception exception) {
+        if (state.isOpened() && !sessionHasNecessaryPerms(session)) {
+            AlertDialog.Builder builder = new AlertDialog.Builder(this);
+            builder.setMessage(R.string.need_perms_alert_text);
+            builder.setPositiveButton(
+                    R.string.need_perms_alert_button_ok, 
+                    new DialogInterface.OnClickListener() {
+                        @Override
+                        public void onClick(DialogInterface dialog, int which) {
+                            session.requestNewReadPermissions(
+                                    new NewPermissionsRequest(
+                                            FriendPickerSampleActivity.this, 
+                                            getMissingPermissions(session)));
+                        }
+                    });
+            builder.setNegativeButton(
+                    R.string.need_perms_alert_button_quit,
+                    new DialogInterface.OnClickListener() {
+                        @Override
+                        public void onClick(DialogInterface dialog, int which) {
+                            finish();
+                        }
+                    });
+            builder.show();
+        } else if (pickFriendsWhenSessionOpened && state.isOpened()) {
             pickFriendsWhenSessionOpened = false;
 
             startPickFriendsActivity();
diff --git a/samples/GraphApiSample/build.gradle b/samples/GraphApiSample/build.gradle
index a2cda0280..535d02a65 100644
--- a/samples/GraphApiSample/build.gradle
+++ b/samples/GraphApiSample/build.gradle
@@ -13,6 +13,10 @@ android {
         targetSdkVersion 19
     }
 
+    lintOptions {
+        abortOnError false
+    }
+
     sourceSets {
         main {
             manifest.srcFile 'AndroidManifest.xml'
diff --git a/samples/HelloFacebookSample/build.gradle b/samples/HelloFacebookSample/build.gradle
index a2cda0280..535d02a65 100644
--- a/samples/HelloFacebookSample/build.gradle
+++ b/samples/HelloFacebookSample/build.gradle
@@ -13,6 +13,10 @@ android {
         targetSdkVersion 19
     }
 
+    lintOptions {
+        abortOnError false
+    }
+
     sourceSets {
         main {
             manifest.srcFile 'AndroidManifest.xml'
diff --git a/samples/PlacePickerSample/build.gradle b/samples/PlacePickerSample/build.gradle
index a2cda0280..535d02a65 100644
--- a/samples/PlacePickerSample/build.gradle
+++ b/samples/PlacePickerSample/build.gradle
@@ -13,6 +13,10 @@ android {
         targetSdkVersion 19
     }
 
+    lintOptions {
+        abortOnError false
+    }
+
     sourceSets {
         main {
             manifest.srcFile 'AndroidManifest.xml'
diff --git a/samples/ProfilePictureSample/build.gradle b/samples/ProfilePictureSample/build.gradle
index a2cda0280..535d02a65 100644
--- a/samples/ProfilePictureSample/build.gradle
+++ b/samples/ProfilePictureSample/build.gradle
@@ -13,6 +13,10 @@ android {
         targetSdkVersion 19
     }
 
+    lintOptions {
+        abortOnError false
+    }
+
     sourceSets {
         main {
             manifest.srcFile 'AndroidManifest.xml'
diff --git a/samples/RPSSample/build.gradle b/samples/RPSSample/build.gradle
index a2cda0280..535d02a65 100644
--- a/samples/RPSSample/build.gradle
+++ b/samples/RPSSample/build.gradle
@@ -13,6 +13,10 @@ android {
         targetSdkVersion 19
     }
 
+    lintOptions {
+        abortOnError false
+    }
+
     sourceSets {
         main {
             manifest.srcFile 'AndroidManifest.xml'
diff --git a/samples/Scrumptious/AndroidManifest.xml b/samples/Scrumptious/AndroidManifest.xml
index c4365dd21..9a83e201c 100644
--- a/samples/Scrumptious/AndroidManifest.xml
+++ b/samples/Scrumptious/AndroidManifest.xml
@@ -11,10 +11,11 @@
     <uses-feature android:name="android.hardware.camera"/>
     <uses-feature android:name="android.hardware.camera.autofocus"/>
     <application android:label="@string/app_name"
-                 android:icon="@drawable/icon"
+                 android:icon="@drawable/add_food"
                  android:name=".ScrumptiousApplication">
         <activity android:name="MainActivity"
                   android:label="@string/app_name"
+                  android:theme="@style/Theme.Scrumptious"
                   android:windowSoftInputMode="adjustResize">
             <intent-filter>
                 <action android:name="android.intent.action.MAIN"/>
diff --git a/samples/Scrumptious/build.gradle b/samples/Scrumptious/build.gradle
index a2cda0280..535d02a65 100644
--- a/samples/Scrumptious/build.gradle
+++ b/samples/Scrumptious/build.gradle
@@ -13,6 +13,10 @@ android {
         targetSdkVersion 19
     }
 
+    lintOptions {
+        abortOnError false
+    }
+
     sourceSets {
         main {
             manifest.srcFile 'AndroidManifest.xml'
diff --git a/samples/Scrumptious/res/drawable-mdpi/logo.png b/samples/Scrumptious/res/drawable-mdpi/logo.png
new file mode 100644
index 000000000..27fd9ffc1
Binary files /dev/null and b/samples/Scrumptious/res/drawable-mdpi/logo.png differ
diff --git a/samples/Scrumptious/res/drawable-xhdpi/logo.png b/samples/Scrumptious/res/drawable-xhdpi/logo.png
new file mode 100644
index 000000000..0fff04bb9
Binary files /dev/null and b/samples/Scrumptious/res/drawable-xhdpi/logo.png differ
diff --git a/samples/Scrumptious/res/drawable/action_eating.png b/samples/Scrumptious/res/drawable/action_eating.png
deleted file mode 100644
index 7b951edf0..000000000
Binary files a/samples/Scrumptious/res/drawable/action_eating.png and /dev/null differ
diff --git a/samples/Scrumptious/res/drawable/action_location.png b/samples/Scrumptious/res/drawable/action_location.png
deleted file mode 100644
index 13dfe86ff..000000000
Binary files a/samples/Scrumptious/res/drawable/action_location.png and /dev/null differ
diff --git a/samples/Scrumptious/res/drawable/action_people.png b/samples/Scrumptious/res/drawable/action_people.png
deleted file mode 100644
index 19546267c..000000000
Binary files a/samples/Scrumptious/res/drawable/action_people.png and /dev/null differ
diff --git a/samples/Scrumptious/res/drawable/action_photo.png b/samples/Scrumptious/res/drawable/action_photo.png
deleted file mode 100644
index 46533cc70..000000000
Binary files a/samples/Scrumptious/res/drawable/action_photo.png and /dev/null differ
diff --git a/samples/Scrumptious/res/drawable/add_food.png b/samples/Scrumptious/res/drawable/add_food.png
new file mode 100644
index 000000000..b556dd6e3
Binary files /dev/null and b/samples/Scrumptious/res/drawable/add_food.png differ
diff --git a/samples/Scrumptious/res/drawable/add_friends.png b/samples/Scrumptious/res/drawable/add_friends.png
new file mode 100644
index 000000000..1cafe3625
Binary files /dev/null and b/samples/Scrumptious/res/drawable/add_friends.png differ
diff --git a/samples/Scrumptious/res/drawable/add_location.png b/samples/Scrumptious/res/drawable/add_location.png
new file mode 100644
index 000000000..2df780552
Binary files /dev/null and b/samples/Scrumptious/res/drawable/add_location.png differ
diff --git a/samples/Scrumptious/res/drawable/add_photo.png b/samples/Scrumptious/res/drawable/add_photo.png
new file mode 100644
index 000000000..48f5740a6
Binary files /dev/null and b/samples/Scrumptious/res/drawable/add_photo.png differ
diff --git a/samples/Scrumptious/res/drawable/button_text_color.xml b/samples/Scrumptious/res/drawable/button_text_color.xml
new file mode 100644
index 000000000..ee8b69573
--- /dev/null
+++ b/samples/Scrumptious/res/drawable/button_text_color.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0" encoding="utf-8"?>
+<selector xmlns:android="http://schemas.android.com/apk/res/android" >
+	<item 
+		android:state_enabled="false"
+		android:color="@color/disabled_button_color"/>
+    <item
+    	android:color="@color/scrumptious_main_orange"/>
+</selector>
diff --git a/samples/Scrumptious/res/drawable/title_bar_logo.png b/samples/Scrumptious/res/drawable/title_bar_logo.png
new file mode 100644
index 000000000..27fd9ffc1
Binary files /dev/null and b/samples/Scrumptious/res/drawable/title_bar_logo.png differ
diff --git a/samples/Scrumptious/res/layout/listitem.xml b/samples/Scrumptious/res/layout/listitem.xml
index 293ef0c7e..543aab35a 100644
--- a/samples/Scrumptious/res/layout/listitem.xml
+++ b/samples/Scrumptious/res/layout/listitem.xml
@@ -23,9 +23,8 @@
 
     <ImageView
             android:id="@+id/icon"
-            android:src="@drawable/action_eating"
-            android:layout_width="60dp"
-            android:layout_height="60dp" />
+            android:layout_width="50dp"
+            android:layout_height="50dp" />
     <LinearLayout
             android:orientation="vertical"
             android:layout_gravity="center_vertical"
@@ -35,16 +34,16 @@
         <TextView
                 android:id="@+id/text1"
                 android:text="test"
-                android:textColor="#333"
+                android:textColor="#FB5820"
                 android:layout_width="wrap_content"
                 android:layout_height="wrap_content"
-                android:textSize="18sp" />
+                android:textSize="16sp" />
         <TextView
                 android:id="@+id/text2"
                 android:text="test2"
-                android:textColor="#6699CC"
+                android:textColor="#E4C897"
                 android:layout_width="wrap_content"
                 android:layout_height="wrap_content"
-                android:textSize="14sp" />
+                android:textSize="12sp" />
     </LinearLayout>
 </LinearLayout>
diff --git a/samples/Scrumptious/res/layout/selection.xml b/samples/Scrumptious/res/layout/selection.xml
index 3367e4840..9e6c2db73 100644
--- a/samples/Scrumptious/res/layout/selection.xml
+++ b/samples/Scrumptious/res/layout/selection.xml
@@ -14,58 +14,88 @@
     See the License for the specific language governing permissions and
     limitations under the License.
 -->
-
-<ScrollView
-        xmlns:android="http://schemas.android.com/apk/res/android"
-        xmlns:facebook="http://schemas.android.com/apk/res-auto"
+<LinearLayout 
+	xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:facebook="http://schemas.android.com/apk/res-auto"
+	android:layout_width="match_parent"
+	android:layout_height="match_parent"
+	android:orientation="vertical">
+	
+	<RelativeLayout 
+		android:layout_width="match_parent"
+		android:layout_height="60dp"
+		android:background="@color/scrumptious_main_orange">
+		
+		<ImageView
+			android:id="@+id/image_title"
+			android:layout_width="wrap_content"
+			android:layout_height="wrap_content"
+			android:layout_margin="16dp"
+			android:layout_centerInParent="true"
+			android:scaleType="fitCenter"
+			android:src="@drawable/title_bar_logo"/>
+		
+        <com.facebook.widget.ProfilePictureView
+            android:id="@+id/selection_profile_pic"
+            android:layout_height="wrap_content"
+            android:layout_width="wrap_content"
+            android:layout_alignParentRight="true"
+            android:layout_centerVertical="true"
+            android:gravity="right|center_vertical"
+            android:layout_margin="10dp"
+            facebook:preset_size="small" />
+        
+	</RelativeLayout>
+	<ScrollView
         android:layout_width="fill_parent"
         android:layout_height="fill_parent"
+        android:fillViewport="true"
         android:background="#FFF">
-    <LinearLayout
-        android:layout_width="fill_parent"
-        android:layout_height="fill_parent"
-        android:orientation="vertical">
+	    <LinearLayout
+	        android:layout_width="fill_parent"
+	        android:layout_height="fill_parent"
+	        android:orientation="vertical">
+	
+	        <com.facebook.scrumptious.FullListView
+	            android:id="@+id/selection_list"
+	            android:layout_width="fill_parent"
+	            android:layout_height="wrap_content"
+	            android:layout_margin="20dp"
+	            android:dividerHeight="@dimen/item_list_padding"
+	            android:divider="#00000000"/>
+	
+	        <ImageView 
+	            android:id="@+id/selected_image"
+	            android:layout_width="match_parent"
+	            android:layout_height="0dp"
+	            android:layout_weight="1"
+	            android:layout_marginLeft="50dp"
+	            android:layout_marginRight="50dp"/>
+	        
+	        <TextView
+	            android:id="@+id/announce_text"
+	            android:layout_width="wrap_content"
+	            android:layout_height="wrap_content"
+	            android:layout_gravity="center"
+	            android:layout_marginTop="10dp"
+	            android:layout_marginBottom="30dp"
+	            android:text="@string/announce"
+	            android:textColor="@drawable/button_text_color"
+	            android:gravity="center" />
+	
+	        <Button
+	            android:id="@+id/message_text"
+	            android:layout_width="wrap_content"
+	            android:layout_height="wrap_content"
+	            android:layout_gravity="center"
+	            android:layout_marginTop="10dp"
+	            android:layout_marginBottom="10dp"
+	            android:text="@string/message"
+	            android:textColor="@color/scrumptious_main_orange"
+	            android:gravity="center"
+	            android:visibility="gone" />
+	    </LinearLayout>
+    </ScrollView>
+</LinearLayout>
 
-        <LinearLayout
-            android:layout_width="fill_parent"
-            android:layout_height="wrap_content"
-            android:layout_marginTop="20dp"
-            android:gravity="center_horizontal"
-            android:orientation="horizontal" >
-            <com.facebook.widget.ProfilePictureView
-                android:id="@+id/selection_profile_pic"
-                android:layout_height="wrap_content"
-                android:layout_width="wrap_content"
-                android:layout_gravity="center"
-                android:gravity="center_horizontal"
-                facebook:preset_size="small" />
-            <TextView
-                android:id="@+id/selection_user_name"
-                android:layout_width="wrap_content"
-                android:layout_height="wrap_content"
-                android:layout_marginLeft="10dp"
-                android:layout_gravity="center"
-                android:textColor="#333"
-                android:textSize="18sp" />
-        </LinearLayout>
-
-        <com.facebook.scrumptious.FullListView
-            android:id="@+id/selection_list"
-            android:layout_width="fill_parent"
-            android:layout_height="wrap_content"
-            android:layout_margin="20dp"
-            android:background="@drawable/button_border"/>
-
-        <Button
-            android:id="@+id/announce_button"
-            android:layout_width="wrap_content"
-            android:layout_height="wrap_content"
-            android:layout_gravity="center"
-            android:textStyle="bold"
-            android:background="@drawable/button_border"
-            android:layout_marginBottom="20dp"
-            android:text="@string/announce"
-            android:gravity="center" />
 
-    </LinearLayout>
-</ScrollView>
diff --git a/samples/Scrumptious/res/layout/splash.xml b/samples/Scrumptious/res/layout/splash.xml
index b84d8e58f..8ea96ae84 100644
--- a/samples/Scrumptious/res/layout/splash.xml
+++ b/samples/Scrumptious/res/layout/splash.xml
@@ -17,52 +17,23 @@
 
 <ScrollView
     xmlns:android="http://schemas.android.com/apk/res/android"
-    android:layout_width="fill_parent"
-    android:layout_height="fill_parent"
-    android:background="#303040" >
+    android:layout_width="match_parent"
+    android:layout_height="match_parent"
+    android:fillViewport="true"
+    android:background="#FB5820" >
 
     <LinearLayout
-        android:layout_width="fill_parent"
-        android:layout_height="fill_parent"
+        android:layout_width="match_parent"
+        android:layout_height="match_parent"
         android:orientation="vertical">
 
-        <LinearLayout
-            android:layout_width="fill_parent"
-            android:layout_height="wrap_content"
-            android:layout_marginTop="30dp"
-            android:gravity="center_horizontal"
-            android:orientation="horizontal" >
-            <ImageView
-                android:id="@+id/splash_icon"
-                android:layout_width="wrap_content"
-                android:layout_height="wrap_content"
-                android:layout_gravity="center"
-                android:layout_marginRight="10dp"
-                android:gravity="center"
-                android:src="@drawable/icon" />
-            <TextView
-                android:layout_width="wrap_content"
-                android:layout_height="wrap_content"
-                android:layout_gravity="center"
-                android:gravity="center"
-                android:textColor="#AFDEFE"
-                android:textSize="28sp"
-                android:typeface="serif"
-                android:textStyle="italic"
-                android:text="@string/app_name" />
-        </LinearLayout>
-
-
-        <TextView
-            android:id="@+id/profile_name"
-            android:layout_width="174dp"
-            android:layout_height="wrap_content"
-            android:layout_marginTop="35dp"
-            android:lines="2"
-            android:textSize="17sp"
-            android:text="@string/get_started"
-            android:layout_gravity="center_horizontal"
-            android:gravity="center_horizontal"/>
+    	<ImageView 
+    		android:layout_width="match_parent"
+    		android:layout_height="0dp"
+    		android:layout_weight="1"
+    		android:layout_gravity="center"
+    		android:padding="50dp"
+    		android:src="@drawable/logo"/>
 
         <com.facebook.widget.LoginButton
             android:id="@+id/login_button"
@@ -72,18 +43,16 @@
             android:layout_marginTop="30dp"
             android:layout_marginBottom="30dp" />
 
-        <Button
+        <TextView
             android:id="@+id/skip_login_button"
             android:layout_width="wrap_content"
             android:layout_height="wrap_content"
             android:layout_gravity="center_horizontal"
             android:text="@string/skip_login"
-            android:background="@drawable/com_facebook_loginbutton_silver"
-            android:textSize="@dimen/com_facebook_loginview_text_size"
-            android:textColor="@color/com_facebook_blue"
+            android:textSize="12sp"
+            android:textColor="#EAFEA7"
             android:paddingLeft="20dp"
             android:paddingRight="20dp"
-            android:layout_marginTop="30dp"
             android:layout_marginBottom="30dp" />
 
     </LinearLayout>
diff --git a/samples/Scrumptious/res/values/colors.xml b/samples/Scrumptious/res/values/colors.xml
new file mode 100644
index 000000000..71f8c032b
--- /dev/null
+++ b/samples/Scrumptious/res/values/colors.xml
@@ -0,0 +1,5 @@
+<?xml version="1.0" encoding="utf-8"?>
+<resources>
+	<color name="scrumptious_main_orange">#FFFD5720</color>
+    <color name="disabled_button_color">#FFB7B7B7</color>
+</resources>
diff --git a/samples/Scrumptious/res/values/dimens.xml b/samples/Scrumptious/res/values/dimens.xml
new file mode 100644
index 000000000..1820b4cf2
--- /dev/null
+++ b/samples/Scrumptious/res/values/dimens.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0" encoding="utf-8"?>
+<resources>
+	<dimen name="item_list_padding">14dp</dimen>
+</resources>
diff --git a/samples/Scrumptious/res/values/strings.xml b/samples/Scrumptious/res/values/strings.xml
index c28e8df63..5c09fa5d2 100644
--- a/samples/Scrumptious/res/values/strings.xml
+++ b/samples/Scrumptious/res/values/strings.xml
@@ -19,11 +19,11 @@
     <string name="app_name">Scrumptious</string>
     <string name="app_id">233936543368280</string>
     <string name="get_started">To get started, login using Facebook</string>
-    <string name="skip_login">Skip Login</string>
-    <string name="action_eating">What are you eating?</string>
-    <string name="action_location">Where are you?</string>
-    <string name="action_people">With whom?</string>
-    <string name="action_photo">Got a picture?</string>
+    <string name="skip_login">continue as a guest</string>
+    <string name="action_eating">Pick Meal</string>
+    <string name="action_location">Pick Location</string>
+    <string name="action_people">Pick Friends</string>
+    <string name="action_photo">Pick Photo</string>
     <string name="action_eating_default">Select a meal</string>
     <string name="action_location_default">Select a place</string>
     <string name="action_people_default">Select friends</string>
@@ -31,7 +31,8 @@
     <string name="action_photo_ready">Ready</string>
     <string name="action_photo_camera">Take Photo</string>
     <string name="action_photo_gallery">Choose Existing</string>
-    <string name="announce">Announce</string>
+    <string name="announce">Share</string>
+    <string name="message">Whisper</string>
     <string name="login">Login</string>
     <string name="settings">Settings</string>
     <string name="select_meal">Select a meal</string>
diff --git a/samples/Scrumptious/res/values/styles.xml b/samples/Scrumptious/res/values/styles.xml
new file mode 100644
index 000000000..cc9304bcd
--- /dev/null
+++ b/samples/Scrumptious/res/values/styles.xml
@@ -0,0 +1,6 @@
+<?xml version="1.0" encoding="utf-8"?>
+<resources>
+	<style name="Theme.Scrumptious" parent="android:Theme">
+        <item name="android:windowNoTitle">true</item>
+    </style>
+</resources>
diff --git a/samples/Scrumptious/src/com/facebook/scrumptious/FullListView.java b/samples/Scrumptious/src/com/facebook/scrumptious/FullListView.java
index 66c1f83b9..58daa220e 100644
--- a/samples/Scrumptious/src/com/facebook/scrumptious/FullListView.java
+++ b/samples/Scrumptious/src/com/facebook/scrumptious/FullListView.java
@@ -54,9 +54,7 @@ protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
                     MeasureSpec.makeMeasureSpec(0, MeasureSpec.UNSPECIFIED));
             height += childView.getMeasuredHeight();
         }
-        Rect bgPadding = new Rect();
-        getBackground().getPadding(bgPadding);
-        height += (count - 1) * getDividerHeight() + bgPadding.top + bgPadding.bottom;
+        height += getDividerHeight() * (count-1);
         setMeasuredDimension(width, height);
     }
 }
diff --git a/samples/Scrumptious/src/com/facebook/scrumptious/SelectionFragment.java b/samples/Scrumptious/src/com/facebook/scrumptious/SelectionFragment.java
index 86265a074..322979141 100644
--- a/samples/Scrumptious/src/com/facebook/scrumptious/SelectionFragment.java
+++ b/samples/Scrumptious/src/com/facebook/scrumptious/SelectionFragment.java
@@ -68,15 +68,16 @@
     private static final int REAUTH_ACTIVITY_CODE = 100;
     private static final String PERMISSION = "publish_actions";
 
-    private Button announceButton;
+    private TextView announceButton;
+    private TextView messageButton;
     private ListView listView;
     private ProgressDialog progressDialog;
     private List<BaseListElement> listElements;
     private ProfilePictureView profilePictureView;
-    private TextView userNameView;
     private boolean pendingAnnounce;
     private MainActivity activity;
     private Uri photoUri;
+    private ImageView photoThumbnail;
 
     private UiLifecycleHelper uiHelper;
     private Session.StatusCallback sessionCallback = new Session.StatusCallback() {
@@ -136,14 +137,25 @@ public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle sa
 
         profilePictureView = (ProfilePictureView) view.findViewById(R.id.selection_profile_pic);
         profilePictureView.setCropped(true);
-        userNameView = (TextView) view.findViewById(R.id.selection_user_name);
-        announceButton = (Button) view.findViewById(R.id.announce_button);
+        announceButton = (TextView) view.findViewById(R.id.announce_text);
+        messageButton = (TextView) view.findViewById(R.id.message_text);
         listView = (ListView) view.findViewById(R.id.selection_list);
+        photoThumbnail = (ImageView) view.findViewById(R.id.selected_image);
+
+        if (FacebookDialog.canPresentOpenGraphMessageDialog(activity)) {
+            messageButton.setVisibility(View.VISIBLE);
+        }
 
         announceButton.setOnClickListener(new View.OnClickListener() {
             @Override
             public void onClick(View view) {
-                handleAnnounce();
+                handleAnnounce(false);
+            }
+        });
+        messageButton.setOnClickListener(new View.OnClickListener() {
+            @Override
+            public void onClick(View view) {
+                handleAnnounce(true);
             }
         });
 
@@ -190,7 +202,7 @@ public void onDestroy() {
      */
     private void tokenUpdated() {
         if (pendingAnnounce) {
-            handleAnnounce();
+            handleAnnounce(false);
         }
     }
 
@@ -203,7 +215,6 @@ private void onSessionStateChange(final Session session, SessionState state, Exc
             }
         } else {
             profilePictureView.setProfileId(null);
-            userNameView.setText("");
         }
     }
 
@@ -214,7 +225,6 @@ public void onCompleted(GraphUser user, Response response) {
                 if (session == Session.getActiveSession()) {
                     if (user != null) {
                         profilePictureView.setProfileId(user.getId());
-                        userNameView.setText(user.getName());
                     }
                 }
                 if (response.getError() != null) {
@@ -231,6 +241,7 @@ public void onCompleted(GraphUser user, Response response) {
      */
     private void init(Bundle savedInstanceState) {
         announceButton.setEnabled(false);
+        messageButton.setEnabled(false);
 
         listElements = new ArrayList<BaseListElement>();
 
@@ -254,7 +265,7 @@ private void init(Bundle savedInstanceState) {
         }
     }
 
-    private void handleAnnounce() {
+    private void handleAnnounce(boolean isMessage) {
         pendingAnnounce = false;
         Session session = Session.getActiveSession();
 
@@ -263,7 +274,11 @@ private void handleAnnounce() {
         if (session != null && session.isOpened()) {
             handleGraphApiAnnounce();
         } else {
-            handleNativeShareAnnounce();
+            if (isMessage) {
+                handleNativeMessageAnnounce();
+            } else {
+                handleNativeShareAnnounce();
+            }
         }
     }
 
@@ -382,6 +397,43 @@ private void handleNativeShareAnnounce() {
         return builder;
     }
 
+    private void handleNativeMessageAnnounce() {
+        FacebookDialog.OpenGraphMessageDialogBuilder builder = createMessageDialogBuilder();
+        if (builder.canPresent()) {
+            uiHelper.trackPendingDialogCall(builder.build().present());
+        } else {
+            // If we can't show the native open graph share dialog because the Messenger app
+            // does not support it, then show then settings fragment so the user can log in.
+            activity.showSettingsFragment();
+        }
+    }
+
+    private FacebookDialog.OpenGraphMessageDialogBuilder createMessageDialogBuilder() {
+        EatAction eatAction = createEatAction();
+
+        boolean userGenerated = false;
+        if (photoUri != null) {
+            String photoUriString = photoUri.toString();
+            Pair<File, Integer> fileAndMinDimemsion = getImageFileAndMinDimension();
+            userGenerated = fileAndMinDimemsion.second >= USER_GENERATED_MIN_SIZE;
+
+            // If we have a content: URI, we can just use that URI, otherwise we'll need to add it as an attachment.
+            if (fileAndMinDimemsion != null && photoUri.getScheme().startsWith("content")) {
+                eatAction.setImage(getImageListForAction(photoUriString, userGenerated));
+            }
+        }
+
+        FacebookDialog.OpenGraphMessageDialogBuilder builder = new FacebookDialog.OpenGraphMessageDialogBuilder(
+                getActivity(), eatAction, "meal")
+                .setFragment(SelectionFragment.this);
+
+        if (photoUri != null && !photoUri.getScheme().startsWith("content")) {
+            builder.setImageAttachmentFilesForAction(Arrays.asList(new File(photoUri.getPath())), userGenerated);
+        }
+
+        return builder;
+    }
+
     private Pair<File, Integer> getImageFileAndMinDimension() {
         File photoFile = null;
         String photoUriString = photoUri.toString();
@@ -628,9 +680,9 @@ private void startPickerActivity(Uri data, int requestCode) {
         private String foodChoice = null;
 
         public EatListElement(int requestCode) {
-            super(getActivity().getResources().getDrawable(R.drawable.action_eating),
+            super(getActivity().getResources().getDrawable(R.drawable.add_food),
                     getActivity().getResources().getString(R.string.action_eating),
-                    getActivity().getResources().getString(R.string.action_eating_default),
+                    null,
                     requestCode);
             foodChoices = getActivity().getResources().getStringArray(R.array.food_types);
             foodUrls = getActivity().getResources().getStringArray(R.array.food_og_urls);
@@ -737,9 +789,11 @@ private void setFoodText() {
             if (foodChoice != null && foodChoice.length() > 0) {
                 setText2(foodChoice);
                 announceButton.setEnabled(true);
+                messageButton.setEnabled(true);
             } else {
                 setText2(getActivity().getResources().getString(R.string.action_eating_default));
                 announceButton.setEnabled(false);
+                messageButton.setEnabled(false);
             }
         }
     }
@@ -751,9 +805,9 @@ private void setFoodText() {
         private List<GraphUser> selectedUsers;
 
         public PeopleListElement(int requestCode) {
-            super(getActivity().getResources().getDrawable(R.drawable.action_people),
+            super(getActivity().getResources().getDrawable(R.drawable.add_friends),
                     getActivity().getResources().getString(R.string.action_people),
-                    getActivity().getResources().getString(R.string.action_people_default),
+                    null,
                     requestCode);
         }
 
@@ -874,9 +928,9 @@ private void setUsersText() {
         private GraphPlace selectedPlace = null;
 
         public LocationListElement(int requestCode) {
-            super(getActivity().getResources().getDrawable(R.drawable.action_location),
+            super(getActivity().getResources().getDrawable(R.drawable.add_location),
                     getActivity().getResources().getString(R.string.action_location),
-                    getActivity().getResources().getString(R.string.action_location_default),
+                    null,
                     requestCode);
         }
 
@@ -956,9 +1010,9 @@ private void setPlaceText() {
         private Uri tempUri = null;
 
         public PhotoListElement(int requestCode) {
-            super(getActivity().getResources().getDrawable(R.drawable.action_photo),
+            super(getActivity().getResources().getDrawable(R.drawable.add_photo),
                     getActivity().getResources().getString(R.string.action_photo),
-                    getActivity().getResources().getString(R.string.action_photo_default),
+                    null,
                     requestCode);
             photoUri = null;
         }
@@ -980,6 +1034,7 @@ protected void onActivityResult(Intent data) {
             } else if (data != null) {
                 photoUri = data.getData();
             }
+            setPhotoThumbnail();
             setPhotoText();
         }
 
@@ -1030,6 +1085,10 @@ private void setPhotoText() {
                 setText2(getResources().getString(R.string.action_photo_ready));
             }
         }
+        
+        private void setPhotoThumbnail() {
+            photoThumbnail.setImageURI(photoUri);
+        }
 
         private void startCameraActivity() {
             Intent intent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);
@@ -1093,7 +1152,12 @@ public View getView(int position, View convertView, ViewGroup parent) {
                     text1.setText(listElement.getText1());
                 }
                 if (text2 != null) {
-                    text2.setText(listElement.getText2());
+                    if (listElement.getText2() != null) {
+                        text2.setVisibility(View.VISIBLE);
+                        text2.setText(listElement.getText2());
+                    } else {
+                        text2.setVisibility(View.GONE);
+                    }
                 }
             }
             return view;
diff --git a/samples/Scrumptious/src/com/facebook/scrumptious/SplashFragment.java b/samples/Scrumptious/src/com/facebook/scrumptious/SplashFragment.java
index f85fb29df..c89ebbb50 100644
--- a/samples/Scrumptious/src/com/facebook/scrumptious/SplashFragment.java
+++ b/samples/Scrumptious/src/com/facebook/scrumptious/SplashFragment.java
@@ -22,10 +22,11 @@
 import android.view.View;
 import android.view.ViewGroup;
 import android.widget.Button;
+import android.widget.TextView;
 
 public class SplashFragment extends Fragment {
 
-    private Button skipLoginButton;
+    private TextView skipLoginButton;
     private SkipLoginCallback skipLoginCallback;
 
     public interface SkipLoginCallback {
@@ -37,7 +38,7 @@
     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
         View view = inflater.inflate(R.layout.splash, container, false);
 
-        skipLoginButton = (Button) view.findViewById(R.id.skip_login_button);
+        skipLoginButton = (TextView) view.findViewById(R.id.skip_login_button);
         skipLoginButton.setOnClickListener(new View.OnClickListener() {
             @Override
             public void onClick(View view) {
@@ -54,3 +55,4 @@ public void setSkipLoginCallback(SkipLoginCallback callback) {
         skipLoginCallback = callback;
     }
 }
+
diff --git a/samples/SessionLoginSample/build.gradle b/samples/SessionLoginSample/build.gradle
index a2cda0280..535d02a65 100644
--- a/samples/SessionLoginSample/build.gradle
+++ b/samples/SessionLoginSample/build.gradle
@@ -13,6 +13,10 @@ android {
         targetSdkVersion 19
     }
 
+    lintOptions {
+        abortOnError false
+    }
+
     sourceSets {
         main {
             manifest.srcFile 'AndroidManifest.xml'
diff --git a/samples/SwitchUserSample/build.gradle b/samples/SwitchUserSample/build.gradle
index a2cda0280..535d02a65 100644
--- a/samples/SwitchUserSample/build.gradle
+++ b/samples/SwitchUserSample/build.gradle
@@ -13,6 +13,10 @@ android {
         targetSdkVersion 19
     }
 
+    lintOptions {
+        abortOnError false
+    }
+
     sourceSets {
         main {
             manifest.srcFile 'AndroidManifest.xml'
diff --git a/scripts/configure_unit_tests.sh b/scripts/configure_unit_tests.sh
index a6b85224e..237cf91b2 100755
--- a/scripts/configure_unit_tests.sh
+++ b/scripts/configure_unit_tests.sh
@@ -23,12 +23,13 @@ cd $(dirname $0)/..
 FB_SDK_ROOT=$(pwd)
 FB_SDK_TESTS=$FB_SDK_ROOT/facebook/tests
 
-if [ "$#" -lt 2 ]; then
-    echo "Usage: $0 APP_ID APP_SECRET [MACHINE_UNIQUE_USER_KEY]"
-    echo "  APP_ID                   your unit-testing Facebook application's App ID"
-    echo "  APP_SECRET               your unit-testing Facebook application's App Secret"
-    echo "  MACHINE_UNIQUE_USER_TAG  optional text used to ensure this machine will use its own set of test users rather than sharing"
-    die 'Arguments do not conform to usage'
+if [ "$#" -lt 3 ]; then
+      echo "Usage: $0 APP_ID APP_SECRET CLIENT_TOKEN [MACHINE_UNIQUE_USER_KEY]"
+      echo "  APP_ID                   your unit-testing Facebook application's App ID"
+      echo "  APP_SECRET               your unit-testing Facebook application's App Secret"
+      echo "  CLIENT_TOKEN             your unit-testing Facebook application's client token"
+      echo "  MACHINE_UNIQUE_USER_TAG  optional text used to ensure this machine will use its own set of test users rather than sharing"
+      die 'Arguments do not conform to usage'
 fi
 
 function write_config_json {
@@ -39,7 +40,7 @@ function write_config_json {
     # use heredoc syntax to output the json
     cat > "$CONFIG_JSON_FILE" \
 <<DELIMIT
-{"applicationId":"$1","applicationSecret":"$2","machineUniqueUserTag":"$3"}
+{"applicationId":"$1","applicationSecret":"$2","clientToken":"$3","machineUniqueUserTag":"$4"}
 DELIMIT
 # end heredoc
 
diff --git a/settings.gradle b/settings.gradle
index 8fb89427e..6ca4d0965 100644
--- a/settings.gradle
+++ b/settings.gradle
@@ -26,3 +26,5 @@ include 'SessionLoginSample'
 project(':SessionLoginSample').projectDir = new File('samples/SessionLoginSample')
 include 'SwitchUserSample'
 project(':SwitchUserSample').projectDir = new File('samples/SwitchUserSample')
+
+
diff --git a/tests/AndroidManifest.xml b/tests/AndroidManifest.xml
deleted file mode 100644
index c0e209de6..000000000
--- a/tests/AndroidManifest.xml
+++ /dev/null
@@ -1,18 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<manifest xmlns:android="http://schemas.android.com/apk/res/android"
-      package="com.facebook.android.tests"
-      android:versionCode="1"
-      android:versionName="1.0">
-    <application android:icon="@drawable/icon" android:label="@string/app_name">
-        <activity android:name=".Tests"
-                  android:label="@string/app_name">
-            <intent-filter>
-                <action android:name="android.intent.action.MAIN" />
-                <category android:name="android.intent.category.LAUNCHER" />
-            </intent-filter>
-        </activity>
-
-    </application>
-    <uses-permission android:name="android.permission.INTERNET"></uses-permission>
-    <uses-sdk android:minSdkVersion="3" />
-</manifest> 
diff --git a/tests/res/drawable/icon.png b/tests/res/drawable/icon.png
deleted file mode 100644
index a07c69fa5..000000000
Binary files a/tests/res/drawable/icon.png and /dev/null differ
diff --git a/tests/res/layout/main.xml b/tests/res/layout/main.xml
deleted file mode 100644
index 7134549a8..000000000
--- a/tests/res/layout/main.xml
+++ /dev/null
@@ -1,89 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!--
-    Copyright 2010-present Facebook.
-
-    Licensed under the Apache License, Version 2.0 (the "License");
-    you may not use this file except in compliance with the License.
-    You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-    Unless required by applicable law or agreed to in writing, software
-    distributed under the License is distributed on an "AS IS" BASIS,
-    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-    See the License for the specific language governing permissions and
-    limitations under the License.
--->
-
-<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
-    android:orientation="vertical" android:layout_width="fill_parent"
-    android:layout_height="fill_parent" android:background="@drawable/black"
-    android:gravity="center_horizontal">
-
-    <TextView android:id="@+id/publicTests" 
-        android:text="@string/hello"
-        android:textColor="@drawable/black"
-        android:layout_width="wrap_content"
-        android:layout_height="wrap_content"
-        />
-    <TextView android:id="@+id/publicErrors" 
-        android:text="@string/hello"
-        android:textColor="@drawable/black"
-        android:layout_width="wrap_content"
-        android:layout_height="wrap_content"
-        />
-    <Button android:id="@+id/login" 
-        android:text="@string/login"
-        android:layout_width="wrap_content"
-        android:layout_height="wrap_content" 
-        android:paddingRight="20dp" 
-        android:paddingLeft="20dp"
-        android:layout_margin="20dp" 
-        />
-    <TextView android:id="@+id/authenticatedTests" 
-        android:text="@string/hello"
-        android:textColor="@drawable/black"
-        android:layout_width="wrap_content"
-        android:layout_height="wrap_content"
-        />
-    <TextView android:id="@+id/authenticatedErrors" 
-        android:text="@string/hello"
-        android:textColor="@drawable/black"
-        android:layout_width="wrap_content"
-        android:layout_height="wrap_content"
-        />  
-    <Button android:id="@+id/post" 
-        android:text="@string/post"
-        android:layout_width="wrap_content"
-        android:layout_height="wrap_content" 
-        android:paddingRight="20dp" 
-        android:paddingLeft="20dp"
-        android:layout_margin="20dp" 
-        />
-    <TextView android:id="@+id/wallPost" 
-        android:text="@string/hello"
-        android:textColor="@drawable/black"
-        android:layout_width="wrap_content"
-        android:layout_height="wrap_content"
-        />
-    <TextView android:id="@+id/deletedPost" 
-        android:text="@string/hello"
-        android:textColor="@drawable/black"
-        android:layout_width="wrap_content"
-        android:layout_height="wrap_content"
-        /> 
-    <Button android:id="@+id/logout" 
-        android:text="@string/logout"
-        android:layout_width="wrap_content"
-        android:layout_height="wrap_content" 
-        android:paddingRight="20dp" 
-        android:paddingLeft="20dp"
-        android:layout_margin="20dp" 
-        />
-    <TextView android:id="@+id/logoutTest" 
-        android:text="@string/hello"
-        android:textColor="@drawable/black"
-        android:layout_width="wrap_content"
-        android:layout_height="wrap_content"
-        />
-</LinearLayout>
diff --git a/tests/res/values/colors.xml b/tests/res/values/colors.xml
deleted file mode 100644
index 43a557808..000000000
--- a/tests/res/values/colors.xml
+++ /dev/null
@@ -1,21 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!--
-    Copyright 2010-present Facebook.
-
-    Licensed under the Apache License, Version 2.0 (the "License");
-    you may not use this file except in compliance with the License.
-    You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-    Unless required by applicable law or agreed to in writing, software
-    distributed under the License is distributed on an "AS IS" BASIS,
-    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-    See the License for the specific language governing permissions and
-    limitations under the License.
--->
-
-<resources>
-    <drawable name="white">#ffffff</drawable>
-    <drawable name="black">#000000</drawable>
-</resources>
diff --git a/tests/res/values/strings.xml b/tests/res/values/strings.xml
deleted file mode 100644
index a61bf4d4c..000000000
--- a/tests/res/values/strings.xml
+++ /dev/null
@@ -1,24 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!--
-    Copyright 2010-present Facebook.
-
-    Licensed under the Apache License, Version 2.0 (the "License");
-    you may not use this file except in compliance with the License.
-    You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-    Unless required by applicable law or agreed to in writing, software
-    distributed under the License is distributed on an "AS IS" BASIS,
-    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-    See the License for the specific language governing permissions and
-    limitations under the License.
--->
-
-<resources>
-    <string name="hello">Hello World, Tests!</string>
-    <string name="login">Test Login</string>
-    <string name="post">Test UI Server</string>
-    <string name="logout">Test Logout</string>
-    <string name="app_name">Functional Tests</string>
-</resources>
diff --git a/tests/src/com/facebook/android/tests/Tests.java b/tests/src/com/facebook/android/tests/Tests.java
deleted file mode 100644
index e3116289e..000000000
--- a/tests/src/com/facebook/android/tests/Tests.java
+++ /dev/null
@@ -1,595 +0,0 @@
-/**
- * Copyright 2010-present Facebook.
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *    http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-package com.facebook.android.tests;
-
-import java.io.FileNotFoundException;
-import java.io.IOException;
-import java.net.MalformedURLException;
-
-import org.json.JSONObject;
-
-import com.facebook.android.AsyncFacebookRunner;
-import com.facebook.android.DialogError;
-import com.facebook.android.Facebook;
-import com.facebook.android.FacebookError;
-import com.facebook.android.Util;
-import com.facebook.android.AsyncFacebookRunner.RequestListener;
-import com.facebook.android.Facebook.DialogListener;
-
-import android.app.Activity;
-import android.content.Intent;
-import android.graphics.Color;
-import android.os.Bundle;
-import android.util.Log;
-import android.view.View;
-import android.view.View.OnClickListener;
-import android.widget.Button;
-import android.widget.TextView;
-
-public class Tests extends Activity {
-    
-    // Your Facebook Application ID must be set before running this example
-    // See http://www.facebook.com/developers/createapp.php
-    public static final String APP_ID = "110862205611506";
-    
-    private static final String[] PERMISSIONS =
-        new String[] {"publish_stream", "read_stream", "offline_access"};
-    
-    TextView publicTestsText;
-    TextView publicErrorsText;
-    Button loginButton;
-    TextView authenticatedTestsText;
-    TextView authenticatedErrorsText;
-    Button postButton;
-    TextView wallPostText;
-    TextView deletedPostText;
-    Button logoutButton;
-    TextView logoutText;
-    
-    Facebook authenticatedFacebook = new Facebook(APP_ID);
-    
-    /** Called when the activity is first created. */
-    @Override
-    public void onCreate(Bundle savedInstanceState) {
-        super.onCreate(savedInstanceState);
-        setContentView(R.layout.main);
-        
-        publicTestsText = (TextView) findViewById(R.id.publicTests);
-        publicErrorsText = (TextView) findViewById(R.id.publicErrors);
-        loginButton = (Button) findViewById(R.id.login);
-        authenticatedTestsText = (TextView) findViewById(
-                R.id.authenticatedTests);
-        authenticatedErrorsText = (TextView) findViewById(
-                R.id.authenticatedErrors);
-        postButton = (Button) findViewById(R.id.post);
-        wallPostText = (TextView) findViewById(R.id.wallPost);
-        deletedPostText = (TextView) findViewById(R.id.deletedPost);
-        logoutButton = (Button) findViewById(R.id.logout);
-        logoutText = (TextView) findViewById(R.id.logoutTest);
-               
-        // button to test UI Server login method
-        loginButton.setOnClickListener(new OnClickListener() {
-            public void onClick(View v) {
-                authenticatedFacebook.authorize(Tests.this, PERMISSIONS,
-                        new TestLoginListener());
-            }
-        });
-        
-        // button for testing UI server publish stream dialog
-        postButton.setOnClickListener(new OnClickListener() {
-            public void onClick(View v) {
-                authenticatedFacebook.dialog(Tests.this, "stream.publish", 
-                        new TestUiServerListener());
-            }
-        });
-        
-        // enable logout test button
-        logoutButton.setOnClickListener(new OnClickListener() {
-            public void onClick(View v) {
-                runTestLogout();
-            }
-        });
-        
-        runTestPublicApi();
-    }
-
-    @Override
-    public void onActivityResult(int requestCode, int resultCode, Intent data) {
-        authenticatedFacebook.authorizeCallback(requestCode, resultCode, data);
-    }
-
-    public void runTestPublicApi() {
-        if (testPublicApi()) {
-            publicTestsText.setText("Public API tests passed");
-            publicTestsText.setTextColor(Color.GREEN);
-        } else {
-            publicTestsText.setText("Public API tests failed");
-            publicTestsText.setTextColor(Color.RED);
-        }
-        
-        if (testPublicErrors()) {
-            publicErrorsText.setText("Public API errors passed");
-            publicErrorsText.setTextColor(Color.GREEN);
-        } else {
-            publicErrorsText.setText("Public API errors failed");
-            publicErrorsText.setTextColor(Color.RED);
-        }
-    }
-    
-    public boolean testPublicApi() {
-        Facebook fb = new Facebook(APP_ID);
-        try {
-            Log.d("Tests", "Testing standard API call");
-            JSONObject response = Util.parseJson(fb.request("4"));
-            if (!response.getString("name").equals("Mark Zuckerberg")) {
-                return false;
-            }
-            
-            Log.d("Tests", "Testing an API call with a specific method");
-            response = Util.parseJson(
-                    fb.request("soneff", new Bundle(), "GET"));
-            if (!response.getString("name").equals("Steven Soneff")) {
-                return false;
-            }
-            
-            Log.d("Tests", "Testing a public search query");
-            Bundle params = new Bundle();
-            params.putString("q", "facebook");
-            response = Util.parseJson(fb.request("search", params));
-            if (response.getJSONArray("data").length() == 0) return false;
-            
-            Log.d("Tests", "Public API Tests passed"); 
-            return true;
-        } catch (Throwable e) {
-            e.printStackTrace();
-            return false;
-        }
-    }
-    
-    public boolean testPublicErrors() {
-        Facebook fb = new Facebook(APP_ID);
-        try {
-            Bundle params = new Bundle();
-            
-            Log.d("Tests", "Testing illegal post");
-            params.putString("message", "Hello World");
-            try {
-                Util.parseJson(fb.request("4", params, "POST"));
-                return false;
-            } catch (FacebookError e) {
-                Log.d("Tests", "*" + e.getMessage() + "*");
-                if (!e.getMessage().equals("Unsupported post request.")) {
-                    return false;
-                }
-            }
-            
-            Log.d("Tests", "Testing illegal delete");
-            try {
-                Util.parseJson(fb.request("4", new Bundle(), "DELETE"));
-                return false;
-            } catch (FacebookError e) {
-                Log.d("Tests", "*" + e.getMessage() + "*");
-                if (!e.getMessage().equals(
-                        "An access token is required to request this " +
-                        "resource.")) {
-                    return false;
-                }
-            }
-            
-            Log.d("Tests", "Testing illegal post to Zuck's feed");
-            try {
-                Util.parseJson(fb.request("4/feed", new Bundle(), "POST"));
-                return false;
-            } catch (FacebookError e) {
-                Log.d("Tests", "*" + e.getMessage() + "*");
-                if (!e.getMessage().equals("(#200) The user hasn't " +
-                		"authorized the application to perform this action")) {
-                    return false;
-                }
-            }
-            
-            Log.d("Tests", "Testing invalidly specified parameters");
-            try {
-                Util.parseJson(fb.request("bgolub?fields=id,name,picture"));
-                return false;
-            } catch (FacebookError e) {
-                Log.d("Tests", "*" + e.getMessage() + "*");
-                if (!e.getMessage().startsWith("Unknown fields: picture?")) {
-                    return false;
-                }
-            }
-            
-            Log.d("Tests", "Testing request for 'me' is rejected without " +
-            		"access_token");
-            try {
-                Util.parseJson(fb.request("me"));
-                return false;
-            } catch (FacebookError e) {
-                Log.d("Tests", "*" + e.getMessage() + "*");
-                if (!e.getMessage().equals(
-                        "An active access token must be used to " +
-                        "query information about the current user.")) {
-                    return false;
-                }
-            }
-            
-            Log.d("Tests", "Testing empty request");
-            try {
-                Util.parseJson(fb.request(""));
-                return false;
-            } catch (FacebookError e) {
-                Log.d("Tests", "*" + e.getMessage() + "*");
-                if (!e.getMessage().equals("Unsupported get request.")) {
-                    return false;
-                }
-            }
-            
-            Log.d("Tests", "Testing an invalid path");
-            try {
-                Util.parseJson(fb.request("invalidinvalidinvalidinvalid"));
-                return false;
-            } catch (FacebookError e) {
-                Log.d("Tests", "*" + e.getMessage() + "*");
-                if (!e.getMessage().equals(
-                        "(#803) Some of the aliases you requested do not " +
-                        "exist: invalidinvalidinvalidinvalid")) {
-                    return false;
-                }
-            }
-            
-            Log.d("Tests", "Testing missing query parameter");
-            try {
-                Util.parseJson(fb.request("search", new Bundle(), "GET"));
-                return false;
-            } catch (FacebookError e) {
-                Log.d("Tests", "*" + e.getMessage() + "*");
-                if (!e.getMessage().equals("No node specified")) return false;
-            }
-            
-            Log.d("Tests", "Testing that API method is specified");
-            try {
-                fb.request(new Bundle());
-                return false;
-            } catch (IllegalArgumentException e) {
-                Log.d("Tests", "*" + e.getMessage() + "*");
-                if (!e.getMessage().equals(
-                        "API method must be specified. " +
-                        "(parameters must contain key \"method\" " +
-                        "and value). See http://developers.facebook." +
-                        "com/docs/reference/rest/")) {
-                    return false;
-                }
-            }
-            
-            Log.d("Tests", "Testing that old API request cannot be made " +
-                           "without access token");
-            params.putString("method", "stream.publish");
-            try {
-                Util.parseJson(fb.request(params));
-                return false;
-            } catch (FacebookError e) {
-                Log.d("Tests", "*" + e.getMessage() + "*");
-                if (e.getErrorCode() != 101 || 
-                        !e.getMessage().equals("Invalid API key") ) {
-                    return false;
-                }
-            }
-            
-            Log.d("Tests", "Testing invalid access token");
-            try {
-                fb.setAccessToken("invalid");
-                Util.parseJson(fb.request("me", new Bundle(), "GET"));
-                return false;
-            } catch (FacebookError e) {
-                Log.d("Tests", "*" + e.getMessage() + "*");
-                if (!e.getMessage().equals("Invalid OAuth access token.")) {
-                    return false;
-                }
-            }
-            
-            Log.d("Tests", "Public API Error Tests passed"); 
-            return true;
-        } catch (Throwable e) {
-            e.printStackTrace();
-            return false;
-        }
-    }
-    
-    public class TestLoginListener implements DialogListener {
-
-        public void onComplete(Bundle values) {
-            if (testAuthenticatedApi()) {
-                authenticatedTestsText.setText(
-                        "Authenticated API tests passed");
-                authenticatedTestsText.setTextColor(Color.GREEN);
-            } else {
-                authenticatedTestsText.setText(
-                        "Authenticated API tests failed");
-                authenticatedTestsText.setTextColor(Color.RED);
-            }
-            if (testAuthenticatedErrors()) {
-                authenticatedErrorsText.setText(
-                        "Authenticated API errors passed");
-                authenticatedErrorsText.setTextColor(Color.GREEN);
-            } else {
-                authenticatedErrorsText.setText(
-                        "Authenticated API errors failed");
-                authenticatedErrorsText.setTextColor(Color.RED);
-            }
-        }
-
-        public void onCancel() {
-        }
-
-        public void onError(DialogError e) {
-            e.printStackTrace();
-        }
-
-        public void onFacebookError(FacebookError e) {
-            e.printStackTrace();
-        }
-    }
-    
-    public boolean testAuthenticatedApi() {
-        if (!authenticatedFacebook.isSessionValid()) return false;
-        try {
-            Log.d("Tests", "Testing request for 'me'");
-            String response = authenticatedFacebook.request("me");
-            JSONObject obj = Util.parseJson(response);
-            if (obj.getString("name") == null || 
-                    obj.getString("name").equals("")) {
-                return false;
-            }
-            
-            Log.d("Tests", "Testing graph API wall post");
-            Bundle parameters = new Bundle();
-            parameters.putString("message", "hello world");
-            parameters.putString("description", "test test test");
-            response = authenticatedFacebook.request("me/feed", parameters, 
-                    "POST");
-            Log.d("Tests", "got response: " + response);
-            if (response == null || response.equals("") || 
-                    response.equals("false")) {
-                return false;
-            }
-            
-            Log.d("Tests", "Testing graph API delete");
-            response = response.replaceAll("\\{\"id\":\"", "");
-            response = response.replaceAll("\"\\}", "");
-            response = authenticatedFacebook.request(response, new Bundle(), 
-                    "DELETE");
-            if (!response.equals("true")) return false;
-            
-            Log.d("Tests", "Testing old API wall post");
-            parameters = new Bundle();
-            parameters.putString("method", "stream.publish");
-            parameters.putString("attachment", 
-                "{\"name\":\"Name=Title\"," +
-                "\"href\":\"http://www.google.fr/\",\"" +
-                "caption\":\"Caption\",\"description\":\"Description" +
-                "\",\"media\":[{\"type\":\"image\",\"src\":" +
-                "\"http://www.kratiroff.com/logo-facebook.jpg\"," +
-                "\"href\":\"http://developers.facebook.com/\"}]," +
-                "\"properties\":{\"another link\":{\"text\":\"" +
-                "Facebook homepage\",\"href\":\"http://www.facebook." +
-                "com\"}}}");;
-            response = authenticatedFacebook.request(parameters);
-            Log.d("Tests", "got response: " + response);
-            if (response == null || response.equals("") || 
-                    response.equals("false")) {
-                return false;
-            }
-            
-            Log.d("Tests", "Testing wall post delete");
-            response = response.replaceAll("\"", "");
-            response = authenticatedFacebook.request(
-                    response, new Bundle(), "DELETE");
-            if (!response.equals("true")) return false;
-            
-            Log.d("Tests", "All Authenticated Tests Passed");
-            return true;
-        } catch (Throwable e) {
-            e.printStackTrace();
-            return false;
-        }
-    }
-    
-    public boolean testAuthenticatedErrors() {
-        if (!authenticatedFacebook.isSessionValid()) return false;
-        
-        Log.d("Tests", "Testing that request for 'me/invalid' is rejected");
-        try {
-            Util.parseJson(authenticatedFacebook.request("me/invalid"));
-            return false;
-        } catch (Throwable e) {
-            Log.d("Tests", "*" + e.getMessage() + "*");
-            if (!e.getMessage().equals("Unknown path components: /invalid")) {
-                return false;
-            }
-        }
-        
-        Log.d("Tests", "Testing that old API call with invalid method fails");
-        Bundle params = new Bundle();
-        params.putString("method", "something_invalid");
-        try {
-            Util.parseJson(authenticatedFacebook.request(params));
-            return false;
-        } catch (Throwable e) {
-            Log.d("Tests", "*" + e.getMessage() + "*");
-            if (!e.getMessage().equals("Unknown method") ) {
-                return false;
-            }
-        }
-        
-        Log.d("Tests", "All Authenticated Error Tests Passed");
-        return true;
-    }
-    
-    public class TestUiServerListener implements DialogListener {
-
-        public void onComplete(Bundle values) {
-            final String postId = values.getString("post_id");
-            if (postId != null) {
-                Log.d("Facebook-Example", "Dialog Success! post_id=" + postId);
-                new AsyncFacebookRunner(authenticatedFacebook).request(postId, 
-                        new TestPostRequestListener());
-            } else {
-                Tests.this.runOnUiThread(new Runnable() {
-                    public void run() {
-                        wallPostText.setText("Wall Post Failure");
-                        wallPostText.setTextColor(Color.RED);
-                    }
-                });
-            }
-        }
-
-        public void onCancel() { }
-
-        public void onError(DialogError e) {
-            e.printStackTrace();
-        }
-
-        public void onFacebookError(FacebookError e) {
-            e.printStackTrace();
-        }
-    }
-    
-    public class TestPostRequestListener implements RequestListener {
-        
-        public void onComplete(final String response, final Object state) {
-            Log.d("Tests", "Got response: " + response);
-            try {
-                JSONObject json = Util.parseJson(response);
-                //final String message = json.getString("message");
-                String postId = json.getString("id");
-                Tests.this.runOnUiThread(new Runnable() {
-                    public void run() {
-                        wallPostText.setText("Wall Post Success");
-                        wallPostText.setTextColor(Color.GREEN);
-                    }
-                });
-                
-                Log.d("Tests", "Testing wall post delete");
-                if (testPostDelete(postId)) {
-                    Tests.this.runOnUiThread(new Runnable() {
-                        public void run() {
-                            deletedPostText.setText("Deleted Post Success");
-                            deletedPostText.setTextColor(Color.GREEN);
-                        }
-                    });
-                } else {
-                    Tests.this.runOnUiThread(new Runnable() {
-                        public void run() {
-                            deletedPostText.setText("Deleted Post Failure");
-                            deletedPostText.setTextColor(Color.RED);
-                        }
-                    });
-                }
-            } catch (Throwable e) {
-                e.printStackTrace();
-                Tests.this.runOnUiThread(new Runnable() {
-                    public void run() {
-                        wallPostText.setText("Wall Post Failure");
-                        wallPostText.setTextColor(Color.RED);
-                    }
-                });
-            }
-        }
-
-        public void onFacebookError(FacebookError e, final Object state) {
-            e.printStackTrace();
-        }
-
-        public void onFileNotFoundException(FileNotFoundException e,
-                                            final Object state) {
-            e.printStackTrace();
-        }
-
-        public void onIOException(IOException e, final Object state) {
-            e.printStackTrace();
-        }
-
-        public void onMalformedURLException(MalformedURLException e,
-                                            final Object state) {
-            e.printStackTrace();
-        }
-    }
-    
-    public boolean testPostDelete(String postId) {
-        try {
-            String deleteResponse = 
-                authenticatedFacebook.request(postId, new Bundle(), "DELETE");
-            return deleteResponse.equals("true");
-        } catch (Throwable e) {
-            e.printStackTrace();
-            return false;
-        }
-    }
-    
-    public void runTestLogout() {
-        if (testLogout()) {
-            logoutText.setText("Logout Tests Passed");
-            logoutText.setTextColor(Color.GREEN);
-        } else {
-            logoutText.setText("Logout Tests Failed");
-            logoutText.setTextColor(Color.RED);
-        }
-    }
-    
-    public boolean testLogout() {
-        try {
-            Log.d("Tests", "Testing logout");
-            String response = authenticatedFacebook.logout(this);
-            Log.d("Tests", "Got logout response: *" + response + "*");
-            if (!response.equals("true")) {
-                return false;
-            }
-            
-            Log.d("Tests", "Testing logout on logged out facebook session");
-            try {
-                Util.parseJson(authenticatedFacebook.logout(this));
-                return false;
-            } catch (FacebookError e) {
-                if (e.getErrorCode() != 101 || 
-                        !e.getMessage().equals("Invalid API key") ) {
-                    return false;
-                }
-            }
-            
-            Log.d("Tests", "Testing logout on unauthenticated object");
-            try {
-                Util.parseJson(new Facebook(APP_ID).logout(this));
-                return false;
-            } catch (FacebookError e) {
-                if (e.getErrorCode() != 101 || 
-                        !e.getMessage().equals("Invalid API key") ) {
-                    return false;
-                }
-            }
-            
-            Log.d("Tests", "All Logout Tests Passed");
-            return true;
-        } catch (Throwable e) {
-            e.printStackTrace();
-            return false;
-        }
-    }
-    
-    // test bad UI server method?
-    
-    // test invalid permission? <-- UI server test
-}
