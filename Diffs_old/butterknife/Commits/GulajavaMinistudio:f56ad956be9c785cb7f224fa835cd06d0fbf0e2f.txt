diff --git a/.travis.yml b/.travis.yml
index 03da3562..a890e486 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -2,17 +2,18 @@ language: android
 
 android:
   components:
+    # Update tools and then platform-tools explicitly so lint gets an updated database. Can be removed once 3.0 is out.
     - tools
     - platform-tools
-    - build-tools-25.0.2
-    - android-25
-    - extra-android-m2repository
     - sys-img-armeabi-v7a-android-18
 
 jdk:
   - oraclejdk8
 
 before_script:
+  # Install SDK license so Android Gradle plugin can install deps.
+  - mkdir "$ANDROID_HOME/licenses" || true
+  - echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > "$ANDROID_HOME/licenses/android-sdk-license"
   # Create and start an emulator for instrumentation tests.
   - echo no | android create avd --force -n test -t android-18 --abi armeabi-v7a
   - emulator -avd test -no-audio -no-window &
@@ -38,6 +39,5 @@ sudo: false
 
 cache:
   directories:
-    - $HOME/.m2
     - $HOME/.gradle
 
diff --git a/build.gradle b/build.gradle
index ce43435e..4779ab91 100644
--- a/build.gradle
+++ b/build.gradle
@@ -4,12 +4,12 @@ buildscript {
       'compileSdk': 25,
       'buildTools': '25.0.2',
 
-      'supportLibrary': '25.1.0',
-      'androidPlugin': '2.2.0',
-      'androidTools': '25.2.0',
-      'kotlin': '1.1.2-3',
+      'supportLibrary': '25.3.0',
+      'androidPlugin': '2.3.2',
+      'androidTools': '25.3.0',
+      'kotlin': '1.1.2-4',
 
-      'release': '8.4.0',
+      'release': '8.6.0',
   ]
 
   ext.deps = [
@@ -33,12 +33,12 @@ buildscript {
       javapoet: 'com.squareup:javapoet:1.8.0',
       javaparser: 'com.github.javaparser:javaparser-core:2.4.0',
       junit: 'junit:junit:4.12',
-      truth: 'com.google.truth:truth:0.28',
+      truth: 'com.google.truth:truth:0.33',
       robolectric: 'org.robolectric:robolectric:3.1.2',
       openglApi: 'org.khronos:opengl-api:gl1.1-android-2.1_r1',
-      compiletesting: 'com.google.testing.compile:compile-testing:0.9',
+      compiletesting: 'com.google.testing.compile:compile-testing:0.11',
       'auto': [
-          'service': 'com.google.auto.service:auto-service:1.0-rc2',
+          'service': 'com.google.auto.service:auto-service:1.0-rc3',
           'common': 'com.google.auto:auto-common:0.6',
       ],
       'release': [
@@ -57,6 +57,7 @@ subprojects { project ->
 
   repositories {
     mavenCentral()
+    google()
     maven {
       url "https://plugins.gradle.org/m2/"
     }
@@ -85,6 +86,7 @@ subprojects { project ->
   buildscript {
     repositories {
       mavenCentral()
+      google()
       maven {
         url "https://plugins.gradle.org/m2/"
       }
diff --git a/butterknife-annotations/build.gradle b/butterknife-annotations/build.gradle
index 05268ad8..28b5784e 100644
--- a/butterknife-annotations/build.gradle
+++ b/butterknife-annotations/build.gradle
@@ -1,14 +1,6 @@
 apply plugin: 'java'
 apply plugin: 'checkstyle'
 
-def logger = new com.android.build.gradle.internal.LoggerWrapper(project.logger)
-def sdkHandler = new com.android.build.gradle.internal.SdkHandler(project, logger)
-for (File file : sdkHandler.sdkLoader.repositories) {
-  repositories.maven {
-    url = file.toURI()
-  }
-}
-
 sourceCompatibility = JavaVersion.VERSION_1_7
 targetCompatibility = JavaVersion.VERSION_1_7
 
diff --git a/butterknife-gradle-plugin/build.gradle b/butterknife-gradle-plugin/build.gradle
index b7a66072..0cb53e7a 100644
--- a/butterknife-gradle-plugin/build.gradle
+++ b/butterknife-gradle-plugin/build.gradle
@@ -1,14 +1,6 @@
 apply plugin: 'java'
 apply plugin: 'kotlin'
 
-def logger = new com.android.build.gradle.internal.LoggerWrapper(project.logger)
-def sdkHandler = new com.android.build.gradle.internal.SdkHandler(project, logger)
-for (File file : sdkHandler.sdkLoader.repositories) {
-  repositories.maven {
-    url = file.toURI()
-  }
-}
-
 sourceCompatibility = JavaVersion.VERSION_1_8
 targetCompatibility = JavaVersion.VERSION_1_8
 
diff --git a/butterknife-lint/src/test/java/butterknife/lint/InvalidR2UsageDetectorTest.java b/butterknife-lint/src/test/java/butterknife/lint/InvalidR2UsageDetectorTest.java
index 946eada9..c150724d 100644
--- a/butterknife-lint/src/test/java/butterknife/lint/InvalidR2UsageDetectorTest.java
+++ b/butterknife-lint/src/test/java/butterknife/lint/InvalidR2UsageDetectorTest.java
@@ -1,15 +1,66 @@
 package butterknife.lint;
 
+import com.android.tools.lint.checks.infrastructure.LintDetectorTest;
+import com.android.tools.lint.checks.infrastructure.TestFiles;
 import com.android.tools.lint.detector.api.Detector;
 import com.android.tools.lint.detector.api.Issue;
 import com.google.common.collect.ImmutableList;
 import java.util.List;
 
-public class InvalidR2UsageDetectorTest extends LintDetectorTestBase {
-  private static final String PATH_TEST_RESOURCES = "/src/test/java/sample/r2/";
+public final class InvalidR2UsageDetectorTest extends LintDetectorTest {
   private static final String NO_WARNINGS = "No warnings.";
-  private static final String R2 = "R2.java";
-  private static final String BIND_TEST = "BindTest.java";
+  private static final TestFile BIND_TEST = TestFiles.java(""
+      + "package sample.r2;\n"
+      + "\n"
+      + "import java.lang.annotation.ElementType;\n"
+      + "import java.lang.annotation.Retention;\n"
+      + "import java.lang.annotation.RetentionPolicy;\n"
+      + "import java.lang.annotation.Target;\n"
+      + "\n"
+      + "@Retention(RetentionPolicy.SOURCE) @Target({ ElementType.FIELD, ElementType.METHOD })\n"
+      + "public @interface BindTest {\n"
+      + "  int value();\n"
+      + "}\n");
+  private static final TestFile R2 = TestFiles.java(""
+      + "package sample.r2;\n"
+      + "\n"
+      + "public final class R2 {\n"
+      + "  public static final class array {\n"
+      + "    public static final int res = 0x7f040001;\n"
+      + "  }\n"
+      + "\n"
+      + "  public static final class attr {\n"
+      + "    public static final int res = 0x7f040002;\n"
+      + "  }\n"
+      + "\n"
+      + "  public static final class bool {\n"
+      + "    public static final int res = 0x7f040003;\n"
+      + "  }\n"
+      + "\n"
+      + "  public static final class color {\n"
+      + "    public static final int res = 0x7f040004;\n"
+      + "  }\n"
+      + "\n"
+      + "  public static final class dimen {\n"
+      + "    public static final int res = 0x7f040005;\n"
+      + "  }\n"
+      + "\n"
+      + "  public static final class drawable {\n"
+      + "    public static final int res = 0x7f040006;\n"
+      + "  }\n"
+      + "\n"
+      + "  public static final class id {\n"
+      + "    public static final int res = 0x7f040007;\n"
+      + "  }\n"
+      + "\n"
+      + "  public static final class integer {\n"
+      + "    public static final int res = 0x7f040008;\n"
+      + "  }\n"
+      + "\n"
+      + "  public static final class string {\n"
+      + "    public static final int res = 0x7f040009;\n"
+      + "  }\n"
+      + "}");
 
   @Override protected Detector getDetector() {
     return new InvalidR2UsageDetector();
@@ -19,29 +70,63 @@
     return ImmutableList.of(InvalidR2UsageDetector.ISSUE);
   }
 
-  @Override protected String getTestResourcesPath() {
-    return PATH_TEST_RESOURCES;
-  }
-
   public void testNoR2Usage() throws Exception {
-    String file = "NoR2Usage.java";
-    assertSame(NO_WARNINGS, lintFiles(file));
+    TestFile file = TestFiles.java(""
+        + "package sample;\n"
+        + "\n"
+        + "class NoR2Usage {\n"
+        + "}\n");
+    assertSame(NO_WARNINGS, lintFiles(R2, file));
   }
 
   public void testR2UsageInAnnotations() throws Exception {
-    String file = "R2UsageInAnnotations.java";
+    TestFile file = TestFiles.java(""
+        + "package sample.r2;\n"
+        + "\n"
+        + "public class R2UsageInAnnotations {\n"
+        + "\n"
+        + "  @BindTest(sample.r2.R2.string.res) String test;\n"
+        + "\n"
+        + "  @BindTest(R2.id.res) public void foo() { }\n"
+        + "}\n");
     assertSame(NO_WARNINGS, lintFiles(file, BIND_TEST, R2));
   }
 
   public void testR2UsageOutsideAnnotations() throws Exception {
-    String file = "R2UsageOutsideAnnotations.java";
+    TestFile file = TestFiles.java(""
+        + "package sample.r2;\n"
+        + "\n"
+        + "public class R2UsageOutsideAnnotations {\n"
+        + "\n"
+        + "  int array = sample.r2.R2.array.res;\n"
+        + "\n"
+        + "  public void foo(int color) {}\n"
+        + "\n"
+        + "  public void bar() {\n"
+        + "    foo(R2.color.res);\n"
+        + "  }\n"
+        + "}\n");
     String lintOutput = lintFiles(file, R2);
     assertNotSame(NO_WARNINGS, lintOutput);
     assertTrue(lintOutput.contains("2 errors, 0 warnings"));
   }
 
   public void testR2UsageWithSuppression() throws Exception {
-    String file = "R2UsageWithSuppression.java";
+    TestFile file = TestFiles.java(""
+        + "package sample.r2;\n"
+        + "\n"
+        + "public class R2UsageWithSuppression {\n"
+        + "\n"
+        + "  @SuppressWarnings(\"InvalidR2Usage\")\n"
+        + "  int bool = sample.r2.R2.bool.res;\n"
+        + "\n"
+        + "  public void foo(int attr) {}\n"
+        + "\n"
+        + "  @SuppressWarnings(\"InvalidR2Usage\")\n"
+        + "  public void bar() {\n"
+        + "    foo(R2.attr.res);\n"
+        + "  }\n"
+        + "}\n");
     String lintOutput = lintFiles(file, R2);
     assertSame(NO_WARNINGS, lintOutput);
   }
diff --git a/butterknife-lint/src/test/java/butterknife/lint/LintDetectorTestBase.java b/butterknife-lint/src/test/java/butterknife/lint/LintDetectorTestBase.java
deleted file mode 100644
index 78d4269b..00000000
--- a/butterknife-lint/src/test/java/butterknife/lint/LintDetectorTestBase.java
+++ /dev/null
@@ -1,47 +0,0 @@
-package butterknife.lint;
-
-import com.android.annotations.Nullable;
-import com.android.tools.lint.checks.infrastructure.LintDetectorTest;
-import com.android.utils.SdkUtils;
-import java.io.BufferedInputStream;
-import java.io.File;
-import java.io.FileInputStream;
-import java.io.FileNotFoundException;
-import java.io.InputStream;
-import java.net.MalformedURLException;
-import java.net.URL;
-import java.security.CodeSource;
-
-public abstract class LintDetectorTestBase extends LintDetectorTest {
-
-  protected abstract String getTestResourcesPath();
-
-  @Override protected InputStream getTestResource(String relativePath, boolean expectExists) {
-    String path = (getTestResourcesPath() + relativePath).replace('/', File.separatorChar);
-    File file = new File(getTestDataRootDir(), path);
-    if (file.exists()) {
-      try {
-        return new BufferedInputStream(new FileInputStream(file));
-      } catch (FileNotFoundException e) {
-        if (expectExists) {
-          fail("Could not find file " + relativePath);
-        }
-      }
-    }
-    return null;
-  }
-
-  @Nullable private File getTestDataRootDir() {
-    CodeSource source = getClass().getProtectionDomain().getCodeSource();
-    if (source != null) {
-      URL location = source.getLocation();
-      try {
-        File classesDir = SdkUtils.urlToFile(location);
-        return classesDir.getParentFile().getAbsoluteFile().getParentFile().getParentFile();
-      } catch (MalformedURLException e) {
-        fail(e.getLocalizedMessage());
-      }
-    }
-    return null;
-  }
-}
diff --git a/butterknife-lint/src/test/java/butterknife/lint/LintRegistryTest.java b/butterknife-lint/src/test/java/butterknife/lint/LintRegistryTest.java
index d5a7f17d..9ad97538 100644
--- a/butterknife-lint/src/test/java/butterknife/lint/LintRegistryTest.java
+++ b/butterknife-lint/src/test/java/butterknife/lint/LintRegistryTest.java
@@ -4,8 +4,7 @@
 
 import static com.google.common.truth.Truth.assertThat;
 
-public class LintRegistryTest {
-
+public final class LintRegistryTest {
   @Test public void issues() throws Exception {
     assertThat(new LintRegistry().getIssues()).contains(InvalidR2UsageDetector.ISSUE);
   }
diff --git a/butterknife-lint/src/test/java/sample/r2/BindTest.java b/butterknife-lint/src/test/java/sample/r2/BindTest.java
deleted file mode 100644
index b31753ca..00000000
--- a/butterknife-lint/src/test/java/sample/r2/BindTest.java
+++ /dev/null
@@ -1,11 +0,0 @@
-package sample.r2;
-
-import java.lang.annotation.ElementType;
-import java.lang.annotation.Retention;
-import java.lang.annotation.RetentionPolicy;
-import java.lang.annotation.Target;
-
-@Retention(RetentionPolicy.SOURCE) @Target({ ElementType.FIELD, ElementType.METHOD })
-public @interface BindTest {
-  int value();
-}
diff --git a/butterknife-lint/src/test/java/sample/r2/NoR2Usage.java b/butterknife-lint/src/test/java/sample/r2/NoR2Usage.java
deleted file mode 100644
index f14f8b80..00000000
--- a/butterknife-lint/src/test/java/sample/r2/NoR2Usage.java
+++ /dev/null
@@ -1,3 +0,0 @@
-package sample.r2;
-
-public class NoR2Usage { }
diff --git a/butterknife-lint/src/test/java/sample/r2/R2.java b/butterknife-lint/src/test/java/sample/r2/R2.java
deleted file mode 100644
index bfa84bbb..00000000
--- a/butterknife-lint/src/test/java/sample/r2/R2.java
+++ /dev/null
@@ -1,40 +0,0 @@
-// Generated code from Butter Knife gradle plugin. Do not modify!
-package sample.r2;
-
-public final class R2 {
-  public static final class array {
-    public static final int res = 0x7f040001;
-  }
-
-  public static final class attr {
-    public static final int res = 0x7f040002;
-  }
-
-  public static final class bool {
-    public static final int res = 0x7f040003;
-  }
-
-  public static final class color {
-    public static final int res = 0x7f040004;
-  }
-
-  public static final class dimen {
-    public static final int res = 0x7f040005;
-  }
-
-  public static final class drawable {
-    public static final int res = 0x7f040006;
-  }
-
-  public static final class id {
-    public static final int res = 0x7f040007;
-  }
-
-  public static final class integer {
-    public static final int res = 0x7f040008;
-  }
-
-  public static final class string {
-    public static final int res = 0x7f040009;
-  }
-}
diff --git a/butterknife-lint/src/test/java/sample/r2/R2UsageInAnnotations.java b/butterknife-lint/src/test/java/sample/r2/R2UsageInAnnotations.java
deleted file mode 100644
index 9f63a671..00000000
--- a/butterknife-lint/src/test/java/sample/r2/R2UsageInAnnotations.java
+++ /dev/null
@@ -1,8 +0,0 @@
-package sample.r2;
-
-public class R2UsageInAnnotations {
-
-  @BindTest(sample.r2.R2.string.res) String test;
-
-  @BindTest(R2.id.res) public void foo() { }
-}
diff --git a/butterknife-lint/src/test/java/sample/r2/R2UsageOutsideAnnotations.java b/butterknife-lint/src/test/java/sample/r2/R2UsageOutsideAnnotations.java
deleted file mode 100644
index 32564b17..00000000
--- a/butterknife-lint/src/test/java/sample/r2/R2UsageOutsideAnnotations.java
+++ /dev/null
@@ -1,12 +0,0 @@
-package sample.r2;
-
-public class R2UsageOutsideAnnotations {
-
-  int array = sample.r2.R2.array.res;
-
-  public void foo(int color) {}
-
-  public void bar() {
-    foo(R2.color.res);
-  }
-}
diff --git a/butterknife-lint/src/test/java/sample/r2/R2UsageWithSuppression.java b/butterknife-lint/src/test/java/sample/r2/R2UsageWithSuppression.java
deleted file mode 100644
index a808835c..00000000
--- a/butterknife-lint/src/test/java/sample/r2/R2UsageWithSuppression.java
+++ /dev/null
@@ -1,14 +0,0 @@
-package sample.r2;
-
-public class R2UsageWithSuppression {
-
-  @SuppressWarnings("InvalidR2Usage")
-  int bool = sample.r2.R2.bool.res;
-
-  public void foo(int attr) {}
-
-  @SuppressWarnings("InvalidR2Usage")
-  public void bar() {
-    foo(R2.attr.res);
-  }
-}
diff --git a/gradle/wrapper/gradle-wrapper.jar b/gradle/wrapper/gradle-wrapper.jar
index 4552f749..110d836d 100644
Binary files a/gradle/wrapper/gradle-wrapper.jar and b/gradle/wrapper/gradle-wrapper.jar differ
diff --git a/gradle/wrapper/gradle-wrapper.properties b/gradle/wrapper/gradle-wrapper.properties
index 4391436b..ab9913cc 100644
--- a/gradle/wrapper/gradle-wrapper.properties
+++ b/gradle/wrapper/gradle-wrapper.properties
@@ -1,6 +1,6 @@
-#Mon May 08 12:19:25 PDT 2017
+#Fri Jun 02 10:37:29 EDT 2017
 distributionBase=GRADLE_USER_HOME
 distributionPath=wrapper/dists
 zipStoreBase=GRADLE_USER_HOME
 zipStorePath=wrapper/dists
-distributionUrl=https\://services.gradle.org/distributions/gradle-3.5-all.zip
+distributionUrl=https\://services.gradle.org/distributions/gradle-4.0-rc-1-all.zip
