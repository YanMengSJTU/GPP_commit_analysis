diff --git a/TMessagesProj/src/main/java/com/teamjihu/ThemeManager.java b/TMessagesProj/src/main/java/com/teamjihu/ThemeManager.java
index 0556da420..0ef376227 100644
--- a/TMessagesProj/src/main/java/com/teamjihu/ThemeManager.java
+++ b/TMessagesProj/src/main/java/com/teamjihu/ThemeManager.java
@@ -11,6 +11,7 @@
 import android.graphics.drawable.Drawable;
 import android.content.Context;
 import android.content.SharedPreferences;
+import android.view.View;
 
 public class ThemeManager {
 	private static final String CUSTOM_PERMISSION = "com.teamjihu.theme.telegram.v1";
@@ -140,4 +141,11 @@ public int getColor(String name) {
 			return ret;
 		}
 	}
+
+    public void setBackgroundDrawable( View v, Drawable d ) {
+        if(android.os.Build.VERSION.SDK_INT < android.os.Build.VERSION_CODES.JELLY_BEAN)
+            v.setBackgroundDrawable(d);
+        else
+            v.setBackground(d);
+    }
 }
diff --git a/TMessagesProj/src/main/java/org/telegram/android/AndroidUtilities.java b/TMessagesProj/src/main/java/org/telegram/android/AndroidUtilities.java
index b620dc426..6b9dc5455 100644
--- a/TMessagesProj/src/main/java/org/telegram/android/AndroidUtilities.java
+++ b/TMessagesProj/src/main/java/org/telegram/android/AndroidUtilities.java
@@ -44,6 +44,7 @@
     private static Boolean isTablet = null;
 
     public static int[] arrColors = {0xffee4928, 0xff41a903, 0xffe09602, 0xff0f94ed, 0xff8f3bf7, 0xfffc4380, 0xff00a1c4, 0xffeb7002};
+    /*
     public static int[] arrUsersAvatars = {
             R.drawable.user_red,
             R.drawable.user_green,
@@ -53,7 +54,17 @@
             R.drawable.user_pink,
             R.drawable.user_aqua,
             R.drawable.user_orange};
-
+     */
+    public static String[] arrUsersAvatars = {
+            "user_red",
+            "user_green",
+            "user_yellow",
+            "user_blue",
+            "user_violet",
+            "user_pink",
+            "user_aqua",
+            "user_orange"};
+    /*
     public static int[] arrGroupsAvatars = {
             R.drawable.group_red,
             R.drawable.group_green,
@@ -63,7 +74,18 @@
             R.drawable.group_pink,
             R.drawable.group_aqua,
             R.drawable.group_orange};
-
+    */
+    public static String[] arrGroupsAvatars = {
+            "group_red",
+            "group_green",
+            "group_yellow",
+            "group_blue",
+            "group_violet",
+            "group_pink",
+            "group_aqua",
+            "group_orange"};
+
+    /*
     public static int[] arrBroadcastAvatars = {
             R.drawable.broadcast_red,
             R.drawable.broadcast_green,
@@ -73,6 +95,16 @@
             R.drawable.broadcast_pink,
             R.drawable.broadcast_aqua,
             R.drawable.broadcast_orange};
+    */
+    public static String[] arrBroadcastAvatars = {
+            "broadcast_red",
+            "broadcast_green",
+            "broadcast_yellow",
+            "broadcast_blue",
+            "broadcast_violet",
+            "broadcast_pink",
+            "broadcast_aqua",
+            "broadcast_orange"};
 
     static {
         density = ApplicationLoader.applicationContext.getResources().getDisplayMetrics().density;
@@ -306,7 +338,7 @@ public static int getMinTabletSide() {
     }
 
     public static int getColorIndex(int id) {
-        int[] arr;
+        String[] arr;
         if (id >= 0) {
             arr = arrUsersAvatars;
         } else {
@@ -342,18 +374,19 @@ public static int getColorForId(int id) {
         return arrColors[getColorIndex(id)];
     }
 
-    public static int getUserAvatarForId(int id) {
+    public static String getUserAvatarForId(int id) {
         if (id / 1000 == 333 || id / 1000 == 777) {
-            return R.drawable.telegram_avatar;
+            //return R.drawable.telegram_avatar;
+            return "telegram_avatar";
         }
         return arrUsersAvatars[getColorIndex(id)];
     }
 
-    public static int getGroupAvatarForId(int id) {
+    public static String getGroupAvatarForId(int id) {
         return arrGroupsAvatars[getColorIndex(-Math.abs(id))];
     }
 
-    public static int getBroadcastAvatarForId(int id) {
+    public static String getBroadcastAvatarForId(int id) {
         return arrBroadcastAvatars[getColorIndex(-Math.abs(id))];
     }
 
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatAudioCell.java b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatAudioCell.java
index e45c24d54..931c2692c 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatAudioCell.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatAudioCell.java
@@ -9,7 +9,9 @@
 package org.telegram.ui.Cells;
 
 import android.content.Context;
+import android.graphics.Bitmap;
 import android.graphics.Canvas;
+import android.graphics.drawable.BitmapDrawable;
 import android.graphics.drawable.Drawable;
 import android.text.Layout;
 import android.text.StaticLayout;
@@ -17,6 +19,8 @@
 import android.view.MotionEvent;
 import android.view.SoundEffectConstants;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.messenger.FileLoader;
 import org.telegram.android.MediaController;
@@ -58,8 +62,11 @@
     private TLRPC.FileLocation currentPhoto;
     private String currentNameString;
 
+    private ThemeManager themeManager;
+
     public ChatAudioCell(Context context) {
         super(context);
+        themeManager = new ThemeManager(context);
         TAG = MediaController.getInstance().generateObserverTag();
 
         avatarImage = new ImageReceiver(this);
@@ -354,9 +361,17 @@ public void setMessageObject(MessageObject messageObject) {
                 if (audioUser.photo != null) {
                     currentPhoto = audioUser.photo.photo_small;
                 }
-                avatarImage.setImage(currentPhoto, "50_50", getResources().getDrawable(AndroidUtilities.getUserAvatarForId(uid)), false);
+                //avatarImage.setImage(currentPhoto, "50_50", getResources().getDrawable(AndroidUtilities.getUserAvatarForId(uid)), false);
+                String placeHolderId = AndroidUtilities.getUserAvatarForId(uid);
+
+                Drawable d = themeManager.getDrawable(placeHolderId, false);
+                avatarImage.setImage(currentPhoto, "50_50", d, false);
             } else {
-                avatarImage.setImage((TLRPC.FileLocation)null, "50_50", getResources().getDrawable(AndroidUtilities.getUserAvatarForId(uid)), false);
+                //avatarImage.setImage((TLRPC.FileLocation)null, "50_50", getResources().getDrawable(AndroidUtilities.getUserAvatarForId(uid)), false);
+                String placeHolderId = AndroidUtilities.getUserAvatarForId(uid);
+
+                Drawable d = themeManager.getDrawable(placeHolderId, false);
+                avatarImage.setImage((TLRPC.FileLocation)null, "50_50", d, false);
             }
 
             if (messageObject.isOut()) {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatBaseCell.java b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatBaseCell.java
index b14055e74..26a3a35df 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatBaseCell.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatBaseCell.java
@@ -22,6 +22,8 @@
 import android.view.SoundEffectConstants;
 import android.view.ViewConfiguration;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.ContactsController;
 import org.telegram.android.LocaleController;
@@ -119,6 +121,8 @@
 
     private int last_send_state = 0;
 
+    private ThemeManager themeManager;
+
     private final class CheckForTap implements Runnable {
         public void run() {
             if (pendingCheckForLongPress == null) {
@@ -160,7 +164,9 @@ protected void onDetachedFromWindow() {
     }
 
     private void init() {
+        themeManager = new ThemeManager(getContext());
         if (backgroundDrawableIn == null) {
+            /*
             backgroundDrawableIn = getResources().getDrawable(R.drawable.msg_in);
             backgroundDrawableInSelected = getResources().getDrawable(R.drawable.msg_in_selected);
             backgroundDrawableOut = getResources().getDrawable(R.drawable.msg_out);
@@ -179,6 +185,25 @@ private void init() {
             mediaBackgroundDrawable = getResources().getDrawable(R.drawable.phototime);
             broadcastDrawable = getResources().getDrawable(R.drawable.broadcast3);
             broadcastMediaDrawable = getResources().getDrawable(R.drawable.broadcast4);
+            */
+            backgroundDrawableIn = themeManager.getDrawable("msg_in", false);
+            backgroundDrawableInSelected = themeManager.getDrawable("msg_in_selected", false);
+            backgroundDrawableOut = themeManager.getDrawable("msg_out", false);
+            backgroundDrawableOutSelected = themeManager.getDrawable("msg_out_selected", false);
+            backgroundMediaDrawableIn = themeManager.getDrawable("msg_in_photo", false);
+            backgroundMediaDrawableInSelected = themeManager.getDrawable("msg_in_photo_selected", false);
+            backgroundMediaDrawableOut = themeManager.getDrawable("msg_out_photo", false);
+            backgroundMediaDrawableOutSelected = themeManager.getDrawable("msg_out_photo_selected", false);
+            checkDrawable = themeManager.getDrawable("msg_check", false);
+            halfCheckDrawable = themeManager.getDrawable("msg_halfcheck", false);
+            clockDrawable = themeManager.getDrawable("msg_clock", false);
+            checkMediaDrawable = themeManager.getDrawable("msg_check_w", false);
+            halfCheckMediaDrawable = themeManager.getDrawable("msg_halfcheck_w", false);
+            clockMediaDrawable = themeManager.getDrawable("msg_clock_photo", false);
+            errorDrawable = themeManager.getDrawable("msg_warning", false);
+            mediaBackgroundDrawable = themeManager.getDrawable("phototime", false);
+            broadcastDrawable = themeManager.getDrawable("broadcast3", false);
+            broadcastMediaDrawable = themeManager.getDrawable("broadcast4", false);
 
             timePaintIn = new TextPaint(TextPaint.ANTI_ALIAS_FLAG);
             timePaintIn.setTextSize(AndroidUtilities.dp(12));
@@ -265,7 +290,11 @@ public void setMessageObject(MessageObject messageObject) {
                 } else {
                     currentPhoto = null;
                 }
-                avatarImage.setImage(currentPhoto, "50_50", getResources().getDrawable(AndroidUtilities.getUserAvatarForId(currentUser.id)), false);
+                //avatarImage.setImage(currentPhoto, "50_50", getResources().getDrawable(AndroidUtilities.getUserAvatarForId(currentUser.id)), false);
+                String placeHolderId = AndroidUtilities.getUserAvatarForId(currentUser.id);
+
+                Drawable d = themeManager.getDrawable(placeHolderId, false);
+                avatarImage.setImage(currentPhoto, "50_50", d, false);
             } else {
                 avatarImage.setImage(null, "50_50", null, false);
             }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatOrUserCell.java b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatOrUserCell.java
index 81dc0c793..49d5ecf45 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatOrUserCell.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatOrUserCell.java
@@ -17,6 +17,8 @@
 import android.text.TextPaint;
 import android.text.TextUtils;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.PhoneFormat.PhoneFormat;
 import org.telegram.android.ContactsController;
@@ -56,8 +58,11 @@
     public boolean useSeparator = false;
     public float drawAlpha = 1;
 
+    private ThemeManager themeManager;
+
     public ChatOrUserCell(Context context) {
         super(context);
+        themeManager = new ThemeManager(context);
         init();
     }
 
@@ -151,7 +156,7 @@ public void buildLayout() {
     }
 
     public void update(int mask) {
-        int placeHolderId = 0;
+        String placeHolderId = "";
         TLRPC.FileLocation photo = null;
         if (user != null) {
             if (user.photo != null) {
@@ -215,7 +220,8 @@ public void update(int mask) {
 
 
         lastAvatar = photo;
-        avatarImage.setImage(photo, "50_50", placeHolderId == 0 ? null : getResources().getDrawable(placeHolderId), false);
+        //avatarImage.setImage(photo, "50_50", placeHolderId == 0 ? null : getResources().getDrawable(placeHolderId), false);
+        avatarImage.setImage(photo, "50_50", placeHolderId == "" ? null : themeManager.getDrawable(placeHolderId, false), false);
 
         if (getMeasuredWidth() != 0 || getMeasuredHeight() != 0) {
             buildLayout();
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Cells/DialogCell.java b/TMessagesProj/src/main/java/org/telegram/ui/Cells/DialogCell.java
index 68b87d808..ca4933fe6 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Cells/DialogCell.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Cells/DialogCell.java
@@ -17,6 +17,8 @@
 import android.text.TextPaint;
 import android.text.TextUtils;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.PhoneFormat.PhoneFormat;
 import org.telegram.android.LocaleController;
@@ -57,6 +59,8 @@
     private TLRPC.EncryptedChat encryptedChat = null;
     private CharSequence lastPrintString = null;
 
+    ThemeManager themeManager;
+
     private void init() {
         if (namePaint == null) {
             namePaint = new TextPaint(TextPaint.ANTI_ALIAS_FLAG);
@@ -146,6 +150,7 @@ private void init() {
 
     public DialogCell(Context context) {
         super(context);
+        themeManager = new ThemeManager(context);
         init();
     }
 
@@ -246,7 +251,7 @@ public void update(int mask) {
             }
         }
 
-        int placeHolderId = 0;
+        String placeHolderId = "";
         TLRPC.FileLocation photo = null;
         if (user != null) {
             if (user.photo != null) {
@@ -263,7 +268,8 @@ public void update(int mask) {
                 placeHolderId = AndroidUtilities.getBroadcastAvatarForId(chat.id);
             }
         }
-        avatarImage.setImage(photo, "50_50", placeHolderId == 0 ? null : getResources().getDrawable(placeHolderId), false);
+        //avatarImage.setImage(photo, "50_50", placeHolderId == 0 ? null : getResources().getDrawable(placeHolderId), false);
+        avatarImage.setImage(photo, "50_50", placeHolderId == "" ? null : themeManager.getDrawable(placeHolderId, false), false);
 
         if (getMeasuredWidth() != 0 || getMeasuredHeight() != 0) {
             buildLayout();
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
index 9859ad2c7..d706eee61 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
@@ -22,6 +22,7 @@
 import android.content.res.Configuration;
 import android.graphics.Bitmap;
 import android.graphics.Rect;
+import android.graphics.drawable.BitmapDrawable;
 import android.graphics.drawable.Drawable;
 import android.media.MediaMetadataRetriever;
 import android.media.MediaPlayer;
@@ -50,6 +51,8 @@
 import android.widget.TextView;
 import android.widget.Toast;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.PhoneFormat.PhoneFormat;
 import org.telegram.android.ImageLoader;
@@ -186,6 +189,8 @@
     private final static int attach_location = 10;
     private final static int chat_menu_avatar = 11;
 
+    private ThemeManager themeManager;
+
     public ChatActivity(Bundle args) {
         super(args);
     }
@@ -406,7 +411,8 @@ public void onFragmentDestroy() {
 
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
             if (AndroidUtilities.isTablet()) {
                 actionBarLayer.setExtraLeftMargin(4);
             }
@@ -569,12 +575,18 @@ public void onItemClick(int id) {
                 timeItem = menu.addItemResource(chat_enc_timer, R.layout.chat_header_enc_layout);
             }
 
-            ActionBarMenuItem item = menu.addItem(chat_menu_attach, R.drawable.ic_ab_attach);
-            item.addSubItem(attach_photo, LocaleController.getString("ChatTakePhoto", R.string.ChatTakePhoto), R.drawable.ic_attach_photo);
-            item.addSubItem(attach_gallery, LocaleController.getString("ChatGallery", R.string.ChatGallery), R.drawable.ic_attach_gallery);
-            item.addSubItem(attach_video, LocaleController.getString("ChatVideo", R.string.ChatVideo), R.drawable.ic_attach_video);
-            item.addSubItem(attach_document, LocaleController.getString("ChatDocument", R.string.ChatDocument), R.drawable.ic_ab_doc);
-            item.addSubItem(attach_location, LocaleController.getString("ChatLocation", R.string.ChatLocation), R.drawable.ic_attach_location);
+            //ActionBarMenuItem item = menu.addItem(chat_menu_attach, R.drawable.ic_ab_attach);
+            ActionBarMenuItem item = menu.addItem(0, themeManager.getDrawable("ic_ab_attach", false));
+//            item.addSubItem(attach_photo, LocaleController.getString("ChatTakePhoto", R.string.ChatTakePhoto), R.drawable.ic_attach_photo);
+//            item.addSubItem(attach_gallery, LocaleController.getString("ChatGallery", R.string.ChatGallery), R.drawable.ic_attach_gallery);
+//            item.addSubItem(attach_video, LocaleController.getString("ChatVideo", R.string.ChatVideo), R.drawable.ic_attach_video);
+//            item.addSubItem(attach_document, LocaleController.getString("ChatDocument", R.string.ChatDocument), R.drawable.ic_ab_doc);
+//            item.addSubItem(attach_location, LocaleController.getString("ChatLocation", R.string.ChatLocation), R.drawable.ic_attach_location);
+            item.addSubItem(attach_photo, LocaleController.getString("ChatTakePhoto", R.string.ChatTakePhoto), themeManager.getDrawable("ic_attach_photo", false));
+            item.addSubItem(attach_gallery, LocaleController.getString("ChatGallery", R.string.ChatGallery),themeManager.getDrawable("ic_attach_gallery", false));
+            item.addSubItem(attach_video, LocaleController.getString("ChatVideo", R.string.ChatVideo), themeManager.getDrawable("ic_attach_video", false));
+            item.addSubItem(attach_document, LocaleController.getString("ChatDocument", R.string.ChatDocument), themeManager.getDrawable("ic_ab_doc", false));
+            item.addSubItem(attach_location, LocaleController.getString("ChatLocation", R.string.ChatLocation), themeManager.getDrawable("ic_attach_location", false));
             menuItem = item;
 
             actionModeViews.clear();
@@ -1051,7 +1063,8 @@ public void onClick(DialogInterface dialog, int which) {
 
         if (avatarImageView != null) {
             TLRPC.FileLocation photo = null;
-            int placeHolderId = 0;
+            //int placeHolderId = 0;
+            String placeHolderId = "";
             if (currentUser != null) {
                 if (currentUser.photo != null) {
                     photo = currentUser.photo.photo_small;
@@ -1067,7 +1080,11 @@ public void onClick(DialogInterface dialog, int which) {
                     placeHolderId = AndroidUtilities.getGroupAvatarForId(currentChat.id);
                 }
             }
-            avatarImageView.setImage(photo, "50_50", placeHolderId);
+            //avatarImageView.setImage(photo, "50_50", placeHolderId);
+            Drawable d = themeManager.getDrawable(placeHolderId, false);
+            Bitmap bm = ((BitmapDrawable)d).getBitmap();
+            Bitmap bm2 = Bitmap.createScaledBitmap(bm, 50, 50, true);
+            avatarImageView.setImage(photo, "50_50", bm2);
         }
     }
 
@@ -1298,7 +1315,7 @@ private void updateSubtitle() {
 
     private void checkAndUpdateAvatar() {
         TLRPC.FileLocation newPhoto = null;
-        int placeHolderId = 0;
+        String placeHolderId = "";
         if (currentUser != null) {
             TLRPC.User user = MessagesController.getInstance().getUser(currentUser.id);
             if (user == null) {
@@ -1325,7 +1342,11 @@ private void checkAndUpdateAvatar() {
             }
         }
         if (avatarImageView != null) {
-            avatarImageView.setImage(newPhoto, "50_50", placeHolderId);
+            //avatarImageView.setImage(newPhoto, "50_50", placeHolderId);
+            Drawable d = themeManager.getDrawable(placeHolderId, false);
+            Bitmap bm = ((BitmapDrawable)d).getBitmap();
+            Bitmap bm2 = Bitmap.createScaledBitmap(bm, 50, 50, true);
+            avatarImageView.setImage(newPhoto, "50_50", bm2);
         }
     }
 
@@ -3180,16 +3201,20 @@ private void updateRowBackground(ChatListRowHolderEx holder, boolean disableSele
         } else {
             if (messageType == 12) {
                 if (selected) {
-                    holder.chatBubbleView.setBackgroundResource(R.drawable.msg_out_selected);
+                    //holder.chatBubbleView.setBackgroundResource(R.drawable.msg_out_selected);
+                    themeManager.setBackgroundDrawable(holder.chatBubbleView, themeManager.getDrawable("msg_out_selected", false));
                 } else {
-                    holder.chatBubbleView.setBackgroundResource(R.drawable.msg_out);
+                    //holder.chatBubbleView.setBackgroundResource(R.drawable.msg_out);
+                    themeManager.setBackgroundDrawable(holder.chatBubbleView, themeManager.getDrawable("msg_out", false));
                 }
                 holder.chatBubbleView.setPadding(AndroidUtilities.dp(6), AndroidUtilities.dp(6), AndroidUtilities.dp(18), 0);
             } else if (messageType == 13) {
                 if (selected) {
-                    holder.chatBubbleView.setBackgroundResource(R.drawable.msg_in_selected);
+                    //holder.chatBubbleView.setBackgroundResource(R.drawable.msg_in_selected);
+                    themeManager.setBackgroundDrawable(holder.chatBubbleView, themeManager.getDrawable("msg_in_selected", false));
                 } else {
-                    holder.chatBubbleView.setBackgroundResource(R.drawable.msg_in);
+                    //holder.chatBubbleView.setBackgroundResource(R.drawable.msg_in);
+                    themeManager.setBackgroundDrawable(holder.chatBubbleView, themeManager.getDrawable("msg_in", false));
                 }
                 holder.chatBubbleView.setPadding(AndroidUtilities.dp(15), AndroidUtilities.dp(6), AndroidUtilities.dp(9), 0);
             }
@@ -3591,8 +3616,12 @@ public void update() {
                 if (fromUser.photo != null) {
                     photo = fromUser.photo.photo_small;
                 }
-                int placeHolderId = AndroidUtilities.getUserAvatarForId(fromUser.id);
-                avatarImageView.setImage(photo, "50_50", placeHolderId);
+                String placeHolderId = AndroidUtilities.getUserAvatarForId(fromUser.id);
+                //avatarImageView.setImage(photo, "50_50", placeHolderId);
+                Drawable d = themeManager.getDrawable(placeHolderId, false);
+                Bitmap bm = ((BitmapDrawable)d).getBitmap();
+                Bitmap bm2 = Bitmap.createScaledBitmap(bm, 50, 50, true);
+                avatarImageView.setImage(photo, "50_50", bm2);
             }
 
             if (type != 12 && type != 13 && nameTextView != null && fromUser != null && type != 8 && type != 9) {
@@ -3612,17 +3641,35 @@ public void update() {
 
                 if (type == 11) {
                     if (message.messageOwner.action instanceof TLRPC.TL_messageActionUserUpdatedPhoto) {
-                        photoImage.setImage(message.messageOwner.action.newUserPhoto.photo_small, "50_50", AndroidUtilities.getUserAvatarForId(currentUser.id));
+                        //photoImage.setImage(message.messageOwner.action.newUserPhoto.photo_small, "50_50", AndroidUtilities.getUserAvatarForId(currentUser.id));
+
+                        String placeHolderId =  AndroidUtilities.getUserAvatarForId(currentUser.id);
+                        Drawable d = themeManager.getDrawable(placeHolderId, false);
+                        Bitmap bm = ((BitmapDrawable)d).getBitmap();
+                        Bitmap bm2 = Bitmap.createScaledBitmap(bm, 50, 50, true);
+                        photoImage.setImage(message.messageOwner.action.newUserPhoto.photo_small, "50_50", bm2);
                     } else {
                         PhotoObject photo = PhotoObject.getClosestImageWithSize(message.photoThumbs, AndroidUtilities.dp(64));
                         if (photo != null) {
                             if (photo.image != null) {
                                 photoImage.setImageBitmap(photo.image);
                             } else {
-                                photoImage.setImage(photo.photoOwner.location, "50_50", AndroidUtilities.getGroupAvatarForId(currentChat.id));
+                                //photoImage.setImage(photo.photoOwner.location, "50_50", AndroidUtilities.getGroupAvatarForId(currentChat.id));
+
+                                String placeHolderId =  AndroidUtilities.getUserAvatarForId(currentChat.id);
+                                Drawable d = themeManager.getDrawable(placeHolderId, false);
+                                Bitmap bm = ((BitmapDrawable)d).getBitmap();
+                                Bitmap bm2 = Bitmap.createScaledBitmap(bm, 50, 50, true);
+                                photoImage.setImage(photo.photoOwner.location, "50_50", bm2);
                             }
                         } else {
-                            photoImage.setImageResource(AndroidUtilities.getGroupAvatarForId(currentChat.id));
+                            //photoImage.setImageResource(AndroidUtilities.getGroupAvatarForId(currentChat.id));
+
+                            String placeHolderId =  AndroidUtilities.getGroupAvatarForId(currentChat.id);
+                            Drawable d = themeManager.getDrawable(placeHolderId, false);
+                            Bitmap bm = ((BitmapDrawable)d).getBitmap();
+                            Bitmap bm2 = Bitmap.createScaledBitmap(bm, 50, 50, true);
+                            photoImage.setImageBitmap(bm2);
                         }
                     }
                     photoImage.imageReceiver.setVisible(!PhotoViewer.getInstance().isShowingImage(message), false);
@@ -3645,8 +3692,14 @@ public void update() {
                     if (contactUser.photo != null) {
                         photo = contactUser.photo.photo_small;
                     }
-                    int placeHolderId = AndroidUtilities.getUserAvatarForId(contactUser.id);
-                    contactAvatar.setImage(photo, "50_50", placeHolderId);
+                    String placeHolderId = AndroidUtilities.getUserAvatarForId(contactUser.id);
+                    //contactAvatar.setImage(photo, "50_50", placeHolderId);
+
+                    Drawable d = themeManager.getDrawable(placeHolderId, false);
+                    Bitmap bm = ((BitmapDrawable)d).getBitmap();
+                    Bitmap bm2 = Bitmap.createScaledBitmap(bm, 50, 50, true);
+                    photoImage.setImage(photo, "50_50", bm2);
+
                     if (contactUser.id != UserConfig.getClientUserId() && ContactsController.getInstance().contactsDict.get(contactUser.id) == null) {
                         addContactView.setVisibility(View.VISIBLE);
                     } else {
@@ -3664,7 +3717,14 @@ public void update() {
                     } else {
                         phoneTextView.setText("Unknown");
                     }
-                    contactAvatar.setImageResource(AndroidUtilities.getUserAvatarForId(message.messageOwner.media.user_id));
+                    //contactAvatar.setImageResource(AndroidUtilities.getUserAvatarForId(message.messageOwner.media.user_id));
+
+                    String placeHolderId  = AndroidUtilities.getUserAvatarForId(message.messageOwner.media.user_id);
+                    Drawable d = themeManager.getDrawable(placeHolderId, false);
+                    Bitmap bm = ((BitmapDrawable)d).getBitmap();
+                    Bitmap bm2 = Bitmap.createScaledBitmap(bm, 50, 50, true);
+                    contactAvatar.setImageBitmap(bm2);
+
                     addContactView.setVisibility(View.GONE);
                 }
             } else if (type == 6) {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java
index 58901889c..e867548fd 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java
@@ -12,7 +12,10 @@
 import android.content.Context;
 import android.content.DialogInterface;
 import android.content.Intent;
+import android.graphics.Bitmap;
 import android.graphics.Typeface;
+import android.graphics.drawable.BitmapDrawable;
+import android.graphics.drawable.Drawable;
 import android.os.Bundle;
 import android.text.Html;
 import android.view.LayoutInflater;
@@ -23,6 +26,8 @@
 import android.widget.ListView;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
 import org.telegram.android.MessagesStorage;
@@ -75,6 +80,8 @@
 
     private static final int done_button = 1;
 
+    private ThemeManager themeManager;
+
     public ChatProfileActivity(Bundle args) {
         super(args);
     }
@@ -171,7 +178,8 @@ public void onFragmentDestroy() {
 
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
             actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             if (chat_id > 0) {
                 actionBarLayer.setTitle(LocaleController.getString("GroupInfo", R.string.GroupInfo));
@@ -641,7 +649,14 @@ public void onClick(DialogInterface dialogInterface, int i) {
                     photo = chat.photo.photo_small;
                     photoBig = chat.photo.photo_big;
                 }
-                avatarImage.setImage(photo, "50_50", chat_id > 0 ? AndroidUtilities.getGroupAvatarForId(chat.id) : AndroidUtilities.getBroadcastAvatarForId(chat.id));
+                //avatarImage.setImage(photo, "50_50", chat_id > 0 ? AndroidUtilities.getGroupAvatarForId(chat.id) : AndroidUtilities.getBroadcastAvatarForId(chat.id));
+
+                String placeHolderId =  chat_id > 0 ? AndroidUtilities.getGroupAvatarForId(chat.id) : AndroidUtilities.getBroadcastAvatarForId(chat.id);
+                Drawable d = themeManager.getDrawable(placeHolderId, false);
+                Bitmap bm = ((BitmapDrawable)d).getBitmap();
+                Bitmap bm2 = Bitmap.createScaledBitmap(bm, 50, 50, true);
+                avatarImage.setImage(photo, "50_50", bm2);
+
                 avatarImage.imageReceiver.setVisible(!PhotoViewer.getInstance().isShowingImage(photoBig), false);
                 return view;
             } else if (type == 1) {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ContactAddActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/ContactAddActivity.java
index 7faaac4fc..c4e11d535 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ContactAddActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ContactAddActivity.java
@@ -10,7 +10,10 @@
 
 import android.app.Activity;
 import android.content.SharedPreferences;
+import android.graphics.Bitmap;
 import android.graphics.Typeface;
+import android.graphics.drawable.BitmapDrawable;
+import android.graphics.drawable.Drawable;
 import android.os.Bundle;
 import android.view.KeyEvent;
 import android.view.LayoutInflater;
@@ -21,6 +24,8 @@
 import android.widget.EditText;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.PhoneFormat.PhoneFormat;
 import org.telegram.android.ContactsController;
@@ -42,6 +47,8 @@
     private TextView onlineText;
     private TextView phoneText;
 
+    private ThemeManager themeManager;
+
     public ContactAddActivity(Bundle args) {
         super(args);
     }
@@ -64,6 +71,7 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
+            themeManager = new ThemeManager(getParentActivity());
             actionBarLayer.setCustomView(R.layout.settings_do_action_layout);
             Button cancelButton = (Button)actionBarLayer.findViewById(R.id.cancel_button);
             cancelButton.setOnClickListener(new View.OnClickListener() {
@@ -164,7 +172,13 @@ private void updateAvatarLayout() {
         if (user.photo != null) {
             photo = user.photo.photo_small;
         }
-        avatarImage.setImage(photo, "50_50", AndroidUtilities.getUserAvatarForId(user.id));
+        //avatarImage.setImage(photo, "50_50", AndroidUtilities.getUserAvatarForId(user.id));
+        String placeHolderId = AndroidUtilities.getUserAvatarForId(user.id);
+
+        Drawable d = themeManager.getDrawable(placeHolderId, false);
+        Bitmap bm = ((BitmapDrawable)d).getBitmap();
+        Bitmap bm2 = Bitmap.createScaledBitmap(bm, 50, 50, true);
+        avatarImage.setImage(photo, "50_50", bm2);
     }
 
     public void didReceivedNotification(int id, Object... args) {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ContactsActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/ContactsActivity.java
index 9592a7df6..42ae8cf63 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ContactsActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ContactsActivity.java
@@ -28,6 +28,8 @@
 import android.widget.FrameLayout;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
 import org.telegram.messenger.TLObject;
@@ -74,6 +76,8 @@
     private boolean updatingInviteText = false;
     private ContactsActivityDelegate delegate;
 
+    private ThemeManager themeManager;
+
     public static interface ContactsActivityDelegate {
         public abstract void didSelectContact(TLRPC.User user, String param);
     }
@@ -120,7 +124,8 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
             actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             if (destroyAfterSelect) {
                 actionBarLayer.setTitle(LocaleController.getString("SelectContact", R.string.SelectContact));
@@ -138,7 +143,8 @@ public void onItemClick(int id) {
             });
 
             ActionBarMenu menu = actionBarLayer.createMenu();
-            menu.addItem(0, R.drawable.ic_ab_search).setIsSearchField(true).setActionBarMenuItemSearchListener(new ActionBarMenuItem.ActionBarMenuItemSearchListener() {
+            //menu.addItem(0, R.drawable.ic_ab_search).setIsSearchField(true).setActionBarMenuItemSearchListener(new ActionBarMenuItem.ActionBarMenuItemSearchListener() {
+            menu.addItem(0, themeManager.getDrawable("ic_ab_search", false)).setIsSearchField(true).setActionBarMenuItemSearchListener(new ActionBarMenuItem.ActionBarMenuItemSearchListener() {
                 @Override
                 public void onSearchExpand() {
                     searching = true;
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/CountrySelectActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/CountrySelectActivity.java
index 97ba06dbc..58ae62f3c 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/CountrySelectActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/CountrySelectActivity.java
@@ -19,6 +19,8 @@
 import android.widget.EditText;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.messenger.FileLog;
 import org.telegram.android.LocaleController;
@@ -61,6 +63,8 @@
     private Timer searchTimer;
     public ArrayList<Country> searchResult;
 
+    private ThemeManager themeManager;
+
     public static class Country {
         public String name;
         public String code;
@@ -121,7 +125,8 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
             actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("ChooseCountry", R.string.ChooseCountry));
 
@@ -135,7 +140,8 @@ public void onItemClick(int id) {
             });
 
             ActionBarMenu menu = actionBarLayer.createMenu();
-            menu.addItem(0, R.drawable.ic_ab_search).setIsSearchField(true).setActionBarMenuItemSearchListener(new ActionBarMenuItem.ActionBarMenuItemSearchListener() {
+            //menu.addItem(0, R.drawable.ic_ab_search).setIsSearchField(true).setActionBarMenuItemSearchListener(new ActionBarMenuItem.ActionBarMenuItemSearchListener() {
+            menu.addItem(0, themeManager.getDrawable("ic_ab_search", false)).setIsSearchField(true).setActionBarMenuItemSearchListener(new ActionBarMenuItem.ActionBarMenuItemSearchListener() {
                 @Override
                 public void onSearchExpand() {
                     searching = true;
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/DocumentSelectActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/DocumentSelectActivity.java
index 1c671134d..c5f30b8f3 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/DocumentSelectActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/DocumentSelectActivity.java
@@ -24,6 +24,8 @@
 import android.widget.ListView;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.messenger.FileLog;
 import org.telegram.android.LocaleController;
 import org.telegram.messenger.phonethemeshop.R;
@@ -60,6 +62,8 @@
     private long sizeLimit = 1024 * 1024 * 1024;
     private DocumentSelectActivityDelegate delegate;
 
+    private ThemeManager themeManager;
+
     private class ListItem {
         int icon;
         String title;
@@ -130,7 +134,9 @@ public View createView(LayoutInflater inflater, ViewGroup container) {
         }
 
         if (fragmentView == null) {
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            //actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
             actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("SelectFile", R.string.SelectFile));
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
@@ -147,7 +153,8 @@ public void onItemClick(int id) {
                 }
             });
             ActionBarMenu menu = actionBarLayer.createMenu();
-            ActionBarMenuItem item = menu.addItem(1, R.drawable.ic_ab_other);
+            //ActionBarMenuItem item = menu.addItem(1, R.drawable.ic_ab_other);
+            ActionBarMenuItem item = menu.addItem(1, themeManager.getDrawable("ic_ab_other", false));
 
             fragmentView = inflater.inflate(R.layout.document_select_layout, container, false);
             listAdapter = new ListAdapter(getParentActivity());
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/GroupCreateActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/GroupCreateActivity.java
index 26dcbe84c..6d7c0fcbc 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/GroupCreateActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/GroupCreateActivity.java
@@ -33,6 +33,8 @@
 import android.widget.ImageView;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.PhoneFormat.PhoneFormat;
 import org.telegram.android.LocaleController;
@@ -59,6 +61,8 @@
 
 public class GroupCreateActivity extends BaseFragment implements NotificationCenter.NotificationCenterDelegate {
 
+    private ThemeManager themeManager;
+
     public static class XImageSpan extends ImageSpan {
         public int uid;
 
@@ -137,7 +141,9 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            //actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
             actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             if (isBroadcast) {
                 actionBarLayer.setTitle(LocaleController.getString("NewBroadcastList", R.string.NewBroadcastList));
@@ -561,8 +567,13 @@ public View getItemView(int section, int position, View convertView, ViewGroup p
             if (user.photo != null) {
                 photo = user.photo.photo_small;
             }
-            int placeHolderId = AndroidUtilities.getUserAvatarForId(user.id);
-            holder.avatarImage.setImage(photo, "50_50", placeHolderId);
+            String placeHolderId = AndroidUtilities.getUserAvatarForId(user.id);
+            //holder.avatarImage.setImage(photo, "50_50", placeHolderId);
+
+            Drawable d = themeManager.getDrawable(placeHolderId, false);
+            Bitmap bm = ((BitmapDrawable)d).getBitmap();
+            Bitmap bm2 = Bitmap.createScaledBitmap(bm, 50, 50, true);
+            holder.avatarImage.setImage(photo, "50_50", bm2);
 
             holder.messageTextView.setText(LocaleController.formatUserStatus(user));
             if (user.status != null && user.status.expires > ConnectionsManager.getInstance().getCurrentTime()) {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/GroupCreateFinalActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/GroupCreateFinalActivity.java
index 525ee28e2..dd9757b14 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/GroupCreateFinalActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/GroupCreateFinalActivity.java
@@ -21,6 +21,8 @@
 import android.widget.ImageButton;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.messenger.ConnectionsManager;
 import org.telegram.android.LocaleController;
@@ -58,6 +60,8 @@
 
     private final static int done_button = 1;
 
+    private ThemeManager themeManager;
+
     public GroupCreateFinalActivity(Bundle args) {
         super(args);
         isBroadcast = args.getBoolean("broadcast", false);
@@ -120,7 +124,9 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            //actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
             actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             if (isBroadcast) {
                 actionBarLayer.setTitle(LocaleController.getString("NewBroadcastList", R.string.NewBroadcastList));
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/IdenticonActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/IdenticonActivity.java
index 6289ba136..dbeb14679 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/IdenticonActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/IdenticonActivity.java
@@ -20,6 +20,8 @@
 import android.widget.LinearLayout;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
 import org.telegram.messenger.TLRPC;
@@ -32,6 +34,8 @@
 public class IdenticonActivity extends BaseFragment {
     private int chat_id;
 
+    private ThemeManager themeManager;
+
     public IdenticonActivity(Bundle args) {
         super(args);
     }
@@ -45,7 +49,9 @@ public boolean onFragmentCreate() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            //actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
             actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("EncryptionKey", R.string.EncryptionKey));
             actionBarLayer.setTitleIcon(R.drawable.ic_lock_white, AndroidUtilities.dp(4));
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/LanguageSelectActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/LanguageSelectActivity.java
index dddc89c19..021dafd45 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/LanguageSelectActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/LanguageSelectActivity.java
@@ -21,6 +21,8 @@
 import android.widget.ListView;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.messenger.FileLog;
 import org.telegram.android.LocaleController;
@@ -47,10 +49,14 @@
     private Timer searchTimer;
     public ArrayList<LocaleController.LocaleInfo> searchResult;
 
+    private ThemeManager themeManager;
+
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            //actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
             actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("Language", R.string.Language));
 
@@ -64,7 +70,8 @@ public void onItemClick(int id) {
             });
 
             ActionBarMenu menu = actionBarLayer.createMenu();
-            menu.addItem(0, R.drawable.ic_ab_search).setIsSearchField(true).setActionBarMenuItemSearchListener(new ActionBarMenuItem.ActionBarMenuItemSearchListener() {
+            //menu.addItem(0, R.drawable.ic_ab_search).setIsSearchField(true).setActionBarMenuItemSearchListener(new ActionBarMenuItem.ActionBarMenuItemSearchListener() {
+            menu.addItem(0, themeManager.getDrawable("ic_ab_search", false)).setIsSearchField(true).setActionBarMenuItemSearchListener(new ActionBarMenuItem.ActionBarMenuItemSearchListener() {
                 @Override
                 public void onSearchExpand() {
                     searching = true;
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/LocationActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/LocationActivity.java
index 22abcfa58..33f50d3bf 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/LocationActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/LocationActivity.java
@@ -9,6 +9,9 @@
 package org.telegram.ui;
 
 import android.content.Context;
+import android.graphics.Bitmap;
+import android.graphics.drawable.BitmapDrawable;
+import android.graphics.drawable.Drawable;
 import android.location.Location;
 import android.location.LocationManager;
 import android.view.LayoutInflater;
@@ -26,6 +29,7 @@
 import com.google.android.gms.maps.model.LatLng;
 import com.google.android.gms.maps.model.Marker;
 import com.google.android.gms.maps.model.MarkerOptions;
+import com.teamjihu.ThemeManager;
 
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.ContactsController;
@@ -63,6 +67,8 @@
     private final static int map_list_menu_satellite = 3;
     private final static int map_list_menu_hybrid = 4;
 
+    private ThemeManager themeManager;
+
     public static interface LocationActivityDelegate {
         public abstract void didSelectLocation(double latitude, double longitude);
     }
@@ -91,7 +97,9 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            //actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
             actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             if (messageObject != null) {
                 actionBarLayer.setTitle(LocaleController.getString("ChatLocation", R.string.ChatLocation));
@@ -131,7 +139,8 @@ public void onItemClick(int id) {
             ActionBarMenu menu = actionBarLayer.createMenu();
             menu.addItem(map_to_my_location, R.drawable.ic_ab_location);
 
-            ActionBarMenuItem item = menu.addItem(0, R.drawable.ic_ab_other);
+            //ActionBarMenuItem item = menu.addItem(0, R.drawable.ic_ab_other);
+            ActionBarMenuItem item = menu.addItem(0, themeManager.getDrawable("ic_ab_other", false));
             item.addSubItem(map_list_menu_map, LocaleController.getString("Map", R.string.Map), 0);
             item.addSubItem(map_list_menu_satellite, LocaleController.getString("Satellite", R.string.Satellite), 0);
             item.addSubItem(map_list_menu_hybrid, LocaleController.getString("Hybrid", R.string.Hybrid), 0);
@@ -236,7 +245,14 @@ public void onClick(View view) {
                         if (user.photo != null) {
                             photo = user.photo.photo_small;
                         }
-                        avatarImageView.setImage(photo, "50_50", AndroidUtilities.getUserAvatarForId(user.id));
+                        //avatarImageView.setImage(photo, "50_50", AndroidUtilities.getUserAvatarForId(user.id));
+                        String placeHolderId = AndroidUtilities.getUserAvatarForId(user.id);
+
+                        Drawable d = themeManager.getDrawable(placeHolderId, false);
+                        Bitmap bm = ((BitmapDrawable)d).getBitmap();
+                        Bitmap bm2 = Bitmap.createScaledBitmap(bm, 50, 50, true);
+                        avatarImageView.setImage(photo, "50_50", bm2);
+
                         nameTextView.setText(ContactsController.formatName(user.first_name, user.last_name));
                     }
                     userLocation = new Location("network");
@@ -285,7 +301,14 @@ private void updateUserData() {
                 if (user.photo != null) {
                     photo = user.photo.photo_small;
                 }
-                avatarImageView.setImage(photo, null, AndroidUtilities.getUserAvatarForId(user.id));
+                //avatarImageView.setImage(photo, null, AndroidUtilities.getUserAvatarForId(user.id));
+                String placeHolderId = AndroidUtilities.getUserAvatarForId(user.id);
+
+                Drawable d = themeManager.getDrawable(placeHolderId, false);
+                Bitmap bm = ((BitmapDrawable)d).getBitmap();
+                Bitmap bm2 = Bitmap.createScaledBitmap(bm, 50, 50, true);
+                avatarImageView.setImage(photo, null, bm2);
+
                 nameTextView.setText(ContactsController.formatName(user.first_name, user.last_name));
             }
         }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/LoginActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/LoginActivity.java
index f55d9fb9f..a70771531 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/LoginActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/LoginActivity.java
@@ -13,6 +13,7 @@
 import android.app.ProgressDialog;
 import android.content.Context;
 import android.content.SharedPreferences;
+import android.content.res.Resources;
 import android.os.Bundle;
 import android.view.LayoutInflater;
 import android.view.View;
@@ -22,6 +23,8 @@
 import android.widget.ScrollView;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.messenger.FileLog;
 import org.telegram.android.LocaleController;
@@ -36,6 +39,8 @@
 import java.util.Set;
 
 public class LoginActivity extends BaseFragment implements SlideView.SlideViewDelegate {
+    private ThemeManager themeManager;
+
     private int currentViewNum = 0;
     private SlideView[] views = new SlideView[3];
     private ProgressDialog progressDialog;
@@ -61,7 +66,8 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBarLayer.setDisplayUseLogoEnabled(true, R.drawable.ic_ab_logo);
+            themeManager = new ThemeManager(getParentActivity());
+            actionBarLayer.setDisplayUseLogoEnabled(true, themeManager.getDrawable("ic_ab_logo", false));
             actionBarLayer.setTitle(LocaleController.getString("AppName", R.string.AppName));
 
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/MediaActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/MediaActivity.java
index 7f0dc81cf..19f4e38fa 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/MediaActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/MediaActivity.java
@@ -24,6 +24,8 @@
 import android.widget.GridView;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
 import org.telegram.messenger.FileLoader;
@@ -55,6 +57,8 @@
     private View progressView;
     private TextView emptyView;
 
+    private ThemeManager themeManager;
+
     public MediaActivity(Bundle args) {
         super(args);
     }
@@ -87,7 +91,9 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            //actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
             actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("SharedMedia", R.string.SharedMedia));
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/MessagesActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/MessagesActivity.java
index af2e14064..5a696fb9d 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/MessagesActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/MessagesActivity.java
@@ -180,13 +180,14 @@ public void onTextChanged(EditText editText) {
                 }
             });
             if (onlySelect) {
-                actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+                //actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
+                actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
                 actionBarLayer.setTitle(LocaleController.getString("SelectChat", R.string.SelectChat));
             } else {
-                actionBarLayer.setDisplayUseLogoEnabled(true, R.drawable.ic_ab_logo);
+                actionBarLayer.setDisplayUseLogoEnabled(true, themeManager.getDrawable("ic_ab_logo", false));
                 actionBarLayer.setTitle(LocaleController.getString("AppName", R.string.AppName));
-                menu.addItem(messages_list_menu_new_messages, R.drawable.ic_ab_compose);
-                ActionBarMenuItem item = menu.addItem(0, R.drawable.ic_ab_other);
+                menu.addItem(messages_list_menu_new_messages, themeManager.getDrawable("ic_ab_compose", false));
+                ActionBarMenuItem item = menu.addItem(0, themeManager.getDrawable("ic_ab_other", false));
                 item.addSubItem(messages_list_menu_new_chat, LocaleController.getString("NewGroup", R.string.NewGroup), 0);
                 item.addSubItem(messages_list_menu_new_secret_chat, LocaleController.getString("NewSecretChat", R.string.NewSecretChat), 0);
                 item.addSubItem(messages_list_menu_new_broadcast, LocaleController.getString("NewBroadcastList", R.string.NewBroadcastList), 0);
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/PhotoPickerActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/PhotoPickerActivity.java
index 1e5e128ec..bc29bd5e2 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/PhotoPickerActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/PhotoPickerActivity.java
@@ -24,6 +24,8 @@
 import android.widget.ImageView;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
 import org.telegram.android.MediaController;
@@ -41,6 +43,7 @@
 import java.util.HashMap;
 
 public class PhotoPickerActivity extends BaseFragment implements NotificationCenter.NotificationCenterDelegate, PhotoViewer.PhotoViewerProvider {
+    private ThemeManager themeManager;
 
     public static interface PhotoPickerActivityDelegate {
         public abstract void didSelectPhotos(ArrayList<String> photos);
@@ -84,10 +87,12 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
+            themeManager = new ThemeManager(getParentActivity());
             actionBarLayer.setBackgroundColor(0xff333333);
             actionBarLayer.setItemsBackground(R.drawable.bar_selector_picker);
-            actionBarLayer.setDisplayUseLogoEnabled(true, R.drawable.gallery);
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.photo_back);
+            actionBarLayer.setDisplayUseLogoEnabled(true, themeManager.getDrawable("gallery", false));
+            //actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.photo_back);
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("photo_back", false));
             actionBarLayer.setTitle(LocaleController.getString("Gallery", R.string.Gallery));
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
                 @Override
@@ -115,7 +120,8 @@ public void onItemClick(int id) {
             });
 
             ActionBarMenu menu = actionBarLayer.createMenu();
-            menu.addItem(1, R.drawable.ic_ab_other_white2);
+            //menu.addItem(1, R.drawable.ic_ab_other_white2);
+            menu.addItem(1, themeManager.getDrawable("ic_ab_other_white2", false));
 
             fragmentView = inflater.inflate(R.layout.photo_picker_layout, container, false);
 
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/PhotoViewer.java b/TMessagesProj/src/main/java/org/telegram/ui/PhotoViewer.java
index 5660924eb..aa396f402 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/PhotoViewer.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/PhotoViewer.java
@@ -46,6 +46,8 @@
 import android.widget.Scroller;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.ContactsController;
 import org.telegram.android.MessagesStorage;
@@ -184,6 +186,8 @@
 
     private final static int PAGE_SPACING = AndroidUtilities.dp(30);
 
+    private ThemeManager themeManager;
+
     private static class OverlayView extends FrameLayout {
 
         public TextView actionButton;
@@ -464,6 +468,7 @@ public void setParentActivity(Activity activity) {
             return;
         }
         parentActivity = activity;
+        themeManager = new ThemeManager(activity);
 
         scroller = new Scroller(activity);
 
@@ -499,7 +504,8 @@ public void setParentActivity(Activity activity) {
         actionBar.setLayoutParams(layoutParams);
         actionBarLayer = actionBar.createLayer();
         actionBarLayer.setItemsBackground(R.drawable.bar_selector_white);
-        actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.photo_back);
+        //actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.photo_back);
+        actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("photo_back", false));
         actionBarLayer.setTitle(LocaleController.formatString("Of", R.string.Of, 1, 1));
         actionBar.setCurrentActionBarLayer(actionBarLayer);
 
@@ -582,7 +588,8 @@ public boolean canOpenMenu() {
         });
 
         ActionBarMenu menu = actionBarLayer.createMenu();
-        menuItem = menu.addItem(0, R.drawable.ic_ab_other_white);
+        //menuItem = menu.addItem(0, R.drawable.ic_ab_other_white);
+        menuItem = menu.addItem(0, themeManager.getDrawable("ic_ab_other_white", false));
         menuItem.addSubItem(gallery_menu_save, LocaleController.getString("SaveToGallery", R.string.SaveToGallery), 0);
         menuItem.addSubItem(gallery_menu_showall, LocaleController.getString("ShowAllMedia", R.string.ShowAllMedia), 0);
 
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/PopupNotificationActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/PopupNotificationActivity.java
index c5947b1b2..b3c3ed7fa 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/PopupNotificationActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/PopupNotificationActivity.java
@@ -13,6 +13,9 @@
 import android.content.Context;
 import android.content.Intent;
 import android.content.res.Configuration;
+import android.graphics.Bitmap;
+import android.graphics.drawable.BitmapDrawable;
+import android.graphics.drawable.Drawable;
 import android.os.Bundle;
 import android.os.PowerManager;
 import android.util.AttributeSet;
@@ -29,6 +32,8 @@
 import android.widget.RelativeLayout;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.ContactsController;
 import org.telegram.android.LocaleController;
@@ -86,6 +91,8 @@
     private boolean startedMoving = false;
     private Runnable onAnimationEndRunnable = null;
 
+    private ThemeManager themeManager;
+
     private class FrameLayoutTouch extends FrameLayoutFixed {
         public FrameLayoutTouch(Context context) {
             super(context);
@@ -187,8 +194,11 @@ public void needSendTyping() {
         layoutParams.width = ViewGroup.LayoutParams.MATCH_PARENT;
         actionBar.setLayoutParams(layoutParams);
 
+        themeManager = new ThemeManager(this);
+
         actionBarLayer = actionBar.createLayer();
-        actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+        //actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+        actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
         actionBarLayer.setBackgroundResource(R.color.header);
         actionBarLayer.setItemsBackground(R.drawable.bar_selector);
         actionBar.setCurrentActionBarLayer(actionBarLayer);
@@ -791,7 +801,7 @@ private void updateSubtitle() {
 
     private void checkAndUpdateAvatar() {
         TLRPC.FileLocation newPhoto = null;
-        int placeHolderId = 0;
+        String placeHolderId = "";
         if (currentChat != null) {
             TLRPC.Chat chat = MessagesController.getInstance().getChat(currentChat.id);
             if (chat == null) {
@@ -814,7 +824,12 @@ private void checkAndUpdateAvatar() {
             placeHolderId = AndroidUtilities.getUserAvatarForId(currentUser.id);
         }
         if (avatarImageView != null) {
-            avatarImageView.setImage(newPhoto, "50_50", placeHolderId);
+            //avatarImageView.setImage(newPhoto, "50_50", placeHolderId);
+
+            Drawable d = themeManager.getDrawable(placeHolderId, false);
+            Bitmap bm = ((BitmapDrawable)d).getBitmap();
+            Bitmap bm2 = Bitmap.createScaledBitmap(bm, 50, 50, true);
+            avatarImageView.setImage(newPhoto, "50_50", bm2);
         }
     }
 
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ProfileNotificationsActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/ProfileNotificationsActivity.java
index 38791c60f..ea29574ba 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ProfileNotificationsActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ProfileNotificationsActivity.java
@@ -26,6 +26,8 @@
 import android.widget.ListView;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.MessagesController;
 import org.telegram.android.MessagesStorage;
 import org.telegram.messenger.ConnectionsManager;
@@ -52,6 +54,8 @@
     private int settingsLedRow;
     private int rowCount = 0;
 
+    private ThemeManager themeManager;
+
     public ProfileNotificationsActivity(Bundle args) {
         super(args);
         dialog_id = args.getLong("dialog_id");
@@ -76,7 +80,9 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            //actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
             actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
 
             actionBarLayer.setTitle(LocaleController.getString("NotificationsAndSounds", R.string.NotificationsAndSounds));
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
index d95d0b754..3ee8bc9d8 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
@@ -16,7 +16,10 @@
 import android.content.Intent;
 import android.content.SharedPreferences;
 import android.content.pm.PackageInfo;
+import android.graphics.Bitmap;
 import android.graphics.Typeface;
+import android.graphics.drawable.BitmapDrawable;
+import android.graphics.drawable.Drawable;
 import android.net.Uri;
 import android.os.Bundle;
 import android.text.Html;
@@ -34,6 +37,8 @@
 import android.widget.TextView;
 import android.widget.Toast;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.ContactsController;
 import org.telegram.PhoneFormat.PhoneFormat;
@@ -101,6 +106,8 @@
     private int selectThemeRow;
     private int rowCount;
 
+    private ThemeManager themeManager;
+
     private static class LinkMovementMethodMy extends LinkMovementMethod {
         @Override
         public boolean onTouchEvent(TextView widget, Spannable buffer, MotionEvent event) {
@@ -222,7 +229,9 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            //actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
             actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("Settings", R.string.Settings));
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
@@ -836,7 +845,14 @@ public void onClick(DialogInterface dialogInterface, int i) {
                         photo = user.photo.photo_small;
                         photoBig = user.photo.photo_big;
                     }
-                    avatarImage.setImage(photo, "50_50", AndroidUtilities.getUserAvatarForId(user.id));
+                    //avatarImage.setImage(photo, "50_50", AndroidUtilities.getUserAvatarForId(user.id));
+                    String placeHolderId = AndroidUtilities.getUserAvatarForId(user.id);
+
+                    Drawable d = themeManager.getDrawable(placeHolderId, false);
+                    Bitmap bm = ((BitmapDrawable)d).getBitmap();
+                    Bitmap bm2 = Bitmap.createScaledBitmap(bm, 50, 50, true);
+                    avatarImage.setImage(photo, "50_50", bm2);
+
                     avatarImage.imageReceiver.setVisible(!PhotoViewer.getInstance().isShowingImage(photoBig), false);
                 }
                 return view;
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/SettingsBlockedUsersActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/SettingsBlockedUsersActivity.java
index ba9d8ab47..554027273 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/SettingsBlockedUsersActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/SettingsBlockedUsersActivity.java
@@ -20,6 +20,8 @@
 import android.widget.ListView;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.PhoneFormat.PhoneFormat;
 import org.telegram.android.LocaleController;
 import org.telegram.messenger.TLRPC;
@@ -41,6 +43,8 @@
 
     private final static int block_user = 1;
 
+    private ThemeManager themeManager;
+
     @Override
     public boolean onFragmentCreate() {
         super.onFragmentCreate();
@@ -60,7 +64,9 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            //actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
             actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("BlockedUsers", R.string.BlockedUsers));
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/SettingsNotificationsActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/SettingsNotificationsActivity.java
index 2fc545787..d8127b348 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/SettingsNotificationsActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/SettingsNotificationsActivity.java
@@ -27,6 +27,8 @@
 import android.widget.TextView;
 import android.widget.Toast;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
 import org.telegram.android.NotificationsController;
@@ -75,6 +77,8 @@
     private int resetNotificationsRow;
     private int rowCount = 0;
 
+    private ThemeManager themeManager;
+
     @Override
     public boolean onFragmentCreate() {
         notificationsServiceRow = rowCount++;
@@ -118,7 +122,9 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            //actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
             actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("NotificationsAndSounds", R.string.NotificationsAndSounds));
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/SettingsThemeActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/SettingsThemeActivity.java
index 56a924de4..30c292b8e 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/SettingsThemeActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/SettingsThemeActivity.java
@@ -3,10 +3,17 @@
 import org.telegram.android.LocaleController;
 import org.telegram.ui.Views.ActionBar.ActionBarLayer;
 import org.telegram.ui.Views.ActionBar.BaseFragment;
+
+import android.content.Context;
+import android.os.Bundle;
 import android.view.View;
 import android.view.ViewGroup;
 import android.view.LayoutInflater;
+import android.widget.AdapterView;
+import android.widget.ArrayAdapter;
+import android.widget.BaseAdapter;
 import android.widget.FrameLayout;
+import android.widget.ImageView;
 import android.widget.LinearLayout;
 import android.widget.ListView;
 import android.widget.TextView;
@@ -16,19 +23,28 @@
 import org.telegram.messenger.phonethemeshop.R;
 
 import java.util.ArrayList;
+import java.util.List;
 
 /**
  * Created by soohwanpark on 2014-10-22.
  */
 public class SettingsThemeActivity extends BaseFragment {
-    ThemeManager mThemeManager;
+    ThemeManager themeManager;
+    String currentThemePkg;
     LayoutInflater INFLATER;
 
+    ListView themeList = null;
+    ArrayAdapterThemeList arrayAdapterThemeList = null;
+    List<Bundle> themeItems = new ArrayList<Bundle>();
+    int prevThemePosition;
+
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         INFLATER = inflater;
         if (fragmentView == null) {
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            //actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
             actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("SelectTheme", R.string.SelectTheme));
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
@@ -41,8 +57,15 @@ public void onItemClick(int id) {
             });
 
             fragmentView = inflater.inflate(R.layout.settings_theme_layout, container, false);
-            mThemeManager = new ThemeManager(getParentActivity());
+
+            currentThemePkg = themeManager.getCurrentTheme();
             getThemeList();
+
+            themeList = (ListView)fragmentView.findViewById(R.id.theme_list);
+            arrayAdapterThemeList = new ArrayAdapterThemeList(getParentActivity(), R.layout.theme_item, themeItems);
+            themeList.setAdapter(arrayAdapterThemeList);
+
+            themeList.setOnItemClickListener(onThemeItemClickListener);
         } else {
             ViewGroup parent = (ViewGroup)fragmentView.getParent();
             if (parent != null) {
@@ -56,14 +79,75 @@ private void getThemeList() {
         ArrayList<String> pkgs = new ArrayList<String>();
         ArrayList<String> names = new ArrayList<String>();
 
-        ListView themeList = (ListView)fragmentView.findViewById(R.id.theme_list);
-        mThemeManager.GetThemeList(pkgs, names);
-//        for ( int i = 0; i < pkgs.size(); i++ ) {
-//            FrameLayout themeItem = (FrameLayout)INFLATER.inflate(R.layout.theme_item, themeList, false);
-//            TextView themeName = (TextView)themeItem.findViewById(R.id.theme_name);
-//            themeName.setText(names.get(i));
-//
-//            themeList.addView(themeItem);
-//        }
+        themeManager.GetThemeList(pkgs, names);
+        for ( int i = 0; i < pkgs.size(); i++ ) {
+            Bundle b = new Bundle();
+            b.putString("themeName", names.get(i));
+            b.putString("themePkg", pkgs.get(i));
+            themeItems.add(b);
+        }
+    }
+
+    AdapterView.OnItemClickListener onThemeItemClickListener = new AdapterView.OnItemClickListener() {
+        @Override
+        public void onItemClick(AdapterView<?> parent, View view, int pos, long id) {
+            FrameLayout selectedThemeItem = (FrameLayout)view;
+            Bundle b = (Bundle)selectedThemeItem.getTag();
+
+            if ( !currentThemePkg.equals(b.getString("themePkg")) ) {
+                themeManager.applyTheme(b.getString("themePkg"));
+                ImageView btnCheck = (ImageView)selectedThemeItem.findViewById(R.id.settings_row_check_button);
+                btnCheck.setImageResource(R.drawable.btn_check_on);
+
+                FrameLayout prevThemeItem = (FrameLayout)parent.getChildAt(prevThemePosition);
+                btnCheck = (ImageView)prevThemeItem.findViewById(R.id.settings_row_check_button);
+                btnCheck.setImageResource(R.drawable.btn_check_off);
+            }
+            prevThemePosition = pos;
+        }
+    };
+
+    public class ArrayAdapterThemeList extends ArrayAdapter<Bundle> {
+        int layoutResourceId;
+        List<Bundle> _themeItems;
+
+        public ArrayAdapterThemeList(Context context, int resource, List<Bundle> objects) {
+            super(context, resource, objects);
+
+            layoutResourceId = resource;
+            _themeItems = objects;
+        }
+
+        @Override
+        public View getView(int position, View convertView, ViewGroup parent) {
+            if(convertView == null) {
+                LayoutInflater inflater = (LayoutInflater)getParentActivity().getSystemService(Context.LAYOUT_INFLATER_SERVICE);
+                convertView = inflater.inflate(layoutResourceId, parent, false);
+            }
+
+            if(_themeItems.size() == 0)
+                return null;
+            if(position < 0)
+                position = 0;
+            else if(position >= _themeItems.size())
+                position = _themeItems.size()-1;
+            Bundle item = _themeItems.get(position);
+
+            convertView.setTag(item);
+
+            if ( item != null ) {
+                TextView themeName = (TextView)convertView.findViewById(R.id.theme_name);
+                ImageView btnCheck = (ImageView)convertView.findViewById(R.id.settings_row_check_button);
+                if ( themeName != null ) {
+                    themeName.setText(item.getString("themeName"));
+                    if ( currentThemePkg.equals(item.getString("themePkg")) ) {
+                        btnCheck.setImageResource(R.drawable.btn_check_on);
+                        prevThemePosition = position;
+                    }
+                }
+            }
+
+            return convertView;
+        }
     }
 }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/UserProfileActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/UserProfileActivity.java
index 799743f37..ab4e17a58 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/UserProfileActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/UserProfileActivity.java
@@ -12,7 +12,10 @@
 import android.content.Context;
 import android.content.DialogInterface;
 import android.content.Intent;
+import android.graphics.Bitmap;
 import android.graphics.Typeface;
+import android.graphics.drawable.BitmapDrawable;
+import android.graphics.drawable.Drawable;
 import android.net.Uri;
 import android.os.Bundle;
 import android.view.LayoutInflater;
@@ -23,6 +26,8 @@
 import android.widget.ListView;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.PhoneFormat.PhoneFormat;
 import org.telegram.android.LocaleController;
@@ -72,6 +77,8 @@
     private int sharedMediaRow;
     private int rowCount = 0;
 
+    private ThemeManager themeManager;
+
     public UserProfileActivity(Bundle args) {
         super(args);
     }
@@ -129,7 +136,9 @@ private void updateRowsIds() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            //actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
             actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             if (dialog_id != 0) {
                 actionBarLayer.setTitle(LocaleController.getString("SecretTitle", R.string.SecretTitle));
@@ -432,7 +441,8 @@ private void createActionBarMenu() {
             if (user == null) {
                 return;
             }
-            ActionBarMenuItem item = menu.addItem(0, R.drawable.ic_ab_other);
+            //ActionBarMenuItem item = menu.addItem(0, R.drawable.ic_ab_other);
+            ActionBarMenuItem item = menu.addItem(0, themeManager.getDrawable("ic_ab_other", false));
             if (user.phone != null && user.phone.length() != 0) {
                 item.addSubItem(add_contact, LocaleController.getString("AddContact", R.string.AddContact), 0);
                 item.addSubItem(share_contact, LocaleController.getString("ShareContact", R.string.ShareContact), 0);
@@ -441,7 +451,8 @@ private void createActionBarMenu() {
                 item.addSubItem(block_contact, !userBlocked ? LocaleController.getString("BlockContact", R.string.BlockContact) : LocaleController.getString("Unblock", R.string.Unblock), 0);
             }
         } else {
-            ActionBarMenuItem item = menu.addItem(0, R.drawable.ic_ab_other);
+            //ActionBarMenuItem item = menu.addItem(0, R.drawable.ic_ab_other);
+            ActionBarMenuItem item = menu.addItem(0, themeManager.getDrawable("ic_ab_other", false));
             item.addSubItem(share_contact, LocaleController.getString("ShareContact", R.string.ShareContact), 0);
             item.addSubItem(block_contact, !userBlocked ? LocaleController.getString("BlockContact", R.string.BlockContact) : LocaleController.getString("Unblock", R.string.Unblock), 0);
             item.addSubItem(edit_contact, LocaleController.getString("EditContact", R.string.EditContact), 0);
@@ -550,7 +561,14 @@ public void onClick(View view) {
                     photo = user.photo.photo_small;
                     photoBig = user.photo.photo_big;
                 }
-                avatarImage.setImage(photo, "50_50", AndroidUtilities.getUserAvatarForId(user.id));
+                //avatarImage.setImage(photo, "50_50", AndroidUtilities.getUserAvatarForId(user.id));
+                String placeHolderId = AndroidUtilities.getUserAvatarForId(user.id);
+
+                Drawable d = themeManager.getDrawable(placeHolderId, false);
+                Bitmap bm = ((BitmapDrawable)d).getBitmap();
+                Bitmap bm2 = Bitmap.createScaledBitmap(bm, 50, 50, true);
+                avatarImage.setImage(photo, "50_50", bm2);
+
                 avatarImage.imageReceiver.setVisible(!PhotoViewer.getInstance().isShowingImage(photoBig), false);
                 return view;
             } else if (type == 1) {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/VideoEditorActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/VideoEditorActivity.java
index cc9653706..2363751c7 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/VideoEditorActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/VideoEditorActivity.java
@@ -39,6 +39,7 @@
 import com.coremedia.iso.boxes.TrackHeaderBox;
 import com.googlecode.mp4parser.util.Matrix;
 import com.googlecode.mp4parser.util.Path;
+import com.teamjihu.ThemeManager;
 
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
@@ -94,6 +95,8 @@
     private long esimatedDuration = 0;
     private long originalSize = 0;
 
+    private ThemeManager themeManager;
+
     public interface VideoEditorActivityDelegate {
         public abstract void didFinishEditVideo(String videoPath, long startTime, long endTime, int resultWidth, int resultHeight, int rotationValue, int originalWidth, int originalHeight, int bitrate, long estimatedSize, long estimatedDuration);
     }
@@ -214,9 +217,11 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
+            themeManager = new ThemeManager(getParentActivity());
+            //actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.photo_back);
+            actionBarLayer.setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("photo_back", false));
             actionBarLayer.setBackgroundColor(0xff333333);
             actionBarLayer.setItemsBackground(R.drawable.bar_selector_white);
-            actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.photo_back);
             actionBarLayer.setTitle(LocaleController.getString("EditVideo", R.string.EditVideo));
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
                 @Override
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarLayer.java b/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarLayer.java
index e95c65d86..9b15d6594 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarLayer.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarLayer.java
@@ -21,10 +21,13 @@
 import android.widget.ImageView;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.messenger.phonethemeshop.R;
 
 public class ActionBarLayer extends FrameLayout {
+    private ThemeManager themeManager;
 
     public static class ActionBarMenuOnItemClick {
         public void onItemClick(int id) {
@@ -44,7 +47,9 @@ public boolean canOpenMenu() {
     private ActionBarMenu menu;
     private ActionBarMenu actionMode;
     private int logoResourceId;
+    private Drawable logoResourceDrawable;
     private int backResourceId;
+    private Drawable backResourceDrawable;
     protected ActionBar parentActionBar;
     private boolean oldUseLogo;
     private boolean oldUseBack;
@@ -80,6 +85,8 @@ public void onClick(View view) {
             }
         });
         backButtonFrameLayout.setEnabled(false);
+
+        themeManager = new ThemeManager(context);
     }
 
     public ActionBarLayer(Context context) {
@@ -216,6 +223,7 @@ public void positionMenu(int width, int height) {
         menu.measure(width, height);
     }
 
+    /*
     public void setDisplayUseLogoEnabled(boolean value, int resource) {
         if (value && logoImageView == null) {
             logoResourceId = resource;
@@ -229,7 +237,22 @@ public void setDisplayUseLogoEnabled(boolean value, int resource) {
             positionLogoImage(getMeasuredHeight());
         }
     }
+    */
+    public void setDisplayUseLogoEnabled(boolean value, Drawable d) {
+        if (value && logoImageView == null) {
+            logoResourceDrawable = d;
+            logoImageView = new ImageView(getContext());
+            logoImageView.setScaleType(ImageView.ScaleType.CENTER_INSIDE);
+            backButtonFrameLayout.addView(logoImageView);
+        }
+        if (logoImageView != null) {
+            logoImageView.setVisibility(value ? VISIBLE : GONE);
+            logoImageView.setImageDrawable(d);
+            positionLogoImage(getMeasuredHeight());
+        }
+    }
 
+    /*
     public void setDisplayHomeAsUpEnabled(boolean value, int resource) {
         if (value && backButtonImageView == null) {
             backResourceId = resource;
@@ -243,6 +266,20 @@ public void setDisplayHomeAsUpEnabled(boolean value, int resource) {
             positionBackImage(getMeasuredHeight());
         }
     }
+    */
+    public void setDisplayHomeAsUpEnabled(boolean value, Drawable d) {
+        if (value && backButtonImageView == null) {
+            backResourceDrawable = d;
+            backButtonImageView = new ImageView(getContext());
+            backButtonFrameLayout.addView(backButtonImageView);
+        }
+        if (backButtonImageView != null) {
+            backButtonImageView.setVisibility(value ? VISIBLE : GONE);
+            backButtonFrameLayout.setEnabled(value);
+            backButtonImageView.setImageDrawable(d);
+            positionBackImage(getMeasuredHeight());
+        }
+    }
 
     public void setSubtitle(CharSequence value) {
         if (value != null && subTitleTextView == null) {
@@ -414,15 +451,15 @@ protected void onSearchFieldVisibilityChanged(boolean visible) {
         backButtonFrameLayout.setPadding(0, 0, visible ? 0 : AndroidUtilities.dp(4), 0);
         if (visible) {
             oldUseLogo = logoImageView != null && logoImageView.getVisibility() == VISIBLE;
-            setDisplayUseLogoEnabled(true, R.drawable.ic_ab_search);
+            setDisplayUseLogoEnabled(true, themeManager.getDrawable("ic_ab_search", false));
         } else {
-            setDisplayUseLogoEnabled(oldUseLogo, logoResourceId);
+            setDisplayUseLogoEnabled(oldUseLogo, logoResourceDrawable);
         }
         if (visible) {
             oldUseBack = backButtonImageView != null && backButtonImageView.getVisibility() == VISIBLE;
-            setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            setDisplayHomeAsUpEnabled(true, themeManager.getDrawable("ic_ab_back", false));
         } else {
-            setDisplayHomeAsUpEnabled(oldUseBack, backResourceId);
+            setDisplayHomeAsUpEnabled(oldUseBack, backResourceDrawable);
         }
         positionBackOverlay(getMeasuredWidth(), getMeasuredHeight());
     }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarLayout.java b/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarLayout.java
index f483e5d64..5ffd76d5e 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarLayout.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarLayout.java
@@ -15,6 +15,7 @@
 import android.content.Context;
 import android.content.Intent;
 import android.content.res.Configuration;
+import android.graphics.Color;
 import android.os.Build;
 import android.os.Handler;
 import android.view.ActionMode;
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarMenuItem.java b/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarMenuItem.java
index 45049e2cd..1eb4c4161 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarMenuItem.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarMenuItem.java
@@ -10,6 +10,7 @@
 
 import android.content.Context;
 import android.graphics.Rect;
+import android.graphics.drawable.Drawable;
 import android.os.Build;
 import android.text.Editable;
 import android.text.TextWatcher;
@@ -121,6 +122,7 @@ public boolean onTouchEvent(MotionEvent event) {
         return super.onTouchEvent(event);
     }
 
+
     public void addSubItem(int id, String text, int icon) {
         if (popupLayout == null) {
             rect = new Rect();
@@ -201,6 +203,86 @@ public void onClick(View view) {
         });
     }
 
+    public void addSubItem(int id, String text, Drawable icon) {
+        if (popupLayout == null) {
+            rect = new Rect();
+            location = new int[2];
+            popupLayout = new ActionBarPopupWindow.ActionBarPopupWindowLayout(getContext());
+            popupLayout.setOrientation(LinearLayout.VERTICAL);
+            popupLayout.setBackgroundResource(R.drawable.popup_fixed);
+            popupLayout.setOnTouchListener(new OnTouchListener() {
+                @Override
+                public boolean onTouch(View v, MotionEvent event) {
+                    if (event.getActionMasked() == MotionEvent.ACTION_DOWN) {
+                        if (popupWindow != null && popupWindow.isShowing()) {
+                            v.getHitRect(rect);
+                            if (!rect.contains((int)event.getX(), (int)event.getY())) {
+                                popupWindow.dismiss();
+                            }
+                        }
+                    }
+                    return false;
+                }
+            });
+            popupLayout.setDispatchKeyEventListener(new ActionBarPopupWindow.OnDispatchKeyEventListener() {
+                @Override
+                public void onDispatchKeyEvent(KeyEvent keyEvent) {
+                    if (keyEvent.getKeyCode() == KeyEvent.KEYCODE_BACK && keyEvent.getRepeatCount() == 0 && popupWindow != null && popupWindow.isShowing()) {
+                        popupWindow.dismiss();
+                    }
+                }
+            });
+        }
+        if (popupLayout.getChildCount() != 0) {
+            View delimeter = new View(getContext());
+            delimeter.setBackgroundColor(0xffdcdcdc);
+            popupLayout.addView(delimeter);
+            LinearLayout.LayoutParams layoutParams = (LinearLayout.LayoutParams)delimeter.getLayoutParams();
+            layoutParams.width = LinearLayout.LayoutParams.MATCH_PARENT;
+            layoutParams.height = AndroidUtilities.density >= 3 ? 2 : 1;
+            delimeter.setLayoutParams(layoutParams);
+            delimeter.setTag(100 + id);
+        }
+        TextView textView = new TextView(getContext());
+        textView.setTextColor(0xff000000);
+        textView.setBackgroundResource(R.drawable.list_selector);
+        if (!LocaleController.isRTL) {
+            textView.setGravity(Gravity.CENTER_VERTICAL);
+        } else {
+            textView.setGravity(Gravity.CENTER_VERTICAL | Gravity.RIGHT);
+        }
+        textView.setPadding(AndroidUtilities.dp(16), 0, AndroidUtilities.dp(16), 0);
+        textView.setTextSize(18);
+        textView.setMinWidth(AndroidUtilities.dp(196));
+        textView.setTag(id);
+        textView.setText(text);
+        if (icon != null) {
+            textView.setCompoundDrawablePadding(AndroidUtilities.dp(12));
+            if (!LocaleController.isRTL) {
+                textView.setCompoundDrawablesWithIntrinsicBounds(icon, null, null, null);
+            } else {
+                textView.setCompoundDrawablesWithIntrinsicBounds(null, null, icon, null);
+            }
+        }
+        popupLayout.addView(textView);
+        LinearLayout.LayoutParams layoutParams = (LinearLayout.LayoutParams)textView.getLayoutParams();
+        if (LocaleController.isRTL) {
+            layoutParams.gravity = Gravity.RIGHT;
+        }
+        layoutParams.width = LinearLayout.LayoutParams.WRAP_CONTENT;
+        layoutParams.height = AndroidUtilities.dp(48);
+        textView.setLayoutParams(layoutParams);
+        textView.setOnClickListener(new OnClickListener() {
+            @Override
+            public void onClick(View view) {
+                parentMenu.onItemClick((Integer) view.getTag());
+                if (popupWindow != null && popupWindow.isShowing()) {
+                    popupWindow.dismiss();
+                }
+            }
+        });
+    }
+
     public boolean hasSubMenu() {
         return popupLayout != null;
     }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/BaseFragment.java b/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/BaseFragment.java
index 0a699e3e6..184ab3a81 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/BaseFragment.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/BaseFragment.java
@@ -12,11 +12,14 @@
 import android.app.AlertDialog;
 import android.content.DialogInterface;
 import android.content.Intent;
+import android.graphics.Color;
 import android.os.Bundle;
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.messenger.ConnectionsManager;
 import org.telegram.messenger.FileLog;
 import org.telegram.messenger.phonethemeshop.R;
@@ -31,6 +34,8 @@
     private AlertDialog visibleDialog = null;
     protected boolean swipeBackEnabled = true;
 
+    private ThemeManager themeManager;
+
     public BaseFragment() {
         classGuid = ConnectionsManager.getInstance().generateClassGuid();
     }
@@ -64,7 +69,10 @@ public void setParentLayout(ActionBarLayout layout) {
                 }
                 actionBarLayer = parentLayout.getInternalActionBar().createLayer();
                 actionBarLayer.parentFragment = this;
-                actionBarLayer.setBackgroundResource(R.color.header);
+
+                themeManager = new ThemeManager(getParentActivity());
+                themeManager.setBackgroundDrawable(actionBarLayer, themeManager.getDrawable("bg_actionbar", false));
+
                 actionBarLayer.setItemsBackground(R.drawable.bar_selector);
             }
         }
diff --git a/TMessagesProj/src/main/res/drawable/bg_actionbar.xml b/TMessagesProj/src/main/res/drawable/bg_actionbar.xml
new file mode 100644
index 000000000..cbfa21fda
--- /dev/null
+++ b/TMessagesProj/src/main/res/drawable/bg_actionbar.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0" encoding="utf-8"?>
+<shape xmlns:android="http://schemas.android.com/apk/res/android" >
+    <solid android:color="#ff54759e" />
+</shape>
\ No newline at end of file
diff --git a/TMessagesProj/src/main/res/layout/messages_list.xml b/TMessagesProj/src/main/res/layout/messages_list.xml
index bd3eb6002..7a933fd71 100644
--- a/TMessagesProj/src/main/res/layout/messages_list.xml
+++ b/TMessagesProj/src/main/res/layout/messages_list.xml
@@ -21,8 +21,7 @@
         android:textColor="#808080"
         android:gravity="center"
         android:textSize="24dp"
-        android:id="@+id/searchEmptyView"
-        android:visibility="invisible"/>
+        android:id="@+id/searchEmptyView"/>
 
     <LinearLayout
         android:layout_width="fill_parent"
diff --git a/TMessagesProj/src/main/res/layout/settings_theme_layout.xml b/TMessagesProj/src/main/res/layout/settings_theme_layout.xml
index 9649c338f..65e072af0 100644
--- a/TMessagesProj/src/main/res/layout/settings_theme_layout.xml
+++ b/TMessagesProj/src/main/res/layout/settings_theme_layout.xml
@@ -4,7 +4,6 @@
     android:orientation="horizontal"
     android:layout_width="fill_parent"
     android:layout_height="wrap_content"
-    android:paddingTop="13dp"
     android:paddingBottom="12dp">
     <ListView
         android:id="@+id/theme_list"
diff --git a/TMessagesProj/src/main/res/layout/theme_item.xml b/TMessagesProj/src/main/res/layout/theme_item.xml
index ca77d6cd6..beede905c 100644
--- a/TMessagesProj/src/main/res/layout/theme_item.xml
+++ b/TMessagesProj/src/main/res/layout/theme_item.xml
@@ -1,16 +1,34 @@
 <?xml version="1.0" encoding="utf-8"?>
 <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
     android:layout_width="match_parent"
-    android:layout_height="50dp">
+    android:layout_height="70dp"
+    android:layout_gravity="top">
 
-    <LinearLayout
-        android:layout_width="match_parent"
-        android:layout_height="match_parent"
-        android:orientation="horizontal">
-        <TextView
-            android:id="@+id/theme_name"
-            android:layout_width="match_parent"
-            android:layout_height="match_parent" />
-    </LinearLayout>
+    <TextView
+        android:textSize="18dp"
+        android:textColor="#333333"
+        android:id="@+id/theme_name"
+        android:layout_width="wrap_content"
+        android:layout_height="fill_parent"
+        android:layout_marginLeft="8dp"
+        android:layout_marginRight="104dp"
+        android:gravity="center_vertical"
+        android:layout_gravity="top"/>
+
+    <ImageView
+        android:layout_gravity="center_vertical|right"
+        android:id="@+id/settings_row_check_button"
+        android:duplicateParentState="false"
+        android:layout_width="wrap_content"
+        android:layout_height="wrap_content"
+        android:layout_marginRight="8dp"
+        android:src="@drawable/btn_check_off"/>
+
+    <View
+        android:background="@color/divider"
+        android:layout_width="fill_parent"
+        android:layout_height="1px"
+        android:layout_gravity="bottom"
+        android:id="@+id/settings_row_divider"/>
 
 </FrameLayout>
diff --git a/TMessagesProj/src/main/res/values/styles.xml b/TMessagesProj/src/main/res/values/styles.xml
index a6dcf0b96..8198de7d1 100644
--- a/TMessagesProj/src/main/res/values/styles.xml
+++ b/TMessagesProj/src/main/res/values/styles.xml
@@ -35,7 +35,7 @@
     <!--ACTION BAR-->
 
     <style name="ActionBar.Transparent.TMessages.Start" parent="android:style/Widget.Holo.Light.ActionBar">
-        <item name="android:background">@color/header</item>
+        <!--<item name="android:background">@color/header</item>-->
         <item name="android:logo">@drawable/transparent</item>
         <item name="android:title">""</item>
     </style>
