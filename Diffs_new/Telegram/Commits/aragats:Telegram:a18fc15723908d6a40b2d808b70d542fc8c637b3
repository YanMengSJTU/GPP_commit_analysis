diff --git a/TMessagesProj/build.gradle b/TMessagesProj/build.gradle
index c8852e395..2ab6f192f 100644
--- a/TMessagesProj/build.gradle
+++ b/TMessagesProj/build.gradle
@@ -21,7 +21,7 @@ dependencies {
 
 android {
     compileSdkVersion 23
-    buildToolsVersion '23.0.1'
+    buildToolsVersion '23.0.3'
 
     useLibrary 'org.apache.http.legacy' // FOT HTTP APACHE CLIENT
 
diff --git a/TMessagesProj/src/main/java/org/telegram/android/NotificationCenter.java b/TMessagesProj/src/main/java/org/telegram/android/NotificationCenter.java
index 79069c929..db1f671a7 100644
--- a/TMessagesProj/src/main/java/org/telegram/android/NotificationCenter.java
+++ b/TMessagesProj/src/main/java/org/telegram/android/NotificationCenter.java
@@ -37,6 +37,10 @@
     //    public static final int loadPostsError = totalEvents++;
     public static final int invalidPost = totalEvents++;
 
+    public static final int locationPermissionGranted = totalEvents++;
+    public static final int storagePermissionGranted = totalEvents++;
+    public static final int cameraPermissionGranted = totalEvents++;
+
 
     public static final int didReceivedNewPosts = totalEvents++; //TODO
     public static final int updateInterfaces = totalEvents++; //TODO
diff --git a/TMessagesProj/src/main/java/org/telegram/android/location/LocationManagerHelper.java b/TMessagesProj/src/main/java/org/telegram/android/location/LocationManagerHelper.java
index 2688fe8ee..1c6a6fbcd 100644
--- a/TMessagesProj/src/main/java/org/telegram/android/location/LocationManagerHelper.java
+++ b/TMessagesProj/src/main/java/org/telegram/android/location/LocationManagerHelper.java
@@ -1,5 +1,7 @@
 package org.telegram.android.location;
 
+import android.Manifest;
+import android.app.Activity;
 import android.content.Context;
 import android.content.pm.ApplicationInfo;
 import android.content.pm.PackageManager;
@@ -8,10 +10,12 @@
 import android.location.Location;
 import android.location.LocationListener;
 import android.location.LocationManager;
+import android.os.Build;
 import android.os.Bundle;
 
 import org.telegram.messenger.TLRPC;
 import org.telegram.utils.CollectionUtils;
+import org.telegram.utils.Permissions;
 import org.telegram.utils.StringUtils;
 
 import java.io.IOException;
@@ -91,6 +95,13 @@ public void onProviderDisabled(String provider) {
 
     //TODO move the method to other place.
     public void runLocationListener() {
+        Activity activity = ApplicationLoader.parentActivity;
+        //TODO check both permissions
+        if (!Permissions.locationPermitted && activity != null && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M && activity.checkSelfPermission(Manifest.permission.ACCESS_COARSE_LOCATION) != PackageManager.PERMISSION_GRANTED) {
+//            activity.requestPermissions(Permissions.LOCATION_PERMISSION_GROUP, Permissions.LOCATION_REQUEST_CODE);
+            return;
+        }
+
         LocationManager locationManager = (LocationManager) ApplicationLoader.applicationContext.getSystemService(Context.LOCATION_SERVICE);
 
 // Register the listener with the Location Manager to receive location updates
@@ -99,6 +110,12 @@ public void runLocationListener() {
     }
 
     public void stopLocationListener() {
+        Activity activity = ApplicationLoader.parentActivity;
+        //TODO check both permissions
+        if (!Permissions.locationPermitted && activity != null && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M && activity.checkSelfPermission(Manifest.permission.ACCESS_COARSE_LOCATION) != PackageManager.PERMISSION_GRANTED) {
+//            activity.requestPermissions(Permissions.LOCATION_PERMISSION_GROUP, Permissions.LOCATION_REQUEST_CODE);
+            return;
+        }
         LocationManager locationManager = (LocationManager) ApplicationLoader.applicationContext.getSystemService(Context.LOCATION_SERVICE);
         locationManager.removeUpdates(locationListener);
 
@@ -109,6 +126,12 @@ public void stopLocationListener() {
     //TODO-aragats method to get location
     // TODO It does not work all time. It return only the last location, but not search current location ((( .
     public Location getLastLocation() {
+        Activity activity = ApplicationLoader.parentActivity;
+        //TODO check both permissions
+        if (!Permissions.locationPermitted && activity != null && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M && activity.checkSelfPermission(Manifest.permission.ACCESS_COARSE_LOCATION) != PackageManager.PERMISSION_GRANTED) {
+            activity.requestPermissions(Permissions.LOCATION_PERMISSION_GROUP, Permissions.LOCATION_REQUEST_CODE);
+            return null;
+        }
         LocationManager lm = (LocationManager) ApplicationLoader.applicationContext.getSystemService(Context.LOCATION_SERVICE);
         List<String> providers = lm.getProviders(true);
         Location l = null;
@@ -130,6 +153,11 @@ public Location getLocation4TimeLine() {
     }
 
     public boolean isLocationServiceEnabled() {
+        Activity activity = ApplicationLoader.parentActivity;
+        if (!Permissions.locationPermitted && activity != null && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M && activity.checkSelfPermission(Manifest.permission.ACCESS_COARSE_LOCATION) != PackageManager.PERMISSION_GRANTED) {
+            activity.requestPermissions(Permissions.LOCATION_PERMISSION_GROUP, Permissions.LOCATION_REQUEST_CODE);
+            return false;
+        }
         LocationManager lm = (LocationManager) ApplicationLoader.applicationContext.getSystemService(Context.LOCATION_SERVICE);
         return (lm.isProviderEnabled(LocationManager.GPS_PROVIDER) && lm.isProviderEnabled(LocationManager.NETWORK_PROVIDER));
     }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/BaseFragment.java b/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/BaseFragment.java
index 411305c5f..f2e508ddd 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/BaseFragment.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/BaseFragment.java
@@ -285,4 +285,9 @@ protected void onDialogDismiss() {
     public void setVisibleDialog(Dialog dialog) {
         visibleDialog = dialog;
     }
+
+    //aragats
+    public void onRequestPermissionsResultFragment(int requestCode, String[] permissions, int[] grantResults) {
+
+    }
 }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Adapters/PostsAdapter.java b/TMessagesProj/src/main/java/org/telegram/ui/Adapters/PostsAdapter.java
index 6d3b8f871..89dd60163 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Adapters/PostsAdapter.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Adapters/PostsAdapter.java
@@ -8,8 +8,11 @@
 
 package org.telegram.ui.Adapters;
 
+import android.Manifest;
 import android.app.Activity;
 import android.content.Context;
+import android.content.pm.PackageManager;
+import android.os.Build;
 import android.os.Bundle;
 import android.view.View;
 import android.view.ViewGroup;
@@ -26,6 +29,7 @@
 import org.telegram.ui.LocationActivityAragats;
 import org.telegram.ui.PhotoViewer;
 import org.telegram.ui.PostsActivity;
+import org.telegram.utils.Permissions;
 import org.telegram.utils.StringUtils;
 
 // TODO-aragats
@@ -127,6 +131,15 @@ public void didClickedImage(PostCell cell) {
 
                 @Override
                 public void didClickedVenue(PostCell cell) {
+                    if (postsActivity == null) {
+                        return;
+                    }
+                    Activity activity = postsActivity.getParentActivity();
+                    //TODO check both permissions
+                    if (!Permissions.locationPermitted && activity != null && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M && activity.checkSelfPermission(Manifest.permission.ACCESS_COARSE_LOCATION) != PackageManager.PERMISSION_GRANTED) {
+                        activity.requestPermissions(Permissions.LOCATION_PERMISSION_GROUP, Permissions.LOCATION_REQUEST_CODE);
+                        return;
+                    }
                     Post cellPost = cell.getPost();
                     LocationActivityAragats fragment = new LocationActivityAragats(new Bundle());
                     fragment.setPost(cellPost);
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
index 8daabfb9c..416568be4 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
@@ -13,6 +13,7 @@
 import android.content.DialogInterface;
 import android.content.Intent;
 import android.content.SharedPreferences;
+import android.content.pm.PackageManager;
 import android.content.res.Configuration;
 import android.graphics.Point;
 import android.net.Uri;
@@ -48,6 +49,7 @@
 import org.telegram.ui.Adapters.DrawerLayoutAdapter;
 import org.telegram.ui.Components.LayoutHelper;
 import org.telegram.utils.CollectionUtils;
+import org.telegram.utils.Permissions;
 
 import java.util.ArrayList;
 import java.util.Map;
@@ -80,6 +82,8 @@
     @Override
     protected void onCreate(Bundle savedInstanceState) {
         ApplicationLoader.postInitApplication();
+        //Set parentActivity to ApplicationLoader
+        ApplicationLoader.parentActivity = this;
 
         if (!UserConfig.isClientActivated()) {
             Intent intent = getIntent();
@@ -946,4 +950,30 @@ public void onRebuildAllFragments(ActionBarLayout layout) {
         }
         drawerLayoutAdapter.notifyDataSetChanged();
     }
+
+    @Override
+    public void onRequestPermissionsResult(int requestCode, String[] permissions, int[] grantResults) {
+        super.onRequestPermissionsResult(requestCode, permissions, grantResults);
+
+        switch (requestCode) {
+            case Permissions.LOCATION_REQUEST_CODE:
+                if (grantResults.length > 0 && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
+                    Permissions.locationPermitted = true;
+                    NotificationCenter.getInstance().postNotificationName(NotificationCenter.locationPermissionGranted);
+                }
+                break;
+            case Permissions.STORAGE_REQUEST:
+                if (grantResults.length > 0 && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
+                    Permissions.storagePermitted = true;
+                    NotificationCenter.getInstance().postNotificationName(NotificationCenter.storagePermissionGranted);
+                }
+                break;
+            case Permissions.CAMERA_REQUEST:
+                if (grantResults.length > 0 && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
+                    Permissions.cameraPermitted = true;
+                    NotificationCenter.getInstance().postNotificationName(NotificationCenter.cameraPermissionGranted);
+                }
+                break;
+        }
+    }
 }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/PhotoViewer.java b/TMessagesProj/src/main/java/org/telegram/ui/PhotoViewer.java
index f1849aa4f..051412ec3 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/PhotoViewer.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/PhotoViewer.java
@@ -8,12 +8,14 @@
 
 package org.telegram.ui;
 
+import android.Manifest;
 import android.annotation.SuppressLint;
 import android.app.Activity;
 import android.app.AlertDialog;
 import android.content.Context;
 import android.content.DialogInterface;
 import android.content.Intent;
+import android.content.pm.PackageManager;
 import android.graphics.Bitmap;
 import android.graphics.Canvas;
 import android.graphics.Paint;
@@ -69,6 +71,7 @@
 import org.telegram.ui.Components.PhotoPickerBottomLayout;
 import org.telegram.ui.Components.PhotoViewerCaptionEnterView;
 import org.telegram.ui.Components.SizeNotifierRelativeLayoutPhoto;
+import org.telegram.utils.Permissions;
 
 import java.io.File;
 import java.util.ArrayList;
@@ -647,6 +650,11 @@ public void onItemClick(int id) {
                     }
                     closePhoto(true, false);
                 } else if (id == gallery_menu_save) {
+                    if (!Permissions.storagePermitted && parentActivity != null && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M && parentActivity.checkSelfPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) {
+                        parentActivity.requestPermissions(Permissions.STORAGE_PERMISSION_GROUP, Permissions.STORAGE_REQUEST);
+                        return;
+                    }
+                    Permissions.storagePermitted = true;
                     File f = null;
                     //TODO-aragats new. It is important do not save again from the internet but use saved in cache. // TOOD why jpg???
                     if (currentPost != null) {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/PostCreateActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/PostCreateActivity.java
index 0c6e90a16..a497f5cb3 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/PostCreateActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/PostCreateActivity.java
@@ -8,11 +8,13 @@
 
 package org.telegram.ui;
 
+import android.Manifest;
 import android.app.Activity;
 import android.app.ProgressDialog;
 import android.content.Context;
 import android.content.Intent;
 import android.content.SharedPreferences;
+import android.content.pm.PackageManager;
 import android.content.res.Configuration;
 import android.graphics.Bitmap;
 import android.graphics.BitmapFactory;
@@ -69,6 +71,7 @@
 import org.telegram.utils.CollectionUtils;
 import org.telegram.utils.Constants;
 import org.telegram.utils.NotificationEnum;
+import org.telegram.utils.Permissions;
 import org.telegram.utils.StringUtils;
 
 import java.io.File;
@@ -1458,6 +1461,12 @@ public void removePost(Post post) {
 
 
     private void openLocationChooser() {
+        Activity activity = getParentActivity();
+        //TODO check both permissions
+        if (!Permissions.locationPermitted && activity != null && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M && activity.checkSelfPermission(Manifest.permission.ACCESS_COARSE_LOCATION) != PackageManager.PERMISSION_GRANTED) {
+            activity.requestPermissions(Permissions.LOCATION_PERMISSION_GROUP, Permissions.LOCATION_REQUEST_CODE);
+            return;
+        }
         if (!isGoogleMapsInstalled()) {
             return;
         }
@@ -1754,6 +1763,12 @@ public boolean didSelectVideo(String path) {
 
 
     private void openPhotoPicker() {
+        Activity activity = getParentActivity();
+        if (!Permissions.storagePermitted && activity != null && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M && activity.checkSelfPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) {
+            activity.requestPermissions(Permissions.STORAGE_PERMISSION_GROUP, Permissions.STORAGE_REQUEST);
+            return;
+        }
+        Permissions.storagePermitted = true;
         if (photoPickerWrapper != null) {
             startProgressView();
             photoPickerWrapper.openPhotoPicker();
@@ -1795,6 +1810,12 @@ public boolean didSelectVideo(String path) {
     }
 
     private boolean attachPhotoHandle() {
+        Activity activity = getParentActivity();
+        if (!Permissions.cameraPermitted && activity != null && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M && activity.checkSelfPermission(Manifest.permission.CAMERA) != PackageManager.PERMISSION_GRANTED) {
+            activity.requestPermissions(Permissions.CAMERA_PERMISSION_GROUP, Permissions.CAMERA_REQUEST);
+            return false;
+        }
+        Permissions.cameraPermitted = true;
         try {
             Intent takePictureIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);
             File image = AndroidUtilities.generatePicturePath();
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/PostsActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/PostsActivity.java
index 5340f441b..b4c5796a3 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/PostsActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/PostsActivity.java
@@ -8,6 +8,7 @@
 
 package org.telegram.ui;
 
+import android.Manifest;
 import android.animation.ObjectAnimator;
 import android.animation.StateListAnimator;
 import android.annotation.SuppressLint;
@@ -16,6 +17,7 @@
 import android.content.Context;
 import android.content.DialogInterface;
 import android.content.Intent;
+import android.content.pm.PackageManager;
 import android.content.res.Configuration;
 import android.graphics.Bitmap;
 import android.graphics.Outline;
@@ -71,6 +73,7 @@
 import org.telegram.ui.Components.RecyclerListView;
 import org.telegram.ui.Components.ResourceLoader;
 import org.telegram.utils.Constants;
+import org.telegram.utils.Permissions;
 import org.telegram.utils.StringUtils;
 
 import ru.aragats.wgo.ApplicationLoader;
@@ -140,7 +143,6 @@ public void run() {
     private final static int action_bar_menu_other = itemId++;
 
     private boolean offlineMode;
-//    private boolean checkPermission = true;
 
 
     //TODO-legacy. update according to new version.
@@ -255,12 +257,12 @@ public boolean onFragmentCreate() {
             NotificationCenter.getInstance().addObserver(this, NotificationCenter.postsNeedReload);
             NotificationCenter.getInstance().addObserver(this, NotificationCenter.emojiDidLoaded);
             NotificationCenter.getInstance().addObserver(this, NotificationCenter.updateInterfaces);
+            NotificationCenter.getInstance().addObserver(this, NotificationCenter.locationPermissionGranted);
         }
 
         if (offlineMode) {
             MediaController.loadGeoTaggedGalleryPhotos(classGuid, false);
         }
-        LocationManagerHelper.getInstance().runLocationListener();
 
         if (!offlineMode && !postsLoaded) {
             PostsController.getInstance().loadPosts(null, null, 0, Constants.POST_COUNT, true, offlineMode);
@@ -319,6 +321,7 @@ public void onFragmentDestroy() {
             NotificationCenter.getInstance().removeObserver(this, NotificationCenter.postsNeedReload);
             NotificationCenter.getInstance().removeObserver(this, NotificationCenter.emojiDidLoaded);
             NotificationCenter.getInstance().removeObserver(this, NotificationCenter.updateInterfaces);
+            NotificationCenter.getInstance().removeObserver(this, NotificationCenter.locationPermissionGranted);
         }
         LocationManagerHelper.getInstance().stopLocationListener();
 
@@ -796,17 +799,6 @@ public void onResume() {
         if (postsSearchAdapter != null) {
             postsSearchAdapter.notifyDataSetChanged();
         }
-//        if (checkPermission && Build.VERSION.SDK_INT >= 23) {
-//            Activity activity = getParentActivity();
-//            if (activity != null) {
-//                checkPermission = false;
-//                if (activity.checkSelfPermission(Manifest.permission.ACCESS_COARSE_LOCATION) != PackageManager.PERMISSION_GRANTED) {
-//                    activity.requestPermissions(new String[]{Manifest.permission.ACCESS_COARSE_LOCATION, Manifest.permission.ACCESS_FINE_LOCATION}, 2);
-//                }
-//            }
-//        } else {
-////            LocationManagerHelper.getInstance().runLocationListener();
-//        }
     }
 
     @Override
@@ -925,6 +917,8 @@ public void onClick(DialogInterface dialogInterface, int i) {
             this.offlineMode = false;
 //            layoutManager.scrollToPosition(0);
             refreshPosts(force);
+        } else if (id == NotificationCenter.locationPermissionGranted) {
+            LocationManagerHelper.getInstance().runLocationListener();
         }
     }
 
@@ -1105,6 +1099,12 @@ private void stopRefreshingProgressView() {
 
     //http://stackoverflow.com/questions/5375654/how-to-implement-google-maps-search-by-address-in-android  search Google Maps
     private void openLocationChooser() {
+        Activity activity = getParentActivity();
+        //TODO check both permissions
+        if (!Permissions.locationPermitted && activity != null && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M && activity.checkSelfPermission(Manifest.permission.ACCESS_COARSE_LOCATION) != PackageManager.PERMISSION_GRANTED) {
+            activity.requestPermissions(Permissions.LOCATION_PERMISSION_GROUP, Permissions.LOCATION_REQUEST_CODE);
+            return;
+        }
         if (!isGoogleMapsInstalled()) {
             return;
         }
diff --git a/TMessagesProj/src/main/java/org/telegram/utils/Permissions.java b/TMessagesProj/src/main/java/org/telegram/utils/Permissions.java
new file mode 100644
index 000000000..56417b695
--- /dev/null
+++ b/TMessagesProj/src/main/java/org/telegram/utils/Permissions.java
@@ -0,0 +1,37 @@
+package org.telegram.utils;
+
+import android.Manifest;
+
+/**
+ * Created by aragats on 05/06/16.
+ */
+public class Permissions {
+
+    public static boolean locationPermitted = false;
+    public static boolean cameraPermitted = false;
+    public static boolean storagePermitted = false;
+
+
+    //    Permissions
+//Runtime Permissions
+//https://inthecheesefactory.com/blog/things-you-need-to-know-about-android-m-permission-developer-edition/en
+//https://www.captechconsulting.com/blogs/runtime-permissions-best-practices-and-how-to-gracefully-handle-permission-removal
+    ///http://stackoverflow.com/questions/32083913/android-gps-requires-access-fine-location-error-even-though-my-manifest-file
+    //Request Permission in Realtime
+    public static final String[] LOCATION_PERMISSION_GROUP = {
+            Manifest.permission.ACCESS_COARSE_LOCATION,
+            Manifest.permission.ACCESS_FINE_LOCATION
+    };
+    public static final String[] CAMERA_PERMISSION_GROUP = {
+            Manifest.permission.CAMERA
+    };
+    public static final String[] STORAGE_PERMISSION_GROUP = {
+//            Manifest.permission.READ_EXTERNAL_STORAGE,
+            Manifest.permission.WRITE_EXTERNAL_STORAGE
+    };
+
+    public static final int LOCATION_REQUEST_CODE = 1;
+    public static final int STORAGE_REQUEST = 2;
+    public static final int CAMERA_REQUEST = 3;
+
+}
diff --git a/TMessagesProj/src/main/java/ru/aragats/wgo/ApplicationLoader.java b/TMessagesProj/src/main/java/ru/aragats/wgo/ApplicationLoader.java
index 915cafdcf..5ba3f4c7c 100644
--- a/TMessagesProj/src/main/java/ru/aragats/wgo/ApplicationLoader.java
+++ b/TMessagesProj/src/main/java/ru/aragats/wgo/ApplicationLoader.java
@@ -43,6 +43,7 @@
 
     private static final Object sync = new Object();
 
+    public static volatile Activity parentActivity;
     public static volatile Context applicationContext;
     public static volatile Handler applicationHandler;
     private static volatile boolean applicationInited = false;
diff --git a/build.gradle b/build.gradle
index 464489f66..5e8488b3e 100644
--- a/build.gradle
+++ b/build.gradle
@@ -4,6 +4,6 @@ buildscript {
         mavenCentral()
     }
     dependencies {
-        classpath 'com.android.tools.build:gradle:2.1.0'
+        classpath 'com.android.tools.build:gradle:2.1.2'
     }
 }
\ No newline at end of file
