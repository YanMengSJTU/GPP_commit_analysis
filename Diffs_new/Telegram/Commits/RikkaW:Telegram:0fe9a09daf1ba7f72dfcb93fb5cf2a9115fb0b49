diff --git a/TMessagesProj/build.gradle b/TMessagesProj/build.gradle
index 7e1e906f4..94cbeb787 100644
--- a/TMessagesProj/build.gradle
+++ b/TMessagesProj/build.gradle
@@ -9,9 +9,9 @@ configurations {
 }
 
 dependencies {
-    compile 'com.google.android.gms:play-services-gcm:9.8.00'
-    compile 'com.google.android.gms:play-services-maps:9.8.00'
-    compile 'com.google.android.gms:play-services-vision:9.8.00'
+    compile 'com.google.android.gms:play-services-gcm:9.8.0'
+    compile 'com.google.android.gms:play-services-maps:9.8.0'
+    compile 'com.google.android.gms:play-services-vision:9.8.0'
     compile 'com.android.support:support-core-ui:25.0.0'
     compile 'com.android.support:support-compat:25.0.0'
     compile 'com.android.support:support-core-utils:25.0.0'
@@ -81,7 +81,7 @@ android {
         }
     }
 
-    defaultConfig.versionCode = 851 + 9
+    defaultConfig.versionCode = 851 + 10
 
     sourceSets.debug {
         manifest.srcFile 'config/debug/AndroidManifest.xml'
@@ -121,7 +121,7 @@ android {
     defaultConfig {
         minSdkVersion 21
         targetSdkVersion 25
-        versionName "3.13.1.9"
+        versionName "3.13.1.10"
 
         /*externalNativeBuild {
             ndkBuild {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Cells/TextCheckCell.java b/TMessagesProj/src/main/java/org/telegram/ui/Cells/TextCheckCell.java
index ecd6c72ff..893919b07 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Cells/TextCheckCell.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Cells/TextCheckCell.java
@@ -126,6 +126,7 @@ public void setTextAndValueAndCheck(String text, String value, boolean checked,
     public boolean isChecked() {
         return checkBox.isChecked();
     }
+
     public void setChecked(boolean checked) {
         checkBox.setChecked(checked);
     }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Components/TwilightManager.java b/TMessagesProj/src/main/java/org/telegram/ui/Components/TwilightManager.java
index 23a8bb80f..3a4a0ceb1 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Components/TwilightManager.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Components/TwilightManager.java
@@ -22,10 +22,12 @@
 
 import android.Manifest;
 import android.content.Context;
+import android.content.pm.PackageManager;
 import android.location.Location;
 import android.location.LocationManager;
 import android.support.annotation.NonNull;
 import android.support.annotation.VisibleForTesting;
+import android.support.v4.app.ActivityCompat;
 import android.support.v4.content.PermissionChecker;
 import android.text.format.DateUtils;
 import android.util.Log;
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/NightModeActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/NightModeActivity.java
index 72cdfc9cd..50f07b020 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/NightModeActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/NightModeActivity.java
@@ -1,10 +1,14 @@
 package org.telegram.ui;
 
+import android.Manifest;
+import android.animation.LayoutTransition;
 import android.app.Activity;
 import android.app.TimePickerDialog;
 import android.content.Context;
 import android.content.DialogInterface;
 import android.content.SharedPreferences;
+import android.content.pm.PackageManager;
+import android.os.Build;
 import android.support.v4.content.ContextCompat;
 import android.text.format.DateFormat;
 import android.view.MotionEvent;
@@ -12,6 +16,7 @@
 import android.view.ViewGroup;
 import android.widget.LinearLayout;
 import android.widget.TimePicker;
+import android.widget.Toast;
 
 import org.telegram.messenger.ApplicationLoader;
 import org.telegram.messenger.LocaleController;
@@ -20,6 +25,8 @@
 import org.telegram.ui.ActionBar.BaseFragment;
 import org.telegram.ui.ActionBar.BottomSheet;
 import org.telegram.ui.Cells.HeaderCell;
+import org.telegram.ui.Cells.ShadowSectionCell;
+import org.telegram.ui.Cells.TextCheckCell;
 import org.telegram.ui.Cells.TextInfoPrivacyCell;
 import org.telegram.ui.Cells.TextSettingsCell;
 import org.telegram.ui.Components.DayNightActivity;
@@ -34,20 +41,25 @@
 
 public class NightModeActivity extends BaseFragment implements TimePickerDialog.OnTimeSetListener {
 
+    private SharedPreferences preferences;
+
+    private ShadowSectionCell followSystemCell;
+    private HeaderCell nightTimeHeaderCell;
+    private TextCheckCell useLocationCell;
     private TextSettingsCell sunriseCell;
     private TextSettingsCell sunsetCell;
+    private TextInfoPrivacyCell autoInfoCell;
 
     private int[] hourOfDay, minute;
     private static final int SUNRISE = 0;
     private static final int SUNSET = 1;
 
-
     @Override
     public View createView(Context context) {
         hourOfDay = new int[2];
         minute = new int[2];
 
-        SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("mainconfig", Activity.MODE_PRIVATE);
+        preferences = ApplicationLoader.applicationContext.getSharedPreferences("mainconfig", Activity.MODE_PRIVATE);
 
         hourOfDay[SUNRISE] = preferences.getInt("nightModeSunrise", 6);
         minute[SUNRISE] = preferences.getInt("nightModeSunriseMinute", 0);
@@ -79,6 +91,7 @@ public boolean onTouch(View v, MotionEvent event) {
         fragmentView.setBackgroundColor(ContextCompat.getColor(context, R.color.settings_background));
 
         ((LinearLayout) fragmentView).setOrientation(LinearLayout.VERTICAL);
+        ((LinearLayout) fragmentView).setLayoutTransition(new LayoutTransition());
 
         int nightMode = preferences.getInt("nightMode", DayNightActivity.MODE_NIGHT_FOLLOW_SYSTEM);
 
@@ -87,14 +100,32 @@ public boolean onTouch(View v, MotionEvent event) {
         nightModeCell.setForeground(R.drawable.list_selector);
         ((LinearLayout) fragmentView).addView(nightModeCell, LayoutHelper.createLinear(LayoutHelper.MATCH_PARENT, LayoutHelper.WRAP_CONTENT));
 
-        TextInfoPrivacyCell infoCell = new TextInfoPrivacyCell(context);
-        infoCell.setText(LocaleController.getString("NightModeInfo", R.string.NightModeInfo));
-        ((LinearLayout) fragmentView).addView(infoCell, LayoutHelper.createLinear(LayoutHelper.MATCH_PARENT, LayoutHelper.WRAP_CONTENT));
+        followSystemCell = new ShadowSectionCell(context);
+        ((LinearLayout) fragmentView).addView(followSystemCell, LayoutHelper.createLinear(LayoutHelper.MATCH_PARENT, LayoutHelper.WRAP_CONTENT));
 
-        HeaderCell headerCell = new HeaderCell(context);
-        headerCell.setText(LocaleController.getString("NightModeAutoSwitch", R.string.NightModeAutoSwitch));
-        ((LinearLayout) fragmentView).addView(headerCell, LayoutHelper.createLinear(LayoutHelper.MATCH_PARENT, LayoutHelper.WRAP_CONTENT));
+        nightTimeHeaderCell = new HeaderCell(context);
+        nightTimeHeaderCell.setText(LocaleController.getString("NightModeAutoSwitch", R.string.NightModeAutoSwitch));
+        ((LinearLayout) fragmentView).addView(nightTimeHeaderCell, LayoutHelper.createLinear(LayoutHelper.MATCH_PARENT, LayoutHelper.WRAP_CONTENT));
 
+        useLocationCell = new TextCheckCell(context);
+        useLocationCell.setForeground(R.drawable.list_selector);
+        useLocationCell.setTextAndValueAndCheck(LocaleController.getString("NightModeLocation", R.string.NightModeLocation), LocaleController.getString("NightModeLocationInfo", R.string.NightModeLocationInfo), preferences.getBoolean("nightModeUseLocation", false), true, true);
+        ((LinearLayout) fragmentView).addView(useLocationCell, LayoutHelper.createLinear(LayoutHelper.MATCH_PARENT, LayoutHelper.WRAP_CONTENT));
+        useLocationCell.setOnClickListener(new View.OnClickListener() {
+            @Override
+            public void onClick(View view) {
+                if (!useLocationCell.isChecked()
+                        && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M
+                        && getParentActivity().checkSelfPermission(Manifest.permission.ACCESS_COARSE_LOCATION) != PackageManager.PERMISSION_GRANTED) {
+                    getParentActivity().requestPermissions(new String[]{Manifest.permission.ACCESS_COARSE_LOCATION}, 1);
+                } else {
+                    useLocationCell.setChecked(!useLocationCell.isChecked());
+                    preferences.edit().putBoolean("nightModeUseLocation", useLocationCell.isChecked()).apply();
+
+                    resetNightModeAutoViewsVisibility();
+                }
+            }
+        });
 
         Calendar calendar = Calendar.getInstance();
         calendar.setTimeInMillis(System.currentTimeMillis());
@@ -127,9 +158,9 @@ public boolean onTouch(View v, MotionEvent event) {
         sunriseCell.setTextAndValue(LocaleController.getString("NightModeEndTime", R.string.NightModeEndTime), sunrise.toString(), false);
         ((LinearLayout) fragmentView).addView(sunriseCell, LayoutHelper.createLinear(LayoutHelper.MATCH_PARENT, LayoutHelper.WRAP_CONTENT));
 
-        TextInfoPrivacyCell infoCell2 = new TextInfoPrivacyCell(context);
-        infoCell2.setText(LocaleController.getString("NightModeAutoSwitchInfo", R.string.NightModeAutoSwitchInfo));
-        ((LinearLayout) fragmentView).addView(infoCell2, LayoutHelper.createLinear(LayoutHelper.MATCH_PARENT, LayoutHelper.WRAP_CONTENT));
+        autoInfoCell = new TextInfoPrivacyCell(context);
+        autoInfoCell.setText(LocaleController.getString("NightModeAutoSwitchInfo", R.string.NightModeAutoSwitchInfo));
+        ((LinearLayout) fragmentView).addView(autoInfoCell, LayoutHelper.createLinear(LayoutHelper.MATCH_PARENT, LayoutHelper.WRAP_CONTENT));
 
         nightModeCell.setOnClickListener(new View.OnClickListener() {
             @Override
@@ -154,6 +185,10 @@ public void onClick(DialogInterface dialogInterface, int i) {
                                     case 3: nightMode = DayNightActivity.MODE_NIGHT_FOLLOW_SYSTEM; break;
                                 }
 
+                                if (nightMode == DayNightActivity.MODE_NIGHT_FOLLOW_SYSTEM) {
+                                    Toast.makeText(getParentActivity(), LocaleController.getString("NightModeFollowSystemInfo", R.string.NightModeAutoSwitchInfo), Toast.LENGTH_SHORT).show();
+                                }
+
                                 SharedPreferences.Editor editor = preferences.edit();
                                 editor.putInt("nightMode", nightMode);
                                 editor.commit();
@@ -184,6 +219,54 @@ public void onClick(View view) {
         return fragmentView;
     }
 
+    @Override
+    public void onResume() {
+        super.onResume();
+
+        int nightMode = preferences.getInt("nightMode", DayNightActivity.MODE_NIGHT_FOLLOW_SYSTEM);
+
+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
+            if (getParentActivity().checkSelfPermission(Manifest.permission.ACCESS_COARSE_LOCATION) != PackageManager.PERMISSION_GRANTED) {
+                useLocationCell.setChecked(false);
+                preferences.edit().putBoolean("nightModeUseLocation", useLocationCell.isChecked()).apply();
+                TwilightManager.setUseLocation(false);
+            }
+        }
+
+        if (nightMode == DayNightActivity.MODE_NIGHT_AUTO) {
+            resetNightModeAutoViewsVisibility();
+        } else {
+            nightTimeHeaderCell.setVisibility(View.GONE);
+            sunriseCell.setVisibility(View.GONE);
+            sunsetCell.setVisibility(View.GONE);
+            autoInfoCell.setVisibility(View.GONE);
+            useLocationCell.setVisibility(View.GONE);
+        }
+    }
+
+    private void resetNightModeAutoViewsVisibility() {
+        if (useLocationCell.isChecked()) {
+            sunriseCell.setVisibility(View.GONE);
+            sunsetCell.setVisibility(View.GONE);
+        } else {
+            sunriseCell.setVisibility(View.VISIBLE);
+            sunsetCell.setVisibility(View.VISIBLE);
+        }
+
+        nightTimeHeaderCell.setVisibility(View.VISIBLE);
+        autoInfoCell.setVisibility(View.VISIBLE);
+        useLocationCell.setVisibility(View.VISIBLE);
+
+    }
+
+    @Override
+    public void onRequestPermissionsResultFragment(int requestCode, String[] permissions, int[] grantResults) {
+        if (requestCode == 1 && grantResults.length > 0 && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
+            TwilightManager.setUseLocation(true);
+            useLocationCell.setChecked(true);
+        }
+    }
+
     private boolean isEditingSunrise;
 
     private void showDataPickerDialog(boolean isEnd, int hour, int minute) {
diff --git a/TMessagesProj/src/main/res/values-ar/strings.xml b/TMessagesProj/src/main/res/values-ar/strings.xml
index 2d7837109..b5d3360d2 100644
--- a/TMessagesProj/src/main/res/values-ar/strings.xml
+++ b/TMessagesProj/src/main/res/values-ar/strings.xml
@@ -1307,7 +1307,9 @@
     <string name="NightModeFollowSystem">Follow System</string>
     <string name="NightModeAutoSwitch">Night time</string>
     <string name="NightModeStartTime">From</string>
-    <string name="NightModeAutoSwitchInfo">The above section will only take effect if \'Auto\' is selected.</string>
+    <string name="NightModeAutoSwitchInfo">Restart of the app may be required for above settings to come into effect.</string>
     <string name="NightModeEndTime">To</string>
-    <string name="NightModeInfo">Restart of the app may be required for \'Follow System\' to come into effect</string>
+    <string name="NightModeFollowSystemInfo">Restart of the app may be required for \'Follow System\' to come into effect.</string>
+    <string name="NightModeLocation">Location enhancement</string>
+    <string name="NightModeLocationInfo">Use location to calculate sunset and sun rise time</string>
 </resources>
diff --git a/TMessagesProj/src/main/res/values-de/strings.xml b/TMessagesProj/src/main/res/values-de/strings.xml
index 16d30fd62..f2a20a494 100644
--- a/TMessagesProj/src/main/res/values-de/strings.xml
+++ b/TMessagesProj/src/main/res/values-de/strings.xml
@@ -1307,7 +1307,9 @@
     <string name="NightModeFollowSystem">Follow System</string>
     <string name="NightModeAutoSwitch">Night time</string>
     <string name="NightModeStartTime">From</string>
-    <string name="NightModeAutoSwitchInfo">The above section will only take effect if \'Auto\' is selected.</string>
+    <string name="NightModeAutoSwitchInfo">Restart of the app may be required for above settings to come into effect.</string>
     <string name="NightModeEndTime">To</string>
-    <string name="NightModeInfo">Restart of the app may be required for \'Follow System\' to come into effect</string>
+    <string name="NightModeFollowSystemInfo">Restart of the app may be required for \'Follow System\' to come into effect.</string>
+    <string name="NightModeLocation">Location enhancement</string>
+    <string name="NightModeLocationInfo">Use location to calculate sunset and sun rise time</string>
 </resources>
diff --git a/TMessagesProj/src/main/res/values-es/strings.xml b/TMessagesProj/src/main/res/values-es/strings.xml
index aeb822d9d..9dad30f06 100644
--- a/TMessagesProj/src/main/res/values-es/strings.xml
+++ b/TMessagesProj/src/main/res/values-es/strings.xml
@@ -1307,7 +1307,9 @@
     <string name="NightModeFollowSystem">Follow System</string>
     <string name="NightModeAutoSwitch">Night time</string>
     <string name="NightModeStartTime">From</string>
-    <string name="NightModeAutoSwitchInfo">The above section will only take effect if \'Auto\' is selected.</string>
+    <string name="NightModeAutoSwitchInfo">Restart of the app may be required for above settings to come into effect.</string>
     <string name="NightModeEndTime">To</string>
-    <string name="NightModeInfo">Restart of the app may be required for \'Follow System\' to come into effect</string>
+    <string name="NightModeFollowSystemInfo">Restart of the app may be required for \'Follow System\' to come into effect.</string>
+    <string name="NightModeLocation">Location enhancement</string>
+    <string name="NightModeLocationInfo">Use location to calculate sunset and sun rise time</string>
 </resources>
diff --git a/TMessagesProj/src/main/res/values-it/strings.xml b/TMessagesProj/src/main/res/values-it/strings.xml
index 6b09c288b..6da3a3243 100644
--- a/TMessagesProj/src/main/res/values-it/strings.xml
+++ b/TMessagesProj/src/main/res/values-it/strings.xml
@@ -1307,7 +1307,9 @@
     <string name="NightModeFollowSystem">Follow System</string>
     <string name="NightModeAutoSwitch">Night time</string>
     <string name="NightModeStartTime">From</string>
-    <string name="NightModeAutoSwitchInfo">The above section will only take effect if \'Auto\' is selected.</string>
+    <string name="NightModeAutoSwitchInfo">Restart of the app may be required for above settings to come into effect.</string>
     <string name="NightModeEndTime">To</string>
-    <string name="NightModeInfo">Restart of the app may be required for \'Follow System\' to come into effect</string>
+    <string name="NightModeFollowSystemInfo">Restart of the app may be required for \'Follow System\' to come into effect.</string>
+    <string name="NightModeLocation">Location enhancement</string>
+    <string name="NightModeLocationInfo">Use location to calculate sunset and sun rise time</string>
 </resources>
diff --git a/TMessagesProj/src/main/res/values-ko/strings.xml b/TMessagesProj/src/main/res/values-ko/strings.xml
index 0fad9df6c..7296207a3 100644
--- a/TMessagesProj/src/main/res/values-ko/strings.xml
+++ b/TMessagesProj/src/main/res/values-ko/strings.xml
@@ -1309,5 +1309,7 @@
     <string name="NightModeStartTime">From</string>
     <string name="NightModeAutoSwitchInfo">The above section will only take effect if \'Auto\' is selected.</string>
     <string name="NightModeEndTime">To</string>
-    <string name="NightModeInfo">Restart of the app may be required for \'Follow System\' to come into effect</string>
+    <string name="NightModeFollowSystemInfo">Restart of the app may be required for \'Follow System\' to come into effect.</string>
+    <string name="NightModeLocation">Location enhancement</string>
+    <string name="NightModeLocationInfo">Use location to calculate sunset and sun rise time</string>
 </resources>
diff --git a/TMessagesProj/src/main/res/values-nl/strings.xml b/TMessagesProj/src/main/res/values-nl/strings.xml
index 2c6b6c4ab..4ca9451f2 100644
--- a/TMessagesProj/src/main/res/values-nl/strings.xml
+++ b/TMessagesProj/src/main/res/values-nl/strings.xml
@@ -1309,5 +1309,7 @@
     <string name="NightModeStartTime">From</string>
     <string name="NightModeAutoSwitchInfo">The above section will only take effect if \'Auto\' is selected.</string>
     <string name="NightModeEndTime">To</string>
-    <string name="NightModeInfo">Restart of the app may be required for \'Follow System\' to come into effect</string>
+    <string name="NightModeFollowSystemInfo">Restart of the app may be required for \'Follow System\' to come into effect.</string>
+    <string name="NightModeLocation">Location enhancement</string>
+    <string name="NightModeLocationInfo">Use location to calculate sunset and sun rise time</string>
 </resources>
diff --git a/TMessagesProj/src/main/res/values-pt-rBR/strings.xml b/TMessagesProj/src/main/res/values-pt-rBR/strings.xml
index 154814aea..a6e5ceba5 100644
--- a/TMessagesProj/src/main/res/values-pt-rBR/strings.xml
+++ b/TMessagesProj/src/main/res/values-pt-rBR/strings.xml
@@ -1309,5 +1309,7 @@
     <string name="NightModeStartTime">From</string>
     <string name="NightModeAutoSwitchInfo">The above section will only take effect if \'Auto\' is selected.</string>
     <string name="NightModeEndTime">To</string>
-    <string name="NightModeInfo">Restart of the app may be required for \'Follow System\' to come into effect</string>
+    <string name="NightModeFollowSystemInfo">Restart of the app may be required for \'Follow System\' to come into effect.</string>
+    <string name="NightModeLocation">Location enhancement</string>
+    <string name="NightModeLocationInfo">Use location to calculate sunset and sun rise time</string>
 </resources>
diff --git a/TMessagesProj/src/main/res/values-pt-rPT/strings.xml b/TMessagesProj/src/main/res/values-pt-rPT/strings.xml
index b0bb6fc5f..74ced8882 100644
--- a/TMessagesProj/src/main/res/values-pt-rPT/strings.xml
+++ b/TMessagesProj/src/main/res/values-pt-rPT/strings.xml
@@ -1309,5 +1309,7 @@
     <string name="NightModeStartTime">From</string>
     <string name="NightModeAutoSwitchInfo">The above section will only take effect if \'Auto\' is selected.</string>
     <string name="NightModeEndTime">To</string>
-    <string name="NightModeInfo">Restart of the app may be required for \'Follow System\' to come into effect</string>
+    <string name="NightModeFollowSystemInfo">Restart of the app may be required for \'Follow System\' to come into effect.</string>
+    <string name="NightModeLocation">Location enhancement</string>
+    <string name="NightModeLocationInfo">Use location to calculate sunset and sun rise time</string>
 </resources>
diff --git a/TMessagesProj/src/main/res/values-zh-rCN/strings.xml b/TMessagesProj/src/main/res/values-zh-rCN/strings.xml
index 7303c573b..94df1dc47 100644
--- a/TMessagesProj/src/main/res/values-zh-rCN/strings.xml
+++ b/TMessagesProj/src/main/res/values-zh-rCN/strings.xml
@@ -1311,6 +1311,8 @@
     <string name="NightModeAutoSwitch">自动切换时间</string>
     <string name="NightModeStartTime">夜间模式开始时间</string>
     <string name="NightModeEndTime">夜间模式结束时间</string>
-    <string name="NightModeAutoSwitchInfo">该设置只在您选择自动时生效。</string>
-    <string name="NightModeInfo">跟随系统可能需要您强制停止并重启应用才能生效。</string>
+    <string name="NightModeAutoSwitchInfo">您可能需要重启应用来使以上设置生效。</string>
+    <string name="NightModeFollowSystemInfo">跟随系统可能需要您重启应用才能生效。</string>
+    <string name="NightModeLocation">位置增强</string>
+    <string name="NightModeLocationInfo">使用位置来计算日落和日出时间</string>
 </resources>
diff --git a/TMessagesProj/src/main/res/values/strings.xml b/TMessagesProj/src/main/res/values/strings.xml
index f9210c9a8..c75fee79f 100644
--- a/TMessagesProj/src/main/res/values/strings.xml
+++ b/TMessagesProj/src/main/res/values/strings.xml
@@ -1309,7 +1309,9 @@
     <string name="NightModeFollowSystem">Follow System</string>
     <string name="NightModeAutoSwitch">Night time</string>
     <string name="NightModeStartTime">From</string>
-    <string name="NightModeAutoSwitchInfo">The above section will only take effect if \'Auto\' is selected.</string>
+    <string name="NightModeAutoSwitchInfo">Restart of the app may be required for above settings to come into effect.</string>
     <string name="NightModeEndTime">To</string>
-    <string name="NightModeInfo">Restart of the app may be required for \'Follow System\' to come into effect</string>
+    <string name="NightModeFollowSystemInfo">Restart of the app may be required for \'Follow System\' to come into effect.</string>
+    <string name="NightModeLocation">Location enhancement</string>
+    <string name="NightModeLocationInfo">Use location to calculate sunset and sun rise time</string>
 </resources>
