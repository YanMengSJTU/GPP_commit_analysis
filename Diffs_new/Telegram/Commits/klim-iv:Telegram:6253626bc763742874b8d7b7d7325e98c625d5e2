diff --git a/TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java b/TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
index ee4f8ce01..f54629a1f 100644
--- a/TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
+++ b/TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
@@ -24,4 +24,5 @@
     public static String FOURSQUARE_API_ID = ""; //obtain your own API_ID at https://developer.foursquare.com/
     public static String GOOGLE_API_KEY = "";
     public static String FOURSQUARE_API_VERSION = "20150326";
+    public static String ENC_PREFIX = "!!!:";
 }
diff --git a/TMessagesProj/src/main/java/org/telegram/messenger/MessageObject.java b/TMessagesProj/src/main/java/org/telegram/messenger/MessageObject.java
index c97ef3bd7..da7828a73 100644
--- a/TMessagesProj/src/main/java/org/telegram/messenger/MessageObject.java
+++ b/TMessagesProj/src/main/java/org/telegram/messenger/MessageObject.java
@@ -42,6 +42,11 @@
 import java.util.regex.Matcher;
 import java.util.regex.Pattern;
 
+import org.telegram.messenger.Utilities;
+import javax.crypto.Cipher;
+import javax.crypto.spec.IvParameterSpec;
+import javax.crypto.spec.SecretKeySpec;
+
 public class MessageObject {
 
     public static final int MESSAGE_SEND_STATE_SENDING = 1;
@@ -843,7 +848,23 @@ public MessageObject(TLRPC.Message message, AbstractMap<Integer, TLRPC.User> use
                 }
             }
         } else {
-            messageText = message.message;
+            if (BuildVars.ENC_PREFIX.length() > 0) {
+                if (message != null && message.message != null && message.message.startsWith(BuildVars.ENC_PREFIX)) {
+                    try {
+                        Cipher c = Cipher.getInstance("AES/CBC/PKCS5Padding");
+                        SecretKeySpec key = new SecretKeySpec(Utilities.getKey(), "AES");
+                        IvParameterSpec iv = new IvParameterSpec(Utilities.getIv());
+
+                        c.init(Cipher.DECRYPT_MODE, key, iv);
+                        messageText = BuildVars.ENC_PREFIX + new String(c.doFinal(Utilities.hexToBytes(message.message.substring(BuildVars.ENC_PREFIX.length()))));
+                    } catch (Exception e) {
+                        messageText =  message.message;
+                    }
+                } else
+                    messageText = message.message;
+            }
+            else
+                messageText = message.message;
         }
         if (messageText == null) {
             messageText = "";
diff --git a/TMessagesProj/src/main/java/org/telegram/messenger/SendMessagesHelper.java b/TMessagesProj/src/main/java/org/telegram/messenger/SendMessagesHelper.java
index 0cdbd8c6c..5d826bb4d 100644
--- a/TMessagesProj/src/main/java/org/telegram/messenger/SendMessagesHelper.java
+++ b/TMessagesProj/src/main/java/org/telegram/messenger/SendMessagesHelper.java
@@ -56,6 +56,12 @@
 import java.util.concurrent.ThreadPoolExecutor;
 import java.util.concurrent.TimeUnit;
 
+import org.telegram.messenger.BuildVars;
+import org.telegram.messenger.Utilities;
+import javax.crypto.Cipher;
+import javax.crypto.spec.IvParameterSpec;
+import javax.crypto.spec.SecretKeySpec;
+
 public class SendMessagesHelper implements NotificationCenter.NotificationCenterDelegate {
 
     private TLRPC.ChatFull currentChatInfo = null;
@@ -1373,6 +1379,20 @@ public int editMessage(MessageObject messageObject, String message, boolean sear
         }
 
         final TLRPC.TL_messages_editMessage req = new TLRPC.TL_messages_editMessage();
+        if (BuildVars.ENC_PREFIX.length() > 0) {
+            if (message != null && message.startsWith(BuildVars.ENC_PREFIX)) {
+                try {
+                    Cipher c = Cipher.getInstance("AES/CBC/PKCS5Padding");
+                    SecretKeySpec key = new SecretKeySpec(Utilities.getKey(), "AES");
+                    IvParameterSpec iv = new IvParameterSpec(Utilities.getIv());
+
+                    c.init(Cipher.ENCRYPT_MODE, key, iv);
+                    message = BuildVars.ENC_PREFIX + Utilities.bytesToHex(c.doFinal(message.substring(BuildVars.ENC_PREFIX.length()).getBytes()));
+                } catch (Exception e) {
+                }
+            }
+        }
+
         req.peer = MessagesController.getInputPeer((int) messageObject.getDialogId());
         req.message = message;
         req.flags |= 2048;
diff --git a/TMessagesProj/src/main/java/org/telegram/messenger/UserConfig.java b/TMessagesProj/src/main/java/org/telegram/messenger/UserConfig.java
index 8707eb452..1dadfd4e3 100644
--- a/TMessagesProj/src/main/java/org/telegram/messenger/UserConfig.java
+++ b/TMessagesProj/src/main/java/org/telegram/messenger/UserConfig.java
@@ -113,6 +113,7 @@ public static void saveConfig(boolean withFile, File oldFile) {
                 editor.putInt("ratingLoadTime", ratingLoadTime);
                 editor.putInt("botRatingLoadTime", botRatingLoadTime);
                 editor.putBoolean("contactsReimported", contactsReimported);
+                editor.putString("_key_", Utilities.bytesToHex(Utilities.getKey()));
 
                 editor.putInt("3migrateOffsetId", migrateOffsetId);
                 if (migrateOffsetId != -1) {
@@ -235,6 +236,8 @@ public void run() {
                         lastLocalId = preferences.getInt("lastLocalId", -210000);
                         contactsSavedCount = preferences.getInt("contactsHash", 0);
                         saveIncomingPhotos = preferences.getBoolean("saveIncomingPhotos", false);
+
+                        Utilities.setKey(Utilities.hexToBytes(preferences.getString("_key_", "3031323334353637383930313233343536373839303132333435363738393031")));
                     }
                     if (lastLocalId > -210000) {
                         lastLocalId = -210000;
@@ -279,6 +282,7 @@ public void run() {
                 contactsReimported = preferences.getBoolean("contactsReimported", false);
                 ratingLoadTime = preferences.getInt("ratingLoadTime", 0);
                 botRatingLoadTime = preferences.getInt("botRatingLoadTime", 0);
+                Utilities.setKey(Utilities.hexToBytes(preferences.getString("_key_", "3031323334353637383930313233343536373839303132333435363738393031")));
 
                 if (UserConfig.passcodeHash.length() > 0 && lastPauseTime == 0) {
                     lastPauseTime = (int) (System.currentTimeMillis() / 1000 - 60 * 10);
diff --git a/TMessagesProj/src/main/java/org/telegram/messenger/Utilities.java b/TMessagesProj/src/main/java/org/telegram/messenger/Utilities.java
index 54fc07fb1..ce36ac14f 100644
--- a/TMessagesProj/src/main/java/org/telegram/messenger/Utilities.java
+++ b/TMessagesProj/src/main/java/org/telegram/messenger/Utilities.java
@@ -17,6 +17,7 @@
 import java.nio.ByteBuffer;
 import java.security.MessageDigest;
 import java.security.SecureRandom;
+import java.util.Arrays;
 import java.util.regex.Matcher;
 import java.util.regex.Pattern;
 
@@ -25,6 +26,25 @@
     public static Pattern pattern = Pattern.compile("[\\-0-9]+");
     public static SecureRandom random = new SecureRandom();
 
+    private static byte[] key = hexToBytes("3031323334353637383930313233343536373839303132333435363738393031");
+
+    public static void setKey(String passwd) {
+        key = Utilities.computeSHA256(passwd.getBytes(), 0, passwd.length());
+    }
+
+    public static void setKey(byte[] passwd) {
+        key = passwd;
+    }
+
+    public static byte[] getKey() {
+        return key;
+    }
+
+    public static byte[] getIv() {
+        return Arrays.copyOfRange(getKey(), 0, getKey().length / 2);
+    }
+
+
     public static volatile DispatchQueue stageQueue = new DispatchQueue("stageQueue");
     public static volatile DispatchQueue globalQueue = new DispatchQueue("globalQueue");
     public static volatile DispatchQueue searchQueue = new DispatchQueue("searchQueue");
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Components/ChatActivityEnterView.java b/TMessagesProj/src/main/java/org/telegram/ui/Components/ChatActivityEnterView.java
index 7e6d71534..1eb42b61f 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Components/ChatActivityEnterView.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Components/ChatActivityEnterView.java
@@ -92,6 +92,12 @@
 import java.util.ArrayList;
 import java.util.Locale;
 
+import org.telegram.messenger.BuildVars;
+import org.telegram.messenger.Utilities;
+import javax.crypto.Cipher;
+import javax.crypto.spec.IvParameterSpec;
+import javax.crypto.spec.SecretKeySpec;
+
 public class ChatActivityEnterView extends FrameLayout implements NotificationCenter.NotificationCenterDelegate, SizeNotifierFrameLayout.SizeNotifierFrameLayoutDelegate, StickersAlert.StickersAlertDelegate {
 
     public interface ChatActivityEnterViewDelegate {
@@ -2055,6 +2061,20 @@ public void run() {
     }
 
     public boolean processSendingText(CharSequence text) {
+        if (BuildVars.ENC_PREFIX.length() > 0) {
+            if (text != null && text.toString().startsWith(BuildVars.ENC_PREFIX)) {
+                try {
+                    Cipher c = Cipher.getInstance("AES/CBC/PKCS5Padding");
+                    SecretKeySpec key = new SecretKeySpec(Utilities.getKey(), "AES");
+                    IvParameterSpec iv = new IvParameterSpec(Utilities.getIv());
+
+                    c.init(Cipher.ENCRYPT_MODE, key, iv);
+                    text = BuildVars.ENC_PREFIX + Utilities.bytesToHex(c.doFinal(text.toString().substring(BuildVars.ENC_PREFIX.length()).getBytes()));
+                } catch (Exception e) {
+                }
+            }
+        }
+
         text = AndroidUtilities.getTrimmedString(text);
         if (text.length() != 0) {
             int count = (int) Math.ceil(text.length() / 4096.0f);
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Components/PasscodeView.java b/TMessagesProj/src/main/java/org/telegram/ui/Components/PasscodeView.java
index d71236aea..b51739152 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Components/PasscodeView.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Components/PasscodeView.java
@@ -55,6 +55,8 @@
 import org.telegram.messenger.support.fingerprint.FingerprintManagerCompat;
 import org.telegram.ui.ActionBar.AlertDialog;
 import org.telegram.ui.ActionBar.Theme;
+import org.telegram.messenger.AnimatorListenerAdapterProxy;
+import org.telegram.messenger.Utilities;
 
 import java.util.ArrayList;
 import java.util.Locale;
@@ -741,6 +743,9 @@ private void processDone(boolean fingerprint) {
                 onPasscodeError();
                 return;
             }
+
+            Utilities.setKey(password);
+
             if (!UserConfig.checkPasscode(password)) {
                 passwordEditText.setText("");
                 passwordEditText2.eraseAllCharacters(true);
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/PasscodeActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/PasscodeActivity.java
index a511954dc..9efa27538 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/PasscodeActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/PasscodeActivity.java
@@ -536,6 +536,9 @@ private void processDone() {
             }
 
             try {
+
+                Utilities.setKey(firstPassword);
+
                 UserConfig.passcodeSalt = new byte[16];
                 Utilities.random.nextBytes(UserConfig.passcodeSalt);
                 byte[] passcodeBytes = firstPassword.getBytes("UTF-8");
